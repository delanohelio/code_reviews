{"pr_number": 1843, "pr_title": "DBZ-2582 Updating LSN handling", "pr_author": "jgormley6", "pr_createdAt": "2020-09-25T12:43:57Z", "pr_url": "https://github.com/debezium/debezium/pull/1843", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MzE1MA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497373150", "body": "```suggestion\r\n            LOGGER.trace(\"Current maximum LSN is {}\", ret);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOGGER.trace(\"Current maximum lsn is {}\", ret);\n          \n          \n            \n                        LOGGER.trace(\"Current maximum LSN is {}\", ret);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span>trace(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Current maximum <span class=\"x x-first x-last\">lsn</span> is {}<span class=\"pl-pds\">\"</span></span>, ret);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span>trace(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Current maximum <span class=\"x x-first x-last\">LSN</span> is {}<span class=\"pl-pds\">\"</span></span>, ret);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gunnarmorling", "createdAt": "2020-09-30T09:32:41Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MzI4OQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497373289", "body": "```suggestion\r\n            LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);\n          \n          \n            \n                        LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span>trace(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Current maximum transactional <span class=\"x x-first x-last\">lsn</span> is {}<span class=\"pl-pds\">\"</span></span>, ret);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span>trace(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Current maximum transactional <span class=\"x x-first x-last\">LSN</span> is {}<span class=\"pl-pds\">\"</span></span>, ret);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gunnarmorling", "createdAt": "2020-09-30T09:32:50Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);\n+            return ret;\n+        }, \"Maximum LSN query must return exactly one value\"));\n+\n+        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {\n+            // If not alternative query is provided, return the default for both.\n+            return new MaxLsnResult(maxLsn, maxLsn);\n+        }\n+\n+        // Else run the alternative query for getting the largest lsn related to a valid transaction.\n+        return new MaxLsnResult(maxLsn, queryAndMap(alternativeMaxTransactionalQuery, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497384003", "body": "Would be better to use prepared statements to avoid the repeated parsing (see `preparedQueryAndMap()`), for that one and similar queries (I suppose this started off not using PS once and then similar methods followed that precedence).", "bodyText": "Would be better to use prepared statements to avoid the repeated parsing (see preparedQueryAndMap()), for that one and similar queries (I suppose this started off not using PS once and then similar methods followed that precedence).", "bodyHTML": "<p dir=\"auto\">Would be better to use prepared statements to avoid the repeated parsing (see <code>preparedQueryAndMap()</code>), for that one and similar queries (I suppose this started off not using PS once and then similar methods followed that precedence).</p>", "author": "gunnarmorling", "createdAt": "2020-09-30T09:50:35Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MDM0OQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497390349", "bodyText": "Btw. in the Jira statement you originally suggested a single statement to get both LSN values. Can we actually do this, avoiding one round-trip to the DB?", "author": "gunnarmorling", "createdAt": "2020-09-30T10:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTE3NQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497391175", "bodyText": "Also, should the existing getMaxLsn() method be removed, and all callers be updated to use this one?", "author": "gunnarmorling", "createdAt": "2020-09-30T10:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2ODYwOQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497468609", "bodyText": "I can update to the prepared query.\nI'm not sure how we want to handle these sql statements. @jpechane made a valuable suggestion in that we have this feature defaulted, but still removable incase there are issues with it, so I was trying to minimize changing from the current flow. I could update the code to be more of a split between the current way we handle the lsn and the new way and have the new way utilize the query that contains both lsns.\ngetMaxLsn() still has its uses as the stored procs require a valid lsn, which the max transactional way may not be valid after a long period of inactivity. The idea is that one lsn can be utilize for comparison, and the other should be utilized for any queries", "author": "jgormley6", "createdAt": "2020-09-30T12:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTkzMQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497391931", "body": "Seems this would only be the case if someone set the statement explicitly to \"\"; is this what you're expecting here?", "bodyText": "Seems this would only be the case if someone set the statement explicitly to \"\"; is this what you're expecting here?", "bodyHTML": "<p dir=\"auto\">Seems this would only be the case if someone set the statement explicitly to \"\"; is this what you're expecting here?</p>", "author": "gunnarmorling", "createdAt": "2020-09-30T10:03:40Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);\n+            return ret;\n+        }, \"Maximum LSN query must return exactly one value\"));\n+\n+        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2MzA5NA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497463094", "bodyText": "The original idea for the configuration was that if you put nothing, the current flow wouldn't change, but with this second go around where the query is defaulted, but still overridable, I'm not sure what exactly we want to do.\nMaybe we could make this as a sort of feature flag and just have a boolean for determining whether or not we utilize the new lsn handling?", "author": "jgormley6", "createdAt": "2020-09-30T12:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2OTE0Mw==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497469143", "bodyText": "I think the question is whether there's a realistic chance for other statements really being used. If not (which I think is the case tbh.) then yes hard-coding the statement and instead having a feature-toggle for enabling/disabling this optimization seems more reasonable. It could remain an internal (undocumented one) as is right now, defaulting to enable this. Then this could be used to disable the optimization should it prove troublesome in production.", "author": "gunnarmorling", "createdAt": "2020-09-30T12:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTkzMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497393619", "body": "Do we actually need to expose both values to calling code? Wouldn't it suffice to expose only the lower of the two?", "bodyText": "Do we actually need to expose both values to calling code? Wouldn't it suffice to expose only the lower of the two?", "bodyHTML": "<p dir=\"auto\">Do we actually need to expose both values to calling code? Wouldn't it suffice to expose only the lower of the two?</p>", "author": "gunnarmorling", "createdAt": "2020-09-30T10:06:26Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/MaxLsnResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.connector.sqlserver;\n+\n+/**\n+ * Stores the result from querying the lsn_time_mapping for the highest LSNs.\n+ */\n+public class MaxLsnResult {\n+\n+    /**\n+     * The highest lsn regardless of configuration. This should be utilized when querying the CDC tables as using an LSN that is no longer valid can lead to errors.\n+     */\n+    private final Lsn maxLsn;\n+\n+    /**\n+     * The highest lsn belonging to a valid change transaction as determined by {@link SqlServerConnectorConfig#STREAMING_MAX_LSN_SELECT_STATEMENT} or default to the same as maxLsn.\n+     */\n+    private final Lsn maxTransactionalLsn;\n+\n+    public MaxLsnResult(Lsn maxLsn, Lsn maxTransactionalLsn) {\n+        this.maxLsn = maxLsn;\n+        this.maxTransactionalLsn = maxTransactionalLsn;\n+    }\n+\n+    public Lsn getMaxLsn() {\n+        return maxLsn;\n+    }\n+\n+    public Lsn getMaxTransactionalLsn() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2NDcyOA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497464728", "bodyText": "We need both values because the stored proc later used to read the changes will fail if you give it an invalid lsn.\nWhen query the actual tables, we need to always give it the real maximum lsn (and not just the highest one related to changes) otherwise if a server is dormant for a while, you'll run into errors.\nI tried clarifying that through the comments, let me know what changes I can make to them as it's not an obvious thing and should be well documented in the code why.", "author": "jgormley6", "createdAt": "2020-09-30T12:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MjU1Nw==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497562557", "bodyText": "I think I got it overall, thanks for elaborating! One thing still unclear: when does an LSN become invalid exactly?", "author": "gunnarmorling", "createdAt": "2020-09-30T14:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczNzc2Ng==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497737766", "bodyText": "From my understanding, LSNs are cleaned up and removed from the lsn_time_mapping table. It happens automatically, but I believe this stored procedure also could trigger it manually if you wanted to see an example\nhttps://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-cleanup-change-table-transact-sql?view=sql-server-ver15", "author": "jgormley6", "createdAt": "2020-09-30T19:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "203e73ab61c4e6a879a20916262516ae589699e0", "url": "https://github.com/debezium/debezium/commit/203e73ab61c4e6a879a20916262516ae589699e0", "message": "DBZ-2582 Updating LSN handling", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "6e55c5c016ec0b0beaf7f10225d9f15589b2bf4b", "url": "https://github.com/debezium/debezium/commit/6e55c5c016ec0b0beaf7f10225d9f15589b2bf4b", "message": "DBZ-2582-lsn-changes revert log change", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "05497e16cd3c998a8a17b28f67f2d166f197e05a", "url": "https://github.com/debezium/debezium/commit/05497e16cd3c998a8a17b28f67f2d166f197e05a", "message": "DBZ-2582 Fixing tests and adding pause back", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "410f2d74b3c4378b065d3ea9464577475de26bb8", "url": "https://github.com/debezium/debezium/commit/410f2d74b3c4378b065d3ea9464577475de26bb8", "message": "DBZ-2582 Adding copyright", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "e0339efe1cf12536c545f04f9d9e6f7658c30739", "url": "https://github.com/debezium/debezium/commit/e0339efe1cf12536c545f04f9d9e6f7658c30739", "message": "DBZ-2582 Apply suggestions from code review\n\nCo-authored-by: Gunnar Morling <gunnar.morling@googlemail.com>", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "714edc7b4a61340fd5f19ced8dec95c0de96a561", "url": "https://github.com/debezium/debezium/commit/714edc7b4a61340fd5f19ced8dec95c0de96a561", "message": "DBZ-2582 Updating configuration to be feature flag and using prepared statements", "committedDate": "2020-10-08T13:01:55Z", "type": "commit"}, {"oid": "fcd7c5bf5f18eee77511ec7742a37f7282881e7f", "url": "https://github.com/debezium/debezium/commit/fcd7c5bf5f18eee77511ec7742a37f7282881e7f", "message": "DBZ-2582 Updating test for consistency", "committedDate": "2020-10-08T13:01:55Z", "type": "commit"}, {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "url": "https://github.com/debezium/debezium/commit/38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "message": "DBZ-2582 Adding boolean check and removing TODO as no changes are necessary", "committedDate": "2020-10-08T13:01:55Z", "type": "commit"}, {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "url": "https://github.com/debezium/debezium/commit/38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "message": "DBZ-2582 Adding boolean check and removing TODO as no changes are necessary", "committedDate": "2020-10-08T13:01:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0OTg5MA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r502249890", "body": "Tiny nit: \"LSN\" -> \"Lsn\" (this isn't done consistently across the code base yet, but it's the casing we want to converge on eventually for abbreviations in type/method/variable names).", "bodyText": "Tiny nit: \"LSN\" -> \"Lsn\" (this isn't done consistently across the code base yet, but it's the casing we want to converge on eventually for abbreviations in type/method/variable names).", "bodyHTML": "<p dir=\"auto\">Tiny nit: \"LSN\" -&gt; \"Lsn\" (this isn't done consistently across the code base yet, but it's the casing we want to converge on eventually for abbreviations in type/method/variable names).</p>", "author": "gunnarmorling", "createdAt": "2020-10-09T07:51:17Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java", "diffHunk": "@@ -442,6 +452,10 @@ public boolean isReadOnlyDatabaseConnection() {\n         return readOnlyDatabaseConnection;\n     }\n \n+    public boolean isSkipLowActivityLSNsEnabled() {", "originalCommit": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "46374255986b33aaf48f574ec2cbe06d74c35c01", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\nindex 201ddb6a6..885cab2b8 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n", "chunk": "@@ -452,8 +453,8 @@ public boolean isReadOnlyDatabaseConnection() {\n         return readOnlyDatabaseConnection;\n     }\n \n-    public boolean isSkipLowActivityLSNsEnabled() {\n-        return skipLowActivityLSNsEnabled;\n+    public String getMaxLsnSelectStatement() {\n+        return maxLsnSelectStatement;\n     }\n \n     @Override\n", "next_change": {"commit": "55e68df708ef886eb45a567b54a40d276c6a2f73", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\nindex 885cab2b8..201ddb6a6 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n", "chunk": "@@ -453,8 +452,8 @@ public boolean isReadOnlyDatabaseConnection() {\n         return readOnlyDatabaseConnection;\n     }\n \n-    public String getMaxLsnSelectStatement() {\n-        return maxLsnSelectStatement;\n+    public boolean isSkipLowActivityLSNsEnabled() {\n+        return skipLowActivityLSNsEnabled;\n     }\n \n     @Override\n", "next_change": {"commit": "bea46a3059d3cf3d0c82c5ec2153440db35f1a31", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\nindex 201ddb6a6..40854dd6a 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n", "chunk": "@@ -452,8 +452,8 @@ public boolean isReadOnlyDatabaseConnection() {\n         return readOnlyDatabaseConnection;\n     }\n \n-    public boolean isSkipLowActivityLSNsEnabled() {\n-        return skipLowActivityLSNsEnabled;\n+    public boolean isSkipLowActivityLsnsEnabled() {\n+        return skipLowActivityLsnsEnabled;\n     }\n \n     @Override\n", "next_change": {"commit": "dd23e0faad7bc5e9dba648658703be4d17ae2f74", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\nindex 40854dd6a..3276d19d3 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n", "chunk": "@@ -444,16 +390,12 @@ public SourceTimestampMode getSourceTimestampMode() {\n         return sourceTimestampMode;\n     }\n \n-    public ColumnNameFilter getColumnFilter() {\n-        return columnFilter;\n-    }\n-\n     public boolean isReadOnlyDatabaseConnection() {\n         return readOnlyDatabaseConnection;\n     }\n \n-    public boolean isSkipLowActivityLsnsEnabled() {\n-        return skipLowActivityLsnsEnabled;\n+    public int getMaxTransactionsPerIteration() {\n+        return maxTransactionsPerIteration;\n     }\n \n     @Override\n", "next_change": {"commit": "cbf2abaaf2e64995595f1b133002df237734effc", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\nindex 3276d19d3..7890c1c85 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n", "chunk": "@@ -398,6 +398,11 @@ public int getMaxTransactionsPerIteration() {\n         return maxTransactionsPerIteration;\n     }\n \n+    @Override\n+    public boolean supportsOperationFiltering() {\n+        return true;\n+    }\n+\n     @Override\n     protected SourceInfoStructMaker<? extends AbstractSourceInfo> getSourceInfoStructMaker(Version version) {\n         switch (version) {\n", "next_change": {"commit": "44073cf7d89c17922476fffa226ec4497f493ad2", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\nindex 7890c1c85..990c61905 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n", "chunk": "@@ -398,11 +455,20 @@ public int getMaxTransactionsPerIteration() {\n         return maxTransactionsPerIteration;\n     }\n \n+    public boolean getOptionRecompile() {\n+        return optionRecompile;\n+    }\n+\n     @Override\n     public boolean supportsOperationFiltering() {\n         return true;\n     }\n \n+    @Override\n+    protected boolean supportsSchemaChangesDuringIncrementalSnapshot() {\n+        return true;\n+    }\n+\n     @Override\n     protected SourceInfoStructMaker<? extends AbstractSourceInfo> getSourceInfoStructMaker(Version version) {\n         switch (version) {\n", "next_change": {"commit": "4a48eb33df3a4a9c0865271e1065a20d7e4a49bd", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\nindex 990c61905..29af6a07c 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java\n", "chunk": "@@ -471,12 +446,7 @@ protected boolean supportsSchemaChangesDuringIncrementalSnapshot() {\n \n     @Override\n     protected SourceInfoStructMaker<? extends AbstractSourceInfo> getSourceInfoStructMaker(Version version) {\n-        switch (version) {\n-            case V1:\n-                return new LegacyV1SqlServerSourceInfoStructMaker(Module.name(), Module.version(), this);\n-            default:\n-                return new SqlServerSourceInfoStructMaker(Module.name(), Module.version(), this);\n-        }\n+        return new SqlServerSourceInfoStructMaker(Module.name(), Module.version(), this);\n     }\n \n     private static class SystemTablesPredicate implements TableFilter {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MDEwOQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r502250109", "body": "Same comment as below.", "bodyText": "Same comment as below.", "bodyHTML": "<p dir=\"auto\">Same comment as below.</p>", "author": "gunnarmorling", "createdAt": "2020-10-09T07:51:39Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -153,6 +156,24 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(boolean skipLowActivityLSNsEnabled) throws SQLException {\n+        if (skipLowActivityLSNsEnabled) {", "originalCommit": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "46374255986b33aaf48f574ec2cbe06d74c35c01", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\nindex 4adf5dabe..0ea257067 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n", "chunk": "@@ -156,22 +154,24 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n-    public MaxLsnResult getMaxLsnResult(boolean skipLowActivityLSNsEnabled) throws SQLException {\n-        if (skipLowActivityLSNsEnabled) {\n-            return prepareQueryAndMap(GET_MAX_LSN_SKIP_LOW_ACTIVTY, statement -> {\n-            }, singleResultMapper(rs -> {\n-                final MaxLsnResult ret = new MaxLsnResult(Lsn.valueOf(rs.getBytes(1)), Lsn.valueOf(rs.getBytes(2)));\n-                LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);\n-                return ret;\n-            }, \"Maximum transactional LSN query must return exactly one value\"));\n-        }\n-        Lsn maxLsn = prepareQueryAndMap(GET_MAX_LSN, statement -> {\n-        }, singleResultMapper(rs -> {\n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n             final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n-            LOGGER.trace(\"Current maximum LSN is {}\", ret);\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);\n             return ret;\n         }, \"Maximum LSN query must return exactly one value\"));\n-        return new MaxLsnResult(maxLsn, maxLsn);\n+\n+        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {\n+            // If not alternative query is provided, return the default for both.\n+            return new MaxLsnResult(maxLsn, maxLsn);\n+        }\n+\n+        // Else run the alternative query for getting the largest lsn related to a valid transaction.\n+        return new MaxLsnResult(maxLsn, queryAndMap(alternativeMaxTransactionalQuery, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);\n+            return ret;\n+        }, \"Maximum transactional LSN query must return exactly one value\")));\n     }\n \n     /**\n", "next_change": {"commit": "67ff06df9529f911916fdd1bb5f3316c11256e7a", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\nindex 0ea257067..4ec174344 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n", "chunk": "@@ -169,7 +169,7 @@ public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) thr\n         // Else run the alternative query for getting the largest lsn related to a valid transaction.\n         return new MaxLsnResult(maxLsn, queryAndMap(alternativeMaxTransactionalQuery, singleResultMapper(rs -> {\n             final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n-            LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);\n+            LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);\n             return ret;\n         }, \"Maximum transactional LSN query must return exactly one value\")));\n     }\n", "next_change": {"commit": "55e68df708ef886eb45a567b54a40d276c6a2f73", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\nindex 4ec174344..4adf5dabe 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n", "chunk": "@@ -154,24 +156,22 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n-    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n-        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+    public MaxLsnResult getMaxLsnResult(boolean skipLowActivityLSNsEnabled) throws SQLException {\n+        if (skipLowActivityLSNsEnabled) {\n+            return prepareQueryAndMap(GET_MAX_LSN_SKIP_LOW_ACTIVTY, statement -> {\n+            }, singleResultMapper(rs -> {\n+                final MaxLsnResult ret = new MaxLsnResult(Lsn.valueOf(rs.getBytes(1)), Lsn.valueOf(rs.getBytes(2)));\n+                LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);\n+                return ret;\n+            }, \"Maximum transactional LSN query must return exactly one value\"));\n+        }\n+        Lsn maxLsn = prepareQueryAndMap(GET_MAX_LSN, statement -> {\n+        }, singleResultMapper(rs -> {\n             final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n             LOGGER.trace(\"Current maximum LSN is {}\", ret);\n             return ret;\n         }, \"Maximum LSN query must return exactly one value\"));\n-\n-        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {\n-            // If not alternative query is provided, return the default for both.\n-            return new MaxLsnResult(maxLsn, maxLsn);\n-        }\n-\n-        // Else run the alternative query for getting the largest lsn related to a valid transaction.\n-        return new MaxLsnResult(maxLsn, queryAndMap(alternativeMaxTransactionalQuery, singleResultMapper(rs -> {\n-            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n-            LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);\n-            return ret;\n-        }, \"Maximum transactional LSN query must return exactly one value\")));\n+        return new MaxLsnResult(maxLsn, maxLsn);\n     }\n \n     /**\n", "next_change": {"commit": "dd23e0faad7bc5e9dba648658703be4d17ae2f74", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\nindex 4adf5dabe..2a11acd19 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n", "chunk": "@@ -156,22 +148,44 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n-    public MaxLsnResult getMaxLsnResult(boolean skipLowActivityLSNsEnabled) throws SQLException {\n-        if (skipLowActivityLSNsEnabled) {\n-            return prepareQueryAndMap(GET_MAX_LSN_SKIP_LOW_ACTIVTY, statement -> {\n-            }, singleResultMapper(rs -> {\n-                final MaxLsnResult ret = new MaxLsnResult(Lsn.valueOf(rs.getBytes(1)), Lsn.valueOf(rs.getBytes(2)));\n-                LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);\n-                return ret;\n-            }, \"Maximum transactional LSN query must return exactly one value\"));\n-        }\n-        Lsn maxLsn = prepareQueryAndMap(GET_MAX_LSN, statement -> {\n+    /**\n+     * @return the log sequence number of the most recent transaction\n+     *         that isn't further than {@code maxOffset} from the beginning.\n+     */\n+    public Lsn getNthTransactionLsnFromBeginning(int maxOffset) throws SQLException {\n+        return prepareQueryAndMap(GET_NTH_TRANSACTION_LSN_FROM_BEGINNING, statement -> {\n+            statement.setInt(1, maxOffset);\n         }, singleResultMapper(rs -> {\n             final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n-            LOGGER.trace(\"Current maximum LSN is {}\", ret);\n+            LOGGER.trace(\"Nth lsn from beginning is {}\", ret);\n             return ret;\n-        }, \"Maximum LSN query must return exactly one value\"));\n-        return new MaxLsnResult(maxLsn, maxLsn);\n+        }, \"Nth LSN query must return exactly one value\"));\n+    }\n+\n+    /**\n+     * @return the log sequence number of the most recent transaction\n+     *         that isn't further than {@code maxOffset} from {@code lastLsn}.\n+     */\n+    public Lsn getNthTransactionLsnFromLast(Lsn lastLsn, int maxOffset) throws SQLException {\n+        return prepareQueryAndMap(GET_NTH_TRANSACTION_LSN_FROM_LAST, statement -> {\n+            statement.setInt(1, maxOffset);\n+            statement.setBytes(2, lastLsn.getBinary());\n+        }, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Nth lsn from last is {}\", ret);\n+            return ret;\n+        }, \"Nth LSN query must return exactly one value\"));\n+    }\n+\n+    /**\n+     * @return the log sequence number of the most recent transaction.\n+     */\n+    public Lsn getMaxTransactionLsn() throws SQLException {\n+        return queryAndMap(GET_MAX_TRANSACTION_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Max transaction lsn is {}\", ret);\n+            return ret;\n+        }, \"Max transaction LSN query must return exactly one value\"));\n     }\n \n     /**\n", "next_change": {"commit": "37a4523685253311d4e82950142f5da865ae5fcd", "changed_code": [{"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\nindex 2a11acd19..46a96844a 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n", "chunk": "@@ -180,8 +231,8 @@ public Lsn getNthTransactionLsnFromLast(Lsn lastLsn, int maxOffset) throws SQLEx\n     /**\n      * @return the log sequence number of the most recent transaction.\n      */\n-    public Lsn getMaxTransactionLsn() throws SQLException {\n-        return queryAndMap(GET_MAX_TRANSACTION_LSN, singleResultMapper(rs -> {\n+    public Lsn getMaxTransactionLsn(String databaseName) throws SQLException {\n+        return queryAndMap(replaceDatabaseNamePlaceholder(GET_MAX_TRANSACTION_LSN, databaseName), singleResultMapper(rs -> {\n             final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n             LOGGER.trace(\"Max transaction lsn is {}\", ret);\n             return ret;\n", "next_change": null}, {"header": "diff --git a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\nindex 2a11acd19..46a96844a 100644\n--- a/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n+++ b/debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java\n", "chunk": "@@ -191,8 +242,9 @@ public Lsn getMaxTransactionLsn() throws SQLException {\n     /**\n      * @return the smallest log sequence number of table\n      */\n-    public Lsn getMinLsn(String changeTableName) throws SQLException {\n-        String query = GET_MIN_LSN.replace(STATEMENTS_PLACEHOLDER, changeTableName);\n+    public Lsn getMinLsn(String databaseName, String changeTableName) throws SQLException {\n+        String query = replaceDatabaseNamePlaceholder(GET_MIN_LSN, databaseName)\n+                .replace(STATEMENTS_PLACEHOLDER, changeTableName);\n         return queryAndMap(query, singleResultMapper(rs -> {\n             final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n             LOGGER.trace(\"Current minimum lsn is {}\", ret);\n", "next_change": null}]}}]}}]}}]}}]}}, {"oid": "bd8db7979f407681554fcb71bc4fe659cf4da6ca", "url": "https://github.com/debezium/debezium/commit/bd8db7979f407681554fcb71bc4fe659cf4da6ca", "message": "DBZ-2582 Fixing LSN casing", "committedDate": "2020-10-09T18:55:32Z", "type": "commit"}]}