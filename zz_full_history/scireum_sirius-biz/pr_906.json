{"pr_number": 906, "pr_title": "Improves handling of archives in file based import jobs and especially reworks the archive extraction job.", "pr_author": "andyHa", "pr_createdAt": "2020-11-11T21:17:20Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/906", "merge_commit": "c22aec824b45e73e12ee8c9e982ae8d83f896f07", "timeline": [{"oid": "98a764cb70a8b202395544b1f6c87527854c1be3", "url": "https://github.com/scireum/sirius-biz/commit/98a764cb70a8b202395544b1f6c87527854c1be3", "message": "Merge branch 'aha/make-parameters-great-again' into aha/archive-jobs", "committedDate": "2020-11-11T20:42:49Z", "type": "commit"}, {"oid": "ee4bea40e7ef6ffbb852b3f6ff11191b2d8d8fb5", "url": "https://github.com/scireum/sirius-biz/commit/ee4bea40e7ef6ffbb852b3f6ff11191b2d8d8fb5", "message": "Uses the new constants as provided by sirius-db.", "committedDate": "2020-11-11T21:02:09Z", "type": "commit"}, {"oid": "8016e7777932d2451ef8321f22af211dfe817ac9", "url": "https://github.com/scireum/sirius-biz/commit/8016e7777932d2451ef8321f22af211dfe817ac9", "message": "Makes the FileImportJob use the ArchiveExtractor and adds support for handling auxiliary files.", "committedDate": "2020-11-11T21:04:10Z", "type": "commit"}, {"oid": "774c048126fcc9d7b404b35daaafac5257d32652", "url": "https://github.com/scireum/sirius-biz/commit/774c048126fcc9d7b404b35daaafac5257d32652", "message": "Uses the new API as defined by the FileImportJob.", "committedDate": "2020-11-11T21:05:02Z", "type": "commit"}, {"oid": "8396fa50c19c57e074fe9c36094077649da33a09", "url": "https://github.com/scireum/sirius-biz/commit/8396fa50c19c57e074fe9c36094077649da33a09", "message": "Uses the new API as defined by FileImportJob.\n\nThis greatly simplifies the internal workings as it eliminates a whole\nbunch of duplicate code.", "committedDate": "2020-11-11T21:06:01Z", "type": "commit"}, {"oid": "fc230b5dc579281ba1d8feb62c5d9d4d6db496e1", "url": "https://github.com/scireum/sirius-biz/commit/fc230b5dc579281ba1d8feb62c5d9d4d6db496e1", "message": "Supports the new API as defined by FileImportJob and adds support to import all sheets of an excel file.", "committedDate": "2020-11-11T21:07:21Z", "type": "commit"}, {"oid": "e8d46aa792eba500cc06f0b6b9b23b5fd1bd2a9b", "url": "https://github.com/scireum/sirius-biz/commit/e8d46aa792eba500cc06f0b6b9b23b5fd1bd2a9b", "message": "Provides updated translations for the refactored jobs.", "committedDate": "2020-11-11T21:08:19Z", "type": "commit"}, {"oid": "6ac8f4a984357e4f952ee8b8ca326da207c8cdd4", "url": "https://github.com/scireum/sirius-biz/commit/6ac8f4a984357e4f952ee8b8ca326da207c8cdd4", "message": "Provides some cleanup for the ArchiveImportJob.", "committedDate": "2020-11-11T21:08:40Z", "type": "commit"}, {"oid": "e7b86eafd6eb0de75af377f1160013d81bf7038e", "url": "https://github.com/scireum/sirius-biz/commit/e7b86eafd6eb0de75af377f1160013d81bf7038e", "message": "Refactors the extract archive job.\n\nBy default we now overwrite files if a change is detected (SIRI-279) and also permit to delete\nthe archive once all files are extracted (SIRI-276).\n\nWe also reduced the logging quite a bit (which is still available in debug mode). Also we now\nrequire a destination to be given and no longer use the parent directory of the archive\nas fallback (as this provides quite a potential for trouble).", "committedDate": "2020-11-11T21:15:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkzNjAzOQ==", "url": "https://github.com/scireum/sirius-biz/pull/906#discussion_r521936039", "body": "sourceParameter", "bodyText": "sourceParameter", "bodyHTML": "<p dir=\"auto\">sourceParameter</p>", "author": "mkeckmkeck", "createdAt": "2020-11-12T08:50:49Z", "path": "src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer3;\n+\n+import sirius.biz.jobs.batch.SimpleBatchProcessJobFactory;\n+import sirius.biz.jobs.params.BooleanParameter;\n+import sirius.biz.jobs.params.EnumParameter;\n+import sirius.biz.jobs.params.Parameter;\n+import sirius.biz.process.PersistencePeriod;\n+import sirius.biz.process.ProcessContext;\n+import sirius.biz.process.logs.ProcessLog;\n+import sirius.biz.storage.layer1.FileHandle;\n+import sirius.biz.util.ArchiveExtractor;\n+import sirius.biz.util.ExtractedFile;\n+import sirius.kernel.async.TaskContext;\n+import sirius.kernel.commons.Files;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Watch;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.http.QueryString;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.ArrayList;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Provides a job able to extract archives from the {@link VirtualFileSystem}.\n+ * <p>\n+ * This uses the {@link ArchiveExtractor} so depending if 7-ZIP is enabled this supports either a whole bunch\n+ * of formats (rar, 7z, tar etc.) or \"just\" ZIP files using the Java API.\n+ */\n+@Register\n+public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n+\n+    @Part\n+    private VirtualFileSystem vfs;\n+\n+    @Part\n+    private ArchiveExtractor extractor;\n+\n+    private final Parameter<VirtualFile> sourceParamter;", "originalCommit": "e7b86eafd6eb0de75af377f1160013d81bf7038e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f838bd1258a19e04e28060ea8ba7364a6739fde5", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex 84b2a2f01..4248f0b0a 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -48,7 +48,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n     @Part\n     private ArchiveExtractor extractor;\n \n-    private final Parameter<VirtualFile> sourceParamter;\n+    private final Parameter<VirtualFile> sourceParameter;\n     private final Parameter<VirtualFile> destinationParameter;\n     private final Parameter<ArchiveExtractor.OverrideMode> overwriteExistingFilesParameter;\n     private final Parameter<Boolean> deleteArchiveParameter;\n", "next_change": null}]}, "revised_code_in_main": {"commit": "c22aec824b45e73e12ee8c9e982ae8d83f896f07", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex 84b2a2f01..4248f0b0a 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -48,7 +48,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n     @Part\n     private ArchiveExtractor extractor;\n \n-    private final Parameter<VirtualFile> sourceParamter;\n+    private final Parameter<VirtualFile> sourceParameter;\n     private final Parameter<VirtualFile> destinationParameter;\n     private final Parameter<ArchiveExtractor.OverrideMode> overwriteExistingFilesParameter;\n     private final Parameter<Boolean> deleteArchiveParameter;\n", "next_change": {"commit": "0209cbe88b7c894baba3962d279344aacba1d5e6", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex 4248f0b0a..2a841e07f 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -48,7 +48,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n     @Part\n     private ArchiveExtractor extractor;\n \n-    private final Parameter<VirtualFile> sourceParameter;\n+    private Parameter<VirtualFile> sourceParameter;\n     private final Parameter<VirtualFile> destinationParameter;\n     private final Parameter<ArchiveExtractor.OverrideMode> overwriteExistingFilesParameter;\n     private final Parameter<Boolean> deleteArchiveParameter;\n", "next_change": {"commit": "46acca8f98f7fdc72a704fd9e956e6d66c3c06b8", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex 2a841e07f..09e2f09f0 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -51,6 +51,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n     private Parameter<VirtualFile> sourceParameter;\n     private final Parameter<VirtualFile> destinationParameter;\n     private final Parameter<ArchiveExtractor.OverrideMode> overwriteExistingFilesParameter;\n+    private final Parameter<Boolean> flattenDirectoriesParameter;\n     private final Parameter<Boolean> deleteArchiveParameter;\n \n     /**\n", "next_change": {"commit": "f19e7ccd748e7657b8b0d5ddfb27644b195062f8", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex 09e2f09f0..d7a2585e6 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -60,11 +81,11 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n      * This constructor is primarily used to make the parameter instantiation more readable.\n      */\n     public ExtractArchiveJob() {\n-        this.destinationParameter =\n-                new DirectoryParameter(\"destination\", \"$ExtractArchiveJob.destinationParameter\").withDescription(\n-                        \"$ExtractArchiveJob.destinationParameter.help\").markRequired().build();\n+        this.destinationParameter = new DirectoryParameter(DESTINATION_PARAMETER_NAME,\n+                                                           \"$ExtractArchiveJob.destinationParameter\").withDescription(\n+                \"$ExtractArchiveJob.destinationParameter.help\").markRequired().build();\n \n-        this.overwriteExistingFilesParameter = new EnumParameter<>(\"overwriteExistingFiles\",\n+        this.overwriteExistingFilesParameter = new EnumParameter<>(OVERWRITE_EXISTING_FILES_PARAMETER_NAME,\n                                                                    \"$ExtractArchiveJob.overwriteExistingFilesParameter\",\n                                                                    ArchiveExtractor.OverrideMode.class).withDescription(\n                 \"$ExtractArchiveJob.overwriteExistingFilesParameter.help\")\n", "next_change": {"commit": "4c4b94ecfa8db1db661895d9852725b8c8d1c4b0", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex d7a2585e6..b0c71e701 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -88,7 +88,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n         this.overwriteExistingFilesParameter = new EnumParameter<>(OVERWRITE_EXISTING_FILES_PARAMETER_NAME,\n                                                                    \"$ExtractArchiveJob.overwriteExistingFilesParameter\",\n                                                                    ArchiveExtractor.OverrideMode.class).withDescription(\n-                \"$ExtractArchiveJob.overwriteExistingFilesParameter.help\")\n+                                                                                                               \"$ExtractArchiveJob.overwriteExistingFilesParameter.help\")\n                                                                                                        .withDefault(\n                                                                                                                ArchiveExtractor.OverrideMode.ON_CHANGE)\n                                                                                                        .build();\n", "next_change": {"commit": "57bd759fbf14fbee3c4cee3b0a500fc65039fc9a", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex b0c71e701..f48d803bf 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -88,7 +91,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n         this.overwriteExistingFilesParameter = new EnumParameter<>(OVERWRITE_EXISTING_FILES_PARAMETER_NAME,\n                                                                    \"$ExtractArchiveJob.overwriteExistingFilesParameter\",\n                                                                    ArchiveExtractor.OverrideMode.class).withDescription(\n-                                                                                                               \"$ExtractArchiveJob.overwriteExistingFilesParameter.help\")\n+                \"$ExtractArchiveJob.overwriteExistingFilesParameter.help\")\n                                                                                                        .withDefault(\n                                                                                                                ArchiveExtractor.OverrideMode.ON_CHANGE)\n                                                                                                        .build();\n", "next_change": {"commit": "0493c181eff5d29ae1c9821e26f2c4ba30526b34", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex f48d803bf..8c7c69f89 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n", "chunk": "@@ -91,7 +91,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n         this.overwriteExistingFilesParameter = new EnumParameter<>(OVERWRITE_EXISTING_FILES_PARAMETER_NAME,\n                                                                    \"$ExtractArchiveJob.overwriteExistingFilesParameter\",\n                                                                    ArchiveExtractor.OverrideMode.class).withDescription(\n-                \"$ExtractArchiveJob.overwriteExistingFilesParameter.help\")\n+                                                                                                               \"$ExtractArchiveJob.overwriteExistingFilesParameter.help\")\n                                                                                                        .withDefault(\n                                                                                                                ArchiveExtractor.OverrideMode.ON_CHANGE)\n                                                                                                        .build();\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "c22aec824b45e73e12ee8c9e982ae8d83f896f07", "message": "Merge commit", "committedDate": null}, {"oid": "0209cbe88b7c894baba3962d279344aacba1d5e6", "committedDate": "2020-11-16 15:19:10 +0100", "message": "Lazily initializes a parameter."}, {"oid": "d40dea2a16cff543db1d67763f1042b03bcb5b47", "committedDate": "2020-11-16 15:34:07 +0100", "message": "Uses an appropriate method name."}, {"oid": "46acca8f98f7fdc72a704fd9e956e6d66c3c06b8", "committedDate": "2020-11-23 15:09:59 +0100", "message": "Adds new parameter to ExtractArchiveJob to flatten dirs"}, {"oid": "a6cf244af912ac93c19d90aa2f174c0d3b8aa020", "committedDate": "2020-11-24 15:13:45 +0100", "message": "Simplifies shortening a path."}, {"oid": "f19e7ccd748e7657b8b0d5ddfb27644b195062f8", "committedDate": "2020-11-24 15:14:40 +0100", "message": "Provides a base class to provide a VFSRoot which automatically extracts files into a given destination."}, {"oid": "a04ff38debc50adae43f7e7ad47aa83967a71e48", "committedDate": "2021-03-02 17:13:37 +0100", "message": "Corrects NLS property name to actually see the progress while the extraction of bigger archives happens. Fixes: OX-6245"}, {"oid": "cbb2839370e9d65dc91a043083341092d2544750", "committedDate": "2021-03-07 21:53:07 +0100", "message": "Adds framework references where needed."}, {"oid": "3e0c4dc22070f80f83afcdcf593d3cbf368e18e6", "committedDate": "2021-03-29 10:29:08 +0200", "message": "Removes/ports calls to methods which have been deprecated by sirius-kernel."}, {"oid": "9620f75cc2f11d37b4f4bd18ffec56999340e40f", "committedDate": "2021-06-29 11:53:17 +0200", "message": "Logs and skips 0-byte file in archives"}, {"oid": "05d020648d883656101ca68ea7c351023d5d82f4", "committedDate": "2021-06-29 12:59:35 +0200", "message": "Simplifies logic"}, {"oid": "f1851da67335b48cb67671b7da5168a2171790b8", "committedDate": "2021-07-16 19:10:49 +0200", "message": "Applies sonarlint and IntelliJ inspection fixes."}, {"oid": "4c4b94ecfa8db1db661895d9852725b8c8d1c4b0", "committedDate": "2021-10-13 22:04:59 +0200", "message": "Code cleanup."}, {"oid": "85d72f25a5c1ff1a1772c193a6a1a8e2d172d53a", "committedDate": "2021-11-16 16:02:45 +0100", "message": "No longer creates Extracted7ZFile if the currentBuffer is null. This lead to NPEs before."}, {"oid": "95b21bcf96f4484fd32814895a19a9621c273bbb", "committedDate": "2021-11-16 16:11:29 +0100", "message": "Checks if the file is empty before accessing its fields"}, {"oid": "da7211b004e5569945d8d91846cc68481f235aaf", "committedDate": "2021-11-16 16:13:44 +0100", "message": "Introduces constant (SonarLint)"}, {"oid": "0a1dafbdfc3b8430f3235d2cf1b23b38d5326429", "committedDate": "2021-11-16 16:40:09 +0100", "message": "Passes the timing labels directly to have them translated dynamically"}, {"oid": "57bd759fbf14fbee3c4cee3b0a500fc65039fc9a", "committedDate": "2021-11-18 14:45:33 +0100", "message": "Logs empty files seperated from skipped files when extracting"}, {"oid": "a18159dd24f145090b3e194cadcb998dd603c7ec", "committedDate": "2021-11-19 10:46:40 +0100", "message": "Fixes typo"}, {"oid": "1a12120cec037c8390e8603fc1ca8ec33db3066f", "committedDate": "2022-02-01 12:26:46 +0100", "message": "fix a method callback and a bunch of typos in javadocs"}, {"oid": "0493c181eff5d29ae1c9821e26f2c4ba30526b34", "committedDate": "2022-03-09 18:50:40 +0100", "message": "Code format / JavaDoc typos."}, {"oid": "237474d8c6dabe251ee706da7afb323a93b79abd", "committedDate": "2022-03-09 18:53:32 +0100", "message": "Makes the destination parameter of the ZIP extract job optional."}, {"oid": "922a53a19b08868d0c1d65548ed758f4e79afcc9", "committedDate": "2022-07-29 15:12:12 +0200", "message": "Simplify the file parameters"}, {"oid": "0524ca9396fa67a28aa2661de6d3c4d3155a4a4e", "committedDate": "2022-08-01 17:56:09 +0200", "message": "Fix some fontawesome icons that changed name with update to version 5"}, {"oid": "e18a91973d886db0524b3dce12d43ca3a391b700", "committedDate": "2022-08-04 14:41:46 +0200", "message": "Make the file parameter \"file only\" by default"}, {"oid": "47a7a536d71b837f7c25b70d507461ade260f0b3", "committedDate": "2022-08-25 13:39:11 +0200", "message": "Selects proper categories for jobs provided by SIRIUS."}, {"oid": "4094931a4e08f34f3a7d7b7153edd4ac3c6654c4", "committedDate": "2022-09-01 02:24:24 +0200", "message": "Rename StandardJobCategories -> StandardCategories."}, {"oid": "d62b2ed54053801ae4e95e9324e3ff459f00e0f9", "committedDate": "2022-09-14 23:36:57 +0200", "message": "Properly sorts all provided jobs and charts."}, {"oid": "e7f7f461d70f161d51a609e094757b0e99931f11", "committedDate": "2022-11-22 16:12:55 +0100", "message": "Adds Basepath to ExtractArchiveJob"}]}, {"oid": "26781b29a991845de401bcc27510d029f047a174", "url": "https://github.com/scireum/sirius-biz/commit/26781b29a991845de401bcc27510d029f047a174", "message": "Merge remote-tracking branch 'origin/master' into aha/archive-jobs\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/jobs/batch/file/VirtualFileExtractionJob.java", "committedDate": "2020-11-12T14:52:57Z", "type": "commit"}, {"oid": "f838bd1258a19e04e28060ea8ba7364a6739fde5", "url": "https://github.com/scireum/sirius-biz/commit/f838bd1258a19e04e28060ea8ba7364a6739fde5", "message": "Fixes a typo.", "committedDate": "2020-11-12T14:54:11Z", "type": "commit"}, {"oid": "f693066045e7c968fcabca60d5df6ace8e683d7a", "url": "https://github.com/scireum/sirius-biz/commit/f693066045e7c968fcabca60d5df6ace8e683d7a", "message": "Improves JavaDocs.", "committedDate": "2020-11-12T14:56:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4NTc3Ng==", "url": "https://github.com/scireum/sirius-biz/pull/906#discussion_r522185776", "body": "vfs -> fileSystem?", "bodyText": "vfs -> fileSystem?", "bodyHTML": "<p dir=\"auto\">vfs -&gt; fileSystem?</p>", "author": "sabieber", "createdAt": "2020-11-12T15:19:09Z", "path": "src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java", "diffHunk": "@@ -42,7 +50,48 @@\n      */\n     public static final Parameter<VirtualFile> FILE_PARAMETER = createFileParameter(null);\n \n+    /**\n+     * Determines the mode in which auxiliary files are handled (if this job supports it).\n+     */\n+    public static final Parameter<AuxiliaryFileMode> AUX_FILE_MODE_PARAMETER = new EnumParameter<>(\"auxFileMode\",\n+                                                                                                   \"$FileImportJobFactory.auxFileMode\",\n+                                                                                                   AuxiliaryFileMode.class)\n+            .withDefault(AuxiliaryFileMode.UPDATE_ON_CHANGE)\n+            .markRequired()\n+            .build();\n+\n+    @Part\n+    private static VirtualFileSystem vfs;", "originalCommit": "8016e7777932d2451ef8321f22af211dfe817ac9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex 02bfac384..d8901a275 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -61,7 +61,7 @@ public abstract class FileImportJob extends ImportJob {\n             .build();\n \n     @Part\n-    private static VirtualFileSystem vfs;\n+    private static VirtualFileSystem virtualFileSystem;\n \n     @Part\n     private static ArchiveExtractor extractor;\n", "next_change": null}]}, "revised_code_in_main": {"commit": "c22aec824b45e73e12ee8c9e982ae8d83f896f07", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex 02bfac384..d8901a275 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -61,7 +61,7 @@ public abstract class FileImportJob extends ImportJob {\n             .build();\n \n     @Part\n-    private static VirtualFileSystem vfs;\n+    private static VirtualFileSystem virtualFileSystem;\n \n     @Part\n     private static ArchiveExtractor extractor;\n", "next_change": {"commit": "dfc7ecac33c3d5de8262aa036d3cedad48708de6", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex d8901a275..29ed38d08 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -60,6 +61,14 @@ public abstract class FileImportJob extends ImportJob {\n             .markRequired()\n             .build();\n \n+    /**\n+     * Determines if auxiliary files are extracted including directories (if this job supports it).\n+     */\n+    public static final Parameter<Boolean> AUX_FILE_FLATTEN_DIRS_PARAMETER = new BooleanParameter(\"auxFileFlattenDirs\",\n+                                                                                                  \"$FileImportJobFactory.auxFileFlattenDirectoriesParameter\")\n+            .withDescription(\"$FileImportJobFactory.auxFileFlattenDirectoriesParameter.help\")\n+            .build();\n+\n     @Part\n     private static VirtualFileSystem virtualFileSystem;\n \n", "next_change": {"commit": "b681057d1799b3b8767912f7e1f3d441c856d86f", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex 29ed38d08..ce88cb1fa 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -56,18 +59,23 @@ public abstract class FileImportJob extends ImportJob {\n      */\n     public static final Parameter<AuxiliaryFileMode> AUX_FILE_MODE_PARAMETER = new EnumParameter<>(\"auxFileMode\",\n                                                                                                    \"$FileImportJobFactory.auxFileMode\",\n-                                                                                                   AuxiliaryFileMode.class)\n-            .withDefault(AuxiliaryFileMode.UPDATE_ON_CHANGE)\n-            .markRequired()\n-            .build();\n+                                                                                                   AuxiliaryFileMode.class).withDefault(\n+            AuxiliaryFileMode.UPDATE_ON_CHANGE).markRequired().build();\n \n     /**\n      * Determines if auxiliary files are extracted including directories (if this job supports it).\n      */\n     public static final Parameter<Boolean> AUX_FILE_FLATTEN_DIRS_PARAMETER = new BooleanParameter(\"auxFileFlattenDirs\",\n-                                                                                                  \"$FileImportJobFactory.auxFileFlattenDirectoriesParameter\")\n-            .withDescription(\"$FileImportJobFactory.auxFileFlattenDirectoriesParameter.help\")\n-            .build();\n+                                                                                                  \"$FileImportJobFactory.auxFileFlattenDirectoriesParameter\").withDescription(\n+            \"$FileImportJobFactory.auxFileFlattenDirectoriesParameter.help\").build();\n+\n+    /**\n+     * Defines a parent directory path where auxiliary files will be uploaded (if this job supports it).\n+     */\n+    public static final Parameter<String> AUX_FILE_PARENT_DIRECTORY_PARAMETER = new StringParameter(\n+            \"auxFileParentDirectory\",\n+            \"$FileImportJobFactory.auxFileParentDirectory\").withDescription(\n+            \"$FileImportJobFactory.auxFileParentDirectory.help\").build();\n \n     @Part\n     private static VirtualFileSystem virtualFileSystem;\n", "next_change": {"commit": "d539bf6c3ddf9fa183904bda45afc04cd4cc4f0a", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex ce88cb1fa..fccff47bb 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -80,6 +81,9 @@ public abstract class FileImportJob extends ImportJob {\n     @Part\n     private static VirtualFileSystem virtualFileSystem;\n \n+    @Part\n+    private static StorageUtils storageUtils;\n+\n     @Part\n     private static ArchiveExtractor extractor;\n \n", "next_change": null}]}}]}}, {"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex d8901a275..29ed38d08 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -69,6 +78,7 @@ public abstract class FileImportJob extends ImportJob {\n     protected FileParameter fileParameter;\n     protected ValueHolder<VirtualFile> auxFilesDestination;\n     protected AuxiliaryFileMode auxiliaryFileMode;\n+    protected boolean flattenAuxiliaryFileDirs;\n \n     /**\n      * Defines the modes in which an auxiliary file in an archive can be handled.\n", "next_change": {"commit": "f0f87a35bac4560a0ee7822cd629ad6e0c1026fd", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex 29ed38d08..aedf84016 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -79,6 +81,7 @@ public abstract class FileImportJob extends ImportJob {\n     protected ValueHolder<VirtualFile> auxFilesDestination;\n     protected AuxiliaryFileMode auxiliaryFileMode;\n     protected boolean flattenAuxiliaryFileDirs;\n+    protected boolean suppressFileNameInContext;\n \n     /**\n      * Defines the modes in which an auxiliary file in an archive can be handled.\n", "next_change": {"commit": "d539bf6c3ddf9fa183904bda45afc04cd4cc4f0a", "changed_code": [{"header": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex aedf84016..fccff47bb 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n", "chunk": "@@ -82,6 +92,7 @@ public abstract class FileImportJob extends ImportJob {\n     protected AuxiliaryFileMode auxiliaryFileMode;\n     protected boolean flattenAuxiliaryFileDirs;\n     protected boolean suppressFileNameInContext;\n+    protected String auxFilesParentDirectory;\n \n     /**\n      * Defines the modes in which an auxiliary file in an archive can be handled.\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "c22aec824b45e73e12ee8c9e982ae8d83f896f07", "message": "Merge commit", "committedDate": null}, {"oid": "dfc7ecac33c3d5de8262aa036d3cedad48708de6", "committedDate": "2020-11-30 15:23:28 +0100", "message": "Adds the option to flatten auxilary files and adds missing texts"}, {"oid": "ebba84a8f7a98e1d0a7fdc44d8fa661f79ccf530", "committedDate": "2021-04-14 13:54:14 +0200", "message": "Adds a helper method to retrieve the current file being imported from an archive"}, {"oid": "072fe1f05afc4c0d418bdb6afaecfae538a86cca", "committedDate": "2021-04-14 14:18:36 +0200", "message": "Provides a way to define specific archive entries to process"}, {"oid": "6e0ea8f139fc42bfdbb9ae4794de546573f5338f", "committedDate": "2021-04-14 14:19:39 +0200", "message": "Adds a constant used in a few log calls"}, {"oid": "f43c89482d150835ba68b712d606213c6ceaeaa3", "committedDate": "2021-04-15 18:17:01 +0200", "message": "Stops processing entries if the job is not active"}, {"oid": "2609ca47f65dd4ccb720c744e3761467c00f2aa9", "committedDate": "2021-04-15 18:46:13 +0200", "message": "Imports auxiliary files when using entry filters"}, {"oid": "8f63cfa9a33a0cb5b0b4312fce9509bbd8621bf2", "committedDate": "2021-04-16 13:56:41 +0200", "message": "Refactors getCurrentFileName to getCurrentEntry"}, {"oid": "07809b3b0f566e6a8966f81c79cbcbcfd2c003dc", "committedDate": "2021-04-19 11:43:44 +0200", "message": "Simplifies the usage of the API"}, {"oid": "edd45ae6b23e94ea11a637c5291defaad32f0ba2", "committedDate": "2021-04-28 17:54:56 +0200", "message": "Allows the same file to be loaded multiple times"}, {"oid": "c7c739a1fb555d7d66107fff6e60cebf8285e01d", "committedDate": "2021-04-28 18:16:37 +0200", "message": "Adds a convenience method to determine the  pass count of the current entry"}, {"oid": "d0664122e28aec416ff072f3e3cf6a50756ddd88", "committedDate": "2021-04-28 18:18:20 +0200", "message": "Renames variables"}, {"oid": "0eae4b31c1b47eb6375e426de84200220ac96aba", "committedDate": "2021-05-01 15:57:39 +0200", "message": "BREAKING CHANGE: Move import complexity out of FileImportJob."}, {"oid": "3be4d2604c1817a4fd9567ed03ced093a40164c7", "committedDate": "2021-05-03 10:14:45 +0200", "message": "Extract and handle auxiliary files before files actually handled by the job"}, {"oid": "8e02b6358be6b227782733937982f1e8e9257032", "committedDate": "2021-05-05 15:30:39 +0200", "message": "Passes missing context to error message"}, {"oid": "9057fd787d4c20ce35fad77f3e35177a49f667a2", "committedDate": "2021-07-08 11:22:55 +0200", "message": "Provides an ErrorContext which permits to create more concise error messages."}, {"oid": "f0f87a35bac4560a0ee7822cd629ad6e0c1026fd", "committedDate": "2021-07-13 16:33:55 +0200", "message": "Permits to suppress the file name from error context"}, {"oid": "b681057d1799b3b8767912f7e1f3d441c856d86f", "committedDate": "2022-01-26 17:49:26 +0100", "message": "Permits to define a parent directory(ies) to receive additional files"}, {"oid": "d539bf6c3ddf9fa183904bda45afc04cd4cc4f0a", "committedDate": "2022-01-26 17:59:44 +0100", "message": "Considers the parent directory as target for auxiliary files"}, {"oid": "1146aefd1f0791e2082323247525251f043e5ad0", "committedDate": "2022-01-26 18:21:15 +0100", "message": "Ignores the parent directory if they match the source path"}, {"oid": "30e16526682217d3102a2a1f3a1c69ea4f2e82ee", "committedDate": "2022-01-27 09:29:21 +0100", "message": "Applies PR review comments"}, {"oid": "32d1410450945665fb145dac6a3f00d0eb4e040b", "committedDate": "2022-01-27 10:24:01 +0100", "message": "Fixes typos"}, {"oid": "801f196e94b3a7fde23163b122ad39c8b34f54a7", "committedDate": "2022-01-27 11:21:21 +0100", "message": "Solves an NPE when not using the parameter"}, {"oid": "922a53a19b08868d0c1d65548ed758f4e79afcc9", "committedDate": "2022-07-29 15:12:12 +0200", "message": "Simplify the file parameters"}, {"oid": "1325eb29d49c29c532c25c6fec6f08c8114043aa", "committedDate": "2023-01-28 13:01:32 +0100", "message": "Properly obtains and uses the ErrorContext."}, {"oid": "7d5201d6605323054c1ab7255af88b00de698161", "committedDate": "2023-01-28 13:07:19 +0100", "message": "Merge remote-tracking branch 'origin/develop' into feature/aha/import-improvments"}, {"oid": "401d8fc08c9f34fd419ff0a4ce7f2b722504d6fa", "committedDate": "2023-01-28 20:47:42 +0100", "message": "Fixes a JavaDoc typo"}, {"oid": "186e55f87216bb6ea05990ac1f9f3dccbf2f44a6", "committedDate": "2023-01-28 20:56:24 +0100", "message": "Properly shows and hides dependent parameters."}, {"oid": "b558a1b8ef034e7572325bcaf66f1bc373721c95", "committedDate": "2023-01-31 11:27:46 +0100", "message": "Hides auxillary Files Parameter if no zip file is present"}, {"oid": "086b1b6fa146fc9924e11185e5ea8b808a9c11eb", "committedDate": "2023-01-31 11:55:11 +0100", "message": "Checks for all archives, not only zip"}, {"oid": "f46c7e3ceec57379ed17d2ad82fabda25a3c6ff5", "committedDate": "2023-02-06 11:16:32 +0100", "message": "Merge remote-tracking branch 'origin/develop' into feature/aha/spring-break"}, {"oid": "af5571da36d6e891abb050c7967ddbca0df676b6", "committedDate": "2023-02-13 16:59:03 +0100", "message": "Removes unused variable"}, {"oid": "a82de6b12968a15140993c12a7b3c45e8d200b87", "committedDate": "2023-02-13 18:10:52 +0100", "message": "Add a description to the file parameter"}, {"oid": "57be31ef19f04b0aeed8f24af3002e8c015c1c3b", "committedDate": "2023-02-14 10:33:05 +0100", "message": "Adds a description to the aux file parameter"}, {"oid": "be786f48d49b2f6b5f0bcab48304e1aedb33535d", "committedDate": "2023-02-14 11:23:22 +0100", "message": "Annotates parameter as nullable"}, {"oid": "5d89034ccb6b8e68fedc7e9c3c79a3552c2f3a3f", "committedDate": "2023-02-16 21:11:47 +0100", "message": "Merge branch 'develop' into feature/aha/spring-break"}]}, {"oid": "98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "url": "https://github.com/scireum/sirius-biz/commit/98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "message": "Code style.", "committedDate": "2020-11-12T15:35:04Z", "type": "commit"}]}