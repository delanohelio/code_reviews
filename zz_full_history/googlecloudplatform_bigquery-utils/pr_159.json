{"pr_number": 159, "pr_title": "Auto Query Fixer: Implement the fixers for syntax errors", "pr_author": "mingen-pan", "pr_createdAt": "2020-08-21T19:23:05Z", "pr_url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159", "timeline": [{"oid": "b8f031dac491be271cf668e7b232629161167afa", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b8f031dac491be271cf668e7b232629161167afa", "message": "Implement the fixers for syntax errors", "committedDate": "2020-08-21T19:18:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0NzE4Ng==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r476647186", "body": "'Insert'? ", "bodyText": "'Insert'?", "bodyHTML": "<p dir=\"auto\">'Insert'?</p>", "author": "kikkyo", "createdAt": "2020-08-25T18:17:34Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/ExpectKeywordButGotOthersFixer.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package com.google.cloud.bigquery.utils.queryfixer.fixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixOption;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixResult;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.Position;\n+import com.google.cloud.bigquery.utils.queryfixer.errors.ExpectKeywordButGotOthersError;\n+import com.google.cloud.bigquery.utils.queryfixer.tokenizer.QueryTokenProcessor;\n+import com.google.cloud.bigquery.utils.queryfixer.util.StringUtil;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * A class to fix {@link ExpectKeywordButGotOthersError}. If the expected token is a keyword, then\n+ * the fixer will either (1) replace a token near the error position that is similar to the expected\n+ * keyword to the expected one, or (2) insert the expected keyword at the error location.\n+ *\n+ * <p>Here is a BigQuery query with this error:\n+ *\n+ * <pre>\n+ *     Select max(col1) from table group col2\n+ * </pre>\n+ *\n+ * The error message is \"Syntax error: Expected keyword BY but got identifier \"col2\" at [1:34]\".\n+ * Thus, the fixer will insert a BY keyword at this error position, which looks like\n+ *\n+ * <pre>\n+ *     Select max(col1) from table group BY col2\n+ * </pre>\n+ */\n+public class ExpectKeywordButGotOthersFixer implements IFixer {\n+\n+  private final String query;\n+  private final ExpectKeywordButGotOthersError err;\n+  private final QueryTokenProcessor queryTokenProcessor;\n+\n+  // TODO: it could be configured by users in future.\n+  private static final double SIMILARITY_THRESHOLD = 0.5;\n+\n+  public ExpectKeywordButGotOthersFixer(\n+          String query, ExpectKeywordButGotOthersError err, QueryTokenProcessor queryTokenProcessor) {\n+    this.query = query;\n+    this.err = err;\n+    this.queryTokenProcessor = queryTokenProcessor;\n+  }\n+\n+  @Override\n+  public FixResult fix() {\n+    Position errorPosition = err.getErrorPosition();\n+    IToken token =\n+        queryTokenProcessor.getTokenAt(query, errorPosition.getRow(), errorPosition.getColumn());\n+\n+    List<FixOption> fixOptions = new ArrayList<>();\n+    if (isTokenSimilarAsExpectedKeyword(token)) {\n+      fixOptions.add(replaceToken(token));\n+    }\n+    fixOptions.add(insertKeyword(token));\n+\n+    String approach =\n+        String.format(\"Put keyword %s at the error position\", err.getExpectedKeyword());", "originalCommit": "b8f031dac491be271cf668e7b232629161167afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4Mjk0Nw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r477482947", "bodyText": "Done", "author": "mingen-pan", "createdAt": "2020-08-26T17:53:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0NzE4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "361b16571ca4236a3e55db851447695bdea9a737", "changed_code": [{"header": "diff --git a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/ExpectKeywordButGotOthersFixer.java b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/ExpectKeywordButGotOthersFixer.java\nindex 3aa56ad..b76a6bb 100644\n--- a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/ExpectKeywordButGotOthersFixer.java\n+++ b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/ExpectKeywordButGotOthersFixer.java\n", "chunk": "@@ -58,7 +58,7 @@ public class ExpectKeywordButGotOthersFixer implements IFixer {\n     fixOptions.add(insertKeyword(token));\n \n     String approach =\n-        String.format(\"Put keyword %s at the error position\", err.getExpectedKeyword());\n+        String.format(\"Insert keyword %s at the error position\", err.getExpectedKeyword());\n     return FixResult.success(query, approach, fixOptions, err, /*isConfident=*/ true);\n   }\n \n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0ODAxNg==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r476648016", "body": "nit: The", "bodyText": "nit: The", "bodyHTML": "<p dir=\"auto\">nit: The</p>", "author": "kikkyo", "createdAt": "2020-08-25T18:19:03Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java", "diffHunk": "@@ -39,6 +36,29 @@ public IFixer getFixer(String query, BigQuerySqlError error) {\n       return new FunctionNotFoundFixer(query, functionError, queryTokenProcessor);\n     }\n \n+    if (error instanceof UnexpectedKeywordError) {\n+      return new UnexpectedKeywordFixer(query, (UnexpectedKeywordError) error, queryTokenProcessor);\n+    }\n+\n+    if (error instanceof IllegalInputCharacterError) {\n+      return new IllegalInputCharacterFixer(query, (IllegalInputCharacterError) error);\n+    }\n+\n+    if (error instanceof ExpectKeywordButGotOthersError) {\n+      ExpectKeywordButGotOthersError expectKeywordError = (ExpectKeywordButGotOthersError) error;\n+\n+      // the parser probably expects multiple keywords, but the error messages only provide the last", "originalCommit": "b8f031dac491be271cf668e7b232629161167afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4MzgzOA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r477483838", "bodyText": "Done", "author": "mingen-pan", "createdAt": "2020-08-26T17:55:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0ODAxNg=="}], "type": "inlineReview", "revised_code": {"commit": "03470f43aa5351484342c457d3fc657289a495fc", "changed_code": [{"header": "diff --git a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\nindex 23b36db..5103e4d 100644\n--- a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\n+++ b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\n", "chunk": "@@ -36,29 +40,6 @@ public class FixerFactory {\n       return new FunctionNotFoundFixer(query, functionError, queryTokenProcessor);\n     }\n \n-    if (error instanceof UnexpectedKeywordError) {\n-      return new UnexpectedKeywordFixer(query, (UnexpectedKeywordError) error, queryTokenProcessor);\n-    }\n-\n-    if (error instanceof IllegalInputCharacterError) {\n-      return new IllegalInputCharacterFixer(query, (IllegalInputCharacterError) error);\n-    }\n-\n-    if (error instanceof ExpectKeywordButGotOthersError) {\n-      ExpectKeywordButGotOthersError expectKeywordError = (ExpectKeywordButGotOthersError) error;\n-\n-      // the parser probably expects multiple keywords, but the error messages only provide the last\n-      // option, which usually is END_OF_INPUT. Therefore, if this happens, we can only search near\n-      // the error position and see if an identifier may be converted to a keyword.\n-      if (ExpectKeywordButGotOthersError.END_OF_INPUT.equals(\n-          expectKeywordError.getExpectedKeyword())) {\n-\n-        return new NearbyTokenFixer(query, expectKeywordError, queryTokenProcessor);\n-      }\n-\n-      return new ExpectKeywordButGotOthersFixer(query, expectKeywordError, queryTokenProcessor);\n-    }\n-\n     return null;\n   }\n }\n", "next_change": {"commit": "361b16571ca4236a3e55db851447695bdea9a737", "changed_code": [{"header": "diff --git a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\nindex 5103e4d..5a63d86 100644\n--- a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\n+++ b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\n", "chunk": "@@ -40,6 +37,29 @@ public class FixerFactory {\n       return new FunctionNotFoundFixer(query, functionError, queryTokenProcessor);\n     }\n \n+    if (error instanceof UnexpectedKeywordError) {\n+      return new UnexpectedKeywordFixer(query, (UnexpectedKeywordError) error, queryTokenProcessor);\n+    }\n+\n+    if (error instanceof IllegalInputCharacterError) {\n+      return new IllegalInputCharacterFixer(query, (IllegalInputCharacterError) error);\n+    }\n+\n+    if (error instanceof ExpectKeywordButGotOthersError) {\n+      ExpectKeywordButGotOthersError expectKeywordError = (ExpectKeywordButGotOthersError) error;\n+\n+      // The parser probably expects multiple keywords, but the error messages only provide the last\n+      // option, which usually is END_OF_INPUT. Therefore, if this happens, we can only search near\n+      // the error position and see if an identifier may be converted to a keyword.\n+      if (ExpectKeywordButGotOthersError.END_OF_INPUT.equals(\n+          expectKeywordError.getExpectedKeyword())) {\n+\n+        return new NearbyTokenFixer(query, expectKeywordError, queryTokenProcessor);\n+      }\n+\n+      return new ExpectKeywordButGotOthersFixer(query, expectKeywordError, queryTokenProcessor);\n+    }\n+\n     return null;\n   }\n }\n", "next_change": {"commit": "46983f49381e0283e7404701b0d60ad0b03f45c7", "changed_code": [{"header": "diff --git a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\nindex 5a63d86..54a972d 100644\n--- a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\n+++ b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/FixerFactory.java\n", "chunk": "@@ -60,6 +65,14 @@ public class FixerFactory {\n       return new ExpectKeywordButGotOthersFixer(query, expectKeywordError, queryTokenProcessor);\n     }\n \n+    if (error instanceof DuplicateColumnsError) {\n+      return new DuplicateColumnsFixer(query, (DuplicateColumnsError) error);\n+    }\n+\n+    if (error instanceof ColumnNotGroupedError) {\n+      return new ColumnNotGroupedFixer(query, (ColumnNotGroupedError) error);\n+    }\n+\n     return null;\n   }\n }\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0OTk0NA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r476649944", "body": "'anc' -> 'and'", "bodyText": "'anc' -> 'and'", "bodyHTML": "<p dir=\"auto\">'anc' -&gt; 'and'</p>", "author": "kikkyo", "createdAt": "2020-08-25T18:22:35Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package com.google.cloud.bigquery.utils.queryfixer.fixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixOption;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixResult;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.Position;\n+import com.google.cloud.bigquery.utils.queryfixer.errors.ExpectKeywordButGotOthersError;\n+import com.google.cloud.bigquery.utils.queryfixer.tokenizer.QueryTokenProcessor;\n+import com.google.cloud.bigquery.utils.queryfixer.util.StringUtil;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A class to fix general syntax errors. Usually, a general syntax error looks like {@link\n+ * ExpectKeywordButGotOthersError} but expects \"end of input\". It basically means there may be\n+ * multiple expected tokens but the error message cannot recognize them, so the fixer will try to\n+ * see if the tokens near the error position are similar to any keywords. If yes, then replace the\n+ * token to the similar keyword anc check if the error is eliminated from the query.", "originalCommit": "b8f031dac491be271cf668e7b232629161167afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4Mzg3OA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r477483878", "bodyText": "Done", "author": "mingen-pan", "createdAt": "2020-08-26T17:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0OTk0NA=="}], "type": "inlineReview", "revised_code": {"commit": "361b16571ca4236a3e55db851447695bdea9a737", "changed_code": [{"header": "diff --git a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java\nindex 4335ef9..1d860f6 100644\n--- a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java\n+++ b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java\n", "chunk": "@@ -18,7 +18,7 @@ import java.util.stream.Collectors;\n  * ExpectKeywordButGotOthersError} but expects \"end of input\". It basically means there may be\n  * multiple expected tokens but the error message cannot recognize them, so the fixer will try to\n  * see if the tokens near the error position are similar to any keywords. If yes, then replace the\n- * token to the similar keyword anc check if the error is eliminated from the query.\n+ * token to the similar keyword and check if the error is eliminated from the query.\n  *\n  * <p>Here is an example with an input query:\n  *\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1NDk1Ng==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r476654956", "body": "Do we have a use case where this would be confident? where left edit distance = right distance and use both of them? ", "bodyText": "Do we have a use case where this would be confident? where left edit distance = right distance and use both of them?", "bodyHTML": "<p dir=\"auto\">Do we have a use case where this would be confident? where left edit distance = right distance and use both of them?</p>", "author": "kikkyo", "createdAt": "2020-08-25T18:31:28Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package com.google.cloud.bigquery.utils.queryfixer.fixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixOption;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixResult;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.Position;\n+import com.google.cloud.bigquery.utils.queryfixer.errors.ExpectKeywordButGotOthersError;\n+import com.google.cloud.bigquery.utils.queryfixer.tokenizer.QueryTokenProcessor;\n+import com.google.cloud.bigquery.utils.queryfixer.util.StringUtil;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A class to fix general syntax errors. Usually, a general syntax error looks like {@link\n+ * ExpectKeywordButGotOthersError} but expects \"end of input\". It basically means there may be\n+ * multiple expected tokens but the error message cannot recognize them, so the fixer will try to\n+ * see if the tokens near the error position are similar to any keywords. If yes, then replace the\n+ * token to the similar keyword anc check if the error is eliminated from the query.\n+ *\n+ * <p>Here is an example with an input query:\n+ *\n+ * <pre>\n+ *     SELECT status FORM `bigquery-public-data.austin_311.311_request` LIMIT 10\n+ * </pre>\n+ *\n+ * It causes an error \"Syntax error: Expected end of input but got identifier `...` at [1:20]\". The\n+ * fixer will look around this position and find FORM looks like a keyword FROM and convert it to\n+ * FROM, leading to a new query\n+ *\n+ * <pre>\n+ *     SELECT status FROM `bigquery-public-data.austin_311.311_request` LIMIT 10\n+ * </pre>\n+ */\n+public class NearbyTokenFixer implements IFixer {\n+\n+  private final String query;\n+  private final ExpectKeywordButGotOthersError err;\n+  private final QueryTokenProcessor queryTokenProcessor;\n+  private final List<String> keywords;\n+\n+  // TODO: it could be configured by users in future.\n+  private static final double SIMILARITY_THRESHOLD = 0.5;\n+\n+  public NearbyTokenFixer(\n+      String query, ExpectKeywordButGotOthersError err, QueryTokenProcessor queryTokenProcessor) {\n+    this.query = query;\n+    this.err = err;\n+    this.queryTokenProcessor = queryTokenProcessor;\n+    this.keywords = getAllKeywords();\n+  }\n+\n+  @Override\n+  public FixResult fix() {\n+\n+    Position errorPosition = err.getErrorPosition();\n+    Pair<IToken, IToken> tokens =\n+        queryTokenProcessor.getNearbyTokens(\n+            query, errorPosition.getRow(), errorPosition.getColumn());\n+\n+    StringUtil.SimilarStrings rightTokenSimilarStrings = findSimilarKeywords(tokens.getRight());\n+    StringUtil.SimilarStrings leftTokenSimilarStrings = findSimilarKeywords(tokens.getLeft());\n+\n+    // The overall logic below is that if left token has a more similar (measured by\n+    // edit distance) keyword, then only choose the fixes on left tokens. If right token\n+    // has more similar keywords, choose the fixes on right tokens. If both of them have\n+    // the similar keywords with the same edit distance, then choose both of them.", "originalCommit": "b8f031dac491be271cf668e7b232629161167afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NDU2NQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/159#discussion_r477484565", "bodyText": "I think it is hard to consider them as confident, because we are guessing the correct keywords rather than inferring one from the error message.", "author": "mingen-pan", "createdAt": "2020-08-26T17:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1NDk1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ed5ef325a22f2be64929524e52c654981cd8fea7", "changed_code": [{"header": "diff --git a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java\nindex 4335ef9..4efa07a 100644\n--- a/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java\n+++ b/tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/NearbyTokenFixer.java\n", "chunk": "@@ -60,77 +74,97 @@ public class NearbyTokenFixer implements IFixer {\n         queryTokenProcessor.getNearbyTokens(\n             query, errorPosition.getRow(), errorPosition.getColumn());\n \n-    StringUtil.SimilarStrings rightTokenSimilarStrings = findSimilarKeywords(tokens.getRight());\n-    StringUtil.SimilarStrings leftTokenSimilarStrings = findSimilarKeywords(tokens.getLeft());\n+    // Find the similar keywords that can replace the right token.\n+    List<String> rightTokenKeywords = findSimilarKeywords(tokens.getRight());\n+    List<FixOption> options =\n+        filterKeywordsAndToFixOptions(\n+            tokens.getRight(), rightTokenKeywords, /*offsetErrorPosition=*/ false);\n+\n+    // Find the similar keywords that can replace the left token.\n+    List<String> leftTokenKeywords = findSimilarKeywords(tokens.getLeft());\n+    List<FixOption> leftTokenOptions =\n+        filterKeywordsAndToFixOptions(\n+            tokens.getLeft(), leftTokenKeywords, /*offsetErrorPosition=*/ true);\n \n-    // The overall logic below is that if left token has a more similar (measured by\n-    // edit distance) keyword, then only choose the fixes on left tokens. If right token\n-    // has more similar keywords, choose the fixes on right tokens. If both of them have\n-    // the similar keywords with the same edit distance, then choose both of them.\n-    // Otherwise, if neither of them have any similar keywords, then return FAILURE FixResult.\n-    if (leftTokenSimilarStrings.isEmpty() && rightTokenSimilarStrings.isEmpty()) {\n+    options.addAll(leftTokenOptions);\n+\n+    if (options.isEmpty()) {\n       return FixResult.failure(query, err);\n     }\n \n-    if (rightTokenSimilarStrings.isEmpty()) {\n-      List<FixOption> options = toFixOptions(tokens.getLeft(), leftTokenSimilarStrings);\n-      String approach = String.format(\"Replace `%s`.\", tokens.getLeft());\n-      return FixResult.success(query, approach, options, err, /*isConfident=*/ false);\n-    }\n+    String approach = String.format(\"Replace `%s` or `%s`\", tokens.getLeft(), tokens.getRight());\n+    return FixResult.success(query, approach, options, err, /*isConfident=*/ false);\n+  }\n+\n+  private List<String> getAllKeywords() {\n+    return ZetaSqlHelper.getAllKeywords();\n+  }\n \n-    if (leftTokenSimilarStrings.isEmpty()) {\n-      List<FixOption> options = toFixOptions(tokens.getRight(), rightTokenSimilarStrings);\n-      String approach = String.format(\"Replace `%s`.\", tokens.getRight());\n-      return FixResult.success(query, approach, options, err, /*isConfident=*/ false);\n+  private List<String> findSimilarKeywords(IToken token) {\n+    if (token == null) {\n+      return Collections.emptyList();\n     }\n \n-    if (rightTokenSimilarStrings.getDistance() > leftTokenSimilarStrings.getDistance()) {\n-      List<FixOption> options = toFixOptions(tokens.getLeft(), leftTokenSimilarStrings);\n-      String approach = String.format(\"Replace `%s`.\", tokens.getLeft());\n-      return FixResult.success(query, approach, options, err, /*isConfident=*/ false);\n+    int tokenSize = token.getImage().length();\n+    int maxEditDistance = (int) Math.ceil(SIMILARITY_THRESHOLD * tokenSize);\n+    return StringUtil.findSimilarWords(\n+        KEYWORDS, token.getImage(), maxEditDistance, /*caseSensitive=*/ false);\n+  }\n+\n+  private FixOption toFixOption(IToken token, String keyword, String fixedQuery) {\n+    String action = String.format(\"%s => %s\", token.getImage(), keyword);\n+    return FixOption.of(action, fixedQuery);\n+  }\n+\n+  private Position dryRun_getErrorPosition(String query) {\n+    BigQueryException exception = bigQueryService.catchExceptionFromDryRun(query);\n+    if (exception == null) {\n+      return null;\n     }\n \n-    if (rightTokenSimilarStrings.getDistance() < leftTokenSimilarStrings.getDistance()) {\n-      List<FixOption> options = toFixOptions(tokens.getRight(), rightTokenSimilarStrings);\n-      String approach = String.format(\"Replace `%s`.\", tokens.getRight());\n-      return FixResult.success(query, approach, options, err, /*isConfident=*/ false);\n+    // Syntax error must have error position. If an error does not contain position, it must be\n+    // semantic error.\n+    List<String> contents =\n+        PatternMatcher.extract(exception.getMessage(), \" (\\\\[[0-9]+\\\\:[0-9]+\\\\])$\");\n+    if (contents == null) {\n+      return null;\n     }\n \n-    List<FixOption> options = toFixOptions(tokens.getRight(), rightTokenSimilarStrings);\n-    options.addAll(toFixOptions(tokens.getLeft(), leftTokenSimilarStrings));\n-    String approach = String.format(\"Replace `%s` or `%s`.\", tokens.getLeft(), tokens.getRight());\n-    return FixResult.success(query, approach, options, err, /*isConfident=*/ false);\n+    return PatternMatcher.extractPosition(contents.get(0));\n   }\n \n-  private List<String> getAllKeywords() {\n-    // TODO: needs to implement actual log when the ZetaSQL Helper is updated.\n-    return ImmutableList.of(\"SELECT\", \"FROM\");\n-  }\n+  private boolean isErrorMovedForward(String query, int columnOffset) {\n+    Position position = dryRun_getErrorPosition(query);\n+    if (position == null) {\n+      return true;\n+    }\n \n-  private StringUtil.SimilarStrings findSimilarKeywords(IToken token) {\n-    if (token == null) {\n-      return StringUtil.SimilarStrings.empty();\n+    if (position.getRow() > err.getErrorPosition().getRow()) {\n+      return true;\n+    }\n+    if (position.getRow() < err.getErrorPosition().getRow()) {\n+      return false;\n     }\n-    // TODO: only consider the identifier token. This logic will be implemented when #155 is merged.\n \n-    StringUtil.SimilarStrings similarStrings =\n-        StringUtil.findSimilarWords(keywords, token.getImage(), /*caseSensitive=*/ false);\n+    return position.getColumn() > err.getErrorPosition().getColumn() + columnOffset;\n+  }\n \n-    int tokenSize = token.getImage().length();\n-    if (1.0 * similarStrings.getDistance() / tokenSize > SIMILARITY_THRESHOLD) {\n-      return StringUtil.SimilarStrings.empty();\n+  /**\n+   * Filter similar keywords by checking if replacing to a similar keyword can eliminate the error\n+   * or at least make the error position move forward.\n+   */\n+  private List<FixOption> filterKeywordsAndToFixOptions(\n+      IToken token, List<String> keywords, boolean offsetErrorPosition) {\n+    List<FixOption> fixOptions = new ArrayList<>();\n+    for (String keyword : keywords) {\n+      String modifiedQuery = queryTokenProcessor.replaceToken(query, token, keyword);\n+      int offset = offsetErrorPosition ? keyword.length() - token.getImage().length() : 0;\n+\n+      if (isErrorMovedForward(modifiedQuery, offset)) {\n+        fixOptions.add(toFixOption(token, keyword, modifiedQuery));\n+      }\n     }\n-    return similarStrings;\n-  }\n \n-  private List<FixOption> toFixOptions(IToken token, StringUtil.SimilarStrings similarStrings) {\n-    return similarStrings.getStrings().stream()\n-        .map(\n-            word -> {\n-              String action = String.format(\"%s => %s\", token.getImage(), word);\n-              String modifiedQuery = queryTokenProcessor.replaceToken(query, token, word);\n-              return FixOption.of(action, modifiedQuery);\n-            })\n-        .collect(Collectors.toList());\n+    return fixOptions;\n   }\n }\n", "next_change": null}]}}, {"oid": "3cddc76415db4d15f5bbdbe8430bb2961506219e", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/3cddc76415db4d15f5bbdbe8430bb2961506219e", "message": "Minor fix", "committedDate": "2020-08-26T18:05:46Z", "type": "commit"}, {"oid": "25752b1fecda94fdf832114990d232b624d25190", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/25752b1fecda94fdf832114990d232b624d25190", "message": "Merge branch 'master' into add_syntax_fixer", "committedDate": "2020-08-26T18:08:48Z", "type": "commit"}]}