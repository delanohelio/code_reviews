{"pr_number": 218, "pr_title": "Faster startup time", "pr_author": "RickHawesUSDS", "pr_createdAt": "2020-02-13T13:02:02Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218", "timeline": [{"oid": "310cbe31149ad97b921b81d32c29aa40d9b269bf", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/310cbe31149ad97b921b81d32c29aa40d9b269bf", "message": "Faster startup time\n\nInstead of calling refreshFilters, just set transactionTime during init time. RefreshFilters will happen periodically in the background.", "committedDate": "2020-02-13T12:59:29Z", "type": "commit"}, {"oid": "740f25758f479826c5576ee1460ef7fcdc663bda", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/740f25758f479826c5576ee1460ef7fcdc663bda", "message": "Fixup the set method", "committedDate": "2020-02-13T13:24:18Z", "type": "commit"}, {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "message": "Readability of BEFORE_LAST_UPDATE_FEATURE", "committedDate": "2020-02-13T13:38:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378971883", "body": "If I'm not mistaken the parameters have changed but the general logic behind this statement has not correct?  I ask because currently in the test environment this is logging every second and causing logs to fill up quite a bit.\r\n\r\nCould this be changed to a debug level?", "bodyText": "If I'm not mistaken the parameters have changed but the general logic behind this statement has not correct?  I ask because currently in the test environment this is logging every second and causing logs to fill up quite a bit.\nCould this be changed to a debug level?", "bodyHTML": "<p dir=\"auto\">If I'm not mistaken the parameters have changed but the general logic behind this statement has not correct?  I ask because currently in the test environment this is logging every second and causing logs to fill up quite a bit.</p>\n<p dir=\"auto\">Could this be changed to a debug level?</p>", "author": "njdister", "createdAt": "2020-02-13T16:27:26Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(", "originalCommit": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4ODI3Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378988273", "bodyText": "This code shouldn't put a log entry every second, only when new RIF batch was loaded. It doesn't on my laptop. Can you send me the logs where it is?", "author": "RickHawesUSDS", "createdAt": "2020-02-13T16:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MDYwMQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r379040601", "bodyText": "Got your logs. I understand the problem and was able to reproduce it locally. The cause was using now() for the case where there was an empty LoadedBatches table.  I also confirmed that this change fixes the problem.", "author": "RickHawesUSDS", "createdAt": "2020-02-13T18:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6edfed431b233fb302719b4e85caa14011ec7225", "changed_code": [{"header": "diff --git a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\nindex 05b541efb..f9345fa2e 100644\n--- a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\n+++ b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\n", "chunk": "@@ -222,8 +223,8 @@ public class LoadedFilterManager {\n             lastBatchCreated,\n             currentLastBatchCreated);\n         List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.lastBatchCreated);\n-        this.filters = updateFilters(this.filters, loadedTuples, this::fetchLoadedBatches);\n-        this.lastBatchCreated = currentLastBatchCreated;\n+        List<LoadedFileFilter> newFilters =\n+            updateFilters(this.filters, loadedTuples, this::fetchLoadedBatches);\n \n         // If batches been trimmed, then remove filters which are no longer present\n         final Date currentFirstBatchUpdate =\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MjM2Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378972363", "body": "Same as above, this is currently logging every second in test.  Can this be changed to debug?", "bodyText": "Same as above, this is currently logging every second in test.  Can this be changed to debug?", "bodyHTML": "<p dir=\"auto\">Same as above, this is currently logging every second in test.  Can this be changed to debug?</p>", "author": "njdister", "createdAt": "2020-02-13T16:28:08Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(\n             \"Refreshing LoadedFile filters with new filters from {} to {}\",\n-            transactionTime,\n-            currentLastDatabaseUpdate);\n-        List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.transactionTime);\n+            lastBatchCreated,\n+            currentLastBatchCreated);\n+        List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.lastBatchCreated);\n         this.filters = updateFilters(this.filters, loadedTuples, this::fetchLoadedBatches);\n-        this.transactionTime = currentLastDatabaseUpdate;\n+        this.lastBatchCreated = currentLastBatchCreated;\n \n         // If batches been trimmed, then remove filters which are no longer present\n-        final Date currentFirstBatchUpdate = fetchFirstLoadedBatchTime();\n-        if (this.firstBatchUpdate == null\n-            || this.firstBatchUpdate.before(currentFirstBatchUpdate)) {\n+        final Date currentFirstBatchUpdate =\n+            fetchFirstLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+        if (this.firstBatchCreated == null\n+            || this.firstBatchCreated.before(currentFirstBatchUpdate)) {\n           LOGGER.info(\"Trimmed LoadedFile filters before {}\", currentFirstBatchUpdate);", "originalCommit": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6edfed431b233fb302719b4e85caa14011ec7225", "changed_code": [{"header": "diff --git a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\nindex 05b541efb..f9345fa2e 100644\n--- a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\n+++ b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\n", "chunk": "@@ -222,8 +223,8 @@ public class LoadedFilterManager {\n             lastBatchCreated,\n             currentLastBatchCreated);\n         List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.lastBatchCreated);\n-        this.filters = updateFilters(this.filters, loadedTuples, this::fetchLoadedBatches);\n-        this.lastBatchCreated = currentLastBatchCreated;\n+        List<LoadedFileFilter> newFilters =\n+            updateFilters(this.filters, loadedTuples, this::fetchLoadedBatches);\n \n         // If batches been trimmed, then remove filters which are no longer present\n         final Date currentFirstBatchUpdate =\n", "next_change": null}, {"header": "diff --git a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\nindex 05b541efb..f9345fa2e 100644\n--- a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\n+++ b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\n", "chunk": "@@ -232,12 +233,10 @@ public class LoadedFilterManager {\n             || this.firstBatchCreated.before(currentFirstBatchUpdate)) {\n           LOGGER.info(\"Trimmed LoadedFile filters before {}\", currentFirstBatchUpdate);\n           List<LoadedFile> loadedFiles = fetchLoadedFiles();\n-          this.filters = trimFilters(this.filters, loadedFiles);\n-          this.firstBatchCreated = currentFirstBatchUpdate;\n+          newFilters = trimFilters(newFilters, loadedFiles);\n         }\n \n-        // update the transaction time as well\n-        this.transactionTime = currentLastBatchCreated;\n+        set(newFilters, currentFirstBatchUpdate, currentLastBatchCreated);\n       }\n     } catch (Exception ex) {\n       LOGGER.error(\"Error found refreshing LoadedFile filters\", ex);\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MjEzMA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378972130", "body": "Is this the equivalent of saying `if lastBatchCreated is null or lastBatchCreated is before transactionTime`?", "bodyText": "Is this the equivalent of saying if lastBatchCreated is null or lastBatchCreated is before transactionTime?", "bodyHTML": "<p dir=\"auto\">Is this the equivalent of saying <code>if lastBatchCreated is null or lastBatchCreated is before transactionTime</code>?</p>", "author": "whytheplatypus", "createdAt": "2020-02-13T16:27:48Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {", "originalCommit": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d583c0744149c19563a2c7188958c3eef026f02", "changed_code": [{"header": "diff --git a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/commons/LoadedFilterManager.java\nsimilarity index 93%\nrename from apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\nrename to apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/commons/LoadedFilterManager.java\nindex 05b541efb..c0f2e5c70 100644\n--- a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java\n+++ b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/commons/LoadedFilterManager.java\n", "chunk": "@@ -204,13 +204,15 @@ public class LoadedFilterManager {\n    * call.\n    */\n   @Scheduled(fixedDelay = 1000, initialDelay = 2000)\n-  public synchronized void refreshFilters() {\n+  public void refreshFilters() {\n     /*\n      * Dev note: the pipeline has a process to trim the files list. Nevertheless, building a set of\n-     * bloom filters may take a while. This method is expected to be called on it's own thread, so\n-     * this filter building process can happen without interfering with serving. Also, this refresh\n-     * time will be proportional to the number of files which have been loaded in the past refresh\n-     * period. If no files have been loaded, this refresh should take less than a millisecond.\n+     * bloom filters may take a while. This method is expected to be called on it's own thread by\n+     * the the Spring framework. In addition, it doesn't lock this object until the end of the\n+     * process, so this filter building process can happen without interfering with serving. Also,\n+     * this refresh time will be proportional to the number of files which have been loaded in the\n+     * past refresh period. If no files have been loaded, this refresh should take less than a\n+     * millisecond.\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n", "next_change": null}]}}]}