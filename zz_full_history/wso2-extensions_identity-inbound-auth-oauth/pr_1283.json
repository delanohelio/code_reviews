{"pr_number": 1283, "pr_title": "Fix checkstyle issues", "pr_author": "madurangasiriwardena", "pr_createdAt": "2020-01-03T12:02:48Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1283", "timeline": [{"oid": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "message": "Fix checkstyle issues", "committedDate": "2020-01-03T12:24:40Z", "type": "commit"}, {"oid": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "message": "Fix checkstyle issues", "committedDate": "2020-01-03T12:24:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MjY4MQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1283#discussion_r363162681", "body": "Shall we add a colon `:` before the user parameter?", "bodyText": "Shall we add a colon : before the user parameter?", "bodyHTML": "<p dir=\"auto\">Shall we add a colon <code>:</code> before the user parameter?</p>", "author": "tharindu-bandara", "createdAt": "2020-01-06T05:29:00Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -97,8 +98,8 @@\n \n         String loggedInUser = CarbonContext.getThreadLocalCarbonContext().getUsername();\n \n-        if (log.isDebugEnabled()) {\n-            log.debug(\"Adding a consumer secret for the logged in user \" + loggedInUser);\n+        if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"Adding a consumer secret for the logged in user \" + loggedInUser);", "originalCommit": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex a11f9955e..295a18ef5 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -99,7 +99,7 @@ public class OAuthAdminServiceImpl {\n         String loggedInUser = CarbonContext.getThreadLocalCarbonContext().getUsername();\n \n         if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"Adding a consumer secret for the logged in user \" + loggedInUser);\n+            LOG.debug(\"Adding a consumer secret for the logged in user:\" + loggedInUser);\n         }\n \n         String tenantUser = MultitenantUtils.getTenantAwareUsername(loggedInUser);\n", "next_change": {"commit": "b9446355891a3b5394c78955a4e9b6e6fdb26e31", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex 295a18ef5..c28545dd7 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -96,8 +114,14 @@ public class OAuthAdminServiceImpl {\n      */\n     public String[] registerOAuthConsumer() throws IdentityOAuthAdminException {\n \n-        String loggedInUser = CarbonContext.getThreadLocalCarbonContext().getUsername();\n-\n+        String loggedInUser;\n+        try {\n+            loggedInUser =\n+                    ApplicationMgtUtil.getUsername(CarbonContext.getThreadLocalCarbonContext().getTenantDomain());\n+        } catch (IdentityApplicationManagementException e) {\n+            String msg = \"User not logged in to register OAuth consumer.\";\n+            throw handleClientError(AUTHENTICATED_USER_NOT_FOUND, msg, e);\n+        }\n         if (LOG.isDebugEnabled()) {\n             LOG.debug(\"Adding a consumer secret for the logged in user:\" + loggedInUser);\n         }\n", "next_change": {"commit": "8fc67e25b7861ecf4667fb43ee0013c9a7532648", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex c28545dd7..71ca8c3c3 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -117,7 +116,7 @@ public class OAuthAdminServiceImpl {\n         String loggedInUser;\n         try {\n             loggedInUser =\n-                    ApplicationMgtUtil.getUsername(CarbonContext.getThreadLocalCarbonContext().getTenantDomain());\n+                    OAuthUtil.getUsername(CarbonContext.getThreadLocalCarbonContext().getTenantDomain());\n         } catch (IdentityApplicationManagementException e) {\n             String msg = \"User not logged in to register OAuth consumer.\";\n             throw handleClientError(AUTHENTICATED_USER_NOT_FOUND, msg, e);\n", "next_change": {"commit": "7b29b2ac976cdecec557df684feab8e3e540c1a4", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex 71ca8c3c3..0ae4a7162 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -118,7 +118,7 @@ public class OAuthAdminServiceImpl {\n             loggedInUser =\n                     OAuthUtil.getUsername(CarbonContext.getThreadLocalCarbonContext().getTenantDomain());\n         } catch (IdentityApplicationManagementException e) {\n-            String msg = \"User not logged in to register OAuth consumer.\";\n+            String msg = \"Error while retrieving the username of the logged user.\";\n             throw handleClientError(AUTHENTICATED_USER_NOT_FOUND, msg, e);\n         }\n         if (LOG.isDebugEnabled()) {\n", "next_change": null}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MzEzNA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1283#discussion_r363163134", "body": "Shall we add a colon before the parameters?", "bodyText": "Shall we add a colon before the parameters?", "bodyHTML": "<p dir=\"auto\">Shall we add a colon before the parameters?</p>", "author": "tharindu-bandara", "createdAt": "2020-01-06T05:32:30Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -887,52 +889,52 @@ public OAuthRevocationResponseDTO revokeAuthzForAppsByResourceOwner(\n                             OAuthUtil.clearOAuthCache(accessTokenDO.getConsumerKey(), authzUser,\n                                     buildScopeString(accessTokenDO.getScope()), tokenBindingReference);\n                             OAuthUtil.clearOAuthCache(accessTokenDO.getConsumerKey(), authzUser,\n-                                                      buildScopeString(accessTokenDO.getScope()));\n+                                    buildScopeString(accessTokenDO.getScope()));\n                             OAuthUtil.clearOAuthCache(accessTokenDO.getConsumerKey(), authzUser);\n                             OAuthUtil.clearOAuthCache(accessTokenDO.getAccessToken());\n                             AccessTokenDO scopedToken;\n                             try {\n                                 // Retrieve latest access token for particular client, user and scope combination if\n                                 // its ACTIVE or EXPIRED.\n                                 scopedToken = OAuthTokenPersistenceFactory.getInstance().getAccessTokenDAO()\n-                                                                          .getLatestAccessToken(\n-                                                                                  appDTO.getOauthConsumerKey(), user,\n-                                                                                  userStoreDomain,\n-                                                                                  buildScopeString(\n-                                                                                          accessTokenDO.getScope()),\n-                                                                                  true);\n+                                        .getLatestAccessToken(\n+                                                appDTO.getOauthConsumerKey(), user,\n+                                                userStoreDomain,\n+                                                buildScopeString(\n+                                                        accessTokenDO.getScope()),\n+                                                true);\n                             } catch (IdentityOAuth2Exception e) {\n                                 String errorMsg = \"Error occurred while retrieving latest \" +\n-                                                  \"access token issued for Client ID : \" +\n-                                                  appDTO.getOauthConsumerKey() + \", User ID : \" + userName +\n-                                                  \" and Scope : \" + buildScopeString(accessTokenDO.getScope());\n+                                        \"access token issued for Client ID : \" +\n+                                        appDTO.getOauthConsumerKey() + \", User ID : \" + userName +\n+                                        \" and Scope : \" + buildScopeString(accessTokenDO.getScope());\n                                 throw handleError(errorMsg, e);\n                             }\n                             if (scopedToken != null) {\n                                 //Revoking token from database\n                                 try {\n                                     OAuthTokenPersistenceFactory.getInstance().getAccessTokenDAO()\n-                                                                .revokeAccessTokens(new String[]{scopedToken\n-                                                                        .getAccessToken()});\n+                                            .revokeAccessTokens(new String[]{scopedToken\n+                                                    .getAccessToken()});\n                                 } catch (IdentityOAuth2Exception e) {\n                                     String errorMsg = \"Error occurred while revoking \" + \"Access Token : \" +\n-                                                      scopedToken.getAccessToken();\n+                                            scopedToken.getAccessToken();\n                                     throw handleError(errorMsg, e);\n                                 }\n                                 //Revoking the oauth consent from database.\n                                 try {\n                                     OAuthTokenPersistenceFactory.getInstance().getTokenManagementDAO()\n-                                            .revokeOAuthConsentByApplicationAndUser((\n-                                                    (AuthenticatedUser) authzUser).getAuthenticatedSubjectIdentifier(),\n-                                                                                    tenantDomain, appName);\n+                                            .revokeOAuthConsentByApplicationAndUser(\n+                                                    authzUser.getAuthenticatedSubjectIdentifier(),\n+                                                    tenantDomain, appName);\n                                 } catch (IdentityOAuth2Exception e) {\n                                     String errorMsg = \"Error occurred while removing OAuth Consent of Application \" +\n-                                                      appName + \" of user \" + userName;\n+                                            appName + \" of user \" + userName;", "originalCommit": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex a11f9955e..295a18ef5 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -928,8 +927,8 @@ public class OAuthAdminServiceImpl {\n                                                     authzUser.getAuthenticatedSubjectIdentifier(),\n                                                     tenantDomain, appName);\n                                 } catch (IdentityOAuth2Exception e) {\n-                                    String errorMsg = \"Error occurred while removing OAuth Consent of Application \" +\n-                                            appName + \" of user \" + userName;\n+                                    String errorMsg = \"Error occurred while removing OAuth Consent of Application: \" +\n+                                            appName + \" of user: \" + userName;\n                                     throw handleError(errorMsg, e);\n                                 }\n                             }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2Mzc4OA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1283#discussion_r363163788", "body": "Space at the end of the log might not be required.", "bodyText": "Space at the end of the log might not be required.", "bodyHTML": "<p dir=\"auto\">Space at the end of the log might not be required.</p>", "author": "tharindu-bandara", "createdAt": "2020-01-06T05:37:07Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -998,16 +1000,16 @@ void triggerPostRevokeListeners(OAuthRevocationRequestDTO revokeRequestDTO,\n                                     OAuthRevocationResponseDTO revokeRespDTO, AccessTokenDO[] accessTokenDOs) {\n \n         OAuthEventInterceptor oAuthEventInterceptorProxy = OAuthComponentServiceHolder.getInstance()\n-                                                                                      .getOAuthEventInterceptorProxy();\n+                .getOAuthEventInterceptorProxy();\n \n         for (AccessTokenDO accessTokenDO : accessTokenDOs) {\n             if (oAuthEventInterceptorProxy != null && oAuthEventInterceptorProxy.isEnabled()) {\n                 try {\n                     Map<String, Object> paramMap = new HashMap<String, Object>();\n                     oAuthEventInterceptorProxy.onPostTokenRevocationByResourceOwner(revokeRequestDTO, revokeRespDTO,\n-                                                                                    accessTokenDO, paramMap);\n+                            accessTokenDO, paramMap);\n                 } catch (IdentityOAuth2Exception e) {\n-                    log.error(\"Error occurred with post revocation listener \", e);\n+                    LOG.error(\"Error occurred with post revocation listener \", e);", "originalCommit": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex a11f9955e..295a18ef5 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -1009,7 +1008,7 @@ public class OAuthAdminServiceImpl {\n                     oAuthEventInterceptorProxy.onPostTokenRevocationByResourceOwner(revokeRequestDTO, revokeRespDTO,\n                             accessTokenDO, paramMap);\n                 } catch (IdentityOAuth2Exception e) {\n-                    LOG.error(\"Error occurred with post revocation listener \", e);\n+                    LOG.error(\"Error occurred with post revocation listener.\", e);\n                 }\n             }\n         }\n", "next_change": {"commit": "c67a977b3cccf5bc6a939ab97f0c504f380449c5", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex 295a18ef5..acdee7392 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -1014,6 +1267,135 @@ public class OAuthAdminServiceImpl {\n         }\n     }\n \n+    private void triggerPreApplicationTokenRevokeListeners(OAuthAppRevocationRequestDTO revokeRequestDTO)\n+            throws IdentityOAuthAdminException {\n+\n+        OAuthEventInterceptor oAuthEventInterceptorProxy = OAuthComponentServiceHolder.getInstance()\n+                .getOAuthEventInterceptorProxy();\n+        if (oAuthEventInterceptorProxy != null && oAuthEventInterceptorProxy.isEnabled()) {\n+            Map<String, Object> paramMap = new HashMap<>();\n+            try {\n+                oAuthEventInterceptorProxy.onPreTokenRevocationByApplication(revokeRequestDTO, paramMap);\n+            } catch (IdentityOAuth2Exception e) {\n+                throw handleError(\"Error occurred when triggering pre revocation listener.\", e);\n+            }\n+        }\n+    }\n+\n+    private void triggerPostApplicationTokenRevokeListeners(OAuthAppRevocationRequestDTO revokeRequestDTO,\n+                                                            OAuthRevocationResponseDTO revokeRespDTO,\n+                                                            List<AccessTokenDO> accessTokenDOs)\n+            throws IdentityOAuthAdminException {\n+\n+        OAuthEventInterceptor oAuthEventInterceptorProxy = OAuthComponentServiceHolder.getInstance()\n+                .getOAuthEventInterceptorProxy();\n+        if (oAuthEventInterceptorProxy != null && oAuthEventInterceptorProxy.isEnabled()) {\n+            Map<String, Object> paramMap = new HashMap<>();\n+            try {\n+                oAuthEventInterceptorProxy.onPostTokenRevocationByApplication(revokeRequestDTO, revokeRespDTO,\n+                        accessTokenDOs, paramMap);\n+            } catch (IdentityOAuth2Exception e) {\n+                throw handleError(\"Error occurred when triggering post revocation listener.\", e);\n+            }\n+        }\n+    }\n+\n+    private List<AccessTokenDO> getActiveAccessTokensByConsumerKey(String consumerKey)\n+            throws IdentityOAuthAdminException {\n+\n+        List<AccessTokenDO> accessTokenDOs;\n+        try {\n+            accessTokenDOs = new ArrayList<>(OAuthTokenPersistenceFactory\n+                    .getInstance().getAccessTokenDAO().getActiveAcessTokenDataByConsumerKey(consumerKey));\n+        } catch (IdentityOAuth2Exception e) {\n+            String errorMsg = String.format(\"Error occurred while retrieving access tokens issued for OAuth \" +\n+                    \"app with consumer key: %s.\", consumerKey);\n+            throw handleError(errorMsg, e);\n+        }\n+        return accessTokenDOs;\n+    }\n+\n+    private void revokeAccessTokens(String[] accessTokens, String consumerKey, String tenantDomain)\n+            throws IdentityOAuthAdminException {\n+\n+        try {\n+            OAuthTokenPersistenceFactory.getInstance().getAccessTokenDAO()\n+                    .revokeAccessTokens(accessTokens, OAuth2Util.isHashEnabled());\n+        } catch (IdentityOAuth2Exception e) {\n+            String errorMsg = String.format(\"Error occurred while revoking access tokens for OAuth app in \" +\n+                    \"tenant domain: %s with consumer key: %s.\", tenantDomain, consumerKey);\n+            throw handleError(errorMsg, e);\n+        }\n+    }\n+\n+    private String getTenantDomain(String consumerKey) throws IdentityOAuthAdminException {\n+\n+        String tenantDomain;\n+        try {\n+            tenantDomain = OAuth2Util.getTenantDomainOfOauthApp(consumerKey);\n+        } catch (IdentityOAuth2Exception e) {\n+            String errorMsg = String.format(\"Error occurred while retrieving tenant domain of OAuth app with \" +\n+                    \"consumer key: %s.\", consumerKey);\n+            throw handleError(errorMsg, e);\n+        } catch (InvalidOAuthClientException e) {\n+            String errorMsg = String.format(\"Cannot find a valid OAuth app with consumer key: %s.\", consumerKey);\n+            if (LOG.isDebugEnabled()) {\n+                LOG.debug(errorMsg, e);\n+            }\n+            throw handleClientError(INVALID_OAUTH_CLIENT, errorMsg);\n+        }\n+        return tenantDomain;\n+    }\n+\n+    private String getApplicationName(String consumerKey, String tenantDomain)\n+            throws IdentityOAuthAdminException {\n+\n+        String applicationName;\n+        try {\n+            ApplicationManagementService applicationMgtService = OAuth2ServiceComponentHolder\n+                    .getApplicationMgtService();\n+            applicationName = applicationMgtService\n+                    .getServiceProviderNameByClientId(consumerKey, INBOUND_AUTH2_TYPE, tenantDomain);\n+        } catch (IdentityApplicationManagementException e) {\n+            String errorMsg = String.format(\"Error occurred while retrieving application name for OAuth app in \" +\n+                    \"tenant domain: %s with consumer key: %s.\", tenantDomain, consumerKey);\n+            throw handleError(errorMsg, e);\n+        }\n+        return applicationName;\n+    }\n+\n+    private void clearCacheByAccessTokenAndConsumerKey(AccessTokenDO accessTokenDO, String consumerKey) {\n+\n+        String token = accessTokenDO.getAccessToken();\n+        AuthenticatedUser authenticatedUser = accessTokenDO.getAuthzUser();\n+\n+        OAuthCacheKey cacheKeyToken = new OAuthCacheKey(token);\n+        String scope = buildScopeString(accessTokenDO.getScope());\n+        TokenBinding tokenBinding = accessTokenDO.getTokenBinding();\n+        String tokenBindingReference = (tokenBinding != null &&\n+                StringUtils.isNotBlank(tokenBinding.getBindingReference())) ?\n+                tokenBinding.getBindingReference() : NONE;\n+\n+        OAuthCache.getInstance().clearCacheEntry(cacheKeyToken);\n+        OAuthUtil.clearOAuthCache(consumerKey, authenticatedUser, scope, tokenBindingReference);\n+        OAuthUtil.clearOAuthCache(consumerKey, authenticatedUser, scope);\n+        OAuthUtil.clearOAuthCache(consumerKey, authenticatedUser);\n+        OAuthUtil.clearOAuthCache(accessTokenDO);\n+    }\n+\n+    private void revokeOAuthConsentsForApplication(String applicationName, String tenantDomain)\n+            throws IdentityOAuthAdminException {\n+\n+        try {\n+            OAuthTokenPersistenceFactory.getInstance().getTokenManagementDAO()\n+                    .revokeOAuthConsentsByApplication(applicationName, tenantDomain);\n+        } catch (IdentityOAuth2Exception e) {\n+            String errorMsg = String.format(\"Error occurred while revoking all OAuth consents given for \" +\n+                    \"application: %s in tenant domain: %s.\", applicationName, tenantDomain);\n+            throw handleError(errorMsg, e);\n+        }\n+    }\n+\n     public String[] getAllowedGrantTypes() {\n \n         if (allowedGrants == null) {\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MzkyNA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1283#discussion_r363163924", "body": "Shall we add a colon before the token type parameter?", "bodyText": "Shall we add a colon before the token type parameter?", "bodyHTML": "<p dir=\"auto\">Shall we add a colon before the token type parameter?</p>", "author": "tharindu-bandara", "createdAt": "2020-01-06T05:38:07Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -1137,36 +1140,36 @@ void validateTokenExpiryConfigurations(OAuthConsumerAppDTO oAuthConsumerAppDTO)\n             oAuthConsumerAppDTO.setUserAccessTokenExpiryTime(\n                     OAuthServerConfiguration.getInstance().getUserAccessTokenValidityPeriodInSeconds());\n             logOnInvalidConfig(oAuthConsumerAppDTO.getApplicationName(), \"user access token\",\n-                               oAuthConsumerAppDTO.getUserAccessTokenExpiryTime());\n+                    oAuthConsumerAppDTO.getUserAccessTokenExpiryTime());\n         }\n \n         if (oAuthConsumerAppDTO.getApplicationAccessTokenExpiryTime() == 0) {\n             oAuthConsumerAppDTO.setApplicationAccessTokenExpiryTime(\n                     OAuthServerConfiguration.getInstance().getApplicationAccessTokenValidityPeriodInSeconds());\n             logOnInvalidConfig(oAuthConsumerAppDTO.getApplicationName(), \"application access token\",\n-                               oAuthConsumerAppDTO.getApplicationAccessTokenExpiryTime());\n+                    oAuthConsumerAppDTO.getApplicationAccessTokenExpiryTime());\n         }\n \n         if (oAuthConsumerAppDTO.getRefreshTokenExpiryTime() == 0) {\n             oAuthConsumerAppDTO.setRefreshTokenExpiryTime(\n                     OAuthServerConfiguration.getInstance().getRefreshTokenValidityPeriodInSeconds());\n             logOnInvalidConfig(oAuthConsumerAppDTO.getApplicationName(), \"refresh token\",\n-                               oAuthConsumerAppDTO.getRefreshTokenExpiryTime());\n+                    oAuthConsumerAppDTO.getRefreshTokenExpiryTime());\n         }\n \n         if (oAuthConsumerAppDTO.getIdTokenExpiryTime() == 0) {\n             oAuthConsumerAppDTO.setIdTokenExpiryTime(\n                     OAuthServerConfiguration.getInstance().getOpenIDConnectIDTokenExpiryTimeInSeconds());\n             logOnInvalidConfig(oAuthConsumerAppDTO.getApplicationName(), \"id token\",\n-                               oAuthConsumerAppDTO.getIdTokenExpiryTime());\n+                    oAuthConsumerAppDTO.getIdTokenExpiryTime());\n         }\n     }\n \n     void logOnInvalidConfig(String appName, String tokenType, long defaultValue) {\n \n-        if (log.isDebugEnabled()) {\n-            log.debug(\"Invalid expiry time value '0' set for \" + tokenType + \" in ServiceProvider: \" + appName + \". \"\n-                      + \"Defaulting to expiry value: \" + defaultValue + \" seconds.\");\n+        if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"Invalid expiry time value '0' set for \" + tokenType + \" in ServiceProvider: \" + appName + \". \"", "originalCommit": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex a11f9955e..295a18ef5 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -1168,8 +1167,8 @@ public class OAuthAdminServiceImpl {\n     void logOnInvalidConfig(String appName, String tokenType, long defaultValue) {\n \n         if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"Invalid expiry time value '0' set for \" + tokenType + \" in ServiceProvider: \" + appName + \". \"\n-                    + \"Defaulting to expiry value: \" + defaultValue + \" seconds.\");\n+            LOG.debug(\"Invalid expiry time value '0' set for token type: \" + tokenType + \" in ServiceProvider: \" +\n+                    appName + \". Defaulting to expiry value: \" + defaultValue + \" seconds.\");\n         }\n     }\n \n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NDkxNg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1283#discussion_r363164916", "body": "Shall we add the full stop for the debug messages?", "bodyText": "Shall we add the full stop for the debug messages?", "bodyHTML": "<p dir=\"auto\">Shall we add the full stop for the debug messages?</p>", "author": "pamodaaw", "createdAt": "2020-01-06T05:43:56Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -122,8 +123,8 @@\n \n         if (userName == null) {\n             String msg = \"User not logged in to get all registered OAuth Applications\";", "originalCommit": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex a11f9955e..295a18ef5 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -122,7 +122,7 @@ public class OAuthAdminServiceImpl {\n         OAuthConsumerAppDTO[] dtos = new OAuthConsumerAppDTO[0];\n \n         if (userName == null) {\n-            String msg = \"User not logged in to get all registered OAuth Applications\";\n+            String msg = \"User not logged in to get all registered OAuth Applications.\";\n             if (LOG.isDebugEnabled()) {\n                 LOG.debug(msg);\n             }\n", "next_change": {"commit": "b9446355891a3b5394c78955a4e9b6e6fdb26e31", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex 295a18ef5..c28545dd7 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -118,15 +142,17 @@ public class OAuthAdminServiceImpl {\n      */\n     public OAuthConsumerAppDTO[] getAllOAuthApplicationData() throws IdentityOAuthAdminException {\n \n-        String userName = CarbonContext.getThreadLocalCarbonContext().getUsername();\n+        String userName;\n         OAuthConsumerAppDTO[] dtos = new OAuthConsumerAppDTO[0];\n-\n-        if (userName == null) {\n+        try {\n+            String tenantDomain = CarbonContext.getThreadLocalCarbonContext().getTenantDomain();\n+            userName = ApplicationMgtUtil.getUsername(tenantDomain);\n+        } catch (IdentityApplicationManagementException e) {\n             String msg = \"User not logged in to get all registered OAuth Applications.\";\n             if (LOG.isDebugEnabled()) {\n                 LOG.debug(msg);\n             }\n-            throw handleClientError(AUTHENTICATED_USER_NOT_FOUND, msg);\n+            throw handleClientError(AUTHENTICATED_USER_NOT_FOUND, msg, e);\n         }\n \n         int tenantId = CarbonContext.getThreadLocalCarbonContext().getTenantId();\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NTg3OA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1283#discussion_r363165878", "body": "Can't these two lines be combined?", "bodyText": "Can't these two lines be combined?", "bodyHTML": "<p dir=\"auto\">Can't these two lines be combined?</p>", "author": "pamodaaw", "createdAt": "2020-01-06T05:50:23Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -700,36 +701,36 @@ void updateAppAndRevokeTokensAndAuthzCodes(String consumerKey,\n                     cacheKeyString = consumerKey + \":\" + authorizedUser + \":\" + scope + \":\" + authenticatedIDP;\n                 } else {\n                     cacheKeyString = consumerKey + \":\" + authorizedUser.toLowerCase() + \":\" + scope + \":\"\n-                                     + authenticatedIDP;\n+                            + authenticatedIDP;\n                 }\n                 OAuthCacheKey cacheKeyUser = new OAuthCacheKey(cacheKeyString);\n                 OAuthCache.getInstance().clearCacheEntry(cacheKeyUser);\n             }\n \n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Access tokens and token of users are removed from the cache for OAuth App with \" +\n-                          \"consumerKey: \" + consumerKey);\n+            if (LOG.isDebugEnabled()) {\n+                LOG.debug(\"Access tokens and token of users are removed from the cache for OAuth App with \" +\n+                        \"consumerKey: \" + consumerKey);\n             }\n \n             Set<String> authorizationCodes = OAuthTokenPersistenceFactory.getInstance().getAuthorizationCodeDAO()\n-                                                                         .getActiveAuthorizationCodesByConsumerKey\n-                                                                                 (consumerKey);\n+                    .getActiveAuthorizationCodesByConsumerKey\n+                            (consumerKey);", "originalCommit": "29b087e150eddf3a94c4c4a7e8aa97c362b772b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "changed_code": [{"header": "diff --git a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\nindex a11f9955e..295a18ef5 100644\n--- a/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n+++ b/components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java\n", "chunk": "@@ -713,8 +713,7 @@ public class OAuthAdminServiceImpl {\n             }\n \n             Set<String> authorizationCodes = OAuthTokenPersistenceFactory.getInstance().getAuthorizationCodeDAO()\n-                    .getActiveAuthorizationCodesByConsumerKey\n-                            (consumerKey);\n+                    .getActiveAuthorizationCodesByConsumerKey(consumerKey);\n             for (String authorizationCode : authorizationCodes) {\n                 OAuthCacheKey cacheKey = new OAuthCacheKey(authorizationCode);\n                 OAuthCache.getInstance().clearCacheEntry(cacheKey);\n", "next_change": null}]}}, {"oid": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/79c5215a8ded08479712a7fefce1ee9b14a7e320", "message": "Fix PR comments", "committedDate": "2020-01-06T06:18:00Z", "type": "commit"}, {"oid": "79c5215a8ded08479712a7fefce1ee9b14a7e320", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/79c5215a8ded08479712a7fefce1ee9b14a7e320", "message": "Fix PR comments", "committedDate": "2020-01-06T06:18:00Z", "type": "forcePushed"}, {"oid": "5a9ed3c5454bd5f4c2966ace459d86bb835c757e", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/5a9ed3c5454bd5f4c2966ace459d86bb835c757e", "message": "Fix test failure", "committedDate": "2020-01-06T06:35:27Z", "type": "commit"}]}