{"pr_number": 1017, "pr_title": "DPC-503 fix: html validator to allow `&`", "pr_author": "jonfulk", "pr_createdAt": "2020-08-31T20:10:34Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1017", "timeline": [{"oid": "fa7c5b4abe9c180ee62c09fe2cd9f5c9c5d3c5ff", "url": "https://github.com/CMSgov/dpc-app/commit/fa7c5b4abe9c180ee62c09fe2cd9f5c9c5d3c5ff", "message": "DPC-503: fix html validator to allow `&`\n\nWhen a name or address contained `&`, it was\nfailing validation due to a check to ensure that there\nis no HTML in the form data. This fix ignores such `&`\ncharacters.", "committedDate": "2020-08-31T19:58:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MDEwMA==", "url": "https://github.com/CMSgov/dpc-app/pull/1017#discussion_r480390100", "body": "Would it make more sense to replace with \" and \"?\r\n```suggestion\r\n        String s1 = s.replaceAll(\"(\\\\s&\\\\s)\", \" and \");\r\n```", "bodyText": "Would it make more sense to replace with \" and \"?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String s1 = s.replaceAll(\"(\\\\s&\\\\s)\", \"   \");\n          \n          \n            \n                    String s1 = s.replaceAll(\"(\\\\s&\\\\s)\", \" and \");", "bodyHTML": "<p dir=\"auto\">Would it make more sense to replace with \" and \"?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"27\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">String</span> s1 <span class=\"pl-k\">=</span> s<span class=\"pl-k\">.</span>replaceAll(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>(<span class=\"pl-cce\">\\\\</span>s&amp;<span class=\"pl-cce\">\\\\</span>s)<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span> <span class=\"x x-first x-last\"> </span> <span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"27\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">String</span> s1 <span class=\"pl-k\">=</span> s<span class=\"pl-k\">.</span>replaceAll(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>(<span class=\"pl-cce\">\\\\</span>s&amp;<span class=\"pl-cce\">\\\\</span>s)<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span> <span class=\"x x-first x-last\">and</span> <span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "dhgreene", "createdAt": "2020-08-31T20:47:36Z", "path": "dpc-common/src/main/java/gov/cms/dpc/common/hibernate/validator/NoHtmlValidator.java", "diffHunk": "@@ -23,7 +23,9 @@ public boolean isValid(String s, ConstraintValidatorContext constraintValidatorC\n         if (StringUtils.isBlank(s)) {\n             return true;\n         }\n-        String safe = Jsoup.clean(s, \"\", Whitelist.none(), new Document.OutputSettings().prettyPrint(false));\n-        return safe.equals(s);\n+        // Ignore `&` in names and addresses\n+        String s1 = s.replaceAll(\"(\\\\s&\\\\s)\", \"   \");", "originalCommit": "fa7c5b4abe9c180ee62c09fe2cd9f5c9c5d3c5ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MjQxOA==", "url": "https://github.com/CMSgov/dpc-app/pull/1017#discussion_r480392418", "bodyText": "Would it make more sense to replace with \" and \"?\n\nI considered this but thought it might be best to maintain the same character length. No one is actually going to see the modified string since the validator just returns a boolean, so I don't think the replacement matters much. I did go back and forth on it for a bit, though. I'm open to changing it.", "author": "jonfulk", "createdAt": "2020-08-31T20:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU0OTA3MQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1017#discussion_r480549071", "bodyText": "I think you can just change the Whitelist object to whitelist ampersand.", "author": "MrBilnon", "createdAt": "2020-09-01T01:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU3Mzk4NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1017#discussion_r480573985", "bodyText": "@whuang85 i tried that, as i mentioned in the description, but the Whitelist object seems to be made for whitelisting HTML tags and not random strings or regular expressions. I would prefer to use the whitelist object if you can help me figure out how to do that.", "author": "jonfulk", "createdAt": "2020-09-01T01:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDcwNzcyMg==", "url": "https://github.com/CMSgov/dpc-app/pull/1017#discussion_r480707722", "bodyText": "@jonfulk oops, didn't read the description and yea it looks like it's not possible", "author": "MrBilnon", "createdAt": "2020-09-01T03:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MDEwMA=="}], "type": "inlineReview"}, {"oid": "eac85b6bdcb6fbcad159d94c81883e4152c52ab5", "url": "https://github.com/CMSgov/dpc-app/commit/eac85b6bdcb6fbcad159d94c81883e4152c52ab5", "message": "Merge branch 'master' into jkf/dpc-503-allow-amp", "committedDate": "2020-08-31T22:30:21Z", "type": "commit"}, {"oid": "d401ef0a8fc7ae2b06c5bb146907e5f823cfc083", "url": "https://github.com/CMSgov/dpc-app/commit/d401ef0a8fc7ae2b06c5bb146907e5f823cfc083", "message": "Merge branch 'master' into jkf/dpc-503-allow-amp", "committedDate": "2020-09-03T15:46:06Z", "type": "commit"}]}