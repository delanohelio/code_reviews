{"pr_number": 2595, "pr_title": "Fix/invisibility processor", "pr_author": "ImMorpheus", "pr_createdAt": "2020-05-02T20:34:49Z", "pr_url": "https://github.com/SpongePowered/Sponge/pull/2595", "timeline": [{"oid": "2ac0da9df68180ecacb36a235e922e556ab0a690", "url": "https://github.com/SpongePowered/Sponge/commit/2ac0da9df68180ecacb36a235e922e556ab0a690", "message": "Fix InvisibilityDataProcessor ignoring uncollideable and untargetable state when vanish is false", "committedDate": "2020-05-02T20:27:24Z", "type": "commit"}, {"oid": "4d5c38b40d6febd9fd3ebcfe480b24d54107440f", "url": "https://github.com/SpongePowered/Sponge/commit/4d5c38b40d6febd9fd3ebcfe480b24d54107440f", "message": "VANISH_IGNORES_COLLISION should be ignored if the Entity is not also vanished", "committedDate": "2020-05-02T20:28:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA4Mzg1Ng==", "url": "https://github.com/SpongePowered/Sponge/pull/2595#discussion_r419083856", "body": "So... is this right? When vanish is false, the entity in question should unquestionably be collidable. I'm a little worried that we're getting into a spiderweb here where we have a bridge method named one thing and the key named the other.\r\n\r\nOne school of thought is setting `VANISH_IGNORES_COLLISION` and `VANISH_PREVENTS_TARGETING` to `true` should not be cleared by setting `VANISH` to `false`. That feels largely expected and I err on the side of agreeing with that. I'm thus not against this change myself, but we need to make other changes to insulate ourselves against other issues.\r\n\r\nHowever, I know this is in impl, but `bridge$setUncollideable` and `bridge$setUntargetable` should really be named better to indicate that they are on vanish only. Their representive `is` methods should then be renamed similarly AND include a vanish check within their bodies. I'd rather check one method for collisions, rather than tacking on a vanish check everywhere too because it's not obvious that's what needs to happen.\r\n\r\nIf we want/need separate non-vanish uncollidable/targetting states then we need to think about that more, because we now need to think about how this will work with the vanish based states.", "bodyText": "So... is this right? When vanish is false, the entity in question should unquestionably be collidable. I'm a little worried that we're getting into a spiderweb here where we have a bridge method named one thing and the key named the other.\nOne school of thought is setting VANISH_IGNORES_COLLISION and VANISH_PREVENTS_TARGETING to true should not be cleared by setting VANISH to false. That feels largely expected and I err on the side of agreeing with that. I'm thus not against this change myself, but we need to make other changes to insulate ourselves against other issues.\nHowever, I know this is in impl, but bridge$setUncollideable and bridge$setUntargetable should really be named better to indicate that they are on vanish only. Their representive is methods should then be renamed similarly AND include a vanish check within their bodies. I'd rather check one method for collisions, rather than tacking on a vanish check everywhere too because it's not obvious that's what needs to happen.\nIf we want/need separate non-vanish uncollidable/targetting states then we need to think about that more, because we now need to think about how this will work with the vanish based states.", "bodyHTML": "<p dir=\"auto\">So... is this right? When vanish is false, the entity in question should unquestionably be collidable. I'm a little worried that we're getting into a spiderweb here where we have a bridge method named one thing and the key named the other.</p>\n<p dir=\"auto\">One school of thought is setting <code>VANISH_IGNORES_COLLISION</code> and <code>VANISH_PREVENTS_TARGETING</code> to <code>true</code> should not be cleared by setting <code>VANISH</code> to <code>false</code>. That feels largely expected and I err on the side of agreeing with that. I'm thus not against this change myself, but we need to make other changes to insulate ourselves against other issues.</p>\n<p dir=\"auto\">However, I know this is in impl, but <code>bridge$setUncollideable</code> and <code>bridge$setUntargetable</code> should really be named better to indicate that they are on vanish only. Their representive <code>is</code> methods should then be renamed similarly AND include a vanish check within their bodies. I'd rather check one method for collisions, rather than tacking on a vanish check everywhere too because it's not obvious that's what needs to happen.</p>\n<p dir=\"auto\">If we want/need separate non-vanish uncollidable/targetting states then we need to think about that more, because we now need to think about how this will work with the vanish based states.</p>", "author": "dualspiral", "createdAt": "2020-05-03T10:39:53Z", "path": "src/main/java/org/spongepowered/common/data/processor/multi/entity/InvisibilityDataProcessor.java", "diffHunk": "@@ -67,13 +67,9 @@ protected boolean set(final VanishableBridge dataHolder, final Map<Key<?>, Objec\n         final boolean untargetable = (Boolean) keyValues.get(Keys.VANISH_PREVENTS_TARGETING);\n         final boolean vanish = (Boolean) keyValues.get(Keys.VANISH);\n         dataHolder.bridge$setInvisible(invis);\n-        if (vanish) {\n-            dataHolder.bridge$setVanished(true);\n-            dataHolder.bridge$setUncollideable(collision);\n-            dataHolder.bridge$setUntargetable(untargetable);\n-        } else {\n-            dataHolder.bridge$setVanished(false);\n-        }\n+        dataHolder.bridge$setVanished(vanish);\n+        dataHolder.bridge$setUncollideable(collision);", "originalCommit": "4d5c38b40d6febd9fd3ebcfe480b24d54107440f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0NTA5Nw==", "url": "https://github.com/SpongePowered/Sponge/pull/2595#discussion_r419145097", "bodyText": "From what I gathered from the implementation and the API  (This state will be ignored if the {@link Entity} is not also vanished as per {@link #VANISH}.) the uncollideable state should be ignored in the implementation, not in the data processor.\n\nOne school of thought is setting VANISH_IGNORES_COLLISION and VANISH_PREVENTS_TARGETING to true should not be cleared by setting VANISH to false. That feels largely expected and I err on the side of agreeing with that. I'm thus not against this change myself, but we need to make other changes to insulate ourselves against other issues.\n\nAgreed, but not only that. As it stands now, setting VANISH_IGNORES_COLLISION explicitily to false is ignored if you're also setting VANISH to false. That doesn't feel right to me.\n\nHowever, I know this is in impl, but bridge$setUncollideable and bridge$setUntargetable should really be named better to indicate that they are on vanish only. Their representive is methods should then be renamed similarly AND include a vanish check within their bodies. I'd rather check one method for collisions, rather than tacking on a vanish check everywhere too because it's not obvious that's what needs to happen.\n\nEDIT: I'm not sure anymore about this. Discussions welcomed", "author": "ImMorpheus", "createdAt": "2020-05-03T19:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA4Mzg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0MDEyMQ==", "url": "https://github.com/SpongePowered/Sponge/pull/2595#discussion_r421540121", "body": "Okay, so I was looking about and thinking about previous discussions, and if vanish is `false`, the other two keys are removed from the user compound anyway ([see here](https://github.com/SpongePowered/SpongeCommon/blob/7eeea95c4b167d8bd728950e349e0bb9480090ba/src/main/java/org/spongepowered/common/entity/player/SpongeUser.java#L448-L451) and [here](https://github.com/SpongePowered/SpongeCommon/blob/7eeea95c4b167d8bd728950e349e0bb9480090ba/src/main/java/org/spongepowered/common/entity/player/SpongeUser.java#L469-L473)). So in the interests of getting fix in, I think we should change the calls as follows:\r\n\r\n```suggestion\r\n        dataHolder.bridge$setUncollideable(vanish && collision);\r\n        dataHolder.bridge$setUntargetable(vanish && untargetable);\r\n```\r\n\r\nbecause that's clearly the intention behind what's going on - even though I'm not 100% convinced it's what we should be doing in the wider notion, as I have talked about above.\r\n\r\nI would much rather have the `isUncolliable` methods renamed and updated to also consider vanish state, but I am more interested in having this fixed without having this stuck for ages because it's otherwise not good for our users.", "bodyText": "Okay, so I was looking about and thinking about previous discussions, and if vanish is false, the other two keys are removed from the user compound anyway (see here and here). So in the interests of getting fix in, I think we should change the calls as follows:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    dataHolder.bridge$setUncollideable(collision);\n          \n          \n            \n                    dataHolder.bridge$setUntargetable(untargetable);\n          \n          \n            \n                    dataHolder.bridge$setUncollideable(vanish && collision);\n          \n          \n            \n                    dataHolder.bridge$setUntargetable(vanish && untargetable);\n          \n      \n    \n    \n  \n\nbecause that's clearly the intention behind what's going on - even though I'm not 100% convinced it's what we should be doing in the wider notion, as I have talked about above.\nI would much rather have the isUncolliable methods renamed and updated to also consider vanish state, but I am more interested in having this fixed without having this stuck for ages because it's otherwise not good for our users.", "bodyHTML": "<p dir=\"auto\">Okay, so I was looking about and thinking about previous discussions, and if vanish is <code>false</code>, the other two keys are removed from the user compound anyway (<a href=\"https://github.com/SpongePowered/SpongeCommon/blob/7eeea95c4b167d8bd728950e349e0bb9480090ba/src/main/java/org/spongepowered/common/entity/player/SpongeUser.java#L448-L451\">see here</a> and <a href=\"https://github.com/SpongePowered/SpongeCommon/blob/7eeea95c4b167d8bd728950e349e0bb9480090ba/src/main/java/org/spongepowered/common/entity/player/SpongeUser.java#L469-L473\">here</a>). So in the interests of getting fix in, I think we should change the calls as follows:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        dataHolder<span class=\"pl-k\">.</span>bridge$setUncollideable(collision);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        dataHolder<span class=\"pl-k\">.</span>bridge$setUntargetable(untargetable);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        dataHolder<span class=\"pl-k\">.</span>bridge$setUncollideable(<span class=\"x x-first\">vanish </span><span class=\"pl-k x\">&amp;&amp;</span><span class=\"x x-last\"> </span>collision);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        dataHolder<span class=\"pl-k\">.</span>bridge$setUntargetable(<span class=\"x x-first\">vanish </span><span class=\"pl-k x\">&amp;&amp;</span><span class=\"x x-last\"> </span>untargetable);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">because that's clearly the intention behind what's going on - even though I'm not 100% convinced it's what we should be doing in the wider notion, as I have talked about above.</p>\n<p dir=\"auto\">I would much rather have the <code>isUncolliable</code> methods renamed and updated to also consider vanish state, but I am more interested in having this fixed without having this stuck for ages because it's otherwise not good for our users.</p>", "author": "dualspiral", "createdAt": "2020-05-07T14:17:48Z", "path": "src/main/java/org/spongepowered/common/data/processor/multi/entity/InvisibilityDataProcessor.java", "diffHunk": "@@ -67,13 +67,9 @@ protected boolean set(final VanishableBridge dataHolder, final Map<Key<?>, Objec\n         final boolean untargetable = (Boolean) keyValues.get(Keys.VANISH_PREVENTS_TARGETING);\n         final boolean vanish = (Boolean) keyValues.get(Keys.VANISH);\n         dataHolder.bridge$setInvisible(invis);\n-        if (vanish) {\n-            dataHolder.bridge$setVanished(true);\n-            dataHolder.bridge$setUncollideable(collision);\n-            dataHolder.bridge$setUntargetable(untargetable);\n-        } else {\n-            dataHolder.bridge$setVanished(false);\n-        }\n+        dataHolder.bridge$setVanished(vanish);\n+        dataHolder.bridge$setUncollideable(collision);\n+        dataHolder.bridge$setUntargetable(untargetable);", "originalCommit": "4d5c38b40d6febd9fd3ebcfe480b24d54107440f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15113ab67126126534b988be804c7a6f176fbed4", "url": "https://github.com/SpongePowered/Sponge/commit/15113ab67126126534b988be804c7a6f176fbed4", "message": "Update src/main/java/org/spongepowered/common/data/processor/multi/entity/InvisibilityDataProcessor.java\n\nCo-authored-by: Daniel Naylor <dualspiral@users.noreply.github.com>", "committedDate": "2020-05-09T15:57:41Z", "type": "commit"}]}