{"pr_number": 9580, "pr_title": "CB-10162 Add log message every time the FreeIPA status is checked", "pr_author": "christmasferret", "pr_createdAt": "2020-12-04T19:50:17Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9580", "timeline": [{"oid": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "url": "https://github.com/hortonworks/cloudbreak/commit/5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.", "committedDate": "2020-12-04T19:51:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1Njc2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536356760", "body": "I think the old way of looping outside of the `updateInstanceStatus()` was cleaner.", "bodyText": "I think the old way of looping outside of the updateInstanceStatus() was cleaner.", "bodyHTML": "<p dir=\"auto\">I think the old way of looping outside of the <code>updateInstanceStatus()</code> was cleaner.</p>", "author": "jamisonbennett", "createdAt": "2020-12-04T20:19:14Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -105,23 +105,28 @@ public void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         if (DetailedStackStatus.AVAILABLE == syncResult.getStatus()) {\n-                            for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {", "originalCommit": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTM3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536411373", "bodyText": "Thanks! I changed back to the old way of looping outside now and kept the method signature.", "author": "christmasferret", "createdAt": "2020-12-04T22:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1Njc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1NzIzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536357236", "body": "I am not sure what log level we should have for this. If debug output is enabled in prod, then it probably should be debug level.", "bodyText": "I am not sure what log level we should have for this. If debug output is enabled in prod, then it probably should be debug level.", "bodyHTML": "<p dir=\"auto\">I am not sure what log level we should have for this. If debug output is enabled in prod, then it probably should be debug level.</p>", "author": "jamisonbennett", "createdAt": "2020-12-04T20:20:11Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -105,23 +105,28 @@ public void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         if (DetailedStackStatus.AVAILABLE == syncResult.getStatus()) {\n-                            for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {\n-                                updateInstanceStatus(entry.getKey(), entry.getValue());\n-                            }\n-                            updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            String instanceStatusInfo = updateInstanceStatus(syncResult.getInstanceStatusMap());\n+                            String freeipaStatusInfo = updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            LOGGER.info(\":::Auto sync::: freeipa status from healtch check: \" + freeipaStatusInfo + instanceStatusInfo);", "originalCommit": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTc4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536411782", "bodyText": "Thanks! I changed to debug level.", "author": "christmasferret", "createdAt": "2020-12-04T22:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1NzIzNg=="}], "type": "inlineReview"}, {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "url": "https://github.com/hortonworks/cloudbreak/commit/8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.", "committedDate": "2020-12-04T21:49:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDE4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814186", "body": "`.toString()` is not necessary", "bodyText": ".toString() is not necessary", "bodyHTML": "<p dir=\"auto\"><code>.toString()</code> is not necessary</p>", "author": "lacikaaa", "createdAt": "2020-12-05T16:02:45Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -105,23 +105,31 @@ public void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         if (DetailedStackStatus.AVAILABLE == syncResult.getStatus()) {\n+                            StringBuilder allInstanceStatusInfo = new StringBuilder();\n                             for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {\n-                                updateInstanceStatus(entry.getKey(), entry.getValue());\n+                                allInstanceStatusInfo.append(updateInstanceStatus(entry.getKey(), entry.getValue()));\n                             }\n-                            updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            String freeipaStatusInfo = updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: \" + freeipaStatusInfo + allInstanceStatusInfo.toString());", "originalCommit": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814253", "body": "`.toString()` is not necessary", "bodyText": ".toString() is not necessary", "bodyHTML": "<p dir=\"auto\"><code>.toString()</code> is not necessary</p>", "author": "lacikaaa", "createdAt": "2020-12-05T16:03:16Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -131,23 +139,28 @@ public void syncAStack(Stack stack) {\n         }\n     }\n \n-    private void updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+    private String updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+        String instanceStatusInfo = \"\";\n         switch (detailedStackStatus) {\n             case AVAILABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.CREATED);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.CREATED.toString());", "originalCommit": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814262", "body": "`.toString()` is not necessary", "bodyText": ".toString() is not necessary", "bodyHTML": "<p dir=\"auto\"><code>.toString()</code> is not necessary</p>", "author": "lacikaaa", "createdAt": "2020-12-05T16:03:21Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -131,23 +139,28 @@ public void syncAStack(Stack stack) {\n         }\n     }\n \n-    private void updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+    private String updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+        String instanceStatusInfo = \"\";\n         switch (detailedStackStatus) {\n             case AVAILABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.CREATED);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.CREATED.toString());\n                 break;\n             case UNHEALTHY:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.UNHEALTHY);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.UNHEALTHY.toString());", "originalCommit": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814267", "body": "`.toString()` is not necessary", "bodyText": ".toString() is not necessary", "bodyHTML": "<p dir=\"auto\"><code>.toString()</code> is not necessary</p>", "author": "lacikaaa", "createdAt": "2020-12-05T16:03:25Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -131,23 +139,28 @@ public void syncAStack(Stack stack) {\n         }\n     }\n \n-    private void updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+    private String updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+        String instanceStatusInfo = \"\";\n         switch (detailedStackStatus) {\n             case AVAILABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.CREATED);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.CREATED.toString());\n                 break;\n             case UNHEALTHY:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.UNHEALTHY);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.UNHEALTHY.toString());\n                 break;\n             case UNREACHABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.UNREACHABLE);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.UNREACHABLE.toString());", "originalCommit": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814284", "body": "`.toString()` is not necessary", "bodyText": ".toString() is not necessary", "bodyHTML": "<p dir=\"auto\"><code>.toString()</code> is not necessary</p>", "author": "lacikaaa", "createdAt": "2020-12-05T16:03:32Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -162,6 +175,7 @@ private void updateStackStatus(Stack stack, SyncResult result, List<ProviderSync\n                         stack.getStackStatus().getDetailedStackStatus(), status);\n             }\n         }\n+        return String.format(\"freeipa %s is %s. \", stack.getResourceCrn(), status.getStatus().toString());", "originalCommit": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fe6cb09691ee64db692c7a16c025a8e7039af1c", "url": "https://github.com/hortonworks/cloudbreak/commit/7fe6cb09691ee64db692c7a16c025a8e7039af1c", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.", "committedDate": "2020-12-07T06:20:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY4MjUyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r537682529", "body": "for this to work right I think you have to fetch stack or stack status from db or you would have to modify `StackStatusCheckerJob#updateStackStatus` to return the modified stack and use that.\r\nYou could use `StackStatusService#findFirstByStackIdOrderByCreatedDesc` to fetch the current status.\r\nAlso resource crn logging shouldn't be necessary, the MDCContext should have all the filed set.", "bodyText": "for this to work right I think you have to fetch stack or stack status from db or you would have to modify StackStatusCheckerJob#updateStackStatus to return the modified stack and use that.\nYou could use StackStatusService#findFirstByStackIdOrderByCreatedDesc to fetch the current status.\nAlso resource crn logging shouldn't be necessary, the MDCContext should have all the filed set.", "bodyHTML": "<p dir=\"auto\">for this to work right I think you have to fetch stack or stack status from db or you would have to modify <code>StackStatusCheckerJob#updateStackStatus</code> to return the modified stack and use that.<br>\nYou could use <code>StackStatusService#findFirstByStackIdOrderByCreatedDesc</code> to fetch the current status.<br>\nAlso resource crn logging shouldn't be necessary, the MDCContext should have all the filed set.</p>", "author": "lacikaaa", "createdAt": "2020-12-07T17:18:28Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n+        String freeipaStatusInfo = String.format(\"freeipa %s is %s. \", stack.getResourceCrn(), stack.getStackStatus().getStatus());", "originalCommit": "7fe6cb09691ee64db692c7a16c025a8e7039af1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzOTYyNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r538639625", "bodyText": "Thanks! I added StackStatusService.java and StackStatusRepository.java just like those in cloudbreak-core for datalake stack. Currently we don't have StackStatusService for freeipa but it is just the same as datalake stack. Now I use findFirstByStackIdOrderByCreatedDesc to fetch stack status. Also now CRN is removed as it is already logged by MDC.", "author": "christmasferret", "createdAt": "2020-12-08T17:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY4MjUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5Mzg1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r537693850", "body": "I would suggest some refactor:\r\n```\r\n    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\r\n        String freeipaStatusInfo = String.format(\"freeipa %s is %s.\", stack.getResourceCrn(), stack.getStackStatus().getStatus());\r\n        String allInstanceStatusInfo = createInstancesStatusInfo(checkableInstances);\r\n        LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: {} {}\", freeipaStatusInfo, allInstanceStatusInfo);\r\n    }\r\n\r\n    private String createInstancesStatusInfo(Set<InstanceMetaData> checkableInstances) {\r\n        Set<InstanceMetaData> allInstanceMetaData = fetchCheckableInstancesFromDb(checkableInstances);\r\n        String allInstanceStatusInfo = allInstanceMetaData.stream().map(instance -> String.format(\"%s is %s\", instance.getInstanceId(),\r\n                instance.getInstanceStatus())).collect(Collectors.joining(\"; \"));\r\n        return allInstanceStatusInfo;\r\n    }\r\n\r\n    private Set<InstanceMetaData> fetchCheckableInstancesFromDb(Set<InstanceMetaData> checkableInstances) {\r\n        Set<String> checkableInstanceIds = collectCheckableInstanceIds(checkableInstances);\r\n        Set<InstanceMetaData> allInstanceMetaData = instanceMetaDataService\r\n                .getByInstanceIds(checkableInstanceIds);\r\n        return allInstanceMetaData;\r\n    }\r\n\r\n    private Set<String> collectCheckableInstanceIds(Set<InstanceMetaData> checkableInstances) {\r\n        return checkableInstances.stream()\r\n                .map(InstanceMetaData::getInstanceId)\r\n                .collect(Collectors.toSet());\r\n    }\r\n```\r\n\r\nthe main just next to breaking it into smaller parts that I have switched to stream and used the built in collector instead of creating a StringBuilder. Also I modified the log line and removed the trailing space from `freeipaStatusInfo`. It's a bit odd to add a space there.\r\nFeel free to modify the delimiter in joining, I just added something.\r\nPlease also note I haven't added the fix for the Stack status", "bodyText": "I would suggest some refactor:\n    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n        String freeipaStatusInfo = String.format(\"freeipa %s is %s.\", stack.getResourceCrn(), stack.getStackStatus().getStatus());\n        String allInstanceStatusInfo = createInstancesStatusInfo(checkableInstances);\n        LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: {} {}\", freeipaStatusInfo, allInstanceStatusInfo);\n    }\n\n    private String createInstancesStatusInfo(Set<InstanceMetaData> checkableInstances) {\n        Set<InstanceMetaData> allInstanceMetaData = fetchCheckableInstancesFromDb(checkableInstances);\n        String allInstanceStatusInfo = allInstanceMetaData.stream().map(instance -> String.format(\"%s is %s\", instance.getInstanceId(),\n                instance.getInstanceStatus())).collect(Collectors.joining(\"; \"));\n        return allInstanceStatusInfo;\n    }\n\n    private Set<InstanceMetaData> fetchCheckableInstancesFromDb(Set<InstanceMetaData> checkableInstances) {\n        Set<String> checkableInstanceIds = collectCheckableInstanceIds(checkableInstances);\n        Set<InstanceMetaData> allInstanceMetaData = instanceMetaDataService\n                .getByInstanceIds(checkableInstanceIds);\n        return allInstanceMetaData;\n    }\n\n    private Set<String> collectCheckableInstanceIds(Set<InstanceMetaData> checkableInstances) {\n        return checkableInstances.stream()\n                .map(InstanceMetaData::getInstanceId)\n                .collect(Collectors.toSet());\n    }\n\nthe main just next to breaking it into smaller parts that I have switched to stream and used the built in collector instead of creating a StringBuilder. Also I modified the log line and removed the trailing space from freeipaStatusInfo. It's a bit odd to add a space there.\nFeel free to modify the delimiter in joining, I just added something.\nPlease also note I haven't added the fix for the Stack status", "bodyHTML": "<p dir=\"auto\">I would suggest some refactor:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    public void logFreeipaStatus(Stack stack, Set&lt;InstanceMetaData&gt; checkableInstances) {\n        String freeipaStatusInfo = String.format(&quot;freeipa %s is %s.&quot;, stack.getResourceCrn(), stack.getStackStatus().getStatus());\n        String allInstanceStatusInfo = createInstancesStatusInfo(checkableInstances);\n        LOGGER.debug(&quot;:::Auto sync::: freeipa status from healtch check: {} {}&quot;, freeipaStatusInfo, allInstanceStatusInfo);\n    }\n\n    private String createInstancesStatusInfo(Set&lt;InstanceMetaData&gt; checkableInstances) {\n        Set&lt;InstanceMetaData&gt; allInstanceMetaData = fetchCheckableInstancesFromDb(checkableInstances);\n        String allInstanceStatusInfo = allInstanceMetaData.stream().map(instance -&gt; String.format(&quot;%s is %s&quot;, instance.getInstanceId(),\n                instance.getInstanceStatus())).collect(Collectors.joining(&quot;; &quot;));\n        return allInstanceStatusInfo;\n    }\n\n    private Set&lt;InstanceMetaData&gt; fetchCheckableInstancesFromDb(Set&lt;InstanceMetaData&gt; checkableInstances) {\n        Set&lt;String&gt; checkableInstanceIds = collectCheckableInstanceIds(checkableInstances);\n        Set&lt;InstanceMetaData&gt; allInstanceMetaData = instanceMetaDataService\n                .getByInstanceIds(checkableInstanceIds);\n        return allInstanceMetaData;\n    }\n\n    private Set&lt;String&gt; collectCheckableInstanceIds(Set&lt;InstanceMetaData&gt; checkableInstances) {\n        return checkableInstances.stream()\n                .map(InstanceMetaData::getInstanceId)\n                .collect(Collectors.toSet());\n    }\"><pre><code>    public void logFreeipaStatus(Stack stack, Set&lt;InstanceMetaData&gt; checkableInstances) {\n        String freeipaStatusInfo = String.format(\"freeipa %s is %s.\", stack.getResourceCrn(), stack.getStackStatus().getStatus());\n        String allInstanceStatusInfo = createInstancesStatusInfo(checkableInstances);\n        LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: {} {}\", freeipaStatusInfo, allInstanceStatusInfo);\n    }\n\n    private String createInstancesStatusInfo(Set&lt;InstanceMetaData&gt; checkableInstances) {\n        Set&lt;InstanceMetaData&gt; allInstanceMetaData = fetchCheckableInstancesFromDb(checkableInstances);\n        String allInstanceStatusInfo = allInstanceMetaData.stream().map(instance -&gt; String.format(\"%s is %s\", instance.getInstanceId(),\n                instance.getInstanceStatus())).collect(Collectors.joining(\"; \"));\n        return allInstanceStatusInfo;\n    }\n\n    private Set&lt;InstanceMetaData&gt; fetchCheckableInstancesFromDb(Set&lt;InstanceMetaData&gt; checkableInstances) {\n        Set&lt;String&gt; checkableInstanceIds = collectCheckableInstanceIds(checkableInstances);\n        Set&lt;InstanceMetaData&gt; allInstanceMetaData = instanceMetaDataService\n                .getByInstanceIds(checkableInstanceIds);\n        return allInstanceMetaData;\n    }\n\n    private Set&lt;String&gt; collectCheckableInstanceIds(Set&lt;InstanceMetaData&gt; checkableInstances) {\n        return checkableInstances.stream()\n                .map(InstanceMetaData::getInstanceId)\n                .collect(Collectors.toSet());\n    }\n</code></pre></div>\n<p dir=\"auto\">the main just next to breaking it into smaller parts that I have switched to stream and used the built in collector instead of creating a StringBuilder. Also I modified the log line and removed the trailing space from <code>freeipaStatusInfo</code>. It's a bit odd to add a space there.<br>\nFeel free to modify the delimiter in joining, I just added something.<br>\nPlease also note I haven't added the fix for the Stack status</p>", "author": "lacikaaa", "createdAt": "2020-12-07T17:34:04Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {", "originalCommit": "7fe6cb09691ee64db692c7a16c025a8e7039af1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzNjI3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r538636273", "bodyText": "Thanks a lot! I refactored and also added the fix for stack status.", "author": "christmasferret", "createdAt": "2020-12-08T17:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5Mzg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY0MzM1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r538643359", "bodyText": "Post the new log message here.\n2020-12-08 11:45:59,087 [quartzScheduler_Worker-1] logFreeipaStatus:31 DEBUG c.s.f.s.FreeipaStatusInfoLogger - [type:STACK] [crn:crn:cdp:freeipa:us-west-1:default:freeipa:e09e4a42-07f6-4298-a10f-6e031ab8217f] [name:yuwang-env2-15433-freeipa] [flow:] [requestid:7df9216c-d8cd-4ec9-be2b-bc8b762fd61b] [tenant:default] [userCrn:] [environment:crn:cdp:environments:us-west-1:default:environment:6298663a-49b4-43b2-97d7-c2bd74e67f77] [traceId:] [spanId:] [operationId:] :::Auto sync::: freeipa status from healtch check: freeipa stack is AVAILABLE. instance i-09ecf6806dd902fcc is CREATED; instance i-078af5be4d2eece5d is CREATED", "author": "christmasferret", "createdAt": "2020-12-08T17:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5Mzg1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5NjQ3Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r537696476", "body": "I think it might be saved via stack but I'm not sure. If you seen a missing status maybe it's best to save it here, but please test around with a few changes, even with HA when only one instance's status change to see if there is no issue. thanks", "bodyText": "I think it might be saved via stack but I'm not sure. If you seen a missing status maybe it's best to save it here, but please test around with a few changes, even with HA when only one instance's status change to see if there is no issue. thanks", "bodyHTML": "<p dir=\"auto\">I think it might be saved via stack but I'm not sure. If you seen a missing status maybe it's best to save it here, but please test around with a few changes, even with HA when only one instance's status change to see if there is no issue. thanks</p>", "author": "lacikaaa", "createdAt": "2020-12-07T17:37:48Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -189,6 +197,7 @@ private void setStatusIfNotTheSame(InstanceMetaData instanceMetaData, InstanceSt\n         if (instanceMetaData.getInstanceStatus() != newStatus) {\n             if (updateStatus) {\n                 instanceMetaData.setInstanceStatus(newStatus);\n+                instanceMetaDataService.save(instanceMetaData);", "originalCommit": "7fe6cb09691ee64db692c7a16c025a8e7039af1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzNTAxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r538635017", "bodyText": "Yes. My mistake. You are right. it is already saved via stack by cascading. The original code is working as it is. I confirmed in database and by debugging mode. I removed my change and kept it as before.", "author": "christmasferret", "createdAt": "2020-12-08T17:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5NjQ3Ng=="}], "type": "inlineReview"}, {"oid": "d7268571a35900a0116478c31972a0103f640c3f", "url": "https://github.com/hortonworks/cloudbreak/commit/d7268571a35900a0116478c31972a0103f640c3f", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.", "committedDate": "2020-12-08T17:24:32Z", "type": "forcePushed"}, {"oid": "c5e966c5044c0580810442775dacd01587e789fd", "url": "https://github.com/hortonworks/cloudbreak/commit/c5e966c5044c0580810442775dacd01587e789fd", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.", "committedDate": "2020-12-08T17:40:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MTg5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539171893", "body": "I think you could replace `Stack stack` with `Long stackId` as stack is only used for getting it's id", "bodyText": "I think you could replace Stack stack with Long stackId as stack is only used for getting it's id", "bodyHTML": "<p dir=\"auto\">I think you could replace <code>Stack stack</code> with <code>Long stackId</code> as stack is only used for getting it's id</p>", "author": "lacikaaa", "createdAt": "2020-12-09T10:04:55Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.StackStatus;\n+import com.sequenceiq.freeipa.service.stack.StackStatusService;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    @Inject\n+    private StackStatusService stackStatusService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {", "originalCommit": "c5e966c5044c0580810442775dacd01587e789fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM5MDMyMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539390323", "bodyText": "Thanks! Resolved.", "author": "christmasferret", "createdAt": "2020-12-09T15:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MTg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3Mjc3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539172771", "body": "it would be more readable if you break lines at stream methods, like `map` or/and `collect` instead of in the middle of `String.format`", "bodyText": "it would be more readable if you break lines at stream methods, like map or/and collect instead of in the middle of String.format", "bodyHTML": "<p dir=\"auto\">it would be more readable if you break lines at stream methods, like <code>map</code> or/and <code>collect</code> instead of in the middle of <code>String.format</code></p>", "author": "lacikaaa", "createdAt": "2020-12-09T10:06:10Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.StackStatus;\n+import com.sequenceiq.freeipa.service.stack.StackStatusService;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    @Inject\n+    private StackStatusService stackStatusService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n+        StackStatus freeipaStatus = stackStatusService.findFirstByStackIdOrderByCreatedDesc(stack.getId());\n+        String freeipaStatusInfo = String.format(\"freeipa stack is %s.\", freeipaStatus.getStatus());\n+        String allInstanceStatusInfo = createInstancesStatusInfo(checkableInstances);\n+        LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: {} {}\", freeipaStatusInfo, allInstanceStatusInfo);\n+    }\n+\n+    private String createInstancesStatusInfo(Set<InstanceMetaData> checkableInstances) {\n+        Set<InstanceMetaData> allInstanceMetaData = fetchCheckableInstancesFromDb(checkableInstances);\n+        String allInstanceStatusInfo = allInstanceMetaData.stream().map(instance -> String.format(\"instance %s is %s\", instance.getInstanceId(),", "originalCommit": "c5e966c5044c0580810442775dacd01587e789fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM5MDYwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539390609", "bodyText": "Thanks! Resolved.", "author": "christmasferret", "createdAt": "2020-12-09T15:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3Mjc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MjkyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539172921", "body": "unnecessary extra spaces", "bodyText": "unnecessary extra spaces", "bodyHTML": "<p dir=\"auto\">unnecessary extra spaces</p>", "author": "lacikaaa", "createdAt": "2020-12-09T10:06:26Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -108,7 +115,7 @@ public void syncAStack(Stack stack) {\n                             for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {\n                                 updateInstanceStatus(entry.getKey(), entry.getValue());\n                             }\n-                            updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            updateStackStatus(stack, syncResult, null,   alreadyDeletedCount);", "originalCommit": "c5e966c5044c0580810442775dacd01587e789fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM5MDcxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539390710", "bodyText": "Thanks! Resolved.", "author": "christmasferret", "createdAt": "2020-12-09T15:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MjkyMQ=="}], "type": "inlineReview"}, {"oid": "3e41142c39c50939c4a70f75234b3bcc8a708cc0", "url": "https://github.com/hortonworks/cloudbreak/commit/3e41142c39c50939c4a70f75234b3bcc8a708cc0", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.", "committedDate": "2020-12-09T15:12:25Z", "type": "commit"}, {"oid": "3e41142c39c50939c4a70f75234b3bcc8a708cc0", "url": "https://github.com/hortonworks/cloudbreak/commit/3e41142c39c50939c4a70f75234b3bcc8a708cc0", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.", "committedDate": "2020-12-09T15:12:25Z", "type": "forcePushed"}]}