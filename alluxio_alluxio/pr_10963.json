{"pr_number": 10963, "pr_title": "Cache the getWorkerInfoList results and refresh periodically", "pr_author": "LuQQiu", "pr_createdAt": "2020-02-20T22:44:00Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10963", "merge_commit": "d587b031c3ace1e5d915f73079ed6d363fca31f7", "timeline": [{"oid": "ffd70a4380636274aa9d345db9e64f06b2285bd7", "url": "https://github.com/Alluxio/alluxio/commit/ffd70a4380636274aa9d345db9e64f06b2285bd7", "message": "Cache the getWorkerInfoList results and refresh periodically", "committedDate": "2020-02-20T22:40:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwOTU3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382309575", "body": "```suggestion\r\n              + \"after being cached for this time period.\")\r\n```\r\n\r\nAlso, can you add what the implications may be if it is too short, and too long?", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          + \"after being cached for this time period. \")\n          \n          \n            \n                          + \"after being cached for this time period.\")\n          \n      \n    \n    \n  \n\nAlso, can you add what the implications may be if it is too short, and too long?", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">              <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>after being cached for this time period.<span class=\"x x-first x-last\"> </span><span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">              <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>after being cached for this time period.<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Also, can you add what the implications may be if it is too short, and too long?</p>", "author": "gpang", "createdAt": "2020-02-20T23:07:57Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2079,6 +2079,14 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.MASTER)\n               .build();\n+  public static final PropertyKey MASTER_WORKER_INFO_CACHE_REFRESH_TIME =\n+      new Builder(Name.MASTER_WORKER_INFO_CACHE_REFRESH_TIME)\n+          .setDefaultValue(\"10sec\")\n+          .setDescription(\"The worker information list will be refreshed \"\n+              + \"after being cached for this time period. \")", "originalCommit": "ffd70a4380636274aa9d345db9e64f06b2285bd7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7125ccaabdf6bcd42e41d788eccb63019d7ea796", "changed_code": [{"header": "diff --git a/core/common/src/main/java/alluxio/conf/PropertyKey.java b/core/common/src/main/java/alluxio/conf/PropertyKey.java\nindex 52bf0a16d1..187c4c442e 100644\n--- a/core/common/src/main/java/alluxio/conf/PropertyKey.java\n+++ b/core/common/src/main/java/alluxio/conf/PropertyKey.java\n", "chunk": "@@ -2083,7 +2083,7 @@ public final class PropertyKey implements Comparable<PropertyKey> {\n       new Builder(Name.MASTER_WORKER_INFO_CACHE_REFRESH_TIME)\n           .setDefaultValue(\"10sec\")\n           .setDescription(\"The worker information list will be refreshed \"\n-              + \"after being cached for this time period. \")\n+              + \"after being cached for this time period.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.MASTER)\n           .build();\n", "next_change": {"commit": "e87cd8567042e98597a652a5369a865fb4caaf72", "changed_code": [{"header": "diff --git a/core/common/src/main/java/alluxio/conf/PropertyKey.java b/core/common/src/main/java/alluxio/conf/PropertyKey.java\nindex 187c4c442e..de953c698b 100644\n--- a/core/common/src/main/java/alluxio/conf/PropertyKey.java\n+++ b/core/common/src/main/java/alluxio/conf/PropertyKey.java\n", "chunk": "@@ -2083,7 +2083,11 @@ public final class PropertyKey implements Comparable<PropertyKey> {\n       new Builder(Name.MASTER_WORKER_INFO_CACHE_REFRESH_TIME)\n           .setDefaultValue(\"10sec\")\n           .setDescription(\"The worker information list will be refreshed \"\n-              + \"after being cached for this time period.\")\n+              + \"after being cached for this time period. If the refresh time is too big, \"\n+              + \"operations on the job servers or clients may fail because of \"\n+              + \"the stale worker info. If it is too small, \"\n+              + \"continuously updating worker information may case lock contention \"\n+              + \"in the block master\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.MASTER)\n           .build();\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMDEzNg==", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382310136", "body": "Can we include the information from `e` in this exception message?", "bodyText": "Can we include the information from e in this exception message?", "bodyHTML": "<p dir=\"auto\">Can we include the information from <code>e</code> in this exception message?</p>", "author": "gpang", "createdAt": "2020-02-20T23:09:44Z", "path": "core/server/master/src/main/java/alluxio/master/block/DefaultBlockMaster.java", "diffHunk": "@@ -407,6 +431,14 @@ public long getUsedBytes() {\n     if (mSafeModeManager.isInSafeMode()) {\n       throw new UnavailableException(ExceptionMessage.MASTER_IN_SAFEMODE.getMessage());\n     }\n+    try {\n+      return mWorkerInfoCache.get(WORKER_INFO_CACHE_KEY);\n+    } catch (ExecutionException e) {\n+      throw new UnavailableException(\"Unable to get worker info list from cache\");", "originalCommit": "ffd70a4380636274aa9d345db9e64f06b2285bd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM3Mzg2NA==", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382373864", "bodyText": "Yeah, added the exception message", "author": "LuQQiu", "createdAt": "2020-02-21T02:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMDEzNg=="}], "type": "inlineReview", "revised_code": {"commit": "7125ccaabdf6bcd42e41d788eccb63019d7ea796", "changed_code": [{"header": "diff --git a/core/server/master/src/main/java/alluxio/master/block/DefaultBlockMaster.java b/core/server/master/src/main/java/alluxio/master/block/DefaultBlockMaster.java\nindex e7875b209d..6f36518d6a 100644\n--- a/core/server/master/src/main/java/alluxio/master/block/DefaultBlockMaster.java\n+++ b/core/server/master/src/main/java/alluxio/master/block/DefaultBlockMaster.java\n", "chunk": "@@ -434,7 +434,7 @@ public final class DefaultBlockMaster extends CoreMaster implements BlockMaster\n     try {\n       return mWorkerInfoCache.get(WORKER_INFO_CACHE_KEY);\n     } catch (ExecutionException e) {\n-      throw new UnavailableException(\"Unable to get worker info list from cache\");\n+      throw new UnavailableException(\"Unable to get worker info list from cache\", e);\n     }\n   }\n \n", "next_change": null}]}}, {"oid": "7125ccaabdf6bcd42e41d788eccb63019d7ea796", "url": "https://github.com/Alluxio/alluxio/commit/7125ccaabdf6bcd42e41d788eccb63019d7ea796", "message": "Fix tests", "committedDate": "2020-02-20T23:49:16Z", "type": "commit"}, {"oid": "e87cd8567042e98597a652a5369a865fb4caaf72", "url": "https://github.com/Alluxio/alluxio/commit/e87cd8567042e98597a652a5369a865fb4caaf72", "message": "Add property key description", "committedDate": "2020-02-21T03:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNzcyOQ==", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382737729", "body": "should all integration tests just use a shorter refresh time, like 20ms?", "bodyText": "should all integration tests just use a shorter refresh time, like 20ms?", "bodyHTML": "<p dir=\"auto\">should all integration tests just use a shorter refresh time, like 20ms?</p>", "author": "gpang", "createdAt": "2020-02-21T18:29:51Z", "path": "core/common/src/test/java/alluxio/ConfigurationTestUtils.java", "diffHunk": "@@ -140,6 +140,9 @@ public static InstancedConfiguration defaults() {\n     conf.put(PropertyKey.MASTER_PERSISTENCE_INITIAL_INTERVAL_MS, \"20ms\");\n     conf.put(PropertyKey.MASTER_PERSISTENCE_SCHEDULER_INTERVAL_MS, \"20ms\");\n \n+    // faster refresh\n+    conf.put(PropertyKey.MASTER_WORKER_INFO_CACHE_REFRESH_TIME, \"100ms\");", "originalCommit": "e87cd8567042e98597a652a5369a865fb4caaf72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1MzU4MA==", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382753580", "bodyText": "I am worried if the too frequent getWorkerInfoList calls will create locking contentions in integration tests.", "author": "LuQQiu", "createdAt": "2020-02-21T19:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNzcyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "81933bd207e6a683b602389feb35daaeb4c216b5", "changed_code": [{"header": "diff --git a/core/common/src/test/java/alluxio/ConfigurationTestUtils.java b/core/common/src/test/java/alluxio/ConfigurationTestUtils.java\nindex afe1a3a8fb..a3fc04f8c4 100644\n--- a/core/common/src/test/java/alluxio/ConfigurationTestUtils.java\n+++ b/core/common/src/test/java/alluxio/ConfigurationTestUtils.java\n", "chunk": "@@ -141,7 +141,7 @@ public final class ConfigurationTestUtils {\n     conf.put(PropertyKey.MASTER_PERSISTENCE_SCHEDULER_INTERVAL_MS, \"20ms\");\n \n     // faster refresh\n-    conf.put(PropertyKey.MASTER_WORKER_INFO_CACHE_REFRESH_TIME, \"100ms\");\n+    conf.put(PropertyKey.MASTER_WORKER_INFO_CACHE_REFRESH_TIME, \"20ms\");\n \n     return conf;\n   }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNzg4OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382737889", "body": "if the test config has a faster time, this doesn't have to be set, right?", "bodyText": "if the test config has a faster time, this doesn't have to be set, right?", "bodyHTML": "<p dir=\"auto\">if the test config has a faster time, this doesn't have to be set, right?</p>", "author": "gpang", "createdAt": "2020-02-21T18:30:10Z", "path": "tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java", "diffHunk": "@@ -174,7 +175,8 @@ public void asyncWriteNoEvictBeforeBlockCommit() throws Exception {\n       PropertyKey.Name.USER_FILE_PERSISTENCE_INITIAL_WAIT_TIME, \"1min\",\n       PropertyKey.Name.WORKER_MEMORY_SIZE, TINY_WORKER_MEM,\n       PropertyKey.Name.USER_BLOCK_SIZE_BYTES_DEFAULT, TINY_BLOCK_SIZE,\n-      PropertyKey.Name.USER_FILE_BUFFER_BYTES, \"8k\"\n+      PropertyKey.Name.USER_FILE_BUFFER_BYTES, \"8k\",\n+      PropertyKey.Name.MASTER_WORKER_INFO_CACHE_REFRESH_TIME, \"20ms\"", "originalCommit": "e87cd8567042e98597a652a5369a865fb4caaf72", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "81933bd207e6a683b602389feb35daaeb4c216b5", "changed_code": [{"header": "diff --git a/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java b/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java\nindex 9eca2c1cc1..63495069c1 100644\n--- a/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java\n+++ b/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java\n", "chunk": "@@ -176,7 +175,6 @@ public final class FileOutStreamAsyncWriteIntegrationTest\n       PropertyKey.Name.WORKER_MEMORY_SIZE, TINY_WORKER_MEM,\n       PropertyKey.Name.USER_BLOCK_SIZE_BYTES_DEFAULT, TINY_BLOCK_SIZE,\n       PropertyKey.Name.USER_FILE_BUFFER_BYTES, \"8k\",\n-      PropertyKey.Name.MASTER_WORKER_INFO_CACHE_REFRESH_TIME, \"20ms\"\n       })\n   public void asyncWriteNoEvict() throws Exception {\n     testLostAsyncBlocks();\n", "next_change": {"commit": "967c855351167a5aad3218e8e4f60060540d5a4d", "changed_code": [{"header": "diff --git a/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java b/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java\nindex 63495069c1..65525681ae 100644\n--- a/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java\n+++ b/tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java\n", "chunk": "@@ -174,7 +174,7 @@ public final class FileOutStreamAsyncWriteIntegrationTest\n       PropertyKey.Name.USER_FILE_PERSISTENCE_INITIAL_WAIT_TIME, \"1min\",\n       PropertyKey.Name.WORKER_MEMORY_SIZE, TINY_WORKER_MEM,\n       PropertyKey.Name.USER_BLOCK_SIZE_BYTES_DEFAULT, TINY_BLOCK_SIZE,\n-      PropertyKey.Name.USER_FILE_BUFFER_BYTES, \"8k\",\n+      PropertyKey.Name.USER_FILE_BUFFER_BYTES, \"8k\"\n       })\n   public void asyncWriteNoEvict() throws Exception {\n     testLostAsyncBlocks();\n", "next_change": null}]}}]}}, {"oid": "81933bd207e6a683b602389feb35daaeb4c216b5", "url": "https://github.com/Alluxio/alluxio/commit/81933bd207e6a683b602389feb35daaeb4c216b5", "message": "Change all the cache refresh time to 20ms", "committedDate": "2020-02-21T19:05:59Z", "type": "commit"}, {"oid": "967c855351167a5aad3218e8e4f60060540d5a4d", "url": "https://github.com/Alluxio/alluxio/commit/967c855351167a5aad3218e8e4f60060540d5a4d", "message": "Remove change for AsyncWriteIntegrationTest", "committedDate": "2020-02-21T23:16:59Z", "type": "commit"}, {"oid": "967c855351167a5aad3218e8e4f60060540d5a4d", "url": "https://github.com/Alluxio/alluxio/commit/967c855351167a5aad3218e8e4f60060540d5a4d", "message": "Remove change for AsyncWriteIntegrationTest", "committedDate": "2020-02-21T23:16:59Z", "type": "forcePushed"}, {"oid": "2a68b2d4d538aca56bf195baccf2035c513bb43c", "url": "https://github.com/Alluxio/alluxio/commit/2a68b2d4d538aca56bf195baccf2035c513bb43c", "message": "Merge remote-tracking branch 'upstream/master' into cacheGetWorker", "committedDate": "2020-02-22T00:04:58Z", "type": "commit"}]}