{"pr_number": 4059, "pr_title": "Improve Simplex and Perlin noise generators", "pr_author": "sin3point14", "pr_createdAt": "2020-06-21T13:40:12Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4059", "timeline": [{"oid": "d00c2e734f067f7514171d632f48034b1ccc24ee", "url": "https://github.com/MovingBlocks/Terasology/commit/d00c2e734f067f7514171d632f48034b1ccc24ee", "message": "modified simplex, perlin to allow variable perms", "committedDate": "2020-06-03T21:13:59Z", "type": "commit"}, {"oid": "367d3102d45756ef5192309db47e732ae6c4df76", "url": "https://github.com/MovingBlocks/Terasology/commit/367d3102d45756ef5192309db47e732ae6c4df76", "message": "Merge branch 'develop' of github.com:MovingBlocks/Terasology into develop", "committedDate": "2020-06-04T18:29:37Z", "type": "commit"}, {"oid": "07cc660c43ff75b34caf122d146c318b8765e1fe", "url": "https://github.com/MovingBlocks/Terasology/commit/07cc660c43ff75b34caf122d146c318b8765e1fe", "message": "Merge branch 'develop' of github.com:MovingBlocks/Terasology into develop", "committedDate": "2020-06-04T21:04:53Z", "type": "commit"}, {"oid": "00c1881f661e80fba4f36252e65aab337fd17eb1", "url": "https://github.com/MovingBlocks/Terasology/commit/00c1881f661e80fba4f36252e65aab337fd17eb1", "message": "perlin noise tileable", "committedDate": "2020-06-17T17:16:07Z", "type": "commit"}, {"oid": "38aced9bdffe71da3f83e3a6a50ec712436a40dd", "url": "https://github.com/MovingBlocks/Terasology/commit/38aced9bdffe71da3f83e3a6a50ec712436a40dd", "message": "add tileable noise support, docs", "committedDate": "2020-06-21T12:51:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTI0Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443235243", "body": "Is there a specific reason for writing `1 << 8` instead of `256`? Is the grid dimension required to be a power of 2?", "bodyText": "Is there a specific reason for writing 1 << 8 instead of 256? Is the grid dimension required to be a power of 2?", "bodyHTML": "<p dir=\"auto\">Is there a specific reason for writing <code>1 &lt;&lt; 8</code> instead of <code>256</code>? Is the grid dimension required to be a power of 2?</p>", "author": "skaldarnar", "createdAt": "2020-06-21T16:25:30Z", "path": "engine/src/main/java/org/terasology/utilities/procedural/PerlinNoise.java", "diffHunk": "@@ -27,38 +27,50 @@\n public class PerlinNoise extends AbstractNoise implements Noise2D, Noise3D {\n \n     private final int[] noisePermutations;\n+    private final int permCount;\n \n     /**\n      * Init. a new generator with a given seed value.\n      *\n      * @param seed The seed value\n      */\n     public PerlinNoise(long seed) {\n+        this(seed, 1 << 8);", "originalCommit": "38aced9bdffe71da3f83e3a6a50ec712436a40dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzODE5NQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443238195", "bodyText": "Ah nothing it think this is copypasta effects?\nAnyways fixing this", "author": "sin3point14", "createdAt": "2020-06-21T17:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTQzMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443235433", "body": "Why do we `floor` two times here, or what exactly does `floorMod` do? ", "bodyText": "Why do we floor two times here, or what exactly does floorMod do?", "bodyHTML": "<p dir=\"auto\">Why do we <code>floor</code> two times here, or what exactly does <code>floorMod</code> do?</p>", "author": "skaldarnar", "createdAt": "2020-06-21T16:28:11Z", "path": "engine/src/main/java/org/terasology/utilities/procedural/PerlinNoise.java", "diffHunk": "@@ -71,9 +83,9 @@ public PerlinNoise(long seed) {\n      */\n     @Override\n     public float noise(float posX, float posY, float posZ) {\n-        int xInt = (int) TeraMath.fastFloor(posX) & 255;\n-        int yInt = (int) TeraMath.fastFloor(posY) & 255;\n-        int zInt = (int) TeraMath.fastFloor(posZ) & 255;\n+        int xInt = Math.floorMod((int) TeraMath.fastFloor(posX), permCount);", "originalCommit": "38aced9bdffe71da3f83e3a6a50ec712436a40dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzODU2OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443238569", "bodyText": "% doesn't handle negative numbers well, for those cases floorMod is needed and fastFloor converts a float to int while always reducing it, casting to int will give issues- (int)-7.65 == -7 while -8 is needed here", "author": "sin3point14", "createdAt": "2020-06-21T17:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzODkyMg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443238922", "bodyText": "ok in the simplex implementation I found the better version to use here floorToInt, swapping it in", "author": "sin3point14", "createdAt": "2020-06-21T17:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTQ5Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443235493", "body": "Typo\r\n```suggestion\r\n    public SimplexNoise(long seed, int gridDim) {\r\n```", "bodyText": "Typo\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public SimplexNoise(long seed, int girdDim) {\n          \n          \n            \n                public SimplexNoise(long seed, int gridDim) {", "bodyHTML": "<p dir=\"auto\">Typo</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> SimplexNoise(<span class=\"pl-k\">long</span> seed, <span class=\"pl-k\">int</span> <span class=\"x x-first x-last\">girdDim</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> SimplexNoise(<span class=\"pl-k\">long</span> seed, <span class=\"pl-k\">int</span> <span class=\"x x-first x-last\">gridDim</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "skaldarnar", "createdAt": "2020-06-21T16:29:07Z", "path": "engine/src/main/java/org/terasology/utilities/procedural/SimplexNoise.java", "diffHunk": "@@ -62,42 +62,57 @@\n     private static final float F4 = ((float) Math.sqrt(5.0f) - 1.0f) / 4.0f;\n     private static final float G4 = (5.0f - (float) Math.sqrt(5.0f)) / 20.0f;\n \n-    private final short[] perm = new short[512];\n-    private final short[] permMod12 = new short[512];\n+    private final short[] perm;\n+    private final short[] permMod12;\n+    private final int permCount;\n \n     /**\n-     * Initialize permutations with a given seed\n+     * Multiply this with the gridDim provided and noise(x,x) will give tileable 1D noise which will tile\n+     * when x crosses a multiple of (this * gridDim)\n+     */\n+    public final float tileable1DMagicNumber = 0.5773502691896258f;\n+\n+    /**\n+     * Initialize permutations with a given seed and grid dimension.\n+     * Supports 1D tileable noise\n+     * @see SimplexNoise#tileable1DMagicNumber\n      *\n      * @param seed a seed value used for permutation shuffling\n+     * @param gridDim gridDim x gridDim will be the number of squares in the square grid formed after skewing the simplices belonging to once \"tile\"\n      */\n     public SimplexNoise(long seed) {\n+        this(seed, 8);\n+    }\n+\n+    public SimplexNoise(long seed, int girdDim) {", "originalCommit": "38aced9bdffe71da3f83e3a6a50ec712436a40dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTUyNw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443235527", "body": "Why does Perlin noise have a grid dimension of `1 << 8` and Simplex noise a grid dimension of `8`?", "bodyText": "Why does Perlin noise have a grid dimension of 1 << 8 and Simplex noise a grid dimension of 8?", "bodyHTML": "<p dir=\"auto\">Why does Perlin noise have a grid dimension of <code>1 &lt;&lt; 8</code> and Simplex noise a grid dimension of <code>8</code>?</p>", "author": "skaldarnar", "createdAt": "2020-06-21T16:29:38Z", "path": "engine/src/main/java/org/terasology/utilities/procedural/SimplexNoise.java", "diffHunk": "@@ -62,42 +62,57 @@\n     private static final float F4 = ((float) Math.sqrt(5.0f) - 1.0f) / 4.0f;\n     private static final float G4 = (5.0f - (float) Math.sqrt(5.0f)) / 20.0f;\n \n-    private final short[] perm = new short[512];\n-    private final short[] permMod12 = new short[512];\n+    private final short[] perm;\n+    private final short[] permMod12;\n+    private final int permCount;\n \n     /**\n-     * Initialize permutations with a given seed\n+     * Multiply this with the gridDim provided and noise(x,x) will give tileable 1D noise which will tile\n+     * when x crosses a multiple of (this * gridDim)\n+     */\n+    public final float tileable1DMagicNumber = 0.5773502691896258f;\n+\n+    /**\n+     * Initialize permutations with a given seed and grid dimension.\n+     * Supports 1D tileable noise\n+     * @see SimplexNoise#tileable1DMagicNumber\n      *\n      * @param seed a seed value used for permutation shuffling\n+     * @param gridDim gridDim x gridDim will be the number of squares in the square grid formed after skewing the simplices belonging to once \"tile\"\n      */\n     public SimplexNoise(long seed) {\n+        this(seed, 8);", "originalCommit": "38aced9bdffe71da3f83e3a6a50ec712436a40dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzODYxNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443238616", "bodyText": "Oh this was a bad miss, fixing this rn thanks!", "author": "sin3point14", "createdAt": "2020-06-21T17:09:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTY0OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443235649", "body": "In the Perlin implementation you did some combination of `floorMod` and `floor`  - why is a simple modulo operation sufficient here, and why is it not sufficient in Perlin implementation?", "bodyText": "In the Perlin implementation you did some combination of floorMod and floor  - why is a simple modulo operation sufficient here, and why is it not sufficient in Perlin implementation?", "bodyHTML": "<p dir=\"auto\">In the Perlin implementation you did some combination of <code>floorMod</code> and <code>floor</code>  - why is a simple modulo operation sufficient here, and why is it not sufficient in Perlin implementation?</p>", "author": "skaldarnar", "createdAt": "2020-06-21T16:30:48Z", "path": "engine/src/main/java/org/terasology/utilities/procedural/SimplexNoise.java", "diffHunk": "@@ -154,8 +169,8 @@ public float noise(float xin, float yin) {\n         float y2 = y0 - 1.0f + 2.0f * G2;\n \n         // Work out the hashed gradient indices of the three simplex corners\n-        int ii = i & 255;\n-        int jj = j & 255;\n+        int ii = i % permCount;", "originalCommit": "38aced9bdffe71da3f83e3a6a50ec712436a40dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0Mjg4NQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4059#discussion_r443242885", "bodyText": "oh I thought that here i, j are positive integers but on second look I can see that this is problematic, fixed this", "author": "sin3point14", "createdAt": "2020-06-21T18:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzNTY0OQ=="}], "type": "inlineReview"}, {"oid": "1e0ffa140e15051004a1f74c31d160c962121517", "url": "https://github.com/MovingBlocks/Terasology/commit/1e0ffa140e15051004a1f74c31d160c962121517", "message": "typo fixes, incorrect modulo operator usage fixed", "committedDate": "2020-06-21T19:37:57Z", "type": "commit"}, {"oid": "1e0ffa140e15051004a1f74c31d160c962121517", "url": "https://github.com/MovingBlocks/Terasology/commit/1e0ffa140e15051004a1f74c31d160c962121517", "message": "typo fixes, incorrect modulo operator usage fixed", "committedDate": "2020-06-21T19:37:57Z", "type": "forcePushed"}, {"oid": "f20386cde63a68d841e877d41e4ce595ce8260d6", "url": "https://github.com/MovingBlocks/Terasology/commit/f20386cde63a68d841e877d41e4ce595ce8260d6", "message": "Update .idea/misc.xml\n\nCo-authored-by: Michael Pollind <mpollind@gmail.com>", "committedDate": "2020-06-24T04:35:06Z", "type": "commit"}]}