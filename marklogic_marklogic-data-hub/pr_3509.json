{"pr_number": 3509, "pr_title": "DHFPROD-4095: Provide role information and better error output on login to UI", "pr_author": "ryanjdew", "pr_createdAt": "2020-01-27T18:33:43Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3509", "timeline": [{"oid": "f1305eb6fb34b989023422a53aca5523360ffaf7", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f1305eb6fb34b989023422a53aca5523360ffaf7", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-27T18:36:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ4NTExNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371485116", "body": "This seems brittle - an \"instanceof\" check like below would be a lot better - more reliable and self-documenting. Can the custom code that creates this message throw a better exception for this class to catch?", "bodyText": "This seems brittle - an \"instanceof\" check like below would be a lot better - more reliable and self-documenting. Can the custom code that creates this message throw a better exception for this class to catch?", "bodyHTML": "<p dir=\"auto\">This seems brittle - an \"instanceof\" check like below would be a lot better - more reliable and self-documenting. Can the custom code that creates this message throw a better exception for this class to catch?</p>", "author": "rjrudin", "createdAt": "2020-01-27T21:13:02Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginFailureHandler.java", "diffHunk": "@@ -40,7 +41,13 @@ public void onAuthenticationFailure(HttpServletRequest request, HttpServletRespo\n         String json = new Gson().toJson(output);\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+        if (exception.getMessage().contains(\"Cannot connect to MarkLogic\")) {", "originalCommit": "f1305eb6fb34b989023422a53aca5523360ffaf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk0NDU2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371944560", "bodyText": "changed to use instanceof BadRequestException", "author": "ryanjdew", "createdAt": "2020-01-28T17:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ4NTExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5ODAwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371598001", "body": "https://github.com/marklogic/marklogic-data-hub/blob/f1305eb6fb34b989023422a53aca5523360ffaf7/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java#L49\r\n\r\nSince we autowired the hubConfigSession, we do not need to access it through authentication token.", "bodyText": "marklogic-data-hub/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\n    \n    \n         Line 49\n      in\n      f1305eb\n    \n    \n    \n    \n\n        \n          \n           RolesService rolesService = RolesService.on(authenticationToken.getHubConfigSession().newStagingClient()); \n        \n    \n  \n\n\nSince we autowired the hubConfigSession, we do not need to access it through authentication token.", "bodyHTML": "<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/marklogic/marklogic-data-hub/blob/f1305eb6fb34b989023422a53aca5523360ffaf7/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java#L49\">marklogic-data-hub/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 49\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/marklogic/marklogic-data-hub/commit/f1305eb6fb34b989023422a53aca5523360ffaf7\">f1305eb</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L49\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"49\"></td>\n          <td id=\"LC49\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">RolesService</span> rolesService <span class=\"pl-k\">=</span> <span class=\"pl-smi\">RolesService</span><span class=\"pl-k\">.</span>on(authenticationToken<span class=\"pl-k\">.</span>getHubConfigSession()<span class=\"pl-k\">.</span>newStagingClient()); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">Since we autowired the hubConfigSession, we do not need to access it through authentication token.</p>", "author": "hao1st", "createdAt": "2020-01-28T03:48:07Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java", "diffHunk": "@@ -27,14 +33,24 @@\n import java.io.IOException;\n \n public class LoginLogoutHandler implements AuthenticationSuccessHandler, LogoutSuccessHandler {\n+    @Autowired\n+    HubConfigSession hubConfigSession;\n+\n+    ObjectMapper mapper = new ObjectMapper();\n \n     @Override\n     public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException {\n         ConnectionAuthenticationToken authenticationToken = (ConnectionAuthenticationToken)authentication;\n-\n+        ObjectNode output = mapper.createObjectNode();\n         clearAuthenticationAttributes(request);\n+        output.put(\"isInstalled\", authenticationToken.stagingIsAccessible());\n+        output.put(\"hasManagePrivileges\", authenticationToken.hasManagePrivileges());\n+        if (authenticationToken.stagingIsAccessible()) {\n+            RolesService rolesService = RolesService.on(authenticationToken.getHubConfigSession().newStagingClient());", "originalCommit": "f1305eb6fb34b989023422a53aca5523360ffaf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk0MzA5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371943093", "bodyText": "I should remove the autowired hubConfig. I was getting a null hubConfig when I tried to use the autowired version.", "author": "ryanjdew", "createdAt": "2020-01-28T17:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5ODAwMQ=="}], "type": "inlineReview"}, {"oid": "7211bf0fa27624a068a4078ae0f099d7dab5c7db", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7211bf0fa27624a068a4078ae0f099d7dab5c7db", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T06:18:20Z", "type": "forcePushed"}, {"oid": "f8eda555c809876d68372320bc9c6a473eca5007", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f8eda555c809876d68372320bc9c6a473eca5007", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T17:23:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk2MDEzMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371960130", "body": "I recommend tucking the original exception in here (as a 2nd argument to the constructor), just in case. It may be useful to at least see the message. ", "bodyText": "I recommend tucking the original exception in here (as a 2nd argument to the constructor), just in case. It may be useful to at least see the message.", "bodyHTML": "<p dir=\"auto\">I recommend tucking the original exception in here (as a 2nd argument to the constructor), just in case. It may be useful to at least see the message.</p>", "author": "rjrudin", "createdAt": "2020-01-28T17:50:58Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java", "diffHunk": "@@ -88,7 +90,7 @@ public Authentication authenticate(Authentication authentication) throws Authent\n             hasManagePrivileges = true;\n         }\n         catch(ResourceAccessException ex) {\n-            throw new BadCredentialsException(\"Cannot connect to MarkLogic at \" + environmentInfo.mlHost + \". Are you sure MarkLogic is running?\");\n+            throw new BadRequestException(\"Cannot connect to MarkLogic at \" + environmentInfo.mlHost + \". Are you sure MarkLogic is running?\");", "originalCommit": "f8eda555c809876d68372320bc9c6a473eca5007", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7ff6962cc96f783eb3ff01641359ba6e49e36d0b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7ff6962cc96f783eb3ff01641359ba6e49e36d0b", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T19:00:46Z", "type": "forcePushed"}, {"oid": "dd4d6e9beb39508bf111e3d7fdb7c3a6a1b6d8e2", "url": "https://github.com/marklogic/marklogic-data-hub/commit/dd4d6e9beb39508bf111e3d7fdb7c3a6a1b6d8e2", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T22:59:21Z", "type": "forcePushed"}, {"oid": "16750b240901928335aca170799e27bb2e928a98", "url": "https://github.com/marklogic/marklogic-data-hub/commit/16750b240901928335aca170799e27bb2e928a98", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-29T05:21:19Z", "type": "commit"}, {"oid": "16750b240901928335aca170799e27bb2e928a98", "url": "https://github.com/marklogic/marklogic-data-hub/commit/16750b240901928335aca170799e27bb2e928a98", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-29T05:21:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyODM0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r372228344", "body": "i think we should not ignore the exception after checking the internal implementation of checkConnection().\r\n\r\n```suggestion\r\n    DatabaseClient.ConnectionResult connResult;\r\n    try {\r\n      connResult = dataServicesClient.checkConnection();\r\n    } catch (Exception e) {\r\n      throw new BadRequestException(e.getMessage());\r\n    }\r\n\r\n    if (connResult != null && !connResult.isConnected()) {\r\n      if (connResult.getStatusCode() != null && connResult.getStatusCode() == 401) {\r\n        throw new BadCredentialsException(connResult.getErrorMessage());\r\n      } else {\r\n        throw new BadRequestException(connResult.getErrorMessage());\r\n      }\r\n    }\r\n```", "bodyText": "i think we should not ignore the exception after checking the internal implementation of checkConnection().\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Exception ignored) {\n          \n          \n            \n                DatabaseClient.ConnectionResult connResult;\n          \n          \n            \n                try {\n          \n          \n            \n                  connResult = dataServicesClient.checkConnection();\n          \n          \n            \n                } catch (Exception e) {\n          \n          \n            \n                  throw new BadRequestException(e.getMessage());\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                if (connResult != null && !connResult.isConnected()) {\n          \n          \n            \n                  if (connResult.getStatusCode() != null && connResult.getStatusCode() == 401) {\n          \n          \n            \n                    throw new BadCredentialsException(connResult.getErrorMessage());\n          \n          \n            \n                  } else {\n          \n          \n            \n                    throw new BadRequestException(connResult.getErrorMessage());\n          \n          \n            \n                  }\n          \n          \n            \n                }", "bodyHTML": "<p dir=\"auto\">i think we should not ignore the exception after checking the internal implementation of checkConnection().</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"112\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"x x-first\">    } </span><span class=\"pl-k x\">catch</span><span class=\"x\"> (</span><span class=\"pl-smi x\">Exception</span><span class=\"x x-last\"> ignored) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"112\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-smi x x-first\">DatabaseClient</span><span class=\"pl-k x\">.</span><span class=\"pl-smi x\">ConnectionResult</span><span class=\"x x-last\"> connResult;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"113\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"114\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      connResult <span class=\"pl-k\">=</span> dataServicesClient<span class=\"pl-k\">.</span>checkConnection();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"115\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">Exception</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"116\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">BadRequestException</span>(e<span class=\"pl-k\">.</span>getMessage());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"117\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"118\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"119\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (connResult <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>connResult<span class=\"pl-k\">.</span>isConnected()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"120\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">if</span> (connResult<span class=\"pl-k\">.</span>getStatusCode() <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> connResult<span class=\"pl-k\">.</span>getStatusCode() <span class=\"pl-k\">==</span> <span class=\"pl-c1\">401</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"121\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">BadCredentialsException</span>(connResult<span class=\"pl-k\">.</span>getErrorMessage());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"122\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"123\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">BadRequestException</span>(connResult<span class=\"pl-k\">.</span>getErrorMessage());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"124\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"125\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hao1st", "createdAt": "2020-01-29T07:40:58Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java", "diffHunk": "@@ -107,10 +109,13 @@ public Authentication authenticate(Authentication authentication) throws Authent\n         boolean stagingServerAccessible = false;\n         try {\n             stagingServerAccessible = dataServicesClient.checkConnection().isConnected();\n-        } catch (Exception e) {\n+        } catch (Exception ignored) {", "originalCommit": "16750b240901928335aca170799e27bb2e928a98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyOTMwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r372229303", "body": "we do not need to check stagingServerAccessible because it is a flag to indicate connection status.", "bodyText": "we do not need to check stagingServerAccessible because it is a flag to indicate connection status.", "bodyHTML": "<p dir=\"auto\">we do not need to check stagingServerAccessible because it is a flag to indicate connection status.</p>", "author": "hao1st", "createdAt": "2020-01-29T07:43:59Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java", "diffHunk": "@@ -107,10 +109,13 @@ public Authentication authenticate(Authentication authentication) throws Authent\n         boolean stagingServerAccessible = false;\n         try {\n             stagingServerAccessible = dataServicesClient.checkConnection().isConnected();\n-        } catch (Exception e) {\n+        } catch (Exception ignored) {\n+        }\n+        if (!(hasManagePrivileges || stagingServerAccessible)) {", "originalCommit": "16750b240901928335aca170799e27bb2e928a98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}