{"pr_number": 3273, "pr_title": "[Drools 5867] - Update ApplyPmmlModelCommand to manage both PMML implementations", "pr_author": "gitgabrio", "pr_createdAt": "2020-12-01T15:49:31Z", "pr_url": "https://github.com/kiegroup/drools/pull/3273", "timeline": [{"oid": "fd9fb49676916991a226ebba832e010596d262a0", "url": "https://github.com/kiegroup/drools/commit/fd9fb49676916991a226ebba832e010596d262a0", "message": "[DROOLS-5867] Implemented PMMLCommandExecutorImpl and PMMLCommandExecutorFactoryImpl. Updated kie.conf", "committedDate": "2020-12-01T11:41:58Z", "type": "commit"}, {"oid": "0b82658497c393983db1c14e1f9aaac486796683", "url": "https://github.com/kiegroup/drools/commit/0b82658497c393983db1c14e1f9aaac486796683", "message": "[DROOLS-5867] Using static method inside PMMLAssemblerServices. Fixed kie.conf", "committedDate": "2020-12-01T13:56:00Z", "type": "commit"}, {"oid": "7fdd09e1fd8fc9a464846d8ab81e5c15ad5a4e12", "url": "https://github.com/kiegroup/drools/commit/7fdd09e1fd8fc9a464846d8ab81e5c15ad5a4e12", "message": "[DROOLS-5867] Update for PMMLImplementationsUtil refactoring", "committedDate": "2020-12-01T15:21:44Z", "type": "commit"}, {"oid": "9c9fee325aa2a7f2ed7794efc6b067b1236471a5", "url": "https://github.com/kiegroup/drools/commit/9c9fee325aa2a7f2ed7794efc6b067b1236471a5", "message": "[DROOLS-5867] Implemented/updated ApplyPmmlModelCommand and related test. Cleanup.", "committedDate": "2020-12-01T15:42:46Z", "type": "commit"}, {"oid": "dea58dac5fe8cfac7930f4596967d977179147b9", "url": "https://github.com/kiegroup/drools/commit/dea58dac5fe8cfac7930f4596967d977179147b9", "message": "[DROOLS-5867] Retrieving Classloader from Context.", "committedDate": "2020-12-02T10:18:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3NTYyNg==", "url": "https://github.com/kiegroup/drools/pull/3273#discussion_r534075626", "body": "\r\nWhat about something similar to\r\n```suggestion\r\n        try {\r\n            KieSession kieSession = registryContext.lookup(KieSession.class);\r\n            InternalKnowledgeBase kieBase = (InternalKnowledgeBase) kieSession.getKieBase();\r\n            return kieBase.getRootClassLoader();\r\n        catch (Exception e) {\r\n            logger.warn(\"Impossible to retrieve RootClassLoader, using ContextClassLoader [\" + e.getMessage() + \"]\", e);\r\n            return Thread.currentThread().getContextClassLoader();\r\n        }\r\n```", "bodyText": "What about something similar to\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    KieSession kieSession = registryContext.lookup(KieSession.class);\n          \n          \n            \n                    InternalKnowledgeBase kieBase = (InternalKnowledgeBase) kieSession.getKieBase();\n          \n          \n            \n                    return kieBase.getRootClassLoader();\n          \n          \n            \n                    try {\n          \n          \n            \n                        KieSession kieSession = registryContext.lookup(KieSession.class);\n          \n          \n            \n                        InternalKnowledgeBase kieBase = (InternalKnowledgeBase) kieSession.getKieBase();\n          \n          \n            \n                        return kieBase.getRootClassLoader();\n          \n          \n            \n                    catch (Exception e) {\n          \n          \n            \n                        logger.warn(\"Impossible to retrieve RootClassLoader, using ContextClassLoader [\" + e.getMessage() + \"]\", e);\n          \n          \n            \n                        return Thread.currentThread().getContextClassLoader();\n          \n          \n            \n                    }", "bodyHTML": "<p dir=\"auto\">What about something similar to</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">KieSession</span> kieSession <span class=\"pl-k\">=</span> registryContext<span class=\"pl-k\">.</span>lookup(<span class=\"pl-smi\">KieSession</span><span class=\"pl-k\">.</span>class);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">InternalKnowledgeBase</span> kieBase <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">InternalKnowledgeBase</span>) kieSession<span class=\"pl-k\">.</span>getKieBase();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> kieBase<span class=\"pl-k\">.</span>getRootClassLoader();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">KieSession</span> kieSession <span class=\"pl-k\">=</span> registryContext<span class=\"pl-k\">.</span>lookup(<span class=\"pl-smi\">KieSession</span><span class=\"pl-k\">.</span>class);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">InternalKnowledgeBase</span> kieBase <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">InternalKnowledgeBase</span>) kieSession<span class=\"pl-k\">.</span>getKieBase();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span> kieBase<span class=\"pl-k\">.</span>getRootClassLoader();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">Exception</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            logger<span class=\"pl-k\">.</span>warn(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Impossible to retrieve RootClassLoader, using ContextClassLoader [<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> e<span class=\"pl-k\">.</span>getMessage() <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>]<span class=\"pl-pds\">\"</span></span>, e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span> <span class=\"pl-smi\">Thread</span><span class=\"pl-k\">.</span>currentThread()<span class=\"pl-k\">.</span>getContextClassLoader();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "danielezonca", "createdAt": "2020-12-02T10:55:12Z", "path": "drools-core/src/main/java/org/drools/core/command/runtime/pmml/ApplyPmmlModelCommand.java", "diffHunk": "@@ -119,6 +127,36 @@ public void setOutIdentifier(String outIdentifier) {\n     \n     @Override\n     public PMML4Result execute(Context context) {\n+        if (requestData == null) {\n+            throw new IllegalStateException(\"ApplyPmmlModelCommand requires request data (PMMLRequestData) to execute\");\n+        }\n+        final PMMLConstants toInvoke = getToInvoke(context);\n+        switch (toInvoke) {\n+            case NEW:\n+                return executePMMLTrusty();\n+            case LEGACY:\n+                return executePMMLLegacy(context);\n+            default:\n+                throw new RuntimeException(\"Unmanaged PMMLConstants \" + toInvoke);\n+        }\n+    }\n+\n+    protected PMMLConstants getToInvoke(Context context) {\n+        ClassLoader classLoader = getClassLoader((RegistryContext)context);\n+        return toEnable(classLoader);\n+    }\n+\n+    private ClassLoader getClassLoader(RegistryContext registryContext) {\n+        KieSession kieSession = registryContext.lookup(KieSession.class);\n+        InternalKnowledgeBase kieBase = (InternalKnowledgeBase) kieSession.getKieBase();\n+        return kieBase.getRootClassLoader();", "originalCommit": "dea58dac5fe8cfac7930f4596967d977179147b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzMDEzNA==", "url": "https://github.com/kiegroup/drools/pull/3273#discussion_r534230134", "bodyText": "@danielezonca\nDone", "author": "gitgabrio", "createdAt": "2020-12-02T14:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3NTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3NjYxMw==", "url": "https://github.com/kiegroup/drools/pull/3273#discussion_r534076613", "body": "Please don't use `Test` suffix otherwise Maven will consider this class as a test class and try to load. What about `Mock` instead?", "bodyText": "Please don't use Test suffix otherwise Maven will consider this class as a test class and try to load. What about Mock instead?", "bodyHTML": "<p dir=\"auto\">Please don't use <code>Test</code> suffix otherwise Maven will consider this class as a test class and try to load. What about <code>Mock</code> instead?</p>", "author": "danielezonca", "createdAt": "2020-12-02T10:56:46Z", "path": "drools-ruleunit/src/test/java/org/drools/ruleunit/command/pmml/mock/PMMLCommandExecutorFactoryTest.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.drools.ruleunit.command.pmml.mock;\n+\n+import org.kie.internal.pmml.PMMLCommandExecutor;\n+import org.kie.internal.pmml.PMMLCommandExecutorFactory;\n+\n+public class PMMLCommandExecutorFactoryTest implements PMMLCommandExecutorFactory {", "originalCommit": "dea58dac5fe8cfac7930f4596967d977179147b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzMDI0MQ==", "url": "https://github.com/kiegroup/drools/pull/3273#discussion_r534230241", "bodyText": "@danielezonca\nDone", "author": "gitgabrio", "createdAt": "2020-12-02T14:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3NjYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3NjcyOA==", "url": "https://github.com/kiegroup/drools/pull/3273#discussion_r534076728", "body": "Same as above", "bodyText": "Same as above", "bodyHTML": "<p dir=\"auto\">Same as above</p>", "author": "danielezonca", "createdAt": "2020-12-02T10:56:56Z", "path": "drools-ruleunit/src/test/java/org/drools/ruleunit/command/pmml/mock/PMMLCommandExecutorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.drools.ruleunit.command.pmml.mock;\n+\n+import org.kie.api.pmml.PMML4Result;\n+import org.kie.api.pmml.PMMLRequestData;\n+import org.kie.internal.pmml.PMMLCommandExecutor;\n+\n+public class PMMLCommandExecutorTest implements PMMLCommandExecutor {", "originalCommit": "dea58dac5fe8cfac7930f4596967d977179147b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzMDQyMA==", "url": "https://github.com/kiegroup/drools/pull/3273#discussion_r534230420", "bodyText": "@danielezonca\nDone", "author": "gitgabrio", "createdAt": "2020-12-02T14:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3NjcyOA=="}], "type": "inlineReview"}, {"oid": "daddc2d66c0789eea87838e1af0d4d53004abe67", "url": "https://github.com/kiegroup/drools/commit/daddc2d66c0789eea87838e1af0d4d53004abe67", "message": "[DROOLS-5867] Fixed as per PR requests", "committedDate": "2020-12-02T14:54:50Z", "type": "commit"}, {"oid": "977a71dc075d79d637add733de0a4614bac05c6b", "url": "https://github.com/kiegroup/drools/commit/977a71dc075d79d637add733de0a4614bac05c6b", "message": "Merge remote-tracking branch 'origin/master' into DROOLS-5867", "committedDate": "2020-12-03T09:12:22Z", "type": "commit"}, {"oid": "df204d7489d4cdf7c34ec10bc64e6de733424e54", "url": "https://github.com/kiegroup/drools/commit/df204d7489d4cdf7c34ec10bc64e6de733424e54", "message": "[DROOLS-5867] Fixing as per SONAR suggestion", "committedDate": "2020-12-03T11:58:00Z", "type": "commit"}, {"oid": "c11523eb39638721930ca6e221fd1336084bf572", "url": "https://github.com/kiegroup/drools/commit/c11523eb39638721930ca6e221fd1336084bf572", "message": "[DROOLS-5867] Fixing as per SONAR suggestion", "committedDate": "2020-12-03T11:58:13Z", "type": "commit"}, {"oid": "198dc27dd077608b70744c0bdc1735d75614baaa", "url": "https://github.com/kiegroup/drools/commit/198dc27dd077608b70744c0bdc1735d75614baaa", "message": "[DROOLS-5867] Rollback method implementation", "committedDate": "2020-12-03T11:58:21Z", "type": "commit"}, {"oid": "198dc27dd077608b70744c0bdc1735d75614baaa", "url": "https://github.com/kiegroup/drools/commit/198dc27dd077608b70744c0bdc1735d75614baaa", "message": "[DROOLS-5867] Rollback method implementation", "committedDate": "2020-12-03T11:58:21Z", "type": "forcePushed"}, {"oid": "a2a0a8fa850a5744e790f7d005afd35fbff56a23", "url": "https://github.com/kiegroup/drools/commit/a2a0a8fa850a5744e790f7d005afd35fbff56a23", "message": "Merge remote-tracking branch 'origin/master' into DROOLS-5867\n\n# Conflicts:\n#\tdrools-ruleunit/src/test/java/org/drools/ruleunit/command/pmml/ApplyPmmlModelCommandTest.java", "committedDate": "2020-12-03T15:25:51Z", "type": "commit"}, {"oid": "20cc58fc9594863cd39533c56e07e6dd460b891a", "url": "https://github.com/kiegroup/drools/commit/20cc58fc9594863cd39533c56e07e6dd460b891a", "message": "[DROOLS-5867] Switching to org.kie.internal.pmml.PMMLImplementationsUtil.isjPMMLAvailableToClassLoader method", "committedDate": "2020-12-03T16:21:22Z", "type": "commit"}]}