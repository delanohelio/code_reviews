{"pr_number": 8892, "pr_title": "Fix definingClass for StaticFieldVarHandle", "pr_author": "babsingh", "pr_createdAt": "2020-03-17T19:14:10Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8892", "timeline": [{"oid": "ce30c1c8e5a3d5b6c4ab9298580c77da4fc558ef", "url": "https://github.com/eclipse-openj9/openj9/commit/ce30c1c8e5a3d5b6c4ab9298580c77da4fc558ef", "message": "Fix definingClass for StaticFieldVarHandle\n\nFor a StaticFieldVarHandle, definingClass should point to the owner of\nthe static field.\n \nExample:\n    public class P { public static String publicObject = \"s\"; }\n    public class C extends P { }\n    VarHandle vh =\n    \tMethodHandles.lookup()\n    \t\t.in(C.class)\n    \t\t.findStaticVarHandle(C.class, \"publicObject\", String.class);\n\nIn the above example, vh is an instance of StaticFieldVarHandle, which\nextends FieldVarHandle. vh.definingClass should contain class P since it\ndefines the publicObject.\n\nCurrently, vh.definingClass is set to class C, which is not the owner of\nthe static field. This fix correctly sets the defining class for a\nStaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-17T19:15:11Z", "type": "forcePushed"}, {"oid": "02929db3e6cd6c194a5def1cdc10991a275e669d", "url": "https://github.com/eclipse-openj9/openj9/commit/02929db3e6cd6c194a5def1cdc10991a275e669d", "message": "Fix typo: StaticFieldViewVarHandle -> StaticFieldVarHandle\n\nStaticFieldViewVarHandle is corrected to StaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-19T05:41:56Z", "type": "forcePushed"}, {"oid": "d1e24404af49fa1dce88a1cb06eaac0e12c44053", "url": "https://github.com/eclipse-openj9/openj9/commit/d1e24404af49fa1dce88a1cb06eaac0e12c44053", "message": "Fix typo: StaticFieldViewVarHandle -> StaticFieldVarHandle\n\nStaticFieldViewVarHandle is corrected to StaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-19T15:06:31Z", "type": "forcePushed"}, {"oid": "b1ec71852a71cb2a378db1df7e50474fc63a8040", "url": "https://github.com/eclipse-openj9/openj9/commit/b1ec71852a71cb2a378db1df7e50474fc63a8040", "message": "Fix typo: StaticFieldViewVarHandle -> StaticFieldVarHandle\n\nStaticFieldViewVarHandle is corrected to StaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-19T15:44:07Z", "type": "forcePushed"}, {"oid": "0b0246bc529600fbd3d3e768aa1de66568d3356b", "url": "https://github.com/eclipse-openj9/openj9/commit/0b0246bc529600fbd3d3e768aa1de66568d3356b", "message": "Fix typo: StaticFieldViewVarHandle -> StaticFieldVarHandle\n\nStaticFieldViewVarHandle is corrected to StaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-19T17:05:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE3MTI3Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8892#discussion_r397171276", "body": "Comments shouldn't be about the past - \"no longer satisfies\" - but explaining *why* is great!\r\n\r\n```suggestion\r\n\t/* definingClass cannot be a final field since it is modified twice, once in \r\n\t * Java code and once in native code.\r\n\t */\r\n```", "bodyText": "Comments shouldn't be about the past - \"no longer satisfies\" - but explaining why is great!\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t/* definingClass cannot be a final field since it no longer satisfies the conditions of\n          \n          \n            \n            \t * the final keyword. It is modified twice, once in Java code and once in native code.\n          \n          \n            \n            \t */\n          \n          \n            \n            \t/* definingClass cannot be a final field since it is modified twice, once in \n          \n          \n            \n            \t * Java code and once in native code.\n          \n          \n            \n            \t */", "bodyHTML": "<p dir=\"auto\">Comments shouldn't be about the past - \"no longer satisfies\" - but explaining <em>why</em> is great!</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"42\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t<span class=\"pl-c\"><span class=\"pl-c\">/*</span> definingClass cannot be a final field since it <span class=\"x x-first x-last\">no longer satisfies the conditions of</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"43\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> <span class=\"x x-first\">the </span><span class=\"pl-k x\">final</span><span class=\"x\"> keyword. </span><span class=\"pl-smi x\">It</span><span class=\"x x-last\"> is modified twice, once in </span><span class=\"pl-smi\">Java</span> code and once in <span class=\"pl-k\">native</span> code.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"44\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"42\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t<span class=\"pl-c\"><span class=\"pl-c\">/*</span> definingClass cannot be a final field since it <span class=\"x x-first x-last\">is modified twice, once in </span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"43\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Java</span> code and once in <span class=\"pl-k\">native</span> code.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"44\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*/</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "DanHeidinga", "createdAt": "2020-03-24T13:56:39Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/FieldVarHandle.java", "diffHunk": "@@ -35,9 +35,13 @@\n \n abstract class FieldVarHandle extends VarHandle {\n \tfinal long vmslot;\n-\tfinal Class<?> definingClass;\n \tfinal String fieldName;\n \n+\t/* definingClass cannot be a final field since it no longer satisfies the conditions of\n+\t * the final keyword. It is modified twice, once in Java code and once in native code.\n+\t */", "originalCommit": "0b0246bc529600fbd3d3e768aa1de66568d3356b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE4MTc4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8892#discussion_r397181788", "body": "Can this be broken into a series of tests?  It will be easier to focus debugging efforts in the future if we can clearly see which operation failed.", "bodyText": "Can this be broken into a series of tests?  It will be easier to focus debugging efforts in the future if we can clearly see which operation failed.", "bodyHTML": "<p dir=\"auto\">Can this be broken into a series of tests?  It will be easier to focus debugging efforts in the future if we can clearly see which operation failed.</p>", "author": "DanHeidinga", "createdAt": "2020-03-24T14:11:10Z", "path": "test/functional/Java9andUp/src/org/openj9/test/varhandle/StaticFieldVarHandleTests.java", "diffHunk": "@@ -2484,4 +2491,226 @@ public void testCommonCallSite() {\n \tprivate long commonVarHandleCallSite(VarHandle vh, long value) {\n \t\treturn (long)vh.get();\n \t}\n+\t\n+\t/**\n+\t * Perform all the operations available on a StaticFieldVarHandle referencing a {@link String} field of a\n+\t * parent class via the child class.\n+\t */\n+\t@Test\n+\tpublic void testReferenceInParentFromChild() {", "originalCommit": "0b0246bc529600fbd3d3e768aa1de66568d3356b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQzMTcyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8892#discussion_r397431725", "bodyText": "Divided into a series of tests.", "author": "babsingh", "createdAt": "2020-03-24T20:13:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE4MTc4OA=="}], "type": "inlineReview"}, {"oid": "513bd048f83533c7d9fc31345aec5b06d2fcf01e", "url": "https://github.com/eclipse-openj9/openj9/commit/513bd048f83533c7d9fc31345aec5b06d2fcf01e", "message": "Fix definingClass for StaticFieldVarHandle\n\nFor a StaticFieldVarHandle, definingClass should point to the owner of\nthe static field.\n \nExample:\n    public class P { public static String publicObject = \"s\"; }\n    public class C extends P { }\n    VarHandle vh =\n    \tMethodHandles.lookup()\n    \t\t.in(C.class)\n    \t\t.findStaticVarHandle(C.class, \"publicObject\", String.class);\n\nIn the above example, vh is an instance of StaticFieldVarHandle, which\nextends FieldVarHandle. vh.definingClass should contain class P since it\ndefines the publicObject.\n\nCurrently, vh.definingClass is set to class C, which is not the owner of\nthe static field. This fix correctly sets the defining class for a\nStaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-24T19:39:39Z", "type": "commit"}, {"oid": "cad273fac01fb2bc09150c5432edb7b98d150137", "url": "https://github.com/eclipse-openj9/openj9/commit/cad273fac01fb2bc09150c5432edb7b98d150137", "message": "Add a new test case in StaticFieldVarHandleTests\n\nThe new test case verifies if StaticFieldVarHandle functions correctly\nwhile accessing a static field of a parent class via a child class. It\nonly covers the reference value type. Existing test cases ensure that\nStaticFieldVarHandle will behave correctly for other value types in a\nsimilar scenario if the new test case for the reference value type\nsucceeds.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-24T19:39:39Z", "type": "commit"}, {"oid": "f577b925ca315ce3739a7ed507c1f7879a666afc", "url": "https://github.com/eclipse-openj9/openj9/commit/f577b925ca315ce3739a7ed507c1f7879a666afc", "message": "Fix typo: StaticFieldViewVarHandle -> StaticFieldVarHandle\n\nStaticFieldViewVarHandle is corrected to StaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-24T19:39:39Z", "type": "commit"}, {"oid": "f577b925ca315ce3739a7ed507c1f7879a666afc", "url": "https://github.com/eclipse-openj9/openj9/commit/f577b925ca315ce3739a7ed507c1f7879a666afc", "message": "Fix typo: StaticFieldViewVarHandle -> StaticFieldVarHandle\n\nStaticFieldViewVarHandle is corrected to StaticFieldVarHandle.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-03-24T19:39:39Z", "type": "forcePushed"}]}