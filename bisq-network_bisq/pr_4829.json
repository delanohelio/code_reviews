{"pr_number": 4829, "pr_title": "Check if user has downgraded to an older version", "pr_author": "chimp1984", "pr_createdAt": "2020-11-20T20:29:54Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4829", "timeline": [{"oid": "df9ef80edfd6ad8cb495769ce34287ffe6a62304", "url": "https://github.com/bisq-network/bisq/commit/df9ef80edfd6ad8cb495769ce34287ffe6a62304", "message": "Avoid nullpointer", "committedDate": "2020-11-20T20:10:39Z", "type": "commit"}, {"oid": "9360e89ae8d1a07a758ab84713c46cfa4451a17d", "url": "https://github.com/bisq-network/bisq/commit/9360e89ae8d1a07a758ab84713c46cfa4451a17d", "message": "Check if user has downgraded to an older version. If so require shutdown\nand do not read or write persisted data.\n\nWe had recently a case where a user downgraded from 1.4.2 to 1.3.9 and\nthis caused failed trades and the wallet funds have been missing due to\nsome complexities of the wallet wegwit upgrade. The fund could be recovered\nbut it took quite some effort.\nAs downgrade is never tested and can lead to all kind of weird bugs we\nshould prevent that users accidentally can do it.\nIf there is valid reason to downgrade they can remove the version file.", "committedDate": "2020-11-20T20:27:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIxMjUwOQ==", "url": "https://github.com/bisq-network/bisq/pull/4829#discussion_r528212509", "body": "Since this can't really be tested by downgrading from an older pkg, I hacked BisqSetup.java Line 531:\r\n\r\n\tpublic static boolean hasDowngraded(String lastVersion) {\r\n\t\treturn true;\r\n        // return lastVersion != null && Version.isNewVersion(lastVersion, Version.VERSION);\r\n    }\r\n    \r\nIt worked as expected, showing me a shutdown message & button, but I got an NPE after clicking the shutdown button.  I am not sure this is avoidable or very important, but think you'd want to know.\r\n\r\n\tNov-21 13:28:17.176 [JavaFX Application Thread] ERROR bisq.core.app.BisqSetup: Downgrade from version 1.5.0 to version 1.5.0 is not supported \r\n\tNov-21 13:28:21.649 [Thread-3] INFO  bisq.core.app.BisqExecutable: Start graceful shutDown \r\n\tNov-21 13:28:21.659 [Thread-3] INFO  b.c.a.AvoidStandbyModeService: Stopped \r\n\tNov-21 13:28:21.659 [Thread-3] INFO  b.core.offer.OpenOfferManager: Remove open offers at shutDown. Number of open offers: 0 \r\n\tNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: OpenOfferManager shutdown completed \r\n\tNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: WalletsSetup shutdown completed \r\n\tNov-21 13:28:21.664 [JavaFX Application Thread] INFO  b.n.p2p.network.NetworkNode: Shutdown immediately because no connections are open. \r\n\tNov-21 13:28:21.666 [Thread-3] INFO  b.n.p2p.network.TorNetworkNode: Tor has not been created yet. We cancel the torStartupFuture. \r\n\tNov-21 13:28:21.666 [Thread-3] ERROR b.n.p2p.network.TorNetworkNode: Shutdown torNetworkNode failed with exception: null \r\n\tjava.lang.NullPointerException\r\n\t\tat bisq.network.p2p.network.TorNetworkNode.torNetworkNodeShutDown(TorNetworkNode.java:187)\r\n\t\tat bisq.network.p2p.network.TorNetworkNode.shutDown(TorNetworkNode.java:154)\r\n\t\tat bisq.network.p2p.P2PService.doShutDown(P2PService.java:276)\r\n\t\tat bisq.network.p2p.peers.Broadcaster.doShutDown(Broadcaster.java:81)\r\n\t\tat bisq.network.p2p.peers.Broadcaster.shutDown(Broadcaster.java:68)\r\n\t\tat bisq.network.p2p.P2PService.shutDown(P2PService.java:244)\r\n\t\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$4(BisqExecutable.java:245)\r\n\t\tat com.sun.javafx.binding.ExpressionHelper$SingleChange.fireValueChangedEvent(ExpressionHelper.java:181)\r\n\t\tat com.sun.javafx.binding.ExpressionHelper.fireValueChangedEvent(ExpressionHelper.java:80)\r\n\t\tat javafx.beans.property.BooleanPropertyBase.fireValueChangedEvent(BooleanPropertyBase.java:104)\r\n\t\tat javafx.beans.property.BooleanPropertyBase.markInvalid(BooleanPropertyBase.java:111)\r\n\t\tat javafx.beans.property.BooleanPropertyBase.set(BooleanPropertyBase.java:145)\r\n\t\tat bisq.core.btc.setup.WalletsSetup.shutDown(WalletsSetup.java:344)\r\n\t\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$5(BisqExecutable.java:260)\r\n\t\tat bisq.core.offer.OpenOfferManager.shutDown(OpenOfferManager.java:232)\r\n\t\tat bisq.core.app.BisqExecutable.gracefulShutDown(BisqExecutable.java:234)\r\n\t\tat bisq.desktop.app.BisqApp.lambda$stop$1(BisqApp.java:148)\r\n\t\tat java.base/java.lang.Thread.run(Thread.java:834)\r\n\tNov-21 13:28:26.668 [JavaFX Application Thread] ERROR b.n.p2p.network.TorNetworkNode: A timeout occurred at shutDown ", "bodyText": "Since this can't really be tested by downgrading from an older pkg, I hacked BisqSetup.java Line 531:\npublic static boolean hasDowngraded(String lastVersion) {\n\treturn true;\n    // return lastVersion != null && Version.isNewVersion(lastVersion, Version.VERSION);\n}\n\nIt worked as expected, showing me a shutdown message & button, but I got an NPE after clicking the shutdown button.  I am not sure this is avoidable or very important, but think you'd want to know.\nNov-21 13:28:17.176 [JavaFX Application Thread] ERROR bisq.core.app.BisqSetup: Downgrade from version 1.5.0 to version 1.5.0 is not supported \nNov-21 13:28:21.649 [Thread-3] INFO  bisq.core.app.BisqExecutable: Start graceful shutDown \nNov-21 13:28:21.659 [Thread-3] INFO  b.c.a.AvoidStandbyModeService: Stopped \nNov-21 13:28:21.659 [Thread-3] INFO  b.core.offer.OpenOfferManager: Remove open offers at shutDown. Number of open offers: 0 \nNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: OpenOfferManager shutdown completed \nNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: WalletsSetup shutdown completed \nNov-21 13:28:21.664 [JavaFX Application Thread] INFO  b.n.p2p.network.NetworkNode: Shutdown immediately because no connections are open. \nNov-21 13:28:21.666 [Thread-3] INFO  b.n.p2p.network.TorNetworkNode: Tor has not been created yet. We cancel the torStartupFuture. \nNov-21 13:28:21.666 [Thread-3] ERROR b.n.p2p.network.TorNetworkNode: Shutdown torNetworkNode failed with exception: null \njava.lang.NullPointerException\n\tat bisq.network.p2p.network.TorNetworkNode.torNetworkNodeShutDown(TorNetworkNode.java:187)\n\tat bisq.network.p2p.network.TorNetworkNode.shutDown(TorNetworkNode.java:154)\n\tat bisq.network.p2p.P2PService.doShutDown(P2PService.java:276)\n\tat bisq.network.p2p.peers.Broadcaster.doShutDown(Broadcaster.java:81)\n\tat bisq.network.p2p.peers.Broadcaster.shutDown(Broadcaster.java:68)\n\tat bisq.network.p2p.P2PService.shutDown(P2PService.java:244)\n\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$4(BisqExecutable.java:245)\n\tat com.sun.javafx.binding.ExpressionHelper$SingleChange.fireValueChangedEvent(ExpressionHelper.java:181)\n\tat com.sun.javafx.binding.ExpressionHelper.fireValueChangedEvent(ExpressionHelper.java:80)\n\tat javafx.beans.property.BooleanPropertyBase.fireValueChangedEvent(BooleanPropertyBase.java:104)\n\tat javafx.beans.property.BooleanPropertyBase.markInvalid(BooleanPropertyBase.java:111)\n\tat javafx.beans.property.BooleanPropertyBase.set(BooleanPropertyBase.java:145)\n\tat bisq.core.btc.setup.WalletsSetup.shutDown(WalletsSetup.java:344)\n\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$5(BisqExecutable.java:260)\n\tat bisq.core.offer.OpenOfferManager.shutDown(OpenOfferManager.java:232)\n\tat bisq.core.app.BisqExecutable.gracefulShutDown(BisqExecutable.java:234)\n\tat bisq.desktop.app.BisqApp.lambda$stop$1(BisqApp.java:148)\n\tat java.base/java.lang.Thread.run(Thread.java:834)\nNov-21 13:28:26.668 [JavaFX Application Thread] ERROR b.n.p2p.network.TorNetworkNode: A timeout occurred at shutDown", "bodyHTML": "<p dir=\"auto\">Since this can't really be tested by downgrading from an older pkg, I hacked BisqSetup.java Line 531:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"public static boolean hasDowngraded(String lastVersion) {\n\treturn true;\n    // return lastVersion != null &amp;&amp; Version.isNewVersion(lastVersion, Version.VERSION);\n}\"><pre><code>public static boolean hasDowngraded(String lastVersion) {\n\treturn true;\n    // return lastVersion != null &amp;&amp; Version.isNewVersion(lastVersion, Version.VERSION);\n}\n</code></pre></div>\n<p dir=\"auto\">It worked as expected, showing me a shutdown message &amp; button, but I got an NPE after clicking the shutdown button.  I am not sure this is avoidable or very important, but think you'd want to know.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Nov-21 13:28:17.176 [JavaFX Application Thread] ERROR bisq.core.app.BisqSetup: Downgrade from version 1.5.0 to version 1.5.0 is not supported \nNov-21 13:28:21.649 [Thread-3] INFO  bisq.core.app.BisqExecutable: Start graceful shutDown \nNov-21 13:28:21.659 [Thread-3] INFO  b.c.a.AvoidStandbyModeService: Stopped \nNov-21 13:28:21.659 [Thread-3] INFO  b.core.offer.OpenOfferManager: Remove open offers at shutDown. Number of open offers: 0 \nNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: OpenOfferManager shutdown completed \nNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: WalletsSetup shutdown completed \nNov-21 13:28:21.664 [JavaFX Application Thread] INFO  b.n.p2p.network.NetworkNode: Shutdown immediately because no connections are open. \nNov-21 13:28:21.666 [Thread-3] INFO  b.n.p2p.network.TorNetworkNode: Tor has not been created yet. We cancel the torStartupFuture. \nNov-21 13:28:21.666 [Thread-3] ERROR b.n.p2p.network.TorNetworkNode: Shutdown torNetworkNode failed with exception: null \njava.lang.NullPointerException\n\tat bisq.network.p2p.network.TorNetworkNode.torNetworkNodeShutDown(TorNetworkNode.java:187)\n\tat bisq.network.p2p.network.TorNetworkNode.shutDown(TorNetworkNode.java:154)\n\tat bisq.network.p2p.P2PService.doShutDown(P2PService.java:276)\n\tat bisq.network.p2p.peers.Broadcaster.doShutDown(Broadcaster.java:81)\n\tat bisq.network.p2p.peers.Broadcaster.shutDown(Broadcaster.java:68)\n\tat bisq.network.p2p.P2PService.shutDown(P2PService.java:244)\n\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$4(BisqExecutable.java:245)\n\tat com.sun.javafx.binding.ExpressionHelper$SingleChange.fireValueChangedEvent(ExpressionHelper.java:181)\n\tat com.sun.javafx.binding.ExpressionHelper.fireValueChangedEvent(ExpressionHelper.java:80)\n\tat javafx.beans.property.BooleanPropertyBase.fireValueChangedEvent(BooleanPropertyBase.java:104)\n\tat javafx.beans.property.BooleanPropertyBase.markInvalid(BooleanPropertyBase.java:111)\n\tat javafx.beans.property.BooleanPropertyBase.set(BooleanPropertyBase.java:145)\n\tat bisq.core.btc.setup.WalletsSetup.shutDown(WalletsSetup.java:344)\n\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$5(BisqExecutable.java:260)\n\tat bisq.core.offer.OpenOfferManager.shutDown(OpenOfferManager.java:232)\n\tat bisq.core.app.BisqExecutable.gracefulShutDown(BisqExecutable.java:234)\n\tat bisq.desktop.app.BisqApp.lambda$stop$1(BisqApp.java:148)\n\tat java.base/java.lang.Thread.run(Thread.java:834)\nNov-21 13:28:26.668 [JavaFX Application Thread] ERROR b.n.p2p.network.TorNetworkNode: A timeout occurred at shutDown \"><pre><code>Nov-21 13:28:17.176 [JavaFX Application Thread] ERROR bisq.core.app.BisqSetup: Downgrade from version 1.5.0 to version 1.5.0 is not supported \nNov-21 13:28:21.649 [Thread-3] INFO  bisq.core.app.BisqExecutable: Start graceful shutDown \nNov-21 13:28:21.659 [Thread-3] INFO  b.c.a.AvoidStandbyModeService: Stopped \nNov-21 13:28:21.659 [Thread-3] INFO  b.core.offer.OpenOfferManager: Remove open offers at shutDown. Number of open offers: 0 \nNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: OpenOfferManager shutdown completed \nNov-21 13:28:21.660 [Thread-3] INFO  bisq.core.app.BisqExecutable: WalletsSetup shutdown completed \nNov-21 13:28:21.664 [JavaFX Application Thread] INFO  b.n.p2p.network.NetworkNode: Shutdown immediately because no connections are open. \nNov-21 13:28:21.666 [Thread-3] INFO  b.n.p2p.network.TorNetworkNode: Tor has not been created yet. We cancel the torStartupFuture. \nNov-21 13:28:21.666 [Thread-3] ERROR b.n.p2p.network.TorNetworkNode: Shutdown torNetworkNode failed with exception: null \njava.lang.NullPointerException\n\tat bisq.network.p2p.network.TorNetworkNode.torNetworkNodeShutDown(TorNetworkNode.java:187)\n\tat bisq.network.p2p.network.TorNetworkNode.shutDown(TorNetworkNode.java:154)\n\tat bisq.network.p2p.P2PService.doShutDown(P2PService.java:276)\n\tat bisq.network.p2p.peers.Broadcaster.doShutDown(Broadcaster.java:81)\n\tat bisq.network.p2p.peers.Broadcaster.shutDown(Broadcaster.java:68)\n\tat bisq.network.p2p.P2PService.shutDown(P2PService.java:244)\n\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$4(BisqExecutable.java:245)\n\tat com.sun.javafx.binding.ExpressionHelper$SingleChange.fireValueChangedEvent(ExpressionHelper.java:181)\n\tat com.sun.javafx.binding.ExpressionHelper.fireValueChangedEvent(ExpressionHelper.java:80)\n\tat javafx.beans.property.BooleanPropertyBase.fireValueChangedEvent(BooleanPropertyBase.java:104)\n\tat javafx.beans.property.BooleanPropertyBase.markInvalid(BooleanPropertyBase.java:111)\n\tat javafx.beans.property.BooleanPropertyBase.set(BooleanPropertyBase.java:145)\n\tat bisq.core.btc.setup.WalletsSetup.shutDown(WalletsSetup.java:344)\n\tat bisq.core.app.BisqExecutable.lambda$gracefulShutDown$5(BisqExecutable.java:260)\n\tat bisq.core.offer.OpenOfferManager.shutDown(OpenOfferManager.java:232)\n\tat bisq.core.app.BisqExecutable.gracefulShutDown(BisqExecutable.java:234)\n\tat bisq.desktop.app.BisqApp.lambda$stop$1(BisqApp.java:148)\n\tat java.base/java.lang.Thread.run(Thread.java:834)\nNov-21 13:28:26.668 [JavaFX Application Thread] ERROR b.n.p2p.network.TorNetworkNode: A timeout occurred at shutDown \n</code></pre></div>", "author": "ghubstan", "createdAt": "2020-11-21T16:08:33Z", "path": "core/src/main/java/bisq/core/app/BisqSetup.java", "diffHunk": "@@ -487,6 +502,68 @@ private void checkForInvalidMakerFeeTxs() {\n         });\n     }\n \n+    @Nullable\n+    public static String getLastBisqVersion() {\n+        File versionFile = getVersionFile();\n+        if (!versionFile.exists()) {\n+            return null;\n+        }\n+        try (Scanner scanner = new Scanner(versionFile)) {\n+            // We only expect 1 line\n+            if (scanner.hasNextLine()) {\n+                return scanner.nextLine();\n+            }\n+        } catch (FileNotFoundException e) {\n+            e.printStackTrace();\n+        }\n+        return null;\n+    }\n+\n+    private static File getVersionFile() {\n+        return new File(Config.appDataDir(), VERSION_FILE_NAME);\n+    }\n+\n+    public static boolean hasDowngraded() {\n+        return hasDowngraded(getLastBisqVersion());\n+    }\n+\n+    public static boolean hasDowngraded(String lastVersion) {\n+        return lastVersion != null && Version.isNewVersion(lastVersion, Version.VERSION);\n+    }", "originalCommit": "9360e89ae8d1a07a758ab84713c46cfa4451a17d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}