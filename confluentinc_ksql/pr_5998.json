{"pr_number": 5998, "pr_title": "feat: Support subscript and nested functions in grouping queries ", "pr_author": "vpapavas", "pr_createdAt": "2020-08-12T19:36:25Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5998", "timeline": [{"oid": "2f21890966358df12225c90e6c37fed7f32f8a48", "url": "https://github.com/confluentinc/ksql/commit/2f21890966358df12225c90e6c37fed7f32f8a48", "message": "remove intermediate topics from test file", "committedDate": "2020-08-13T00:49:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1NjU1NQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r470056555", "body": "nit: update the comment above (and on line 83) - might also want to mention that it is only used to validate (i.e. throw exception)", "bodyText": "nit: update the comment above (and on line 83) - might also want to mention that it is only used to validate (i.e. throw exception)", "bodyHTML": "<p dir=\"auto\">nit: update the comment above (and on line 83) - might also want to mention that it is only used to validate (i.e. throw exception)</p>", "author": "agavra", "createdAt": "2020-08-13T15:56:50Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -68,17 +69,19 @@ public AggregateAnalysisResult analyze(\n     private final MutableAggregateAnalysis aggregateAnalysis = new MutableAggregateAnalysis();\n     private final FunctionRegistry functionRegistry;\n     private final Set<Expression> groupBy;\n+    private boolean foundExpressionInGroupBy = false;\n+\n \n     // The list of columns from the source schema that are used in aggregate columns, but not as\n     // parameters to the aggregate functions and which are not part of the GROUP BY clause:\n-    private final List<ColumnReferenceExp> aggSelectsNotPartOfGroupBy = new ArrayList<>();\n+    private final List<Expression> aggSelectsNotPartOfGroupBy = new ArrayList<>();", "originalCommit": "2f21890966358df12225c90e6c37fed7f32f8a48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1ODY1OA==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r470058658", "body": "is there a reason this code is still commented out?", "bodyText": "is there a reason this code is still commented out?", "bodyHTML": "<p dir=\"auto\">is there a reason this code is still commented out?</p>", "author": "agavra", "createdAt": "2020-08-13T16:00:05Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -204,9 +226,18 @@ private void throwOnWindowBoundColumnIfWindowedAggregate(\n \n     private void captureNonAggregateSelectNotPartOfGroupBy(\n         final Expression expression,\n-        final Set<ColumnReferenceExp> nonAggParams\n+        final Set<Expression> nonAggParams\n     ) {\n-      final boolean matchesGroupBy = groupBy.contains(expression);\n+\n+      boolean matchesGroupBy = false;\n+      // If the non-Agg expression is a function, then all its arguments must be part of the\n+      // grouping columns. Note, they may be nested inside other functions.\n+      /*if (expression instanceof FunctionCall) {\n+        matchesGroupBy = functionContainsOnlyGroupingColumns(expression, true);\n+      } else {\n+        matchesGroupBy = groupBy.contains(expression);\n+      }*/", "originalCommit": "2f21890966358df12225c90e6c37fed7f32f8a48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczMjg2Ng==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r471732866", "bodyText": "Sorry, forgot to remove", "author": "vpapavas", "createdAt": "2020-08-17T19:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1ODY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODg0MA==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r472048840", "bodyText": "+1", "author": "big-andy-coates", "createdAt": "2020-08-18T09:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1ODY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA1OTA0NA==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r470059044", "body": "```suggestion\r\n    private void captureNonAggregateHavingNotPartOfGroupBy(final Expression nonAggColumn) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void captureNoneAggregateHavingNotPartOfGroupBy(final Expression nonAggColumn) {\n          \n          \n            \n                private void captureNonAggregateHavingNotPartOfGroupBy(final Expression nonAggColumn) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">captureNoneAggregateHavingNotPartOfGroupBy</span>(<span class=\"pl-k\">final</span> <span class=\"pl-smi\">Expression</span> nonAggColumn) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">captureNonAggregateHavingNotPartOfGroupBy</span>(<span class=\"pl-k\">final</span> <span class=\"pl-smi\">Expression</span> nonAggColumn) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "agavra", "createdAt": "2020-08-13T16:00:44Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -221,15 +252,15 @@ private void captureNonAggregateSelectNotPartOfGroupBy(\n     }\n \n     private void captureAggregateSelectNotPartOfGroupBy(\n-        final Set<ColumnReferenceExp> nonAggParams\n+        final Set<Expression> nonAggParams\n     ) {\n       nonAggParams.stream()\n           .filter(param -> !groupBy.contains(param))\n           .forEach(aggSelectsNotPartOfGroupBy::add);\n     }\n \n-    private void captureNoneAggregateHavingNotPartOfGroupBy(final ColumnReferenceExp nonAggColumn) {\n-      if (groupBy.contains(new UnqualifiedColumnReferenceExp(nonAggColumn.getColumnName()))) {\n+    private void captureNoneAggregateHavingNotPartOfGroupBy(final Expression nonAggColumn) {", "originalCommit": "2f21890966358df12225c90e6c37fed7f32f8a48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2MTUyNw==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r470061527", "body": "I'm a little confused here, why do we unset the `foundExpressioninGroupBy` here? I feel like we should set it right after we set it and call `super`. For example we should unset it after calling `super.visitSubscriptExpression(node, context);`", "bodyText": "I'm a little confused here, why do we unset the foundExpressioninGroupBy here? I feel like we should set it right after we set it and call super. For example we should unset it after calling super.visitSubscriptExpression(node, context);", "bodyHTML": "<p dir=\"auto\">I'm a little confused here, why do we unset the <code>foundExpressioninGroupBy</code> here? I feel like we should set it right after we set it and call <code>super</code>. For example we should unset it after calling <code>super.visitSubscriptExpression(node, context);</code></p>", "author": "agavra", "createdAt": "2020-08-13T16:04:38Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -344,8 +384,10 @@ public Void visitUnqualifiedColumnReference(\n         final UnqualifiedColumnReferenceExp node,\n         final Void context\n     ) {\n-      dereferenceCollector.accept(aggFunctionName, node);\n-\n+      if (!foundExpressionInGroupBy || visitedAggFunction) {\n+        dereferenceCollector.accept(aggFunctionName, node);\n+      }\n+      foundExpressionInGroupBy = false;", "originalCommit": "2f21890966358df12225c90e6c37fed7f32f8a48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2NDYyNQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r470064625", "body": "are there any other expressions that we should be looking that can match exactly other than function calls and subscript expressions? i.e. what about arithmetic expressions (`SELECT AS_VALUE(a + b) AS foo GROUP BY a + b`)\r\n\r\nI think it makes sense to implement this in `visitExpression` instead of in each individual expression type. We would only \"override\" this behavior when we need to (e.g. inside `visitFuncitonCall`)", "bodyText": "are there any other expressions that we should be looking that can match exactly other than function calls and subscript expressions? i.e. what about arithmetic expressions (SELECT AS_VALUE(a + b) AS foo GROUP BY a + b)\nI think it makes sense to implement this in visitExpression instead of in each individual expression type. We would only \"override\" this behavior when we need to (e.g. inside visitFuncitonCall)", "bodyHTML": "<p dir=\"auto\">are there any other expressions that we should be looking that can match exactly other than function calls and subscript expressions? i.e. what about arithmetic expressions (<code>SELECT AS_VALUE(a + b) AS foo GROUP BY a + b</code>)</p>\n<p dir=\"auto\">I think it makes sense to implement this in <code>visitExpression</code> instead of in each individual expression type. We would only \"override\" this behavior when we need to (e.g. inside <code>visitFuncitonCall</code>)</p>", "author": "agavra", "createdAt": "2020-08-13T16:09:39Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -359,5 +401,14 @@ public Void visitQualifiedColumnReference(\n     ) {\n       throw new UnsupportedOperationException(\"Should of been converted to unqualified\");\n     }\n+\n+    @Override\n+    public Void visitSubscriptExpression(final SubscriptExpression node, final Void context) {", "originalCommit": "2f21890966358df12225c90e6c37fed7f32f8a48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg3NDM3OQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r471874379", "bodyText": "I need to check for arithmetic expressions.\nYes, this is a good point in the sense that we need to figure out which expressions need special handling. However, there is no visitExpression in TraversalExpressionVisitor unless I misunderstand what you meant.", "author": "vpapavas", "createdAt": "2020-08-18T02:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2NDYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzNzczNg==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r472437736", "bodyText": "@agavra The approach of putting the \"common\" code in process doesn't work. Reason being is that if the parent expression exists in the group by e.g. (a+b), it will set the flag foundExpressionInGroupBy to true and will continue visiting the children, a and b. If a child doesn't exist in the group by, it will set the flag to false. All the rest of the children then (b in this example), will fail and will wrongly get added to the nonAggParams.\nTLDR: the flag must be set to false only after the entire tree of the expression has been visited. And that is only possible to do in the specific method for each expression", "author": "vpapavas", "createdAt": "2020-08-18T19:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2NDYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3MzUzMg==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r473373532", "bodyText": "look at my newest comment, I think we have that problem anyway. I still think we should be able to do this in the common process if you take the suggestion I have there.", "author": "agavra", "createdAt": "2020-08-19T22:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2NDYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3NTY1OQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r473375659", "bodyText": "#5998 (comment)", "author": "agavra", "createdAt": "2020-08-19T22:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2NDYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2ODUxNw==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r470068517", "body": "why can't this be part of the `Visitor` directly? it seems weird for this to carry over between process steps (lines 95 -> 109)", "bodyText": "why can't this be part of the Visitor directly? it seems weird for this to carry over between process steps (lines 95 -> 109)", "bodyHTML": "<p dir=\"auto\">why can't this be part of the <code>Visitor</code> directly? it seems weird for this to carry over between process steps (lines 95 -&gt; 109)</p>", "author": "agavra", "createdAt": "2020-08-13T16:16:05Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -68,17 +69,19 @@ public AggregateAnalysisResult analyze(\n     private final MutableAggregateAnalysis aggregateAnalysis = new MutableAggregateAnalysis();\n     private final FunctionRegistry functionRegistry;\n     private final Set<Expression> groupBy;\n+    private boolean foundExpressionInGroupBy = false;", "originalCommit": "2f21890966358df12225c90e6c37fed7f32f8a48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0Njk1NQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r472046955", "bodyText": "+1", "author": "big-andy-coates", "createdAt": "2020-08-18T09:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2ODUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODY1OQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r472048659", "body": "The comment on line 190 refers to code now on line 194.  Can you move this `if` statement above the comment please?", "bodyText": "The comment on line 190 refers to code now on line 194.  Can you move this if statement above the comment please?", "bodyHTML": "<p dir=\"auto\">The comment on line 190 refers to code now on line 194.  Can you move this <code>if</code> statement above the comment please?</p>", "author": "big-andy-coates", "createdAt": "2020-08-18T09:36:24Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -128,48 +137,61 @@ private void processSelect(final Expression expression) {\n     }\n \n     private void processGroupBy(final Expression expression) {\n-      final AggregateVisitor visitor = new AggregateVisitor(this, (aggFuncName, node) -> {\n-        if (aggFuncName.isPresent()) {\n-          throw new KsqlException(\"GROUP BY does not support aggregate functions: \"\n-              + aggFuncName.get().text() + \" is an aggregate function.\");\n-        }\n-        throwOnWindowBoundColumnIfWindowedAggregate(node);\n-      });\n+      final AggregateVisitor visitor = new AggregateVisitor(\n+          this,\n+          groupBy,\n+          foundExpressionInGroupBy,\n+          (aggFuncName, node) -> {\n+            if (aggFuncName.isPresent()) {\n+              throw new KsqlException(\"GROUP BY does not support aggregate functions: \"\n+                  + aggFuncName.get().text() + \" is an aggregate function.\");\n+            }\n+            throwOnWindowBoundColumnIfWindowedAggregate(node);\n+          });\n \n       visitor.process(expression, null);\n     }\n \n     private void processWhere(final Expression expression) {\n-      final AggregateVisitor visitor = new AggregateVisitor(this, (aggFuncName, node) ->\n-          throwOnWindowBoundColumnIfWindowedAggregate(node));\n+      final AggregateVisitor visitor = new AggregateVisitor(\n+          this,\n+          groupBy,\n+          foundExpressionInGroupBy,\n+          (aggFuncName, node) ->\n+            throwOnWindowBoundColumnIfWindowedAggregate(node));\n \n       visitor.process(expression, null);\n     }\n \n     private void processHaving(final Expression expression) {\n-      final AggregateVisitor visitor = new AggregateVisitor(this, (aggFuncName, node) -> {\n-        throwOnWindowBoundColumnIfWindowedAggregate(node);\n-\n-        if (!aggFuncName.isPresent()) {\n-          captureNoneAggregateHavingNotPartOfGroupBy(node);\n-        }\n-      });\n+      final AggregateVisitor visitor = new AggregateVisitor(\n+          this,\n+          groupBy,\n+          foundExpressionInGroupBy,\n+          (aggFuncName, node) -> {\n+            throwOnWindowBoundColumnIfWindowedAggregate(node);\n+\n+            if (!aggFuncName.isPresent()) {\n+              captureNoneAggregateHavingNotPartOfGroupBy(node);\n+            }\n+          });\n \n       visitor.process(expression, null);\n \n       aggregateAnalysis.setHavingExpression(expression);\n     }\n \n-    private void throwOnWindowBoundColumnIfWindowedAggregate(\n-        final ColumnReferenceExp node\n-    ) {\n+    private void throwOnWindowBoundColumnIfWindowedAggregate(final Expression node) {\n       // Window bounds are supported for operations on windowed sources\n       if (!analysis.getWindowExpression().isPresent()) {\n         return;\n       }\n \n       // For non-windowed sources, with a windowed GROUP BY, they are only supported in selects:\n-      if (SystemColumns.isWindowBound(node.getColumnName())) {\n+      if (!(node instanceof ColumnReferenceExp)) {\n+        return;\n+      }", "originalCommit": "2f21890966358df12225c90e6c37fed7f32f8a48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b13e92ce5bf09c84b11f20223cb4edb972e9919", "url": "https://github.com/confluentinc/ksql/commit/3b13e92ce5bf09c84b11f20223cb4edb972e9919", "message": "fixed window bounds error", "committedDate": "2020-08-19T17:31:13Z", "type": "forcePushed"}, {"oid": "0ae5730aaebb0bc0866409fb2221103a7d59ed98", "url": "https://github.com/confluentinc/ksql/commit/0ae5730aaebb0bc0866409fb2221103a7d59ed98", "message": "fixed handling subscript and nested functions", "committedDate": "2020-08-19T19:34:29Z", "type": "commit"}, {"oid": "9d8c340df9b8cd219224ea08ca006a5a3fe9513d", "url": "https://github.com/confluentinc/ksql/commit/9d8c340df9b8cd219224ea08ca006a5a3fe9513d", "message": "remove intermediate topics from test file", "committedDate": "2020-08-19T19:34:29Z", "type": "commit"}, {"oid": "d81c2553142f4ca3a877edf54909b903dd330587", "url": "https://github.com/confluentinc/ksql/commit/d81c2553142f4ca3a877edf54909b903dd330587", "message": "addressed comments, handle struct and arithmetic, added plans", "committedDate": "2020-08-19T19:34:29Z", "type": "commit"}, {"oid": "1056b221b710bec7d8c01590caa249c7fa3e84e5", "url": "https://github.com/confluentinc/ksql/commit/1056b221b710bec7d8c01590caa249c7fa3e84e5", "message": "fixed window bounds error", "committedDate": "2020-08-19T19:34:30Z", "type": "commit"}, {"oid": "cdd21f7139fc6c11f2d7d8ca11a4766ffe6c63b0", "url": "https://github.com/confluentinc/ksql/commit/cdd21f7139fc6c11f2d7d8ca11a4766ffe6c63b0", "message": "adding historic plans", "committedDate": "2020-08-19T19:53:37Z", "type": "commit"}, {"oid": "cdd21f7139fc6c11f2d7d8ca11a4766ffe6c63b0", "url": "https://github.com/confluentinc/ksql/commit/cdd21f7139fc6c11f2d7d8ca11a4766ffe6c63b0", "message": "adding historic plans", "committedDate": "2020-08-19T19:53:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1NjE0OA==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r473356148", "body": "```suggestion\r\n    private boolean currentlyInExpressionThatIsPartOfGroupBy;\r\n```\r\nVery lengthy name, but I think it'll make the code easier to read", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean foundExpressionInGroupBy;\n          \n          \n            \n                private boolean currentlyInExpressionThatIsPartOfGroupBy;\n          \n      \n    \n    \n  \n\nVery lengthy name, but I think it'll make the code easier to read", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">foundExpressionInGroupBy</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">currentlyInExpressionThatIsPartOfGroupBy</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Very lengthy name, but I think it'll make the code easier to read</p>", "author": "agavra", "createdAt": "2020-08-19T21:48:18Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -290,21 +278,25 @@ private void enforceAggregateRules() {\n \n   private static final class AggregateVisitor extends TraversalExpressionVisitor<Void> {\n \n-    private final BiConsumer<Optional<FunctionName>, ColumnReferenceExp> dereferenceCollector;\n+    private final BiConsumer<Optional<FunctionName>, Expression> dereferenceCollector;\n     private final ColumnReferenceExp defaultArgument;\n     private final MutableAggregateAnalysis aggregateAnalysis;\n     private final FunctionRegistry functionRegistry;\n+    private final Set<Expression> groupBy;\n+    private boolean foundExpressionInGroupBy;", "originalCommit": "cdd21f7139fc6c11f2d7d8ca11a4766ffe6c63b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1NjQxOA==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r473356418", "body": "```suggestion\r\n    private boolean currentlyInAggegateFunctionCall = false;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean visitedAggFunction = false;\n          \n          \n            \n                private boolean currentlyInAggegateFunctionCall = false;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">visitedAggFunction</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">false</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">currentlyInAggegateFunctionCall</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">false</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "agavra", "createdAt": "2020-08-19T21:48:38Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -290,21 +278,25 @@ private void enforceAggregateRules() {\n \n   private static final class AggregateVisitor extends TraversalExpressionVisitor<Void> {\n \n-    private final BiConsumer<Optional<FunctionName>, ColumnReferenceExp> dereferenceCollector;\n+    private final BiConsumer<Optional<FunctionName>, Expression> dereferenceCollector;\n     private final ColumnReferenceExp defaultArgument;\n     private final MutableAggregateAnalysis aggregateAnalysis;\n     private final FunctionRegistry functionRegistry;\n+    private final Set<Expression> groupBy;\n+    private boolean foundExpressionInGroupBy;\n \n     private Optional<FunctionName> aggFunctionName = Optional.empty();\n     private boolean visitedAggFunction = false;", "originalCommit": "cdd21f7139fc6c11f2d7d8ca11a4766ffe6c63b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3MTQ4Mg==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r473371482", "body": "**tl;dr** this comment is a little hard to follow because I was understanding the problem as I wrote the comment. basically we need to make sure that only the _first_ node that sets `foundExpressionInGroupBy=true` can set it back to `false`.\r\n\r\n---\r\n\r\nso here's a freak scenario:\r\n```sql\r\nSELECT as_value(a['idx'] + b['idx']) FROM s GROUP BY a['idx'], a['idx'] + b['idx']\r\n```\r\n\r\nvisit `a['idx'] + b['idx']` and set `foundExpressionInGroupBy = true`\r\nvisit (left)  `a['idx']` and set `foundExpressionInGroupBy = true`\r\nvisit `'idx'`\r\ngo back to `a['idx']` and set `foundExpressionInGroupBy = false`\r\nvisit (right) `b['idx']` and fail because `b['idx']` is not in group by\r\n\r\nI think there are actually a few bugs here:\r\n1. is what I showed with the weird group by scenario\r\n1. there is another bug where we shouldn't set `foundExpressionInGroupBy` to `false` unless _the exact node that set it to true_ decides so\r\n\r\nthat (number 2 above) could be an even simpler bug:\r\n\r\n```sql\r\n-- a is map<string, map<string, string>>\r\nSELECT as_value(a[b][c]) FROM s GROUP BY a[b][c];\r\n```\r\n\r\nwe set `foundExpressionInGroupBy` to `true` when we visit `a[b][c]` but then set it to false when we visit `a[b]` causing us to fail when we visit `[c]`\r\n\r\nI think the solution here is to have a more complicated `foundExpressionInGroupBy` that once it is set, nobody else can set/unset it until we get back to whoever it was that first set it. You can use a tuple of `(foundExpressionInGroupBy, theGroupByExpression)` to achieve this\r\n\r\nplease add tests for this too!", "bodyText": "tl;dr this comment is a little hard to follow because I was understanding the problem as I wrote the comment. basically we need to make sure that only the first node that sets foundExpressionInGroupBy=true can set it back to false.\n\nso here's a freak scenario:\nSELECT as_value(a['idx'] + b['idx']) FROM s GROUP BY a['idx'], a['idx'] + b['idx']\nvisit a['idx'] + b['idx'] and set foundExpressionInGroupBy = true\nvisit (left)  a['idx'] and set foundExpressionInGroupBy = true\nvisit 'idx'\ngo back to a['idx'] and set foundExpressionInGroupBy = false\nvisit (right) b['idx'] and fail because b['idx'] is not in group by\nI think there are actually a few bugs here:\n\nis what I showed with the weird group by scenario\nthere is another bug where we shouldn't set foundExpressionInGroupBy to false unless the exact node that set it to true decides so\n\nthat (number 2 above) could be an even simpler bug:\n-- a is map<string, map<string, string>>\nSELECT as_value(a[b][c]) FROM s GROUP BY a[b][c];\nwe set foundExpressionInGroupBy to true when we visit a[b][c] but then set it to false when we visit a[b] causing us to fail when we visit [c]\nI think the solution here is to have a more complicated foundExpressionInGroupBy that once it is set, nobody else can set/unset it until we get back to whoever it was that first set it. You can use a tuple of (foundExpressionInGroupBy, theGroupByExpression) to achieve this\nplease add tests for this too!", "bodyHTML": "<p dir=\"auto\"><strong>tl;dr</strong> this comment is a little hard to follow because I was understanding the problem as I wrote the comment. basically we need to make sure that only the <em>first</em> node that sets <code>foundExpressionInGroupBy=true</code> can set it back to <code>false</code>.</p>\n<hr>\n<p dir=\"auto\">so here's a freak scenario:</p>\n<div class=\"highlight highlight-source-sql position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"SELECT as_value(a['idx'] + b['idx']) FROM s GROUP BY a['idx'], a['idx'] + b['idx']\"><pre><span class=\"pl-k\">SELECT</span> as_value(a[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>idx<span class=\"pl-pds\">'</span></span>] <span class=\"pl-k\">+</span> b[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>idx<span class=\"pl-pds\">'</span></span>]) <span class=\"pl-k\">FROM</span> s <span class=\"pl-k\">GROUP BY</span> a[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>idx<span class=\"pl-pds\">'</span></span>], a[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>idx<span class=\"pl-pds\">'</span></span>] <span class=\"pl-k\">+</span> b[<span class=\"pl-s\"><span class=\"pl-pds\">'</span>idx<span class=\"pl-pds\">'</span></span>]</pre></div>\n<p dir=\"auto\">visit <code>a['idx'] + b['idx']</code> and set <code>foundExpressionInGroupBy = true</code><br>\nvisit (left)  <code>a['idx']</code> and set <code>foundExpressionInGroupBy = true</code><br>\nvisit <code>'idx'</code><br>\ngo back to <code>a['idx']</code> and set <code>foundExpressionInGroupBy = false</code><br>\nvisit (right) <code>b['idx']</code> and fail because <code>b['idx']</code> is not in group by</p>\n<p dir=\"auto\">I think there are actually a few bugs here:</p>\n<ol dir=\"auto\">\n<li>is what I showed with the weird group by scenario</li>\n<li>there is another bug where we shouldn't set <code>foundExpressionInGroupBy</code> to <code>false</code> unless <em>the exact node that set it to true</em> decides so</li>\n</ol>\n<p dir=\"auto\">that (number 2 above) could be an even simpler bug:</p>\n<div class=\"highlight highlight-source-sql position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"-- a is map&lt;string, map&lt;string, string&gt;&gt;\nSELECT as_value(a[b][c]) FROM s GROUP BY a[b][c];\"><pre><span class=\"pl-c\"><span class=\"pl-c\">--</span> a is map&lt;string, map&lt;string, string&gt;&gt;</span>\n<span class=\"pl-k\">SELECT</span> as_value(a[b][c]) <span class=\"pl-k\">FROM</span> s <span class=\"pl-k\">GROUP BY</span> a[b][c];</pre></div>\n<p dir=\"auto\">we set <code>foundExpressionInGroupBy</code> to <code>true</code> when we visit <code>a[b][c]</code> but then set it to false when we visit <code>a[b]</code> causing us to fail when we visit <code>[c]</code></p>\n<p dir=\"auto\">I think the solution here is to have a more complicated <code>foundExpressionInGroupBy</code> that once it is set, nobody else can set/unset it until we get back to whoever it was that first set it. You can use a tuple of <code>(foundExpressionInGroupBy, theGroupByExpression)</code> to achieve this</p>\n<p dir=\"auto\">please add tests for this too!</p>", "author": "agavra", "createdAt": "2020-08-19T22:07:20Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -359,5 +359,46 @@ public Void visitQualifiedColumnReference(\n     ) {\n       throw new UnsupportedOperationException(\"Should of been converted to unqualified\");\n     }\n+\n+    @Override\n+    public Void visitSubscriptExpression(final SubscriptExpression node, final Void context) {\n+      if (groupBy.contains(node)) {\n+        foundExpressionInGroupBy = true;\n+      }\n+      super.visitSubscriptExpression(node, context);\n+      foundExpressionInGroupBy = false;\n+      return null;\n+    }\n+\n+    @Override\n+    public Void visitArithmeticBinary(final ArithmeticBinaryExpression node, final Void context) {", "originalCommit": "cdd21f7139fc6c11f2d7d8ca11a4766ffe6c63b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b76bb75946057442239f74eef06e192522d2071e", "url": "https://github.com/confluentinc/ksql/commit/b76bb75946057442239f74eef06e192522d2071e", "message": "addressed Almog's comments", "committedDate": "2020-08-20T02:12:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMDg0OQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474110849", "body": "```suggestion\r\n   * 1) expressions not in aggregate functions are part of the grouping clause,\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * 1) expressions in non-aggregate functions are part of the grouping clause,\n          \n          \n            \n               * 1) expressions not in aggregate functions are part of the grouping clause,", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-c1\">1</span>) expressions in <span class=\"x x-first\">non</span><span class=\"pl-k x x-last\">-</span>aggregate functions are part of the grouping clause,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> <span class=\"pl-c1\">1</span>) expressions <span class=\"x x-first x-last\">not </span>in aggregate functions are part of the grouping clause,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "agavra", "createdAt": "2020-08-20T16:24:13Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -276,17 +273,31 @@ private void enforceAggregateRules() {\n     }\n   }\n \n+  /**\n+   * This visitor performs two tasks: Create the input schema to the AggregateNode and validations.\n+   *\n+   * For creating the input schema, it checks if any expression along the path from the root\n+   * expression to the leaf (UnqualifiedColumnReference) is part of the groupBy. If at least one is,\n+   * then the UnqualifiedColumnReference is added to the schema.\n+   *\n+   * For validation, the visitor checks that:\n+   * 1) expressions in non-aggregate functions are part of the grouping clause,", "originalCommit": "b76bb75946057442239f74eef06e192522d2071e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEyMjE5NA==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474122194", "bodyText": "It's actually correct what I wrote :P  It will throw if expressions used in aggregate functions are not part of the group by", "author": "vpapavas", "createdAt": "2020-08-20T16:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMDg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEyOTQwMg==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474129402", "bodyText": "It will throw if expressions used in aggregate functions are not part of the group by\n\nnow I'm more confused \ud83d\ude02 expressions in aggregate functions must not be part of the group by - SELECT id, SUM(foo) FROM s GROUP BY id works (foo is an aggregate function parameter not in group by)\nWhat you had originally written is true, but does not cover everything. It says expressions in UDFs (not UDAFs) must be part of the grouping clause (true). But it is also true that even if they're not in a UDF, as long as they're not in an aggregate function, they must be in the grouping clause:\n--- valid\nSELECT non_agg_fun(foo), COUNT(*) from s GROUP BY foo; -- (expression in non-aggregate function)\nSELECT foo, COUNT(*) from s GROUP BY foo;  -- (expression not in aggregate function)\n\n-- invalid\nSELECT foo, COUN(T*) from s GROUP BY bar; -- (expression not in aggregate function, and not in grouping)", "author": "agavra", "createdAt": "2020-08-20T16:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMDg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NjI5OQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474196299", "bodyText": "Ah sorry, I meant expressions in non-aggregate functions must be part of group-by. So much confusion :) So, the comments say that the validator will throw if any of the conditions does not hold", "author": "vpapavas", "createdAt": "2020-08-20T18:43:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMDg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NzUzMg==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474197532", "bodyText": "Ah wait, I think I now get what you are suggesting. You are suggesting to make the sentence more general. OK, will make the change", "author": "vpapavas", "createdAt": "2020-08-20T18:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMDg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMDg3NQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474110875", "body": "first, yay for comments! Thanks for writing this detailed comment, helps future people (including me when I forget what this does) understand it \ud83c\udf89 \r\n\r\nsecond, nit: i'm pretty sure checkstyle forces the following format, but if it doesn't it'll make it easier to read anyway :D \r\n\r\n```suggestion\r\n  /**\r\n   * This visitor performs two tasks: Create the input schema to the AggregateNode and validations.\r\n   *\r\n   * <p> For creating the input schema, it checks if any expression along the path from the root\r\n   * expression to the leaf (UnqualifiedColumnReference) is part of the groupBy. If at least one is,\r\n   * then the UnqualifiedColumnReference is added to the schema.\r\n   *\r\n   * <p>For validation, the visitor checks that:\r\n   * <ol>\r\n   *   <li> expressions in non-aggregate functions are part of the grouping clause </li>\r\n   *   <li> aggregate functions are not nested </li>\r\n   *   <li> window clauses (windowstart, windowend) don't appear in aggregate functions or groupBy </li>\r\n   *   <li> aggregate functions don't appear in the groupBy clause </li>\r\n   *   <li> expressions in the having clause are either aggregate functions or grouping keys </li>\r\n   * </ol>\r\n   */\r\n```", "bodyText": "first, yay for comments! Thanks for writing this detailed comment, helps future people (including me when I forget what this does) understand it \ud83c\udf89\nsecond, nit: i'm pretty sure checkstyle forces the following format, but if it doesn't it'll make it easier to read anyway :D\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /**\n          \n          \n            \n               * This visitor performs two tasks: Create the input schema to the AggregateNode and validations.\n          \n          \n            \n               *\n          \n          \n            \n               * For creating the input schema, it checks if any expression along the path from the root\n          \n          \n            \n               * expression to the leaf (UnqualifiedColumnReference) is part of the groupBy. If at least one is,\n          \n          \n            \n               * then the UnqualifiedColumnReference is added to the schema.\n          \n          \n            \n               *\n          \n          \n            \n               * For validation, the visitor checks that:\n          \n          \n            \n               * 1) expressions in non-aggregate functions are part of the grouping clause,\n          \n          \n            \n               * 2) aggregate functions are not nested\n          \n          \n            \n               * 3) window clauses (windowstart, windowend) don't appear in aggregate functions or groupBy\n          \n          \n            \n               * 4) aggregate functions don't appear in the groupBy clause\n          \n          \n            \n               * 5) expressions in the having clause are either aggregate functions or grouping keys\n          \n          \n            \n               */\n          \n          \n            \n              /**\n          \n          \n            \n               * This visitor performs two tasks: Create the input schema to the AggregateNode and validations.\n          \n          \n            \n               *\n          \n          \n            \n               * <p> For creating the input schema, it checks if any expression along the path from the root\n          \n          \n            \n               * expression to the leaf (UnqualifiedColumnReference) is part of the groupBy. If at least one is,\n          \n          \n            \n               * then the UnqualifiedColumnReference is added to the schema.\n          \n          \n            \n               *\n          \n          \n            \n               * <p>For validation, the visitor checks that:\n          \n          \n            \n               * <ol>\n          \n          \n            \n               *   <li> expressions in non-aggregate functions are part of the grouping clause </li>\n          \n          \n            \n               *   <li> aggregate functions are not nested </li>\n          \n          \n            \n               *   <li> window clauses (windowstart, windowend) don't appear in aggregate functions or groupBy </li>\n          \n          \n            \n               *   <li> aggregate functions don't appear in the groupBy clause </li>\n          \n          \n            \n               *   <li> expressions in the having clause are either aggregate functions or grouping keys </li>\n          \n          \n            \n               * </ol>\n          \n          \n            \n               */", "bodyHTML": "<p dir=\"auto\">first, yay for comments! Thanks for writing this detailed comment, helps future people (including me when I forget what this does) understand it <g-emoji class=\"g-emoji\" alias=\"tada\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f389.png\">\ud83c\udf89</g-emoji></p>\n<p dir=\"auto\">second, nit: i'm pretty sure checkstyle forces the following format, but if it doesn't it'll make it easier to read anyway :D</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"291\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"292\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-smi\">This</span> visitor performs two tasks<span class=\"pl-k\">:</span> <span class=\"pl-smi\">Create</span> the input schema to the <span class=\"pl-smi\">AggregateNode</span> and validations.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"293\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"294\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-smi\">For</span> creating the input schema, it checks <span class=\"pl-k\">if</span> any expression along the path from the root</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"295\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> expression to the leaf (<span class=\"pl-smi\">UnqualifiedColumnReference</span>) is part of the groupBy. <span class=\"pl-smi\">If</span> at least one is,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"296\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> then the <span class=\"pl-smi\">UnqualifiedColumnReference</span> is added to the schema.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"297\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"298\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-smi\">For</span> validation, the visitor checks that<span class=\"pl-k\">:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"299\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-c1\">1</span>) expressions in non<span class=\"pl-k\">-</span>aggregate functions are part of the grouping clause,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"300\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-c1\">2</span>) aggregate functions are not nested</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"301\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-c1\">3</span>) window clauses (windowstart, windowend) don<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t appear in aggregate functions or groupBy</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"302\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-c1\">4</span>) aggregate functions don<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t appear in the groupBy clause</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"303\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-c1\">5</span>) expressions in the having clause are either aggregate functions or grouping keys</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"304\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"291\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"292\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> <span class=\"pl-smi\">This</span> visitor performs two tasks<span class=\"pl-k\">:</span> <span class=\"pl-smi\">Create</span> the input schema to the <span class=\"pl-smi\">AggregateNode</span> and validations.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"293\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"294\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>p<span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">For</span> creating the input schema, it checks <span class=\"pl-k\">if</span> any expression along the path from the root</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"295\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> expression to the leaf (<span class=\"pl-smi\">UnqualifiedColumnReference</span>) is part of the groupBy. <span class=\"pl-smi\">If</span> at least one is,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"296\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> then the <span class=\"pl-smi\">UnqualifiedColumnReference</span> is added to the schema.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"297\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"298\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>p<span class=\"pl-k\">&gt;</span><span class=\"pl-smi\">For</span> validation, the visitor checks that<span class=\"pl-k\">:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"299\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>ol<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"300\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span>   <span class=\"pl-k\">&lt;</span>li<span class=\"pl-k\">&gt;</span> expressions in non<span class=\"pl-k\">-</span>aggregate functions are part of the grouping clause <span class=\"pl-k\">&lt;</span><span class=\"pl-k\">/</span>li<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"301\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span>   <span class=\"pl-k\">&lt;</span>li<span class=\"pl-k\">&gt;</span> aggregate functions are not nested <span class=\"pl-k\">&lt;</span><span class=\"pl-k\">/</span>li<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"302\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span>   <span class=\"pl-k\">&lt;</span>li<span class=\"pl-k\">&gt;</span> window clauses (windowstart, windowend) don<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t appear in aggregate functions or groupBy &lt;/li&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"303\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span>   <span class=\"pl-k\">&lt;</span>li<span class=\"pl-k\">&gt;</span> aggregate functions don<span class=\"pl-s\"><span class=\"pl-pds\">'</span>t appear in the groupBy clause &lt;/li&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"304\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span>   <span class=\"pl-k\">&lt;</span>li<span class=\"pl-k\">&gt;</span> expressions in the having clause are either aggregate functions or grouping keys <span class=\"pl-k\">&lt;</span><span class=\"pl-k\">/</span>li<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"305\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span><span class=\"pl-k\">/</span>ol<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"306\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*/</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "agavra", "createdAt": "2020-08-20T16:24:17Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -276,17 +273,31 @@ private void enforceAggregateRules() {\n     }\n   }\n \n+  /**\n+   * This visitor performs two tasks: Create the input schema to the AggregateNode and validations.\n+   *\n+   * For creating the input schema, it checks if any expression along the path from the root\n+   * expression to the leaf (UnqualifiedColumnReference) is part of the groupBy. If at least one is,\n+   * then the UnqualifiedColumnReference is added to the schema.\n+   *\n+   * For validation, the visitor checks that:\n+   * 1) expressions in non-aggregate functions are part of the grouping clause,\n+   * 2) aggregate functions are not nested\n+   * 3) window clauses (windowstart, windowend) don't appear in aggregate functions or groupBy\n+   * 4) aggregate functions don't appear in the groupBy clause\n+   * 5) expressions in the having clause are either aggregate functions or grouping keys\n+   */", "originalCommit": "b76bb75946057442239f74eef06e192522d2071e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMjU0MA==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474112540", "body": "do we ever actually use the boolean? it looks like we proxy for it by checking `!= null`", "bodyText": "do we ever actually use the boolean? it looks like we proxy for it by checking != null", "bodyHTML": "<p dir=\"auto\">do we ever actually use the boolean? it looks like we proxy for it by checking <code>!= null</code></p>", "author": "agavra", "createdAt": "2020-08-20T16:26:44Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -300,6 +311,19 @@ private AggregateVisitor(\n       this.dereferenceCollector = requireNonNull(dereferenceCollector, \"dereferenceCollector\");\n     }\n \n+    @Override\n+    public Void process(final Expression node, final Void context) {\n+      if (groupBy.contains(node) && currentlyInExpressionPartOfGroupBy == null) {\n+        currentlyInExpressionPartOfGroupBy = new Pair<>(node, true);", "originalCommit": "b76bb75946057442239f74eef06e192522d2071e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5NjgyMQ==", "url": "https://github.com/confluentinc/ksql/pull/5998#discussion_r474196821", "bodyText": "You are right, will change it. The initial intention was to use it", "author": "vpapavas", "createdAt": "2020-08-20T18:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMjU0MA=="}], "type": "inlineReview"}, {"oid": "3a50410accd82614ed30f12bae414b41720e7d74", "url": "https://github.com/confluentinc/ksql/commit/3a50410accd82614ed30f12bae414b41720e7d74", "message": "minor fixes", "committedDate": "2020-08-20T19:33:47Z", "type": "commit"}]}