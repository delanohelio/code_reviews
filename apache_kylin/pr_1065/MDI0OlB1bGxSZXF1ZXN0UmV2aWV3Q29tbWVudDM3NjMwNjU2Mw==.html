<html>
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css" />
  <!--diff2html-css-->
  <!--diff2html-js-ui-->
  <link rel="stylesheet" href="https://rawcdn.githack.com/jasonm23/markdown-css-themes/a2b4fd6d5627e4536a789b1feb46d94cd841f164/markdown.css" />
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const targetElement = document.getElementById('diff');
      const diff2htmlUi = new Diff2HtmlUI(targetElement);
      diff2html-fileListToggle
      //diff2html-synchronisedScroll
      //diff2html-highlightCode
    });
  </script>
  <style>
    body {
      width: 90%;
      max-width: unset;
    }
    pre code {
      display: block;
      background: #E8E8E8;
      font-size: small;
      white-space: pre;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      min-width: 100px;
      max-height: 250px;
      padding: 0;
    }
  </style>
</head>

<body>
<h2>apache/kylin - PR 1065</h2>
<p><strong>Title</strong>: KYLIN-4349 Close InputStream in RowRecordReader.initReaders()</p>
<h3>Code Review</h3>
<p>Inline Review ID - <a href="https://github.com/apache/kylin/pull/1065#discussion_r376306563">MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNjU2Mw==</a></p>
<p>Original Commit - <a href="https://github.com/apache/kylin/commit/3a2ecde43662553338ce99a3921005b1077dff80">3a2ecde43662553338ce99a3921005b1077dff80</a></p>
<pre><code>engine-mr/src/main/java/org/apache/kylin/engine/mr/streaming/RowRecordReader.java

@@ -82,51 +82,72 @@ public RowRecordReader(CubeDesc cubeDesc, Path path, FileSystem fileSystem) thro
     }

     public void initReaders() throws IOException {
-        FSDataInputStream in = fs.open(metaFilePath);
-        FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);
-        CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();
-        FSDataInputStream dictInputStream = fs.open(dataFilePath);
+        FSDataInputStream in = null;
+        try {
+            in = fs.open(metaFilePath);
+            FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);
+            CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();
+            FSDataInputStream dictInputStream = fs.open(dataFilePath);

-        List&lt;DimensionMetaInfo&gt; allDimensions = basicCuboidMetaInfo.getDimensionsInfo();
-        Map&lt;String, DimensionEncoding&gt; dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,
-                dictInputStream);
-        dimensionColumnReaders = Lists.newArrayList();
-        dimensionColumnReaderItrs = Lists.newArrayList();
-        dimensionEncodings = Lists.newArrayList();
-        for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {
-            FSDataInputStream dimInputStream = fs.open(dataFilePath);
-            String dimName = dimensionMetaInfo.getName();
-            DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);
-            ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),
-                    dimensionMetaInfo.getCompressionType());
-            ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,
-                    dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),
-                    (int) basicCuboidMetaInfo.getNumberOfRows());
-            dimensionColumnReaders.add(dimDataReader);
-            dimensionColumnReaderItrs.add(dimDataReader.iterator());
-            dimensionEncodings.add(dimEncoding);
-        }
-        rowDimensionValues = new String[dimensionColumnReaders.size()];
+            List&lt;DimensionMetaInfo&gt; allDimensions = basicCuboidMetaInfo.getDimensionsInfo();
+            Map&lt;String, DimensionEncoding&gt; dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,
+                    dictInputStream);
+            dimensionColumnReaders = Lists.newArrayList();
+            dimensionColumnReaderItrs = Lists.newArrayList();
+            dimensionEncodings = Lists.newArrayList();
+            for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {
+                FSDataInputStream dimInputStream = null;
+                try {
+                    dimInputStream = fs.open(dataFilePath);
+                    String dimName = dimensionMetaInfo.getName();
+                    DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);
+                    ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),
+                            dimensionMetaInfo.getCompressionType());
+                    ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,
+                            dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),
+                            (int) basicCuboidMetaInfo.getNumberOfRows());
+                    dimensionColumnReaders.add(dimDataReader);
+                    dimensionColumnReaderItrs.add(dimDataReader.iterator());
+                    dimensionEncodings.add(dimEncoding);
+                } finally {
+                    if (null != dimInputStream) {
+                        dimInputStream.close();
+                    }
+                }
+            }
+            rowDimensionValues = new String[dimensionColumnReaders.size()];

-        metricsColumnReaders = Lists.newArrayList();
-        metricsColumnReaderItrs = Lists.newArrayList();
-        metricsDataTransformers = Lists.newArrayList();
-        for (MetricMetaInfo metricMetaInfo : basicCuboidMetaInfo.getMetricsInfo()) {
-            FSDataInputStream metricsInputStream = fs.open(dataFilePath);
-            MeasureDesc measure = findMeasure(metricMetaInfo.getName());
-            DataType metricsDataType = measure.getFunction().getReturnDataType();
-            ColumnarMetricsEncoding metricsEncoding = ColumnarMetricsEncodingFactory.create(metricsDataType);
-            ColumnarStoreMetricsDesc metricsDesc = new ColumnarStoreMetricsDesc(metricsEncoding,
-                    metricMetaInfo.getCompressionType());
-            ColumnDataReader metricsDataReader = metricsDesc.getMetricsReaderFromFSInput(metricsInputStream,
-                    metricMetaInfo.getStartOffset(), metricMetaInfo.getMetricLength(),
-                    (int) basicCuboidMetaInfo.getNumberOfRows());
-            metricsColumnReaders.add(metricsDataReader);
-            metricsColumnReaderItrs.add(metricsDataReader.iterator());
-            metricsDataTransformers.add(new MetricsDataTransformer(metricsEncoding.asDataTypeSerializer(),
-                    DataTypeSerializer.create(metricsDataType)));
+            metricsColumnReaders = Lists.newArrayList();
+            metricsColumnReaderItrs = Lists.newArrayList();
+            metricsDataTransformers = Lists.newArrayList();
+            for (MetricMetaInfo metricMetaInfo : basicCuboidMetaInfo.getMetricsInfo()) {
+                FSDataInputStream metricsInputStream = null;
+                try {
+                    metricsInputStream = fs.open(dataFilePath);
+                    MeasureDesc measure = findMeasure(metricMetaInfo.getName());
+                    DataType metricsDataType = measure.getFunction().getReturnDataType();
+                    ColumnarMetricsEncoding metricsEncoding = ColumnarMetricsEncodingFactory.create(metricsDataType);
+                    ColumnarStoreMetricsDesc metricsDesc = new ColumnarStoreMetricsDesc(metricsEncoding,
+                            metricMetaInfo.getCompressionType());
+                    ColumnDataReader metricsDataReader = metricsDesc.getMetricsReaderFromFSInput(metricsInputStream,
+                            metricMetaInfo.getStartOffset(), metricMetaInfo.getMetricLength(),
+                            (int) basicCuboidMetaInfo.getNumberOfRows());
+                    metricsColumnReaders.add(metricsDataReader);
+                    metricsColumnReaderItrs.add(metricsDataReader.iterator());
+                    metricsDataTransformers.add(new MetricsDataTransformer(metricsEncoding.asDataTypeSerializer(),
+                            DataTypeSerializer.create(metricsDataType)));
+                } finally {
+                    if (null != metricsInputStream) {</code></pre>
<blockquote>
<p><strong>hit-lacus</strong>: metricsInputStream  should not be closed for the same reason.</p>
</blockquote>
<h3>Improved Code</h3>
<p>Not found</p>

<div id="diff">
  <!--diff2html-diff-->
</div>

</body>

</html>
