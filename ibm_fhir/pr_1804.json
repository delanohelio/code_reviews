{"pr_number": 1804, "pr_title": "IBM FHIR Server audit does not log bundles correctly. #1803", "pr_author": "prb112", "pr_createdAt": "2020-12-07T15:38:15Z", "pr_url": "https://github.com/IBM/FHIR/pull/1804", "timeline": [{"oid": "6d00e2c8ec412072a34b0ff59a9370992593832f", "url": "https://github.com/IBM/FHIR/commit/6d00e2c8ec412072a34b0ff59a9370992593832f", "message": "IBM FHIR Server audit does not log bundles correctly. #1803\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-12-07T15:36:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMTUzNA==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537621534", "body": "I know it's not part of the change, but is this the best way to get the name of the host? Do we ensure that HOSTNAME is part of the environment?  On Windows, COMPUTERNAME might be more appropriate. Let me know if you think we need a ticket for this.", "bodyText": "I know it's not part of the change, but is this the best way to get the name of the host? Do we ensure that HOSTNAME is part of the environment?  On Windows, COMPUTERNAME might be more appropriate. Let me know if you think we need a ticket for this.", "bodyHTML": "<p dir=\"auto\">I know it's not part of the change, but is this the best way to get the name of the host? Do we ensure that HOSTNAME is part of the environment?  On Windows, COMPUTERNAME might be more appropriate. Let me know if you think we need a ticket for this.</p>", "author": "punktilious", "createdAt": "2020-12-07T15:59:57Z", "path": "fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java", "diffHunk": "@@ -82,7 +82,7 @@\n     private static CadfResource observerRsrc =\n             new CadfResource.Builder(\"fhir-server\", ResourceType.compute_node)\n                             .geolocation(new CadfGeolocation.Builder(geoCity, geoState, geoCountry, null).build())\n-                            .name(\"Fhir Audit\")\n+                            .name(\"IBM FHIR Server - Audit\")\n                             .host(System.getenv(\"HOSTNAME\"))", "originalCommit": "6d00e2c8ec412072a34b0ff59a9370992593832f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyODk4NA==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537628984", "bodyText": "Good point, I don't think it's super reliable. I think a ticket isn't bad, probably lower priority.", "author": "prb112", "createdAt": "2020-12-07T16:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMTUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1MjkwOQ==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537652909", "bodyText": "Thanks", "author": "prb112", "createdAt": "2020-12-07T16:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMTUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzM0Mg==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537623342", "body": "String != String. Shouldn't this use !equals(...)?", "bodyText": "String != String. Shouldn't this use !equals(...)?", "bodyHTML": "<p dir=\"auto\">String != String. Shouldn't this use !equals(...)?</p>", "author": "punktilious", "createdAt": "2020-12-07T16:02:13Z", "path": "fhir-audit/src/main/java/com/ibm/fhir/audit/logging/impl/WhcAuditCadfLogService.java", "diffHunk": "@@ -197,8 +196,10 @@ public static CadfEvent createCadfEvent(AuditLogEntry logEntry)\n         Outcome cadfEventOutCome;\n \n         // Cadf does't log config, so skip\n-        if ((logEntry.getEventType() != AuditLogEventType.FHIR_CONFIGDATA.value()) && logEntry.getContext() != null\n-                && logEntry.getContext().getAction() != null && logEntry.getContext().getApiParameters() != null) {\n+        if ((logEntry.getEventType() != AuditLogEventType.FHIR_CONFIGDATA.value())", "originalCommit": "6d00e2c8ec412072a34b0ff59a9370992593832f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY0NjE2MQ==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537646161", "bodyText": "Cleaned this up by addressing Lee's well-known request", "author": "prb112", "createdAt": "2020-12-07T16:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzM0Mg=="}], "type": "inlineReview"}, {"oid": "f2814bf66b821939d42e92031358cc0f5ffbb413", "url": "https://github.com/IBM/FHIR/commit/f2814bf66b821939d42e92031358cc0f5ffbb413", "message": "fix: per code review changed the compare, and added an additional ignore\nfor the metadata endpoints\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-12-07T16:30:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY0ODQ1Mg==", "url": "https://github.com/IBM/FHIR/pull/1804#discussion_r537648452", "body": "```suggestion\r\n        // Skip over the actual logging, in this case, we're deciding by default\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Skip over the actual logging, int his case, we're deciding by default\n          \n          \n            \n                    // Skip over the actual logging, in this case, we're deciding by default", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> Skip over the actual logging, <span class=\"x x-first x-last\">int his</span> case, we're deciding by default</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> Skip over the actual logging, <span class=\"x x-first x-last\">in this</span> case, we're deciding by default</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "lmsurpre", "createdAt": "2020-12-07T16:34:09Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java", "diffHunk": "@@ -311,6 +313,21 @@ public static void logBundle(HttpServletRequest request, Bundle bundle, Date sta\n                 .resourcesUpdated(updateCount).build());\n         entry.setDescription(\"FHIR Bundle request\");\n \n+        // Previously we didn't set the Action which caused the logEntry to\n+        // Skip over the actual logging, int his case, we're deciding by default", "originalCommit": "f2814bf66b821939d42e92031358cc0f5ffbb413", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05602f9306bf2979527649719b02de25e1b2ba4f", "url": "https://github.com/IBM/FHIR/commit/05602f9306bf2979527649719b02de25e1b2ba4f", "message": "Update fhir-server/src/main/java/com/ibm/fhir/server/util/RestAuditLogger.java\r\n\r\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\nCo-authored-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-12-07T16:39:54Z", "type": "commit"}]}