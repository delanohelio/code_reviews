{"pr_number": 2212, "pr_title": "Ignore registry port when inferring auth from maven settings", "pr_author": "padyx", "pr_createdAt": "2020-01-03T23:41:44Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2212", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTk1MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363509950", "body": "It'd be nice if this `server == null` code could go into getServerFromMavenSettings", "bodyText": "It'd be nice if this server == null code could go into getServerFromMavenSettings", "bodyHTML": "<p dir=\"auto\">It'd be nice if this <code>server == null</code> code could go into getServerFromMavenSettings</p>", "author": "loosebazooka", "createdAt": "2020-01-06T22:17:53Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -58,7 +59,7 @@\n   @Override\n   public Optional<AuthProperty> inferAuth(String registry) throws InferredAuthException {\n \n-    Server server = settings.getServer(registry);\n+    Server server = getServerFromMavenSettings(registry);\n     if (server == null) {", "originalCommit": "86324f93e634e5363a36f9b0036510837e7d6dd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyODk0Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363928946", "bodyText": "Could you elaborate? I can't see an option right now to implement that: There could, or could not be, a server returned.\nIf I switch this to use Optional, I would have to swap this out with an isPresent check instead to continue with the decryption below...", "author": "padyx", "createdAt": "2020-01-07T20:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzMjg0NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363932845", "bodyText": "Makes sense. I think we can leave this null check here.", "author": "chanseokoh", "createdAt": "2020-01-07T20:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyOTU2MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363929561", "body": "You don't need this null check. We check nullability with NullAway, and unless the argument is marked with `@Nullable`, it is never null.", "bodyText": "You don't need this null check. We check nullability with NullAway, and unless the argument is marked with @Nullable, it is never null.", "bodyHTML": "<p dir=\"auto\">You don't need this null check. We check nullability with NullAway, and unless the argument is marked with <code>@Nullable</code>, it is never null.</p>", "author": "chanseokoh", "createdAt": "2020-01-07T20:10:31Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +109,23 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable\n+  Server getServerFromMavenSettings(String registry) {\n+    // Find and remove port (if present)\n+    if (registry == null) {\n+      return null;\n+    }", "originalCommit": "b792049b2b01adb4504a9790e0d8587f62a430f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyOTYzMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363929631", "body": "Please add `@VisibleForTesting`.", "bodyText": "Please add @VisibleForTesting.", "bodyHTML": "<p dir=\"auto\">Please add <code>@VisibleForTesting</code>.</p>", "author": "chanseokoh", "createdAt": "2020-01-07T20:10:42Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +109,23 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable", "originalCommit": "b792049b2b01adb4504a9790e0d8587f62a430f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzMjE4Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363932187", "body": "I suggest\r\n\r\n```java\r\n    int index = registry.lastIndexOf(':');\r\n    if (index != -1) {\r\n      return settings.getServer(registry.substring(0, index));\r\n    }\r\n    return null;\r\n```\r\nNo need to call `settings.getServer()` twice if nothing is configured.", "bodyText": "I suggest\n    int index = registry.lastIndexOf(':');\n    if (index != -1) {\n      return settings.getServer(registry.substring(0, index));\n    }\n    return null;\nNo need to call settings.getServer() twice if nothing is configured.", "bodyHTML": "<p dir=\"auto\">I suggest</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    int index = registry.lastIndexOf(':');\n    if (index != -1) {\n      return settings.getServer(registry.substring(0, index));\n    }\n    return null;\n\"><pre>    <span class=\"pl-k\">int</span> index <span class=\"pl-k\">=</span> registry<span class=\"pl-k\">.</span>lastIndexOf(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>:<span class=\"pl-pds\">'</span></span>);\n    <span class=\"pl-k\">if</span> (index <span class=\"pl-k\">!=</span> <span class=\"pl-k\">-</span><span class=\"pl-c1\">1</span>) {\n      <span class=\"pl-k\">return</span> settings<span class=\"pl-k\">.</span>getServer(registry<span class=\"pl-k\">.</span>substring(<span class=\"pl-c1\">0</span>, index));\n    }\n    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">null</span>;</pre></div>\n<p dir=\"auto\">No need to call <code>settings.getServer()</code> twice if nothing is configured.</p>", "author": "chanseokoh", "createdAt": "2020-01-07T20:17:28Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +109,23 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable\n+  Server getServerFromMavenSettings(String registry) {\n+    // Find and remove port (if present)\n+    if (registry == null) {\n+      return null;\n+    }\n+\n+    Server server = settings.getServer(registry);\n+    if (server != null) {\n+      return server;\n+    }\n+\n+    int index = registry.lastIndexOf(':');\n+    if (index != -1) {\n+      registry = registry.substring(0, index);\n+    }\n+    return settings.getServer(registry);", "originalCommit": "165a9b2270c062066dca2fb786c5320780619ae8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c694ae17754b986ee13ac8df1c5bbce7856558b5", "url": "https://github.com/GoogleContainerTools/jib/commit/c694ae17754b986ee13ac8df1c5bbce7856558b5", "message": "Ignore port as fallback when inferring registry auth from maven settings\n\nFixes #2135", "committedDate": "2020-01-07T21:01:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk1Mjg0NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r363952845", "body": "Oh, this comment is now confusing. Let's update and move this to line 123:\r\n\r\n```java\r\n// try without port\r\nint index = registry.lastIndexOf(':');\r\n```\r\n\r\n(Sorry, I should have caught this earlier.)", "bodyText": "Oh, this comment is now confusing. Let's update and move this to line 123:\n// try without port\nint index = registry.lastIndexOf(':');\n(Sorry, I should have caught this earlier.)", "bodyHTML": "<p dir=\"auto\">Oh, this comment is now confusing. Let's update and move this to line 123:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"// try without port\nint index = registry.lastIndexOf(':');\"><pre><span class=\"pl-c\"><span class=\"pl-c\">//</span> try without port</span>\n<span class=\"pl-k\">int</span> index <span class=\"pl-k\">=</span> registry<span class=\"pl-k\">.</span>lastIndexOf(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>:<span class=\"pl-pds\">'</span></span>);</pre></div>\n<p dir=\"auto\">(Sorry, I should have caught this earlier.)</p>", "author": "chanseokoh", "createdAt": "2020-01-07T21:11:53Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenSettingsServerCredentials.java", "diffHunk": "@@ -108,4 +110,20 @@ public String getPasswordDescriptor() {\n           }\n         });\n   }\n+\n+  @Nullable\n+  @VisibleForTesting\n+  Server getServerFromMavenSettings(String registry) {\n+    // Find and remove port (if present)", "originalCommit": "c694ae17754b986ee13ac8df1c5bbce7856558b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAxMTIyNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2212#discussion_r364011225", "bodyText": "Never mind. I just did it myself.", "author": "chanseokoh", "createdAt": "2020-01-08T00:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk1Mjg0NQ=="}], "type": "inlineReview"}, {"oid": "8e274d996d89963c21ac8ddea87f6a2efde935dc", "url": "https://github.com/GoogleContainerTools/jib/commit/8e274d996d89963c21ac8ddea87f6a2efde935dc", "message": "Update comment", "committedDate": "2020-01-08T00:06:42Z", "type": "commit"}]}