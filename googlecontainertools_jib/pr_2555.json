{"pr_number": 2555, "pr_title": "Test for RegistryClient.pullManifest() ", "pr_author": "louismurerwa", "pr_createdAt": "2020-06-30T15:34:45Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2555", "timeline": [{"oid": "5c47fd196093070ce10c6d48c6510c7eda8c6d86", "url": "https://github.com/GoogleContainerTools/jib/commit/5c47fd196093070ce10c6d48c6510c7eda8c6d86", "message": "Solved:NPE if the server doesn't provide any HTTP content for an error", "committedDate": "2020-06-26T20:14:34Z", "type": "commit"}, {"oid": "01835a184a7e1b7595885098e942d70c1b7d7598", "url": "https://github.com/GoogleContainerTools/jib/commit/01835a184a7e1b7595885098e942d70c1b7d7598", "message": "WIP", "committedDate": "2020-06-26T21:28:46Z", "type": "commit"}, {"oid": "47ed51d4f65c96c3e6f62ef850692183a9beae7b", "url": "https://github.com/GoogleContainerTools/jib/commit/47ed51d4f65c96c3e6f62ef850692183a9beae7b", "message": "Google Style Formating Done", "committedDate": "2020-06-26T23:33:01Z", "type": "commit"}, {"oid": "090d655527b962e8ccb8ed58178a954cd1ad4456", "url": "https://github.com/GoogleContainerTools/jib/commit/090d655527b962e8ccb8ed58178a954cd1ad4456", "message": "Fixed the error the styling errors", "committedDate": "2020-06-29T15:20:46Z", "type": "commit"}, {"oid": "6473b4258fe570fc2f507ce7dcc0a03807218a2a", "url": "https://github.com/GoogleContainerTools/jib/commit/6473b4258fe570fc2f507ce7dcc0a03807218a2a", "message": "Merge branch 'master' of https://github.com/GoogleContainerTools/jib into louis-fixnpeexception\nMerging #2537 fix", "committedDate": "2020-06-29T15:23:14Z", "type": "commit"}, {"oid": "646542cde28b272d7dd11c3b7cfbf419a3100542", "url": "https://github.com/GoogleContainerTools/jib/commit/646542cde28b272d7dd11c3b7cfbf419a3100542", "message": "Fixing styling errors", "committedDate": "2020-06-29T15:31:01Z", "type": "commit"}, {"oid": "6594293f20346612c6b1985d4e62143e1013fc83", "url": "https://github.com/GoogleContainerTools/jib/commit/6594293f20346612c6b1985d4e62143e1013fc83", "message": "Minor Style Fix", "committedDate": "2020-06-29T15:37:17Z", "type": "commit"}, {"oid": "1532cb18a29a9ae5fa264f94426922c27065c6ee", "url": "https://github.com/GoogleContainerTools/jib/commit/1532cb18a29a9ae5fa264f94426922c27065c6ee", "message": "RegistryClient.pullManifest() Test", "committedDate": "2020-06-30T15:24:34Z", "type": "commit"}, {"oid": "7fa9e567bf18a2675cb45b89661f617699f89d13", "url": "https://github.com/GoogleContainerTools/jib/commit/7fa9e567bf18a2675cb45b89661f617699f89d13", "message": "Merge branch 'master' of https://github.com/GoogleContainerTools/jib into pullmanifest\nUpdate local branch", "committedDate": "2020-06-30T15:25:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MTM3Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447781377", "body": "```suggestion\r\n```\r\nI think we can just specify this string when calling `pullManifest(...)`.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String imageTag = \"testIMage\";\n          \n      \n    \n    \n  \n\nI think we can just specify this string when calling pullManifest(...).", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">    </span><span class=\"pl-smi x\">String</span><span class=\"x\"> imageTag </span><span class=\"pl-k x\">=</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">testIMage</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">;</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I think we can just specify this string when calling <code>pullManifest(...)</code>.</p>", "author": "chanseokoh", "createdAt": "2020-06-30T15:38:06Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +211,29 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String imageTag = \"testIMage\";", "originalCommit": "7fa9e567bf18a2675cb45b89661f617699f89d13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4OTYyNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447789625", "bodyText": "Done", "author": "louismurerwa", "createdAt": "2020-06-30T15:49:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MTM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MTcyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447781727", "body": "```suggestion\r\n    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(imageTag);\n          \n          \n            \n                ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">ManifestAndDigest&lt;?&gt;</span> manifestAndDigest <span class=\"pl-k\">=</span> registryClient<span class=\"pl-k\">.</span>pullManifest(<span class=\"x x-first x-last\">imageTag</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">ManifestAndDigest&lt;?&gt;</span> manifestAndDigest <span class=\"pl-k\">=</span> registryClient<span class=\"pl-k\">.</span>pullManifest(<span class=\"pl-s\"><span class=\"pl-pds x x-first\">\"</span><span class=\"x\">image-tag</span><span class=\"pl-pds x x-last\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "chanseokoh", "createdAt": "2020-06-30T15:38:36Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +211,29 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String imageTag = \"testIMage\";\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(imageTag);", "originalCommit": "7fa9e567bf18a2675cb45b89661f617699f89d13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4OTkwMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447789903", "bodyText": "Done", "author": "louismurerwa", "createdAt": "2020-06-30T15:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MTcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4NTQ1OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447785458", "body": "Instead of this, let's verify the details with the returned manifest (`getManifest()`) + digest (`getDigest()`).\r\n\r\nThe manifest in this case would be of type `V22ManifestTemplate`. So you could\r\n```java\r\nAssert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\r\nV22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\r\nAssert.assertEquals(2, manifest.getSchemaVersion());\r\nAssert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\r\n... // you can do more checks\r\n```\r\n\r\nLikewise, you'll be able to verify values in the returned digest.\r\n```java\r\nassertEquaus(\"sha256:...\", manifest.getDigest().toString());\r\n...\r\n```", "bodyText": "Instead of this, let's verify the details with the returned manifest (getManifest()) + digest (getDigest()).\nThe manifest in this case would be of type V22ManifestTemplate. So you could\nAssert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\nV22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\nAssert.assertEquals(2, manifest.getSchemaVersion());\nAssert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\n... // you can do more checks\nLikewise, you'll be able to verify values in the returned digest.\nassertEquaus(\"sha256:...\", manifest.getDigest().toString());\n...", "bodyHTML": "<p dir=\"auto\">Instead of this, let's verify the details with the returned manifest (<code>getManifest()</code>) + digest (<code>getDigest()</code>).</p>\n<p dir=\"auto\">The manifest in this case would be of type <code>V22ManifestTemplate</code>. So you could</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\nV22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\nAssert.assertEquals(2, manifest.getSchemaVersion());\nAssert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\n... // you can do more checks\"><pre><span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertTrue(manifestAndDigest<span class=\"pl-k\">.</span>getManifest() <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">V22ManifestTemplate</span>);\n<span class=\"pl-smi\">V22ManifestTemplate</span> manifest <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">V22ManifestTemplate</span>) manifestAndDigest<span class=\"pl-k\">.</span>getManifest();\n<span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertEquals(<span class=\"pl-c1\">2</span>, manifest<span class=\"pl-k\">.</span>getSchemaVersion());\n<span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertEquals(<span class=\"pl-c1\">7023</span>, manifest<span class=\"pl-k\">.</span>getContainerConfiguration()<span class=\"pl-k\">.</span>getSize());\n<span class=\"pl-c1\">...</span> <span class=\"pl-c\"><span class=\"pl-c\">//</span> you can do more checks</span></pre></div>\n<p dir=\"auto\">Likewise, you'll be able to verify values in the returned digest.</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"assertEquaus(&quot;sha256:...&quot;, manifest.getDigest().toString());\n...\"><pre>assertEquaus(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>sha256:...<span class=\"pl-pds\">\"</span></span>, manifest<span class=\"pl-k\">.</span>getDigest()<span class=\"pl-k\">.</span>toString());\n<span class=\"pl-c1\">...</span></pre></div>", "author": "chanseokoh", "createdAt": "2020-06-30T15:43:58Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +211,29 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String imageTag = \"testIMage\";\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(imageTag);\n+    Assert.assertEquals(66, manifestAndDigest.getManifest().toString().length());", "originalCommit": "7fa9e567bf18a2675cb45b89661f617699f89d13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5MTY0Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447791646", "bodyText": "This is a good suggestion.This enables us to confirm that this is the actual manifest we intended to receive.", "author": "louismurerwa", "createdAt": "2020-06-30T15:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4NTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MTI2MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447851260", "bodyText": "Exactly!", "author": "chanseokoh", "createdAt": "2020-06-30T17:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4NTQ1OA=="}], "type": "inlineReview"}, {"oid": "c45f59691669fe50bf870576409157c5f66f8a59", "url": "https://github.com/GoogleContainerTools/jib/commit/c45f59691669fe50bf870576409157c5f66f8a59", "message": "Added more manifest checks", "committedDate": "2020-06-30T16:39:12Z", "type": "commit"}, {"oid": "f03f79cf6ea8de6dac5c6b3aa90a3af1bbcca531", "url": "https://github.com/GoogleContainerTools/jib/commit/f03f79cf6ea8de6dac5c6b3aa90a3af1bbcca531", "message": "Merge branch 'master' of https://github.com/GoogleContainerTools/jib into pullmanifest", "committedDate": "2020-06-30T17:15:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0OTU1Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447849557", "body": "```suggestion\r\n    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\r\n```\r\nCheck the instance here before force-casting below so that in case it's not of `V22ManifestTemplate`, the test doesn't crash with `ClassCastException`.\r\n\r\nAnd we can skip trivial comments. ", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // verify details of the returned manifest\n          \n          \n            \n                Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\n          \n      \n    \n    \n  \n\nCheck the instance here before force-casting below so that in case it's not of V22ManifestTemplate, the test doesn't crash with ClassCastException.\nAnd we can skip trivial comments.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c x x-first\">//</span><span class=\"x x-last\"> verify details of the returned manifest</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-smi x x-first\">Assert</span><span class=\"pl-k x\">.</span><span class=\"x\">assertTrue(manifestAndDigest</span><span class=\"pl-k x\">.</span><span class=\"x\">getManifest() </span><span class=\"pl-k x\">instanceof</span><span class=\"x\"> </span><span class=\"pl-smi x\">V22ManifestTemplate</span><span class=\"x x-last\">);</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Check the instance here before force-casting below so that in case it's not of <code>V22ManifestTemplate</code>, the test doesn't crash with <code>ClassCastException</code>.</p>\n<p dir=\"auto\">And we can skip trivial comments.</p>", "author": "chanseokoh", "createdAt": "2020-06-30T17:15:23Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +212,37 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    // verify details of the returned manifest", "originalCommit": "c45f59691669fe50bf870576409157c5f66f8a59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg2NTA4MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447865081", "bodyText": "Done !! This a clever way of avoiding type an object which is not of V22ManifestTemplate.", "author": "louismurerwa", "createdAt": "2020-06-30T17:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0OTU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MDQ2NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447850465", "body": "As I said before, could you also verify `manifestAndDigest.getDigest().toString()`?", "bodyText": "As I said before, could you also verify manifestAndDigest.getDigest().toString()?", "bodyHTML": "<p dir=\"auto\">As I said before, could you also verify <code>manifestAndDigest.getDigest().toString()</code>?</p>", "author": "chanseokoh", "createdAt": "2020-06-30T17:16:55Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +212,37 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    // verify details of the returned manifest\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\n+  }", "originalCommit": "f03f79cf6ea8de6dac5c6b3aa90a3af1bbcca531", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1NDMxMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447854311", "bodyText": "The manifest file itself doesn't contain a digest in this instance.The digest is in the config file so thats why I used manifest.getContainerConfiguration().getDigest().toString()).I will use the manifestAndDigest.getDigest().toString() when dealing with a manifest list.", "author": "louismurerwa", "createdAt": "2020-06-30T17:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MDQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1ODE0OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447858148", "bodyText": "Oh! There's another test I forget to mention. Testing if pullManifest() is hitting the correct registry API endpoint for fetching a manifest.\nTestWebServer has getInputRead(), which will return all the input pullManifest() has sent through the low-level HTTP protocol. If you check the return value of TestWebServer.getInputRead(), it will contain a line like this:\nGET /v2/foo/bar/manifests/image-tag .... So you can have\nAssert.assertThat(registry.getInputRead(), CoreMatchers.containsString(\"GET ...\"));", "author": "chanseokoh", "createdAt": "2020-06-30T17:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MDQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg2NzE5NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447867194", "bodyText": "manifest.getContainerConfiguration().getDigest().toString() is the SHA256 hash of the test JSON input. (For example, if you change the content of the JSON, say, \"size\": 7023 to \"size\": 98, the hash will change as well.) It's worth checking if pullManifest() is correctly computing the digest.", "author": "chanseokoh", "createdAt": "2020-06-30T17:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MDQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NDg0MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447874840", "bodyText": "I see what you mean !! Done.", "author": "louismurerwa", "createdAt": "2020-06-30T17:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MDQ2NQ=="}], "type": "inlineReview"}, {"oid": "45ead22e5206cc31ba1e0d992007c0171fcdfa52", "url": "https://github.com/GoogleContainerTools/jib/commit/45ead22e5206cc31ba1e0d992007c0171fcdfa52", "message": "Checking Digest of the Json", "committedDate": "2020-06-30T18:10:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4NzY5Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447887696", "body": "nit: `HTTP/1.1` refers to an HTTP protocol version that can change (e.g., when the underlying HTTP client library we use changes the HTTP version), so let's remove it.\r\n\r\n```suggestion\r\n        CoreMatchers.containsString(\"GET /v2/foo/bar/manifests/image-tag \"));\r\n```", "bodyText": "nit: HTTP/1.1 refers to an HTTP protocol version that can change (e.g., when the underlying HTTP client library we use changes the HTTP version), so let's remove it.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    CoreMatchers.containsString(\"GET /v2/foo/bar/manifests/image-tag HTTP/1.1\"));\n          \n          \n            \n                    CoreMatchers.containsString(\"GET /v2/foo/bar/manifests/image-tag \"));", "bodyHTML": "<p dir=\"auto\">nit: <code>HTTP/1.1</code> refers to an HTTP protocol version that can change (e.g., when the underlying HTTP client library we use changes the HTTP version), so let's remove it.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">CoreMatchers</span><span class=\"pl-k\">.</span>containsString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>GET /v2/foo/bar/manifests/image-tag <span class=\"x x-first x-last\">HTTP/1.1</span><span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">CoreMatchers</span><span class=\"pl-k\">.</span>containsString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>GET /v2/foo/bar/manifests/image-tag <span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "chanseokoh", "createdAt": "2020-06-30T18:17:32Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +212,42 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:6b61466eabab6e5ffb68ae2bd9b85c789225540c2ac54ea1f71eb327588e8946\",\n+        manifestAndDigest.getDigest().toString());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\n+    Assert.assertThat(\n+        registry.getInputRead(),\n+        CoreMatchers.containsString(\"GET /v2/foo/bar/manifests/image-tag HTTP/1.1\"));", "originalCommit": "45ead22e5206cc31ba1e0d992007c0171fcdfa52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkxMTE1NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r447911155", "bodyText": "I see !! Done.", "author": "louismurerwa", "createdAt": "2020-06-30T18:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4NzY5Ng=="}], "type": "inlineReview"}, {"oid": "449f4675b39f182043badd50347a2ee7616f1e0e", "url": "https://github.com/GoogleContainerTools/jib/commit/449f4675b39f182043badd50347a2ee7616f1e0e", "message": "Changing Http CLient", "committedDate": "2020-06-30T18:56:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwNzE2NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448007165", "body": "nit: put a newline after this for better readability (separating the manifest checks and the endpoint check.)", "bodyText": "nit: put a newline after this for better readability (separating the manifest checks and the endpoint check.)", "bodyHTML": "<p dir=\"auto\">nit: put a newline after this for better readability (separating the manifest checks and the endpoint check.)</p>", "author": "chanseokoh", "createdAt": "2020-06-30T22:08:55Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +212,42 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:6b61466eabab6e5ffb68ae2bd9b85c789225540c2ac54ea1f71eb327588e8946\",\n+        manifestAndDigest.getDigest().toString());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(7023, manifest.getContainerConfiguration().getSize());", "originalCommit": "449f4675b39f182043badd50347a2ee7616f1e0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1OTYxOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448459619", "bodyText": "I had missed this one .Done.", "author": "louismurerwa", "createdAt": "2020-07-01T15:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwNzE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwNzQxMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448007412", "body": "nit: ditto. Let's put a newline after this. ", "bodyText": "nit: ditto. Let's put a newline after this.", "bodyHTML": "<p dir=\"auto\">nit: ditto. Let's put a newline after this.</p>", "author": "chanseokoh", "createdAt": "2020-06-30T22:09:21Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +212,42 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:6b61466eabab6e5ffb68ae2bd9b85c789225540c2ac54ea1f71eb327588e8946\",\n+        manifestAndDigest.getDigest().toString());", "originalCommit": "449f4675b39f182043badd50347a2ee7616f1e0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ2MDA5OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448460098", "bodyText": "Done", "author": "louismurerwa", "createdAt": "2020-07-01T15:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwNzQxMg=="}], "type": "inlineReview"}, {"oid": "8eb56afe89c806984390f66c2c2cf12ae6345c05", "url": "https://github.com/GoogleContainerTools/jib/commit/8eb56afe89c806984390f66c2c2cf12ae6345c05", "message": "Test for RegistryClient.pullmanifestlist()", "committedDate": "2020-07-01T15:02:37Z", "type": "commit"}, {"oid": "8150d45ee11cb2b83feebec469e2daea391e3ead", "url": "https://github.com/GoogleContainerTools/jib/commit/8150d45ee11cb2b83feebec469e2daea391e3ead", "message": "Merge branch 'master' of https://github.com/GoogleContainerTools/jib into pullmanifest", "committedDate": "2020-07-01T15:03:46Z", "type": "commit"}, {"oid": "66801367a69a3d32e6351740581e8f2d102827dd", "url": "https://github.com/GoogleContainerTools/jib/commit/66801367a69a3d32e6351740581e8f2d102827dd", "message": "Added endpoint test", "committedDate": "2020-07-01T15:14:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNDg2MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448434861", "body": "`getDigestsForPlatform()` returns a `List` object. For complex objects that have multiple other objects/fields/values, often their `toString()` is more or less an internal/debug string representation of the objects. That is, theoretically the string form generated by `List.toString()` is not canonical and may change in future Java versions. For verifying the elements in a list, you would rather do\r\n\r\n```java\r\nassertEquals(\r\n    Arrays.asList(\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\"), \r\n    manifestList.getDigestsForPlatform(\"amd64\", \"linux\"));\r\n```", "bodyText": "getDigestsForPlatform() returns a List object. For complex objects that have multiple other objects/fields/values, often their toString() is more or less an internal/debug string representation of the objects. That is, theoretically the string form generated by List.toString() is not canonical and may change in future Java versions. For verifying the elements in a list, you would rather do\nassertEquals(\n    Arrays.asList(\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\"), \n    manifestList.getDigestsForPlatform(\"amd64\", \"linux\"));", "bodyHTML": "<p dir=\"auto\"><code>getDigestsForPlatform()</code> returns a <code>List</code> object. For complex objects that have multiple other objects/fields/values, often their <code>toString()</code> is more or less an internal/debug string representation of the objects. That is, theoretically the string form generated by <code>List.toString()</code> is not canonical and may change in future Java versions. For verifying the elements in a list, you would rather do</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"assertEquals(\n    Arrays.asList(&quot;sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f&quot;), \n    manifestList.getDigestsForPlatform(&quot;amd64&quot;, &quot;linux&quot;));\"><pre>assertEquals(\n    <span class=\"pl-smi\">Arrays</span><span class=\"pl-k\">.</span>asList(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f<span class=\"pl-pds\">\"</span></span>), \n    manifestList<span class=\"pl-k\">.</span>getDigestsForPlatform(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>amd64<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>linux<span class=\"pl-pds\">\"</span></span>));</pre></div>", "author": "chanseokoh", "createdAt": "2020-07-01T15:15:01Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +213,82 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:6b61466eabab6e5ffb68ae2bd9b85c789225540c2ac54ea1f71eb327588e8946\",\n+        manifestAndDigest.getDigest().toString());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\n+    Assert.assertThat(\n+        registry.getInputRead(),\n+        CoreMatchers.containsString(\"GET /v2/foo/bar/manifests/image-tag \"));\n+  }\n+\n+  @Test\n+  public void testPullManifest_manifestList()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 403\\n\\n{\\n\"\n+            + \"  \\\"schemaVersion\\\": 2,\\n\"\n+            + \"  \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.list.v2+json\\\",\\n\"\n+            + \"  \\\"manifests\\\": [\\n\"\n+            + \"    {\\n\"\n+            + \"      \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"      \\\"size\\\": 7143,\\n\"\n+            + \"      \\\"digest\\\": \\\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\\\",\\n\"\n+            + \"      \\\"platform\\\": {\\n\"\n+            + \"        \\\"architecture\\\": \\\"amd64\\\",\\n\"\n+            + \"        \\\"os\\\": \\\"linux\\\"\\n\"\n+            + \"      }\\n\"\n+            + \"    }\\n\"\n+            + \"  ]\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:a340fa38667f765f8cfd79d4bc684ec8a6f48cdd63abfe36e109f4125ee38488\",\n+        manifestAndDigest.getDigest().toString());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestListTemplate);\n+    V22ManifestListTemplate manifestList =\n+        (V22ManifestListTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifestList.getSchemaVersion());\n+    Assert.assertEquals(", "originalCommit": "66801367a69a3d32e6351740581e8f2d102827dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDM2NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448450365", "bodyText": "done", "author": "louismurerwa", "createdAt": "2020-07-01T15:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNDg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNTQyNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448435426", "body": "nit: ditto. Let's put a newline after this.", "bodyText": "nit: ditto. Let's put a newline after this.", "bodyHTML": "<p dir=\"auto\">nit: ditto. Let's put a newline after this.</p>", "author": "chanseokoh", "createdAt": "2020-07-01T15:15:47Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +213,82 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:6b61466eabab6e5ffb68ae2bd9b85c789225540c2ac54ea1f71eb327588e8946\",\n+        manifestAndDigest.getDigest().toString());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\n+    Assert.assertThat(\n+        registry.getInputRead(),\n+        CoreMatchers.containsString(\"GET /v2/foo/bar/manifests/image-tag \"));\n+  }\n+\n+  @Test\n+  public void testPullManifest_manifestList()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 403\\n\\n{\\n\"\n+            + \"  \\\"schemaVersion\\\": 2,\\n\"\n+            + \"  \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.list.v2+json\\\",\\n\"\n+            + \"  \\\"manifests\\\": [\\n\"\n+            + \"    {\\n\"\n+            + \"      \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"      \\\"size\\\": 7143,\\n\"\n+            + \"      \\\"digest\\\": \\\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\\\",\\n\"\n+            + \"      \\\"platform\\\": {\\n\"\n+            + \"        \\\"architecture\\\": \\\"amd64\\\",\\n\"\n+            + \"        \\\"os\\\": \\\"linux\\\"\\n\"\n+            + \"      }\\n\"\n+            + \"    }\\n\"\n+            + \"  ]\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:a340fa38667f765f8cfd79d4bc684ec8a6f48cdd63abfe36e109f4125ee38488\",\n+        manifestAndDigest.getDigest().toString());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestListTemplate);\n+    V22ManifestListTemplate manifestList =\n+        (V22ManifestListTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifestList.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"[sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f]\",\n+        manifestList.getDigestsForPlatform(\"amd64\", \"linux\").toString());", "originalCommit": "66801367a69a3d32e6351740581e8f2d102827dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDA3Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448450073", "bodyText": "done", "author": "louismurerwa", "createdAt": "2020-07-01T15:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNTQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNTYxNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448435614", "body": "nit: ditto. Let's put a newline after this.", "bodyText": "nit: ditto. Let's put a newline after this.", "bodyHTML": "<p dir=\"auto\">nit: ditto. Let's put a newline after this.</p>", "author": "chanseokoh", "createdAt": "2020-07-01T15:16:07Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/registry/RegistryClientTest.java", "diffHunk": "@@ -211,6 +213,82 @@ public void testConfigureBasicAuth()\n         registry.getInputRead(), CoreMatchers.containsString(\"Authorization: Basic dXNlcjpwYXNz\"));\n   }\n \n+  @Test\n+  public void testPullManifest()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 307\\n\\n{\\n\"\n+            + \"    \\\"schemaVersion\\\": 2,\\n\"\n+            + \"    \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"    \\\"config\\\": {\\n\"\n+            + \"        \\\"mediaType\\\": \\\"application/vnd.docker.container.image.v1+json\\\",\\n\"\n+            + \"        \\\"size\\\": 7023,\\n\"\n+            + \"        \\\"digest\\\": \\\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\\\"\\n\"\n+            + \"    }\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:6b61466eabab6e5ffb68ae2bd9b85c789225540c2ac54ea1f71eb327588e8946\",\n+        manifestAndDigest.getDigest().toString());\n+    Assert.assertTrue(manifestAndDigest.getManifest() instanceof V22ManifestTemplate);\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestAndDigest.getManifest();\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(7023, manifest.getContainerConfiguration().getSize());\n+    Assert.assertThat(\n+        registry.getInputRead(),\n+        CoreMatchers.containsString(\"GET /v2/foo/bar/manifests/image-tag \"));\n+  }\n+\n+  @Test\n+  public void testPullManifest_manifestList()\n+      throws IOException, InterruptedException, GeneralSecurityException, URISyntaxException,\n+          RegistryException {\n+    String manifestResponse =\n+        \"HTTP/1.1 200 OK\\nContent-Length: 403\\n\\n{\\n\"\n+            + \"  \\\"schemaVersion\\\": 2,\\n\"\n+            + \"  \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.list.v2+json\\\",\\n\"\n+            + \"  \\\"manifests\\\": [\\n\"\n+            + \"    {\\n\"\n+            + \"      \\\"mediaType\\\": \\\"application/vnd.docker.distribution.manifest.v2+json\\\",\\n\"\n+            + \"      \\\"size\\\": 7143,\\n\"\n+            + \"      \\\"digest\\\": \\\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\\\",\\n\"\n+            + \"      \\\"platform\\\": {\\n\"\n+            + \"        \\\"architecture\\\": \\\"amd64\\\",\\n\"\n+            + \"        \\\"os\\\": \\\"linux\\\"\\n\"\n+            + \"      }\\n\"\n+            + \"    }\\n\"\n+            + \"  ]\\n\"\n+            + \"}\";\n+\n+    registry = new TestWebServer(false, Arrays.asList(manifestResponse), 1);\n+    RegistryClient registryClient = createRegistryClient(null);\n+    ManifestAndDigest<?> manifestAndDigest = registryClient.pullManifest(\"image-tag\");\n+\n+    Assert.assertEquals(\n+        \"sha256:a340fa38667f765f8cfd79d4bc684ec8a6f48cdd63abfe36e109f4125ee38488\",\n+        manifestAndDigest.getDigest().toString());", "originalCommit": "66801367a69a3d32e6351740581e8f2d102827dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDE1MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2555#discussion_r448450151", "bodyText": "done", "author": "louismurerwa", "createdAt": "2020-07-01T15:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNTYxNA=="}], "type": "inlineReview"}, {"oid": "76a101bffa1a7f68ec107b5e9afb8f881908018a", "url": "https://github.com/GoogleContainerTools/jib/commit/76a101bffa1a7f68ec107b5e9afb8f881908018a", "message": "Small Style CHanges", "committedDate": "2020-07-01T15:42:21Z", "type": "commit"}, {"oid": "982de04c900c64ce7434da20505a9bb3a674cc64", "url": "https://github.com/GoogleContainerTools/jib/commit/982de04c900c64ce7434da20505a9bb3a674cc64", "message": "Styling", "committedDate": "2020-07-01T15:54:39Z", "type": "commit"}]}