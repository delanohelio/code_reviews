{"pr_number": 2580, "pr_title": "Add LayerSpec, ArchiveLayerSpec, FileLayerSpec for buildfile", "pr_author": "loosebazooka", "pr_createdAt": "2020-07-10T20:15:24Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2580", "timeline": [{"oid": "540600f26292909f4a47a87ad8b38a897414ad50", "url": "https://github.com/GoogleContainerTools/jib/commit/540600f26292909f4a47a87ad8b38a897414ad50", "message": "Add LayerSpec, ArchiveLayerSpec, FileLayerSpec for buildfile", "committedDate": "2020-07-10T20:14:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MDczOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453850739", "body": "I do remember the checkstyle complained if having a Javadoc not ending with a period. :man_shrugging:\r\n\r\n```suggestion\r\n * A yaml block for specifying archive layers.\r\n```", "bodyText": "I do remember the checkstyle complained if having a Javadoc not ending with a period. \ud83e\udd37\u200d\u2642\ufe0f\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A yaml block for specifying archive layers\n          \n          \n            \n             * A yaml block for specifying archive layers.", "bodyHTML": "<p dir=\"auto\">I do remember the checkstyle complained if having a Javadoc not ending with a period. <g-emoji class=\"g-emoji\" alias=\"man_shrugging\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f937-2642.png\">\ud83e\udd37\u200d\u2642\ufe0f</g-emoji></p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">A</span> yaml block <span class=\"pl-k\">for</span> specifying archive layers</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">A</span> yaml block <span class=\"pl-k\">for</span> specifying archive layers<span class=\"x x-first x-last\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "chanseokoh", "createdAt": "2020-07-13T18:34:35Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/ArchiveLayerSpec.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A yaml block for specifying archive layers", "originalCommit": "540600f26292909f4a47a87ad8b38a897414ad50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4NTYyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453885627", "bodyText": "Weird that it didn't catch these?", "author": "loosebazooka", "createdAt": "2020-07-13T19:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MDczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MjgzMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453852831", "body": "```suggestion\r\n * A yaml block for specifying files layers.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A yaml block for specifying files layers\n          \n          \n            \n             * A yaml block for specifying files layers.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">A</span> yaml block <span class=\"pl-k\">for</span> specifying files layers</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">A</span> yaml block <span class=\"pl-k\">for</span> specifying files layers<span class=\"x x-first x-last\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "chanseokoh", "createdAt": "2020-07-13T18:38:11Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FileLayerSpec.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import java.util.List;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A yaml block for specifying files layers", "originalCommit": "540600f26292909f4a47a87ad8b38a897414ad50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MzE0NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453853144", "body": "Should we make a copy?", "bodyText": "Should we make a copy?", "bodyHTML": "<p dir=\"auto\">Should we make a copy?</p>", "author": "chanseokoh", "createdAt": "2020-07-13T18:38:41Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FileLayerSpec.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import java.util.List;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A yaml block for specifying files layers\n+ *\n+ * <p>Example use of this yaml snippet.\n+ *\n+ * <pre>{@code\n+ * name: \"my classes layer\"\n+ * files:\n+ *   - {@link CopySpec}\n+ *   - {@link CopySpec}\n+ * // optional properties\n+ * properties: see {@link FilePropertiesSpec}\n+ * }</pre>\n+ */\n+@JsonDeserialize(using = JsonDeserializer.None.class) // required since LayerSpec overrides this\n+public class FileLayerSpec implements LayerSpec {\n+  private String name;\n+  private List<CopySpec> files;\n+  @Nullable private FilePropertiesSpec properties;\n+\n+  /**\n+   * Constructor for use by jackson to populate this object.\n+   *\n+   * @param name a unique name for this layer\n+   * @param files a path to an archive file\n+   * @param properties a {@link FilePropertiesSpec} that applies to all files in this layer\n+   */\n+  @JsonCreator\n+  public FileLayerSpec(\n+      @JsonProperty(value = \"name\", required = true) String name,\n+      @JsonProperty(value = \"files\", required = true) List<CopySpec> files,", "originalCommit": "540600f26292909f4a47a87ad8b38a897414ad50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4NzYyNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453887625", "bodyText": "So I thought about that. This is not a public api, and we will be converting it directly into a build plan. No one will really be processing it in the meantime, so I think it's fine to leave like that.", "author": "loosebazooka", "createdAt": "2020-07-13T19:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MzE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NDU1MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453854551", "body": "Probably `LayerSpec.Deserializer` is publicly accessible, but I guess it doesn't matter because all the buildfile classes are internal and not public API, right?", "bodyText": "Probably LayerSpec.Deserializer is publicly accessible, but I guess it doesn't matter because all the buildfile classes are internal and not public API, right?", "bodyHTML": "<p dir=\"auto\">Probably <code>LayerSpec.Deserializer</code> is publicly accessible, but I guess it doesn't matter because all the buildfile classes are internal and not public API, right?</p>", "author": "chanseokoh", "createdAt": "2020-07-13T18:41:06Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/LayerSpec.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.deser.std.StdDeserializer;\n+import java.io.IOException;\n+\n+/**\n+ * Polymorphic yaml LayerSpec interface with custom deserializer, can parse both {@link\n+ * ArchiveLayerSpec} and {@link FileLayerSpec}.\n+ */\n+@JsonDeserialize(using = LayerSpec.Deserializer.class)\n+public interface LayerSpec {\n+  class Deserializer extends StdDeserializer<LayerSpec> {", "originalCommit": "540600f26292909f4a47a87ad8b38a897414ad50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4NzU4Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453887583", "bodyText": "That's a good point, but since interfaces don't allow the private modifier, I think this is fine. Otherwise we would have to add another class to do this?", "author": "loosebazooka", "createdAt": "2020-07-13T19:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NDU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NTI4MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453855280", "body": "And how about\r\njp --> parser\r\ntxt --> context\r\nn --> node\r\n?", "bodyText": "And how about\njp --> parser\ntxt --> context\nn --> node\n?", "bodyHTML": "<p dir=\"auto\">And how about<br>\njp --&gt; parser<br>\ntxt --&gt; context<br>\nn --&gt; node<br>\n?</p>", "author": "chanseokoh", "createdAt": "2020-07-13T18:42:30Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/LayerSpec.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.deser.std.StdDeserializer;\n+import java.io.IOException;\n+\n+/**\n+ * Polymorphic yaml LayerSpec interface with custom deserializer, can parse both {@link\n+ * ArchiveLayerSpec} and {@link FileLayerSpec}.\n+ */\n+@JsonDeserialize(using = LayerSpec.Deserializer.class)\n+public interface LayerSpec {\n+  class Deserializer extends StdDeserializer<LayerSpec> {\n+\n+    public Deserializer() {\n+      super(LayerSpec.class);\n+    }\n+\n+    /**\n+     * Deserialize based on the presence of \"archive\", if present, consider the layer to be of type\n+     * {@link ArchiveLayerSpec}, else a {@link FileLayerSpec}.\n+     */\n+    @Override\n+    public LayerSpec deserialize(JsonParser jp, DeserializationContext txt) throws IOException {", "originalCommit": "540600f26292909f4a47a87ad8b38a897414ad50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f7a3d822a0f64b7b05a40716dc9ec93379b78b0", "url": "https://github.com/GoogleContainerTools/jib/commit/7f7a3d822a0f64b7b05a40716dc9ec93379b78b0", "message": "fix comments, deserialize method style", "committedDate": "2020-07-13T19:42:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxMDcxOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453910718", "body": "nit: I suggest this as code comment rather than a Javadoc.", "bodyText": "nit: I suggest this as code comment rather than a Javadoc.", "bodyHTML": "<p dir=\"auto\">nit: I suggest this as code comment rather than a Javadoc.</p>", "author": "chanseokoh", "createdAt": "2020-07-13T20:25:07Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/buildfile/ArchiveLayerSpecTest.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import java.nio.file.Paths;\n+import org.hamcrest.CoreMatchers;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ArchiveLayerSpec}. */\n+public class ArchiveLayerSpecTest {\n+\n+  private static final ObjectMapper archiveLayerSpecMapper = new ObjectMapper(new YAMLFactory());\n+\n+  @Test\n+  public void testArchiveLayerSpec_full() throws JsonProcessingException {\n+    String data =\n+        \"name: layer name\\n\" + \"archive: out/archive.tgz\\n\" + \"mediaType: test.media.type\";\n+\n+    ArchiveLayerSpec parsed = archiveLayerSpecMapper.readValue(data, ArchiveLayerSpec.class);\n+    Assert.assertEquals(\"layer name\", parsed.getName());\n+    Assert.assertEquals(Paths.get(\"out/archive.tgz\"), parsed.getArchive());\n+    Assert.assertEquals(\"test.media.type\", parsed.getMediaType().get());\n+  }\n+\n+  @Test\n+  public void testArchiveLayerSpec_nameRequired() {\n+    String data = \"archive: out/archive\";\n+\n+    try {\n+      archiveLayerSpecMapper.readValue(data, ArchiveLayerSpec.class);\n+      Assert.fail();\n+    } catch (JsonProcessingException jpe) {\n+      MatcherAssert.assertThat(\n+          jpe.getMessage(), CoreMatchers.startsWith(\"Missing required creator property 'name'\"));\n+    }\n+  }\n+\n+  /**\n+   * With {@link LayerSpec.Deserializer#deserialize} this test seems pointless, but it still helps\n+   * define the behavior of this class.\n+   */", "originalCommit": "7f7a3d822a0f64b7b05a40716dc9ec93379b78b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxMTM0OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453911348", "body": "incorrect doc?", "bodyText": "incorrect doc?", "bodyHTML": "<p dir=\"auto\">incorrect doc?</p>", "author": "chanseokoh", "createdAt": "2020-07-13T20:26:10Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/FileLayerSpec.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import java.util.List;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A yaml block for specifying files layers.\n+ *\n+ * <p>Example use of this yaml snippet.\n+ *\n+ * <pre>{@code\n+ * name: \"my classes layer\"\n+ * files:\n+ *   - {@link CopySpec}\n+ *   - {@link CopySpec}\n+ * // optional properties\n+ * properties: see {@link FilePropertiesSpec}\n+ * }</pre>\n+ */\n+@JsonDeserialize(using = JsonDeserializer.None.class) // required since LayerSpec overrides this\n+public class FileLayerSpec implements LayerSpec {\n+  private String name;\n+  private List<CopySpec> files;\n+  @Nullable private FilePropertiesSpec properties;\n+\n+  /**\n+   * Constructor for use by jackson to populate this object.\n+   *\n+   * @param name a unique name for this layer\n+   * @param files a path to an archive file", "originalCommit": "7f7a3d822a0f64b7b05a40716dc9ec93379b78b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxMjQyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r453912427", "body": "I remember this has to start with \"Deserialize**s** ...\". And the comment reads a bit weird to me.", "bodyText": "I remember this has to start with \"Deserializes ...\". And the comment reads a bit weird to me.", "bodyHTML": "<p dir=\"auto\">I remember this has to start with \"Deserialize<strong>s</strong> ...\". And the comment reads a bit weird to me.</p>", "author": "chanseokoh", "createdAt": "2020-07-13T20:28:04Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/LayerSpec.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.deser.std.StdDeserializer;\n+import java.io.IOException;\n+\n+/**\n+ * Polymorphic yaml LayerSpec interface with custom deserializer, can parse both {@link\n+ * ArchiveLayerSpec} and {@link FileLayerSpec}.\n+ */\n+@JsonDeserialize(using = LayerSpec.Deserializer.class)\n+public interface LayerSpec {\n+  class Deserializer extends StdDeserializer<LayerSpec> {\n+\n+    public Deserializer() {\n+      super(LayerSpec.class);\n+    }\n+\n+    /**\n+     * Deserialize based on the presence of \"archive\", if present, consider the layer to be of type", "originalCommit": "7f7a3d822a0f64b7b05a40716dc9ec93379b78b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxODAzMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r454018031", "bodyText": "updated this comment", "author": "loosebazooka", "createdAt": "2020-07-14T00:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxMjQyNw=="}], "type": "inlineReview"}, {"oid": "58ad8d93084153973241b5cc54763bdd01dc2808", "url": "https://github.com/GoogleContainerTools/jib/commit/58ad8d93084153973241b5cc54763bdd01dc2808", "message": "fix comments, add name check to layerspec", "committedDate": "2020-07-14T00:03:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjAyNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r454392024", "body": "Sorry, one final comment, then LGTM. I just noticed that the `abstract` super method throws `IOException` and `JsonProcessingException`. Isn't throwing `JsonProcessingException` more suitable for the errors you are checking?", "bodyText": "Sorry, one final comment, then LGTM. I just noticed that the abstract super method throws IOException and JsonProcessingException. Isn't throwing JsonProcessingException more suitable for the errors you are checking?", "bodyHTML": "<p dir=\"auto\">Sorry, one final comment, then LGTM. I just noticed that the <code>abstract</code> super method throws <code>IOException</code> and <code>JsonProcessingException</code>. Isn't throwing <code>JsonProcessingException</code> more suitable for the errors you are checking?</p>", "author": "chanseokoh", "createdAt": "2020-07-14T14:20:19Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/LayerSpec.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.buildfile;\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.deser.std.StdDeserializer;\n+import java.io.IOException;\n+\n+/**\n+ * Polymorphic yaml LayerSpec interface with custom deserializer, can parse both {@link\n+ * ArchiveLayerSpec} and {@link FileLayerSpec}.\n+ */\n+@JsonDeserialize(using = LayerSpec.Deserializer.class)\n+public interface LayerSpec {\n+  class Deserializer extends StdDeserializer<LayerSpec> {\n+\n+    public Deserializer() {\n+      super(LayerSpec.class);\n+    }\n+\n+    /**\n+     * Deserializes to {@link ArchiveLayerSpec} if yaml contains \"archive\" field, to {@link\n+     * FileLayerSpec} if yaml contains \"files\" field or throws {@link IOException} if neither is\n+     * found or no \"name\" was specified for the layer entry.\n+     */\n+    @Override\n+    public LayerSpec deserialize(JsonParser jsonParser, DeserializationContext context)\n+        throws IOException {", "originalCommit": "58ad8d93084153973241b5cc54763bdd01dc2808", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0OTIxMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r454449210", "bodyText": "JsonProcessingException has no public constructor unfortunately \ud83d\ude22 .", "author": "loosebazooka", "createdAt": "2020-07-14T15:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0OTgzMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r454449832", "bodyText": "maybe there's some other subclass that I can use. I added it to the list of things to check on the tracking bug.", "author": "loosebazooka", "createdAt": "2020-07-14T15:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ1NDA3Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2580#discussion_r454454077", "bodyText": "Huh, interesting. I am fine going with IOException then.", "author": "chanseokoh", "createdAt": "2020-07-14T15:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjAyNA=="}], "type": "inlineReview"}]}