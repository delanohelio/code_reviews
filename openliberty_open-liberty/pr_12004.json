{"pr_number": 12004, "pr_title": "Adding a Config Element to enable JNDI trace", "pr_createdAt": "2020-04-30T16:26:25Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/12004", "merge_commit": "311bd598431df6504d23eada7e3719cd8f5d47d1", "timeline": [{"oid": "74b150d93c8fe43fee88ba4bdd8a6ee63d5b28d4", "url": "https://github.com/OpenLiberty/open-liberty/commit/74b150d93c8fe43fee88ba4bdd8a6ee63d5b28d4", "message": "creating a JNDI output Config", "committedDate": "2020-05-01T18:38:19Z", "type": "forcePushed"}, {"oid": "8cd17369b7fde48b080a02018dd2803ebe8f5cc5", "url": "https://github.com/OpenLiberty/open-liberty/commit/8cd17369b7fde48b080a02018dd2803ebe8f5cc5", "message": "creating a JNDI output Config", "committedDate": "2020-05-01T19:11:58Z", "type": "forcePushed"}, {"oid": "a85d5f9e3908ad60511a2efffe2b509faa8a1951", "url": "https://github.com/OpenLiberty/open-liberty/commit/a85d5f9e3908ad60511a2efffe2b509faa8a1951", "message": "creating a JNDI output Config", "committedDate": "2020-05-02T18:17:29Z", "type": "forcePushed"}, {"oid": "ef66f5032e08e8e1e2ed8f7ee2aa7d2ef1d3c715", "url": "https://github.com/OpenLiberty/open-liberty/commit/ef66f5032e08e8e1e2ed8f7ee2aa7d2ef1d3c715", "message": "creating a JNDI output Config", "committedDate": "2020-05-06T04:47:20Z", "type": "forcePushed"}, {"oid": "77f508775ad6fc7ecff403f85d2450e2286790fd", "url": "https://github.com/OpenLiberty/open-liberty/commit/77f508775ad6fc7ecff403f85d2450e2286790fd", "message": "creating a JNDI output Config", "committedDate": "2020-05-11T05:29:22Z", "type": "forcePushed"}, {"oid": "58da5fa0fb9125850ef07a51252cf199ae24b1a5", "url": "https://github.com/OpenLiberty/open-liberty/commit/58da5fa0fb9125850ef07a51252cf199ae24b1a5", "message": "creating a JNDI output Config", "committedDate": "2020-05-11T05:33:12Z", "type": "forcePushed"}, {"oid": "b82607aa83b85b2d76eebf2abd5779ce76fe35d7", "url": "https://github.com/OpenLiberty/open-liberty/commit/b82607aa83b85b2d76eebf2abd5779ce76fe35d7", "message": "creating a JNDI output Config", "committedDate": "2020-05-11T19:28:54Z", "type": "forcePushed"}, {"oid": "568b711cfc5bacd334d45e468e5263e63dcf9bf0", "url": "https://github.com/OpenLiberty/open-liberty/commit/568b711cfc5bacd334d45e468e5263e63dcf9bf0", "message": "creating a JNDI output Config", "committedDate": "2020-05-11T20:31:03Z", "type": "forcePushed"}, {"oid": "43f6a76e87f16465ffb6419936046043b1fdea8f", "url": "https://github.com/OpenLiberty/open-liberty/commit/43f6a76e87f16465ffb6419936046043b1fdea8f", "message": "creating a JNDI output Config", "committedDate": "2020-05-11T21:32:29Z", "type": "forcePushed"}, {"oid": "3c845f3c56c219e6a81df3ea20658aded58e2386", "url": "https://github.com/OpenLiberty/open-liberty/commit/3c845f3c56c219e6a81df3ea20658aded58e2386", "message": "creating a JNDI output Config", "committedDate": "2020-05-11T21:34:42Z", "type": "forcePushed"}, {"oid": "942682783cddfbf1d6b4f4fc9ce1cca7fb436a13", "url": "https://github.com/OpenLiberty/open-liberty/commit/942682783cddfbf1d6b4f4fc9ce1cca7fb436a13", "message": "creating a JNDI output Config", "committedDate": "2020-05-12T02:08:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMjc3MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423912771", "body": "Update the name of the test, the test description and streamline it a bit -- does it really need a sleep?", "bodyText": "Update the name of the test, the test description and streamline it a bit -- does it really need a sleep?", "bodyHTML": "<p dir=\"auto\">Update the name of the test, the test description and streamline it a bit -- does it really need a sleep?</p>", "author": "kristip17", "createdAt": "2020-05-12T17:34:56Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're timing out the LDAP context pool when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n+        ldap.setContextPool(cp);\n+        SearchResultsCache src = new SearchResultsCache();\n+        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+        ldap.setLdapCache(new LdapCache(null, src));\n+\n+        server.getLdapRegistries().add(ldap);\n+        updateConfigDynamically(libertyServer, server);\n+\n+    }\n+\n+    /**\n+     *\n+     * Check that we hit the timeout block of code for the context pool\n+     */\n+    @Test\n+    public void testContextPoolOnTimeout() throws Exception {", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8b3ee5c249b527100b89e8888bda6eb6c78cec9", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex 34deabfd75..ad0c87ca84 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -208,11 +208,11 @@ public class JNDIOutputTest {\n      * Check that we hit the timeout block of code for the context pool\n      */\n     @Test\n-    public void testContextPoolOnTimeout() throws Exception {\n+    public void testJNDIBEROutput() throws Exception {\n         String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n-        assertTrue(\"Should find: \" + trace, errMsgs.isEmpty());\n+        assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n         // Send in setting less than 1 second. Should run up to 1 second.\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n", "next_change": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -205,16 +197,22 @@ public class JNDIOutputTest {\n \n     /**\n      *\n-     * Check that we hit the timeout block of code for the context pool\n+     * Check that we hit the JNDI BER output\n      */\n     @Test\n     public void testJNDIBEROutput() throws Exception {\n-        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String trace = \"-> localhost\";\n+\n+        /*\n+         * Run with JNDI BER trace disabled\n+         */\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n         assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n-        // Send in setting less than 1 second. Should run up to 1 second.\n+        /*\n+         * Enable JNDI BER trace output\n+         */\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n         ConfigElementList<LdapRegistry> ldaps = config.getLdapRegistries();\n         LdapRegistry ldap = null;\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMzAxOA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423913018", "body": "Fix description", "bodyText": "Fix description", "bodyHTML": "<p dir=\"auto\">Fix description</p>", "author": "kristip17", "createdAt": "2020-05-12T17:35:18Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're timing out the LDAP context pool when expected.", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8b3ee5c249b527100b89e8888bda6eb6c78cec9", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex 34deabfd75..ad0c87ca84 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -42,7 +42,7 @@ import componenttest.topology.impl.LibertyServerFactory;\n import componenttest.topology.utils.LDAPUtils;\n \n /**\n- * Ensure we're timing out the LDAP context pool when expected.\n+ * Ensure we're printing out the JNDI BER packets when expected.\n  */\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMzA5OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423913099", "body": "Copyright", "bodyText": "Copyright", "bodyHTML": "<p dir=\"auto\">Copyright</p>", "author": "kristip17", "createdAt": "2020-05-12T17:35:27Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8b3ee5c249b527100b89e8888bda6eb6c78cec9", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex 34deabfd75..ad0c87ca84 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -1,5 +1,5 @@\n /*******************************************************************************\n- * Copyright (c) 2019 IBM Corporation and others.\n+ * Copyright (c) 2020 IBM Corporation and others.\n  * All rights reserved. This program and the accompanying materials\n  * are made available under the terms of the Eclipse Public License v1.0\n  * which accompanies this distribution, and is available at\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMzI5MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423913290", "body": "Are we using this in this class?", "bodyText": "Are we using this in this class?", "bodyHTML": "<p dir=\"auto\">Are we using this in this class?</p>", "author": "kristip17", "createdAt": "2020-05-12T17:35:45Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/TimedDirContext.java", "diffHunk": "@@ -49,6 +50,8 @@\n     /** Constant for JNDI_CALL trace */\n     public static final String JNDI_CALL = \"JNDI_CALL \";\n \n+    public static ByteArrayPlusOutputStream baos;", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "43fe612be2f738c98ebb8ab8f2102d1248266b05", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/TimedDirContext.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/TimedDirContext.java\nindex d7bd9768c3..7e3677b2fd 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/TimedDirContext.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/TimedDirContext.java\n", "chunk": "@@ -50,8 +49,6 @@ public class TimedDirContext {\n     /** Constant for JNDI_CALL trace */\n     public static final String JNDI_CALL = \"JNDI_CALL \";\n \n-    public static ByteArrayPlusOutputStream baos;\n-\n     /** {@link TraceComponent} for the class. */\n     private static final TraceComponent tc = Tr.register(TimedDirContext.class);\n \n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMzU1OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423913559", "body": "Remove or convert to trace.", "bodyText": "Remove or convert to trace.", "bodyHTML": "<p dir=\"auto\">Remove or convert to trace.</p>", "author": "kristip17", "createdAt": "2020-05-12T17:36:15Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1068,16 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Set the LDAP read time out.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            System.out.println(\"Setting print stream\");", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "43fe612be2f738c98ebb8ab8f2102d1248266b05", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex b04ae3a1b2..848bdba58c 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1072,9 +1070,7 @@ public class ContextManager {\n          * Set the LDAP read time out.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            System.out.println(\"Setting print stream\");\n             PrintStream Stdout = new PrintStream(bapos);\n-            TimedDirContext.baos = bapos;\n             iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n         }\n \n", "next_change": {"commit": "34d9f96acd75b7f56ffbb7edc8b4f8ded2ae3b40", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 848bdba58c..375838d504 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1070,8 +1070,10 @@ public class ContextManager {\n          * Set the LDAP read time out.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            PrintStream Stdout = new PrintStream(bapos);\n-            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+            synchronized (iLock) {\n+                PrintStream Stdout = new PrintStream(bapos);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+            }\n         }\n \n         /*\n", "next_change": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 375838d504..aa60f1d572 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,11 +1064,12 @@ public class ContextManager {\n         }\n \n         /*\n-         * Set the LDAP read time out.\n+         * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                PrintStream Stdout = new PrintStream(bapos);\n+                BEROutputStream berOS = new BEROutputStream();\n+                PrintStream Stdout = new PrintStream(berOS);\n                 iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n             }\n         }\n", "next_change": {"commit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex aa60f1d572..57570f987a 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1069,8 +1069,9 @@ public class ContextManager {\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n                 BEROutputStream berOS = new BEROutputStream();\n-                PrintStream Stdout = new PrintStream(berOS);\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n+//                PrintStream Stdout = new PrintStream(berOS);\n+//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n             }\n         }\n \n", "next_change": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMzk3Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423913976", "body": "Fix copyright date", "bodyText": "Fix copyright date", "bodyHTML": "<p dir=\"auto\">Fix copyright date</p>", "author": "kristip17", "createdAt": "2020-05-12T17:36:57Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*******************************************************************************\n+ * Copyright (c) 1997, 2004 IBM Corporation and others.", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "43fe612be2f738c98ebb8ab8f2102d1248266b05", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java\ndeleted file mode 100644\nindex eb735d45c4..0000000000\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java\n+++ /dev/null\n", "chunk": "@@ -1,84 +0,0 @@\n-/*******************************************************************************\n- * Copyright (c) 1997, 2004 IBM Corporation and others.\n- * All rights reserved. This program and the accompanying materials\n- * are made available under the terms of the Eclipse Public License v1.0\n- * which accompanies this distribution, and is available at\n- * http://www.eclipse.org/legal/epl-v10.html\n- *\n- * Contributors:\n- *     IBM Corporation - initial API and implementation\n- *******************************************************************************/\n-package com.ibm.ws.security.wim.adapter.ldap;\n-\n-import java.io.ByteArrayOutputStream;\n-import java.io.IOException;\n-import java.io.UnsupportedEncodingException;\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n-\n-import com.ibm.websphere.ras.annotation.Trivial;\n-\n-/******************************************************************************\n-*\tUse an extended version of ByteArrayOutputStream in order to allow access\n-*\tto protected values.\n-******************************************************************************/\n-@Trivial\n-public class ByteArrayPlusOutputStream extends ByteArrayOutputStream {\n-    public final String eol = getSystemProperty(\"line.separator\");\n-    @Override\n-    public void write(int b) {\n-        super.write(b);\n-        try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n-                try {\n-                    super.writeTo(System.out);\n-                    super.reset();\n-                } catch (IOException e) {\n-                    e.printStackTrace();\n-                }\n-            }\n-        } catch(UnsupportedEncodingException e) {\n-            e.printStackTrace();\n-        }\n-    }\n-\n-    @Override\n-    public void write(byte[] b, int off, int len) {\n-        super.write(b, off, len);\n-        try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n-                try {\n-                    super.writeTo(System.out);\n-                    super.reset();\n-                } catch (IOException e) {\n-                    e.printStackTrace();\n-                }\n-            }\n-        } catch(UnsupportedEncodingException e) {\n-            e.printStackTrace();\n-        }\n-    }\n-\n-    @Override\n-    public void write(byte[] b) {\n-        write(b, 0, b.length);\n-    }\n-\n-    /**\n-     * Convenience method to get a system property using\n-     * {@link AccessController#doPrivileged(PrivilegedAction)}.\n-     *\n-     * @param property The property to retrieve.\n-     * @return The value returned from {@link System#getProperty(String)}.\n-     */\n-    @Trivial\n-    public static String getSystemProperty(final String property) {\n-        return AccessController.doPrivileged(new PrivilegedAction<String>() {\n-            @Override\n-            @Trivial\n-            public String run() {\n-                return System.getProperty(property);\n-            }\n-        });\n-    }\n-}\n\\ No newline at end of file\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNDYyMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423914622", "body": "Fix all the e.printStackTrace -- we should trace it, but don't throw an exception. We don't want failing trace to interrupt an ldap reqeust.", "bodyText": "Fix all the e.printStackTrace -- we should trace it, but don't throw an exception. We don't want failing trace to interrupt an ldap reqeust.", "bodyHTML": "<p dir=\"auto\">Fix all the e.printStackTrace -- we should trace it, but don't throw an exception. We don't want failing trace to interrupt an ldap reqeust.</p>", "author": "kristip17", "createdAt": "2020-05-12T17:38:01Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*******************************************************************************\n+ * Copyright (c) 1997, 2004 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.wim.adapter.ldap;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import com.ibm.websphere.ras.annotation.Trivial;\n+\n+/******************************************************************************\n+*\tUse an extended version of ByteArrayOutputStream in order to allow access\n+*\tto protected values.\n+******************************************************************************/\n+@Trivial\n+public class ByteArrayPlusOutputStream extends ByteArrayOutputStream {\n+    public final String eol = getSystemProperty(\"line.separator\");\n+    @Override\n+    public void write(int b) {\n+        super.write(b);\n+        try {\n+            if (this.toString(\"UTF-8\").contains(eol)) {\n+                try {\n+                    super.writeTo(System.out);\n+                    super.reset();\n+                } catch (IOException e) {\n+                    e.printStackTrace();", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "43fe612be2f738c98ebb8ab8f2102d1248266b05", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java\ndeleted file mode 100644\nindex eb735d45c4..0000000000\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/ByteArrayPlusOutputStream.java\n+++ /dev/null\n", "chunk": "@@ -1,84 +0,0 @@\n-/*******************************************************************************\n- * Copyright (c) 1997, 2004 IBM Corporation and others.\n- * All rights reserved. This program and the accompanying materials\n- * are made available under the terms of the Eclipse Public License v1.0\n- * which accompanies this distribution, and is available at\n- * http://www.eclipse.org/legal/epl-v10.html\n- *\n- * Contributors:\n- *     IBM Corporation - initial API and implementation\n- *******************************************************************************/\n-package com.ibm.ws.security.wim.adapter.ldap;\n-\n-import java.io.ByteArrayOutputStream;\n-import java.io.IOException;\n-import java.io.UnsupportedEncodingException;\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n-\n-import com.ibm.websphere.ras.annotation.Trivial;\n-\n-/******************************************************************************\n-*\tUse an extended version of ByteArrayOutputStream in order to allow access\n-*\tto protected values.\n-******************************************************************************/\n-@Trivial\n-public class ByteArrayPlusOutputStream extends ByteArrayOutputStream {\n-    public final String eol = getSystemProperty(\"line.separator\");\n-    @Override\n-    public void write(int b) {\n-        super.write(b);\n-        try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n-                try {\n-                    super.writeTo(System.out);\n-                    super.reset();\n-                } catch (IOException e) {\n-                    e.printStackTrace();\n-                }\n-            }\n-        } catch(UnsupportedEncodingException e) {\n-            e.printStackTrace();\n-        }\n-    }\n-\n-    @Override\n-    public void write(byte[] b, int off, int len) {\n-        super.write(b, off, len);\n-        try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n-                try {\n-                    super.writeTo(System.out);\n-                    super.reset();\n-                } catch (IOException e) {\n-                    e.printStackTrace();\n-                }\n-            }\n-        } catch(UnsupportedEncodingException e) {\n-            e.printStackTrace();\n-        }\n-    }\n-\n-    @Override\n-    public void write(byte[] b) {\n-        write(b, 0, b.length);\n-    }\n-\n-    /**\n-     * Convenience method to get a system property using\n-     * {@link AccessController#doPrivileged(PrivilegedAction)}.\n-     *\n-     * @param property The property to retrieve.\n-     * @return The value returned from {@link System#getProperty(String)}.\n-     */\n-    @Trivial\n-    public static String getSystemProperty(final String property) {\n-        return AccessController.doPrivileged(new PrivilegedAction<String>() {\n-            @Override\n-            @Trivial\n-            public String run() {\n-                return System.getProperty(property);\n-            }\n-        });\n-    }\n-}\n\\ No newline at end of file\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTM0OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423915348", "body": "Needs to be trace.", "bodyText": "Needs to be trace.", "bodyHTML": "<p dir=\"auto\">Needs to be trace.</p>", "author": "kristip17", "createdAt": "2020-05-12T17:39:09Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1232,6 +1254,16 @@ public TimedDirContext reCreateDirContext(TimedDirContext oldCtx, String errorMe\n     @FFDCIgnore(NamingException.class)\n     public void releaseDirContext(TimedDirContext ctx) throws WIMSystemException {\n         final String METHODNAME = \"releaseDirContext\";\n+        if (iJndiOutputEnabled) {\n+            try {\n+                if (tc.isDebugEnabled()) {\n+                    Tr.debug(tc, METHODNAME + \" Writing the rest of the packet capture\");\n+                }\n+                bapos.writeTo(System.out);\n+            } catch (IOException e) {\n+                e.printStackTrace();", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "43fe612be2f738c98ebb8ab8f2102d1248266b05", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex b04ae3a1b2..848bdba58c 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1261,7 +1257,9 @@ public class ContextManager {\n                 }\n                 bapos.writeTo(System.out);\n             } catch (IOException e) {\n-                e.printStackTrace();\n+                if (tc.isDebugEnabled()) {\n+                    Tr.debug(tc, METHODNAME + \" Could not flush the rest of the buffer\" + e.toString());\n+                }\n             }\n         }\n         if (iContextPoolEnabled) {\n", "next_change": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 848bdba58c..aa60f1d572 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1250,18 +1250,6 @@ public class ContextManager {\n     @FFDCIgnore(NamingException.class)\n     public void releaseDirContext(TimedDirContext ctx) throws WIMSystemException {\n         final String METHODNAME = \"releaseDirContext\";\n-        if (iJndiOutputEnabled) {\n-            try {\n-                if (tc.isDebugEnabled()) {\n-                    Tr.debug(tc, METHODNAME + \" Writing the rest of the packet capture\");\n-                }\n-                bapos.writeTo(System.out);\n-            } catch (IOException e) {\n-                if (tc.isDebugEnabled()) {\n-                    Tr.debug(tc, METHODNAME + \" Could not flush the rest of the buffer\" + e.toString());\n-                }\n-            }\n-        }\n         if (iContextPoolEnabled) {\n \n             //Get the lock for the current domain\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNzQ5Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r423917493", "body": "\"Should not find\" ? You are making sure we don't log the trace, then enable it and we do find the trace?", "bodyText": "\"Should not find\" ? You are making sure we don't log the trace, then enable it and we do find the trace?", "bodyHTML": "<p dir=\"auto\">\"Should not find\" ? You are making sure we don't log the trace, then enable it and we do find the trace?</p>", "author": "kristip17", "createdAt": "2020-05-12T17:42:44Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're timing out the LDAP context pool when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n+        ldap.setContextPool(cp);\n+        SearchResultsCache src = new SearchResultsCache();\n+        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+        ldap.setLdapCache(new LdapCache(null, src));\n+\n+        server.getLdapRegistries().add(ldap);\n+        updateConfigDynamically(libertyServer, server);\n+\n+    }\n+\n+    /**\n+     *\n+     * Check that we hit the timeout block of code for the context pool\n+     */\n+    @Test\n+    public void testContextPoolOnTimeout() throws Exception {\n+        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String returnUser = servlet.checkPassword(USER_DN, PWD);\n+        List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n+        assertTrue(\"Should find: \" + trace, errMsgs.isEmpty());", "originalCommit": "50f45a83d640ab1ca8041f905e10469f24282c8d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8b3ee5c249b527100b89e8888bda6eb6c78cec9", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex 34deabfd75..ad0c87ca84 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -208,11 +208,11 @@ public class JNDIOutputTest {\n      * Check that we hit the timeout block of code for the context pool\n      */\n     @Test\n-    public void testContextPoolOnTimeout() throws Exception {\n+    public void testJNDIBEROutput() throws Exception {\n         String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n-        assertTrue(\"Should find: \" + trace, errMsgs.isEmpty());\n+        assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n         // Send in setting less than 1 second. Should run up to 1 second.\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n", "next_change": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -205,16 +197,22 @@ public class JNDIOutputTest {\n \n     /**\n      *\n-     * Check that we hit the timeout block of code for the context pool\n+     * Check that we hit the JNDI BER output\n      */\n     @Test\n     public void testJNDIBEROutput() throws Exception {\n-        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String trace = \"-> localhost\";\n+\n+        /*\n+         * Run with JNDI BER trace disabled\n+         */\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n         assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n-        // Send in setting less than 1 second. Should run up to 1 second.\n+        /*\n+         * Enable JNDI BER trace output\n+         */\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n         ConfigElementList<LdapRegistry> ldaps = config.getLdapRegistries();\n         LdapRegistry ldap = null;\n", "next_change": null}]}}]}}, {"oid": "43fe612be2f738c98ebb8ab8f2102d1248266b05", "url": "https://github.com/OpenLiberty/open-liberty/commit/43fe612be2f738c98ebb8ab8f2102d1248266b05", "message": "creating a JNDI output Config", "committedDate": "2020-05-13T19:27:18Z", "type": "forcePushed"}, {"oid": "c8b3ee5c249b527100b89e8888bda6eb6c78cec9", "url": "https://github.com/OpenLiberty/open-liberty/commit/c8b3ee5c249b527100b89e8888bda6eb6c78cec9", "message": "creating a JNDI output Config", "committedDate": "2020-05-13T20:06:38Z", "type": "forcePushed"}, {"oid": "3e576635352f9b76b29308a12627e1ac64f0df71", "url": "https://github.com/OpenLiberty/open-liberty/commit/3e576635352f9b76b29308a12627e1ac64f0df71", "message": "creating a JNDI output Config", "committedDate": "2020-05-13T20:16:19Z", "type": "forcePushed"}, {"oid": "34d9f96acd75b7f56ffbb7edc8b4f8ded2ae3b40", "url": "https://github.com/OpenLiberty/open-liberty/commit/34d9f96acd75b7f56ffbb7edc8b4f8ded2ae3b40", "message": "creating a JNDI output Config", "committedDate": "2020-05-13T20:46:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyODA3NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424728075", "body": "add white space after.", "bodyText": "add white space after.", "bodyHTML": "<p dir=\"auto\">add white space after.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:00:29Z", "path": "dev/com.ibm.websphere.security.wim.base/src/com/ibm/websphere/security/wim/ConfigConstants.java", "diffHunk": "@@ -402,6 +402,10 @@\n      */\n     String CONFIG_PROP_READ_TIMEOUT = \"readTimeout\";\n \n+    /**\n+     * Define whether JNDI BER packets will be written to the System.out\n+     */\n+    String CONFIG_PROP_JNDI_OUTPUT_ENABLED = \"jndiOutputEnabled\";", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.websphere.security.wim.base/src/com/ibm/websphere/security/wim/ConfigConstants.java b/dev/com.ibm.websphere.security.wim.base/src/com/ibm/websphere/security/wim/ConfigConstants.java\nindex d36e31ae21..6f6babed2b 100644\n--- a/dev/com.ibm.websphere.security.wim.base/src/com/ibm/websphere/security/wim/ConfigConstants.java\n+++ b/dev/com.ibm.websphere.security.wim.base/src/com/ibm/websphere/security/wim/ConfigConstants.java\n", "chunk": "@@ -406,6 +406,7 @@ public interface ConfigConstants {\n      * Define whether JNDI BER packets will be written to the System.out\n      */\n     String CONFIG_PROP_JNDI_OUTPUT_ENABLED = \"jndiOutputEnabled\";\n+\n     /**\n      * Define whether or not write operations are allowed on secondary servers.\n      * default value is false.\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyODUxNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424728515", "body": "remove\r\n\r\n```suggestion\r\n```", "bodyText": "remove\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //rename BER output stream", "bodyHTML": "<p dir=\"auto\">remove</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-c\"><span class=\"pl-c x x-first\">//</span><span class=\"x x-last\">rename BER output stream</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-13T21:01:19Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.wim.adapter.ldap;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Trivial;\n+\n+/******************************************************************************\n+*\tUse an extended version of ByteArrayOutputStream in order to allow access\n+*\tto protected values.\n+******************************************************************************/\n+@Trivial\n+//rename BER output stream", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\nindex a85edb432b..ac38c774ac 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n", "chunk": "@@ -13,28 +13,25 @@ package com.ibm.ws.security.wim.adapter.ldap;\n import java.io.ByteArrayOutputStream;\n import java.io.IOException;\n import java.io.UnsupportedEncodingException;\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n \n import com.ibm.websphere.ras.Tr;\n import com.ibm.websphere.ras.TraceComponent;\n import com.ibm.websphere.ras.annotation.Trivial;\n \n /******************************************************************************\n-*\tUse an extended version of ByteArrayOutputStream in order to allow access\n-*\tto protected values.\n-******************************************************************************/\n+ * Use an extended version of ByteArrayOutputStream in order to allow\n+ * custom writing to the output stream. This class will be use when JNDI BER packet writing has been enabled\n+ ******************************************************************************/\n @Trivial\n //rename BER output stream\n public class BEROutputStream extends ByteArrayOutputStream {\n     private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n-    public final String eol = getSystemProperty(\"line.separator\");\n     @Override\n     public void write(int b) {\n         String METHODNAME = \"write(int b)\";\n         super.write(b);\n         try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n+            if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {\n                 try {\n                     super.writeTo(System.out);\n                     super.reset();\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTUzMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424729533", "body": "Use the method System.lineSeparator() instead.\r\n\r\n```suggestion\r\n\r\n```", "bodyText": "Use the method System.lineSeparator() instead.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public final String eol = getSystemProperty(\"line.separator\");", "bodyHTML": "<p dir=\"auto\">Use the method System.lineSeparator() instead.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">    </span><span class=\"pl-k x\">public</span><span class=\"x\"> </span><span class=\"pl-k x\">final</span><span class=\"x\"> </span><span class=\"pl-smi x\">String</span><span class=\"x\"> eol </span><span class=\"pl-k x\">=</span><span class=\"x\"> getSystemProperty(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">line.separator</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">);</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-13T21:03:17Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.wim.adapter.ldap;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Trivial;\n+\n+/******************************************************************************\n+*\tUse an extended version of ByteArrayOutputStream in order to allow access\n+*\tto protected values.\n+******************************************************************************/\n+@Trivial\n+//rename BER output stream\n+public class BEROutputStream extends ByteArrayOutputStream {\n+    private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n+    public final String eol = getSystemProperty(\"line.separator\");", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\nindex a85edb432b..ac38c774ac 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n", "chunk": "@@ -13,28 +13,25 @@ package com.ibm.ws.security.wim.adapter.ldap;\n import java.io.ByteArrayOutputStream;\n import java.io.IOException;\n import java.io.UnsupportedEncodingException;\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n \n import com.ibm.websphere.ras.Tr;\n import com.ibm.websphere.ras.TraceComponent;\n import com.ibm.websphere.ras.annotation.Trivial;\n \n /******************************************************************************\n-*\tUse an extended version of ByteArrayOutputStream in order to allow access\n-*\tto protected values.\n-******************************************************************************/\n+ * Use an extended version of ByteArrayOutputStream in order to allow\n+ * custom writing to the output stream. This class will be use when JNDI BER packet writing has been enabled\n+ ******************************************************************************/\n @Trivial\n //rename BER output stream\n public class BEROutputStream extends ByteArrayOutputStream {\n     private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n-    public final String eol = getSystemProperty(\"line.separator\");\n     @Override\n     public void write(int b) {\n         String METHODNAME = \"write(int b)\";\n         super.write(b);\n         try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n+            if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {\n                 try {\n                     super.writeTo(System.out);\n                     super.reset();\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTc0Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424729743", "body": "```suggestion\r\n            if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (this.toString(\"UTF-8\").contains(eol)) {\n          \n          \n            \n                        if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (<span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>toString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>UTF-8<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>contains(<span class=\"x x-first x-last\">eol</span>)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (<span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>toString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>UTF-8<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>contains(<span class=\"pl-smi x x-first\">System</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">lineSeparator()</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-13T21:03:45Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.wim.adapter.ldap;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Trivial;\n+\n+/******************************************************************************\n+*\tUse an extended version of ByteArrayOutputStream in order to allow access\n+*\tto protected values.\n+******************************************************************************/\n+@Trivial\n+//rename BER output stream\n+public class BEROutputStream extends ByteArrayOutputStream {\n+    private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n+    public final String eol = getSystemProperty(\"line.separator\");\n+    @Override\n+    public void write(int b) {\n+        String METHODNAME = \"write(int b)\";\n+        super.write(b);\n+        try {\n+            if (this.toString(\"UTF-8\").contains(eol)) {", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\nindex a85edb432b..ac38c774ac 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n", "chunk": "@@ -13,28 +13,25 @@ package com.ibm.ws.security.wim.adapter.ldap;\n import java.io.ByteArrayOutputStream;\n import java.io.IOException;\n import java.io.UnsupportedEncodingException;\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n \n import com.ibm.websphere.ras.Tr;\n import com.ibm.websphere.ras.TraceComponent;\n import com.ibm.websphere.ras.annotation.Trivial;\n \n /******************************************************************************\n-*\tUse an extended version of ByteArrayOutputStream in order to allow access\n-*\tto protected values.\n-******************************************************************************/\n+ * Use an extended version of ByteArrayOutputStream in order to allow\n+ * custom writing to the output stream. This class will be use when JNDI BER packet writing has been enabled\n+ ******************************************************************************/\n @Trivial\n //rename BER output stream\n public class BEROutputStream extends ByteArrayOutputStream {\n     private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n-    public final String eol = getSystemProperty(\"line.separator\");\n     @Override\n     public void write(int b) {\n         String METHODNAME = \"write(int b)\";\n         super.write(b);\n         try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n+            if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {\n                 try {\n                     super.writeTo(System.out);\n                     super.reset();\n", "next_change": null}]}, "revised_code_in_main": null, "commits_in_main": [{"oid": "311bd598431df6504d23eada7e3719cd8f5d47d1", "message": "Merge commit", "committedDate": null}, {"oid": "0d6b94b984326bb2c88eb47c642f80f2a2ae8df3", "committedDate": "2023-01-07 12:46:43 -0500", "message": "Change copyright to EPL 2.0"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTg1Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424729856", "body": "```suggestion\r\n            if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (this.toString(\"UTF-8\").contains(eol)) {\n          \n          \n            \n                        if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (<span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>toString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>UTF-8<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>contains(<span class=\"x x-first x-last\">eol</span>)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (<span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>toString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>UTF-8<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>contains(<span class=\"pl-smi x x-first\">System</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">lineSeparator()</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-13T21:04:00Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.wim.adapter.ldap;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Trivial;\n+\n+/******************************************************************************\n+*\tUse an extended version of ByteArrayOutputStream in order to allow access\n+*\tto protected values.\n+******************************************************************************/\n+@Trivial\n+//rename BER output stream\n+public class BEROutputStream extends ByteArrayOutputStream {\n+    private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n+    public final String eol = getSystemProperty(\"line.separator\");\n+    @Override\n+    public void write(int b) {\n+        String METHODNAME = \"write(int b)\";\n+        super.write(b);\n+        try {\n+            if (this.toString(\"UTF-8\").contains(eol)) {\n+                try {\n+                    super.writeTo(System.out);\n+                    super.reset();\n+                } catch (IOException e) {\n+                    if (tc.isDebugEnabled())\n+                        Tr.debug(tc, METHODNAME + \" Cannot write to System out: \" + e.toString());\n+                }\n+            }\n+        } catch (UnsupportedEncodingException e) {\n+            if (tc.isDebugEnabled())\n+                Tr.debug(tc, METHODNAME + \" UTF-8 is not a valid encoding: \" + e.toString());\n+        }\n+    }\n+\n+    @Override\n+    public void write(byte[] b, int off, int len) {\n+        String METHODNAME = \"write(byte[] b, int off, int len)\";\n+        super.write(b, off, len);\n+        try {\n+            if (this.toString(\"UTF-8\").contains(eol)) {", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMDk5Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424730996", "bodyText": "I also wonder if the BER output uses different line separators on windows vs unix? Have you tested on both?", "author": "jvanhill", "createdAt": "2020-05-13T21:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTg1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\nindex a85edb432b..ac38c774ac 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n", "chunk": "@@ -54,7 +51,7 @@ public class BEROutputStream extends ByteArrayOutputStream {\n         String METHODNAME = \"write(byte[] b, int off, int len)\";\n         super.write(b, off, len);\n         try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n+            if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {\n                 try {\n                     super.writeTo(System.out);\n                     super.reset();\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMDIyNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424730225", "body": "Delete this method. Use System.lineSeparator() instead.", "bodyText": "Delete this method. Use System.lineSeparator() instead.", "bodyHTML": "<p dir=\"auto\">Delete this method. Use System.lineSeparator() instead.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:04:50Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.wim.adapter.ldap;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Trivial;\n+\n+/******************************************************************************\n+*\tUse an extended version of ByteArrayOutputStream in order to allow access\n+*\tto protected values.\n+******************************************************************************/\n+@Trivial\n+//rename BER output stream\n+public class BEROutputStream extends ByteArrayOutputStream {\n+    private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n+    public final String eol = getSystemProperty(\"line.separator\");\n+    @Override\n+    public void write(int b) {\n+        String METHODNAME = \"write(int b)\";\n+        super.write(b);\n+        try {\n+            if (this.toString(\"UTF-8\").contains(eol)) {\n+                try {\n+                    super.writeTo(System.out);\n+                    super.reset();\n+                } catch (IOException e) {\n+                    if (tc.isDebugEnabled())\n+                        Tr.debug(tc, METHODNAME + \" Cannot write to System out: \" + e.toString());\n+                }\n+            }\n+        } catch (UnsupportedEncodingException e) {\n+            if (tc.isDebugEnabled())\n+                Tr.debug(tc, METHODNAME + \" UTF-8 is not a valid encoding: \" + e.toString());\n+        }\n+    }\n+\n+    @Override\n+    public void write(byte[] b, int off, int len) {\n+        String METHODNAME = \"write(byte[] b, int off, int len)\";\n+        super.write(b, off, len);\n+        try {\n+            if (this.toString(\"UTF-8\").contains(eol)) {\n+                try {\n+                    super.writeTo(System.out);\n+                    super.reset();\n+                } catch (IOException e) {\n+                    if (tc.isDebugEnabled())\n+                        Tr.debug(tc, METHODNAME + \" Cannot write to System out: \" + e.toString());\n+                }\n+            }\n+        } catch (UnsupportedEncodingException e) {\n+            if (tc.isDebugEnabled())\n+                Tr.debug(tc, METHODNAME + \" UTF-8 is not a valid encoding: \" + e.toString());\n+        }\n+    }\n+\n+    @Override\n+    public void write(byte[] b) {\n+        write(b, 0, b.length);\n+    }\n+\n+    /**\n+     * Convenience method to get a system property using\n+     * {@link AccessController#doPrivileged(PrivilegedAction)}.\n+     *\n+     * @param property The property to retrieve.\n+     * @return The value returned from {@link System#getProperty(String)}.\n+     */\n+    @Trivial\n+    public static String getSystemProperty(final String property) {", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\nindex a85edb432b..ac38c774ac 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n", "chunk": "@@ -73,22 +70,4 @@ public class BEROutputStream extends ByteArrayOutputStream {\n     public void write(byte[] b) {\n         write(b, 0, b.length);\n     }\n-\n-    /**\n-     * Convenience method to get a system property using\n-     * {@link AccessController#doPrivileged(PrivilegedAction)}.\n-     *\n-     * @param property The property to retrieve.\n-     * @return The value returned from {@link System#getProperty(String)}.\n-     */\n-    @Trivial\n-    public static String getSystemProperty(final String property) {\n-        return AccessController.doPrivileged(new PrivilegedAction<String>() {\n-            @Override\n-            @Trivial\n-            public String run() {\n-                return System.getProperty(property);\n-            }\n-        });\n-    }\n }\n\\ No newline at end of file\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMTI2Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424731262", "body": "Better Javadoc. Describe what the purpose of the class is.", "bodyText": "Better Javadoc. Describe what the purpose of the class is.", "bodyHTML": "<p dir=\"auto\">Better Javadoc. Describe what the purpose of the class is.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:07:00Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.wim.adapter.ldap;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Trivial;\n+\n+/******************************************************************************\n+*\tUse an extended version of ByteArrayOutputStream in order to allow access", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\nindex a85edb432b..ac38c774ac 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/BEROutputStream.java\n", "chunk": "@@ -13,28 +13,25 @@ package com.ibm.ws.security.wim.adapter.ldap;\n import java.io.ByteArrayOutputStream;\n import java.io.IOException;\n import java.io.UnsupportedEncodingException;\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n \n import com.ibm.websphere.ras.Tr;\n import com.ibm.websphere.ras.TraceComponent;\n import com.ibm.websphere.ras.annotation.Trivial;\n \n /******************************************************************************\n-*\tUse an extended version of ByteArrayOutputStream in order to allow access\n-*\tto protected values.\n-******************************************************************************/\n+ * Use an extended version of ByteArrayOutputStream in order to allow\n+ * custom writing to the output stream. This class will be use when JNDI BER packet writing has been enabled\n+ ******************************************************************************/\n @Trivial\n //rename BER output stream\n public class BEROutputStream extends ByteArrayOutputStream {\n     private static final TraceComponent tc = Tr.register(BEROutputStream.class);\n-    public final String eol = getSystemProperty(\"line.separator\");\n     @Override\n     public void write(int b) {\n         String METHODNAME = \"write(int b)\";\n         super.write(b);\n         try {\n-            if (this.toString(\"UTF-8\").contains(eol)) {\n+            if (this.toString(\"UTF-8\").contains(System.lineSeparator())) {\n                 try {\n                     super.writeTo(System.out);\n                     super.reset();\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMjAyNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424732027", "body": "```suggestion\r\n         * Enabled JNDI BER output if required.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * Set the LDAP read time out.\n          \n          \n            \n                     * Enabled JNDI BER output if required.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">         <span class=\"pl-k\">*</span> <span class=\"pl-smi x x-first\">Set</span><span class=\"x\"> the </span><span class=\"pl-c1 x\">LDAP</span><span class=\"x x-last\"> read time out</span>.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">         <span class=\"pl-k\">*</span> <span class=\"pl-smi x x-first\">Enabled</span><span class=\"x\"> </span><span class=\"pl-c1 x\">JNDI</span><span class=\"x\"> </span><span class=\"pl-c1 x\">BER</span><span class=\"x\"> output </span><span class=\"pl-k x\">if</span><span class=\"x x-last\"> required</span>.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-13T21:08:35Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1066,16 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Set the LDAP read time out.", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 375838d504..aa60f1d572 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,11 +1064,12 @@ public class ContextManager {\n         }\n \n         /*\n-         * Set the LDAP read time out.\n+         * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                PrintStream Stdout = new PrintStream(bapos);\n+                BEROutputStream berOS = new BEROutputStream();\n+                PrintStream Stdout = new PrintStream(berOS);\n                 iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n             }\n         }\n", "next_change": {"commit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex aa60f1d572..57570f987a 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1069,8 +1069,9 @@ public class ContextManager {\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n                 BEROutputStream berOS = new BEROutputStream();\n-                PrintStream Stdout = new PrintStream(berOS);\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n+//                PrintStream Stdout = new PrintStream(berOS);\n+//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n             }\n         }\n \n", "next_change": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMjUzOA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424732538", "body": "Doesn't seem we should need this to be class level. Just add create it when you add it to the env.", "bodyText": "Doesn't seem we should need this to be class level. Just add create it when you add it to the env.", "bodyHTML": "<p dir=\"auto\">Doesn't seem we should need this to be class level. Just add create it when you add it to the env.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:09:40Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -227,6 +235,8 @@\n     /** Write to secondary server configuration. */\n     private boolean iWriteToSecondary = false;\n \n+    /** Buffer stream for catching JNDI output */\n+    BEROutputStream bapos = new BEROutputStream();", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 375838d504..aa60f1d572 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -235,13 +234,11 @@ public class ContextManager {\n     /** Write to secondary server configuration. */\n     private boolean iWriteToSecondary = false;\n \n-    /** Buffer stream for catching JNDI output */\n-    BEROutputStream bapos = new BEROutputStream();\n     /**\n      * Add a fail-over LDAP server hostname and port.\n      *\n      * @param hostname The hostname for the primary LDAP server.\n-     * @param port The port for the primary LDAP server.\n+     * @param port     The port for the primary LDAP server.\n      */\n     public void addFailoverServer(String hostname, int port) {\n         iFailoverServers.add(new HostPort(hostname, port));\n", "next_change": {"commit": "091db6247c2c693439950e45c397ce00f5dd47a8", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex aa60f1d572..93d49a9d81 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -238,7 +238,7 @@ public class ContextManager {\n      * Add a fail-over LDAP server hostname and port.\n      *\n      * @param hostname The hostname for the primary LDAP server.\n-     * @param port     The port for the primary LDAP server.\n+     * @param port The port for the primary LDAP server.\n      */\n     public void addFailoverServer(String hostname, int port) {\n         iFailoverServers.add(new HostPort(hostname, port));\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMjcwNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424732706", "body": "Why do we need this in a PrintStream?", "bodyText": "Why do we need this in a PrintStream?", "bodyHTML": "<p dir=\"auto\">Why do we need this in a PrintStream?</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:10:02Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1066,16 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Set the LDAP read time out.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            synchronized (iLock) {\n+                PrintStream Stdout = new PrintStream(bapos);", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMjk0Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424732942", "bodyText": "bapos should not be class level, create it here.", "author": "jvanhill", "createdAt": "2020-05-13T21:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMjcwNg=="}], "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 375838d504..aa60f1d572 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,11 +1064,12 @@ public class ContextManager {\n         }\n \n         /*\n-         * Set the LDAP read time out.\n+         * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                PrintStream Stdout = new PrintStream(bapos);\n+                BEROutputStream berOS = new BEROutputStream();\n+                PrintStream Stdout = new PrintStream(berOS);\n                 iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n             }\n         }\n", "next_change": {"commit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex aa60f1d572..57570f987a 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1069,8 +1069,9 @@ public class ContextManager {\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n                 BEROutputStream berOS = new BEROutputStream();\n-                PrintStream Stdout = new PrintStream(berOS);\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n+//                PrintStream Stdout = new PrintStream(berOS);\n+//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n             }\n         }\n \n", "next_change": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMzEzOA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424733138", "body": "We shouldn't need to do this here.", "bodyText": "We shouldn't need to do this here.", "bodyHTML": "<p dir=\"auto\">We shouldn't need to do this here.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:10:44Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1232,6 +1252,18 @@ public TimedDirContext reCreateDirContext(TimedDirContext oldCtx, String errorMe\n     @FFDCIgnore(NamingException.class)\n     public void releaseDirContext(TimedDirContext ctx) throws WIMSystemException {\n         final String METHODNAME = \"releaseDirContext\";\n+        if (iJndiOutputEnabled) {", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 375838d504..aa60f1d572 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1252,18 +1250,6 @@ public class ContextManager {\n     @FFDCIgnore(NamingException.class)\n     public void releaseDirContext(TimedDirContext ctx) throws WIMSystemException {\n         final String METHODNAME = \"releaseDirContext\";\n-        if (iJndiOutputEnabled) {\n-            try {\n-                if (tc.isDebugEnabled()) {\n-                    Tr.debug(tc, METHODNAME + \" Writing the rest of the packet capture\");\n-                }\n-                bapos.writeTo(System.out);\n-            } catch (IOException e) {\n-                if (tc.isDebugEnabled()) {\n-                    Tr.debug(tc, METHODNAME + \" Could not flush the rest of the buffer\" + e.toString());\n-                }\n-            }\n-        }\n         if (iContextPoolEnabled) {\n \n             //Get the lock for the current domain\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczMzkzNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424733934", "body": "probably don't need to setup a context pool.", "bodyText": "probably don't need to setup a context pool.", "bodyHTML": "<p dir=\"auto\">probably don't need to setup a context pool.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:12:23Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're printing out the JNDI BER packets when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -192,11 +189,6 @@ public class JNDIOutputTest {\n         ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n         ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n         ldap.setLdapType(\"Custom\");\n-        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n-        ldap.setContextPool(cp);\n-        SearchResultsCache src = new SearchResultsCache();\n-        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n-        ldap.setLdapCache(new LdapCache(null, src));\n \n         server.getLdapRegistries().add(ldap);\n         updateConfigDynamically(libertyServer, server);\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczNDM3Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424734377", "body": "probably should disable attributes cache as well. You want to hit your BEROutputStream as much as you can in the test.", "bodyText": "probably should disable attributes cache as well. You want to hit your BEROutputStream as much as you can in the test.", "bodyHTML": "<p dir=\"auto\">probably should disable attributes cache as well. You want to hit your BEROutputStream as much as you can in the test.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:13:12Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're printing out the JNDI BER packets when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n+        ldap.setContextPool(cp);\n+        SearchResultsCache src = new SearchResultsCache();", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -192,11 +189,6 @@ public class JNDIOutputTest {\n         ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n         ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n         ldap.setLdapType(\"Custom\");\n-        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n-        ldap.setContextPool(cp);\n-        SearchResultsCache src = new SearchResultsCache();\n-        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n-        ldap.setLdapCache(new LdapCache(null, src));\n \n         server.getLdapRegistries().add(ldap);\n         updateConfigDynamically(libertyServer, server);\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczNDQ5OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424734499", "body": "This javadoc comment is outdated.", "bodyText": "This javadoc comment is outdated.", "bodyHTML": "<p dir=\"auto\">This javadoc comment is outdated.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:13:31Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're printing out the JNDI BER packets when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n+        ldap.setContextPool(cp);\n+        SearchResultsCache src = new SearchResultsCache();\n+        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+        ldap.setLdapCache(new LdapCache(null, src));\n+\n+        server.getLdapRegistries().add(ldap);\n+        updateConfigDynamically(libertyServer, server);\n+\n+    }\n+\n+    /**\n+     *\n+     * Check that we hit the timeout block of code for the context pool", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -205,16 +197,22 @@ public class JNDIOutputTest {\n \n     /**\n      *\n-     * Check that we hit the timeout block of code for the context pool\n+     * Check that we hit the JNDI BER output\n      */\n     @Test\n     public void testJNDIBEROutput() throws Exception {\n-        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String trace = \"-> localhost\";\n+\n+        /*\n+         * Run with JNDI BER trace disabled\n+         */\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n         assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n-        // Send in setting less than 1 second. Should run up to 1 second.\n+        /*\n+         * Enable JNDI BER trace output\n+         */\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n         ConfigElementList<LdapRegistry> ldaps = config.getLdapRegistries();\n         LdapRegistry ldap = null;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczNTMzNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424735336", "body": "maybe search for a few items from the BER output if possible.", "bodyText": "maybe search for a few items from the BER output if possible.", "bodyHTML": "<p dir=\"auto\">maybe search for a few items from the BER output if possible.</p>", "author": "jvanhill", "createdAt": "2020-05-13T21:15:08Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're printing out the JNDI BER packets when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n+        ldap.setContextPool(cp);\n+        SearchResultsCache src = new SearchResultsCache();\n+        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+        ldap.setLdapCache(new LdapCache(null, src));\n+\n+        server.getLdapRegistries().add(ldap);\n+        updateConfigDynamically(libertyServer, server);\n+\n+    }\n+\n+    /**\n+     *\n+     * Check that we hit the timeout block of code for the context pool\n+     */\n+    @Test\n+    public void testJNDIBEROutput() throws Exception {\n+        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -205,16 +197,22 @@ public class JNDIOutputTest {\n \n     /**\n      *\n-     * Check that we hit the timeout block of code for the context pool\n+     * Check that we hit the JNDI BER output\n      */\n     @Test\n     public void testJNDIBEROutput() throws Exception {\n-        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String trace = \"-> localhost\";\n+\n+        /*\n+         * Run with JNDI BER trace disabled\n+         */\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n         assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n-        // Send in setting less than 1 second. Should run up to 1 second.\n+        /*\n+         * Enable JNDI BER trace output\n+         */\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n         ConfigElementList<LdapRegistry> ldaps = config.getLdapRegistries();\n         LdapRegistry ldap = null;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczNTc5MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424735790", "body": "```suggestion\r\n        /*\r\n         * Enable JNDI BER trace output.\r\n         */\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Send in setting less than 1 second. Should run up to 1 second.\n          \n          \n            \n                    /*\n          \n          \n            \n                     * Enable JNDI BER trace output.\n          \n          \n            \n                     */", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">/<span class=\"x x-first\">/</span></span><span class=\"x x-last\"> Send in setting less than 1 second. Should run up to 1 second.</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">/<span class=\"x x-first x-last\">*</span></span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">         <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Enable</span> <span class=\"pl-c1\">JNDI</span> <span class=\"pl-c1\">BER</span> trace output.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">         <span class=\"pl-k\">*/</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-13T21:16:01Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're printing out the JNDI BER packets when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n+        ldap.setContextPool(cp);\n+        SearchResultsCache src = new SearchResultsCache();\n+        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+        ldap.setLdapCache(new LdapCache(null, src));\n+\n+        server.getLdapRegistries().add(ldap);\n+        updateConfigDynamically(libertyServer, server);\n+\n+    }\n+\n+    /**\n+     *\n+     * Check that we hit the timeout block of code for the context pool\n+     */\n+    @Test\n+    public void testJNDIBEROutput() throws Exception {\n+        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String returnUser = servlet.checkPassword(USER_DN, PWD);\n+        List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n+        assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n+\n+        // Send in setting less than 1 second. Should run up to 1 second.", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -205,16 +197,22 @@ public class JNDIOutputTest {\n \n     /**\n      *\n-     * Check that we hit the timeout block of code for the context pool\n+     * Check that we hit the JNDI BER output\n      */\n     @Test\n     public void testJNDIBEROutput() throws Exception {\n-        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String trace = \"-> localhost\";\n+\n+        /*\n+         * Run with JNDI BER trace disabled\n+         */\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n         assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n-        // Send in setting less than 1 second. Should run up to 1 second.\n+        /*\n+         * Enable JNDI BER trace output\n+         */\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n         ConfigElementList<LdapRegistry> ldaps = config.getLdapRegistries();\n         LdapRegistry ldap = null;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczNjAxMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r424736012", "body": "/*\r\n * Run with JNDI BER trace disabled.\r\n */", "bodyText": "/*\n\nRun with JNDI BER trace disabled.\n*/", "bodyHTML": "<p dir=\"auto\">/*</p>\n<ul dir=\"auto\">\n<li>Run with JNDI BER trace disabled.<br>\n*/</li>\n</ul>", "author": "jvanhill", "createdAt": "2020-05-13T21:16:28Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.ContextPool;\n+import com.ibm.websphere.simplicity.config.wim.LdapCache;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.config.wim.SearchResultsCache;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're printing out the JNDI BER packets when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+        ContextPool cp = new ContextPool(true, 0, 2, 1, \"2s\", \"5s\");\n+        ldap.setContextPool(cp);\n+        SearchResultsCache src = new SearchResultsCache();\n+        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+        ldap.setLdapCache(new LdapCache(null, src));\n+\n+        server.getLdapRegistries().add(ldap);\n+        updateConfigDynamically(libertyServer, server);\n+\n+    }\n+\n+    /**\n+     *\n+     * Check that we hit the timeout block of code for the context pool\n+     */\n+    @Test\n+    public void testJNDIBEROutput() throws Exception {\n+        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String returnUser = servlet.checkPassword(USER_DN, PWD);", "originalCommit": "c8eb410a7b9e39ca438e875a6c8f647157cb377c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e46e47ce475f367d7da6812db76f9d44a0515b", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\nindex ad0c87ca84..6544a24aa0 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java\n", "chunk": "@@ -205,16 +197,22 @@ public class JNDIOutputTest {\n \n     /**\n      *\n-     * Check that we hit the timeout block of code for the context pool\n+     * Check that we hit the JNDI BER output\n      */\n     @Test\n     public void testJNDIBEROutput() throws Exception {\n-        String trace = \"-> localhost\"; // depends on trace logged in LdapConnection.getDirContext\n+        String trace = \"-> localhost\";\n+\n+        /*\n+         * Run with JNDI BER trace disabled\n+         */\n         String returnUser = servlet.checkPassword(USER_DN, PWD);\n         List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n         assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n \n-        // Send in setting less than 1 second. Should run up to 1 second.\n+        /*\n+         * Enable JNDI BER trace output\n+         */\n         ServerConfiguration config = libertyServer.getServerConfiguration();\n         ConfigElementList<LdapRegistry> ldaps = config.getLdapRegistries();\n         LdapRegistry ldap = null;\n", "next_change": null}]}}, {"oid": "28e46e47ce475f367d7da6812db76f9d44a0515b", "url": "https://github.com/OpenLiberty/open-liberty/commit/28e46e47ce475f367d7da6812db76f9d44a0515b", "message": "creating a JNDI output Config", "committedDate": "2020-05-14T14:27:13Z", "type": "forcePushed"}, {"oid": "c7e8c64f62bee6ec63fc3a57c902ebff4c3f5c58", "url": "https://github.com/OpenLiberty/open-liberty/commit/c7e8c64f62bee6ec63fc3a57c902ebff4c3f5c58", "message": "creating a JNDI output Config", "committedDate": "2020-05-14T14:33:21Z", "type": "forcePushed"}, {"oid": "091db6247c2c693439950e45c397ce00f5dd47a8", "url": "https://github.com/OpenLiberty/open-liberty/commit/091db6247c2c693439950e45c397ce00f5dd47a8", "message": "creating a JNDI output Config", "committedDate": "2020-05-14T14:36:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0MTg3Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425241872", "body": "Copyright date should be updated.", "bodyText": "Copyright date should be updated.", "bodyHTML": "<p dir=\"auto\">Copyright date should be updated.</p>", "author": "jvanhill", "createdAt": "2020-05-14T15:48:36Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -10,6 +10,7 @@\n  *******************************************************************************/\n package com.ibm.ws.security.wim.adapter.ldap.context;", "originalCommit": "091db6247c2c693439950e45c397ce00f5dd47a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 93d49a9d81..57570f987a 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -10,7 +10,6 @@\n  *******************************************************************************/\n package com.ibm.ws.security.wim.adapter.ldap.context;\n \n-import java.io.PrintStream;\n import java.security.AccessController;\n import java.security.PrivilegedAction;\n import java.util.ArrayList;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0MjYzNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425242636", "body": "Javadoc", "bodyText": "Javadoc", "bodyHTML": "<p dir=\"auto\">Javadoc</p>", "author": "jvanhill", "createdAt": "2020-05-14T15:49:42Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -176,6 +181,8 @@\n     /** The initial pool size for the DirContext pool. */\n     private int iInitPoolSize = DEFAULT_INIT_POOL_SIZE;\n \n+    private Boolean iJndiOutputEnabled = false;", "originalCommit": "091db6247c2c693439950e45c397ce00f5dd47a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 93d49a9d81..57570f987a 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -181,6 +180,7 @@ public class ContextManager {\n     /** The initial pool size for the DirContext pool. */\n     private int iInitPoolSize = DEFAULT_INIT_POOL_SIZE;\n \n+    /** Whether to dump JNDI packets to system out */\n     private Boolean iJndiOutputEnabled = false;\n \n     /** The timestamp of the last query for the return to primary. */\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NDgwNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425244804", "body": "Why do we need to wrap with a PrintStream? BEROutputStream is already an java.io.OutputStream.", "bodyText": "Why do we need to wrap with a PrintStream? BEROutputStream is already an java.io.OutputStream.", "bodyHTML": "<p dir=\"auto\">Why do we need to wrap with a PrintStream? BEROutputStream is already an java.io.OutputStream.</p>", "author": "jvanhill", "createdAt": "2020-05-14T15:52:36Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1063,17 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Enabled JNDI BER output if required.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            synchronized (iLock) {\n+                BEROutputStream berOS = new BEROutputStream();\n+                PrintStream Stdout = new PrintStream(berOS);", "originalCommit": "091db6247c2c693439950e45c397ce00f5dd47a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 93d49a9d81..57570f987a 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1069,8 +1069,9 @@ public class ContextManager {\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n                 BEROutputStream berOS = new BEROutputStream();\n-                PrintStream Stdout = new PrintStream(berOS);\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n+//                PrintStream Stdout = new PrintStream(berOS);\n+//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n             }\n         }\n \n", "next_change": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NTQ5Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425245497", "body": "Comment?", "bodyText": "Comment?", "bodyHTML": "<p dir=\"auto\">Comment?</p>", "author": "jvanhill", "createdAt": "2020-05-14T15:53:33Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/LdapConnection.java", "diffHunk": "@@ -409,6 +410,8 @@ private void initializeContextManager(Map<String, Object> configProps) throws WI\n          */\n         iContextManager.setReadTimeout((Long) configProps.get(CONFIG_PROP_READ_TIMEOUT));\n \n+        iContextManager.setJndiOutputEnabled((Boolean) configProps.get(CONFIG_PROP_JNDI_OUTPUT_ENABLED));", "originalCommit": "091db6247c2c693439950e45c397ce00f5dd47a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/LdapConnection.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/LdapConnection.java\nindex 1feb1736ac..ddbbc74d08 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/LdapConnection.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/LdapConnection.java\n", "chunk": "@@ -410,6 +410,9 @@ public class LdapConnection {\n          */\n         iContextManager.setReadTimeout((Long) configProps.get(CONFIG_PROP_READ_TIMEOUT));\n \n+        /*\n+         * Set JNDI packet output to system out\n+         */\n         iContextManager.setJndiOutputEnabled((Boolean) configProps.get(CONFIG_PROP_JNDI_OUTPUT_ENABLED));\n \n         /*\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NjMzMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425246333", "body": "Copyright date above should be 2020.", "bodyText": "Copyright date above should be 2020.", "bodyHTML": "<p dir=\"auto\">Copyright date above should be 2020.</p>", "author": "jvanhill", "createdAt": "2020-05-14T15:54:43Z", "path": "dev/fattest.simplicity/src/com/ibm/websphere/simplicity/config/wim/LdapRegistry.java", "diffHunk": "@@ -45,6 +45,7 @@\n     private LdapFilters idsFilters;\n     private Boolean ignoreCase;\n     private LdapFilters iplanetFilters;\n+    private Boolean jndiOutputEnabled;", "originalCommit": "091db6247c2c693439950e45c397ce00f5dd47a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0ODI5MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425248290", "body": "I thought i put a comment about checking for more output, but I don't see it. Is there anything else we can check for? Maybe the incoming and  outgoing, maybe some data?", "bodyText": "I thought i put a comment about checking for more output, but I don't see it. Is there anything else we can check for? Maybe the incoming and  outgoing, maybe some data?", "bodyHTML": "<p dir=\"auto\">I thought i put a comment about checking for more output, but I don't see it. Is there anything else we can check for? Maybe the incoming and  outgoing, maybe some data?</p>", "author": "jvanhill", "createdAt": "2020-05-14T15:57:25Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/JNDIOutputTest.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.security.wim.adapter.ldap.fat;\n+\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.websphere.simplicity.config.ConfigElementList;\n+import com.ibm.websphere.simplicity.config.ServerConfiguration;\n+import com.ibm.websphere.simplicity.config.wim.LdapRegistry;\n+import com.ibm.websphere.simplicity.log.Log;\n+import com.ibm.ws.com.unboundid.InMemoryLDAPServer;\n+import com.ibm.ws.security.registry.test.UserRegistryServletConnection;\n+import com.unboundid.ldap.sdk.Entry;\n+\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.impl.LibertyServerFactory;\n+import componenttest.topology.utils.LDAPUtils;\n+\n+/**\n+ * Ensure we're printing out the JNDI BER packets when expected.\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class JNDIOutputTest {\n+\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.jndi.output\");\n+    private static final Class<?> c = JNDIOutputTest.class;\n+    private static UserRegistryServletConnection servlet;\n+\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration emptyConfiguration = null;\n+\n+    private static InMemoryLDAPServer ds;\n+    private static final String SUB_DN = \"o=ibm,c=us\";\n+    private static final String USER_BASE_DN = \"ou=TestUsers,ou=Test,o=ibm,c=us\";\n+    private static final String USER = \"user\";\n+    private static final String USER_DN = \"uid=\" + USER + \",\" + USER_BASE_DN;\n+    private static final String PWD = \"usrpwd\";\n+\n+    /**\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n+     */\n+    @BeforeClass\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupldapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer();\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n+        Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n+\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        assertNotNull(\"Application userRegistry does not appear to have started.\",\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+        assertNotNull(\"Security service did not report it was ready\",\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n+        assertNotNull(\"Server did not came up\",\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n+\n+        Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n+\n+        if (servlet.getRealm() == null) {\n+            Thread.sleep(5000);\n+            servlet.getRealm();\n+        }\n+\n+        /*\n+         * The original server configuration has no registry or Federated Repository configuration.\n+         */\n+        emptyConfiguration = libertyServer.getServerConfiguration();\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupldapServer() throws Exception {\n+        ds = new InMemoryLDAPServer(SUB_DN);\n+\n+        Entry entry = new Entry(SUB_DN);\n+        entry.addAttribute(\"objectclass\", \"top\");\n+        entry.addAttribute(\"objectclass\", \"domain\");\n+        ds.add(entry);\n+        /*\n+         * Add the partition entries.\n+         */\n+        entry = new Entry(\"ou=Test,o=ibm,c=us\");\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_BASE_DN);\n+        entry.addAttribute(\"objectclass\", \"organizationalunit\");\n+        entry.addAttribute(\"ou\", \"Test\");\n+        entry.addAttribute(\"ou\", \"TestUsers\");\n+        ds.add(entry);\n+\n+        entry = new Entry(USER_DN);\n+        entry.addAttribute(\"objectclass\", \"inetorgperson\");\n+        entry.addAttribute(\"uid\", USER);\n+        entry.addAttribute(\"sn\", USER);\n+        entry.addAttribute(\"cn\", USER);\n+        entry.addAttribute(\"userPassword\", PWD);\n+        ds.add(entry);\n+\n+    }\n+\n+    /**\n+     * Convenience method to configure the Liberty server with an {@link LdapRegistry} configuration that\n+     * will connect to {@link #ldapServer}.\n+     *\n+     * @throws Exception If there was an error configuring the server.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = emptyConfiguration.clone();\n+\n+        LdapRegistry ldap = new LdapRegistry();\n+        ldap.setId(\"ldap1\");\n+        ldap.setRealm(\"LDAPRealm\");\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getLdapPort()));\n+        ldap.setBaseDN(SUB_DN);\n+        ldap.setBindDN(InMemoryLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryLDAPServer.getBindPassword());\n+        ldap.setLdapType(\"Custom\");\n+\n+        server.getLdapRegistries().add(ldap);\n+        updateConfigDynamically(libertyServer, server);\n+\n+    }\n+\n+    /**\n+     *\n+     * Check that we hit the JNDI BER output\n+     */\n+    @Test\n+    public void testJNDIBEROutput() throws Exception {\n+        String trace = \"-> localhost\";\n+\n+        /*\n+         * Run with JNDI BER trace disabled\n+         */\n+        String returnUser = servlet.checkPassword(USER_DN, PWD);\n+        List<String> errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n+        assertTrue(\"Should not find: \" + trace, errMsgs.isEmpty());\n+\n+        /*\n+         * Enable JNDI BER trace output\n+         */\n+        ServerConfiguration config = libertyServer.getServerConfiguration();\n+        ConfigElementList<LdapRegistry> ldaps = config.getLdapRegistries();\n+        LdapRegistry ldap = null;\n+        if (!ldaps.isEmpty() && ldaps.size() == 1) {\n+            ldap = ldaps.get(0);\n+        }\n+        ldap.setJndiOutputEnabled(true);\n+        updateConfigDynamically(libertyServer, config);\n+        returnUser = servlet.checkPassword(USER_DN, PWD);\n+        errMsgs = libertyServer.findStringsInLogsAndTrace(trace);\n+        assertFalse(\"Should find: \" + trace, errMsgs.isEmpty());", "originalCommit": "091db6247c2c693439950e45c397ce00f5dd47a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0ODU1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425248554", "bodyText": "Need to run with several JREs as well. the trace may be different.", "author": "jvanhill", "createdAt": "2020-05-14T15:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0ODI5MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "url": "https://github.com/OpenLiberty/open-liberty/commit/0736c4073ad65d52d1303aede275ef1f0a1b44d3", "message": "creating a JNDI output Config", "committedDate": "2020-05-14T21:53:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1Njg4MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425456881", "body": "```suggestion\r\n                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\r\n```\r\n```suggestion\r\n                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n          \n          \n            \n                            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n          \n      \n    \n    \n  \n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n          \n          \n            \n                            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                iEnvironment<span class=\"pl-k\">.</span>put(<span class=\"pl-c1\">LDAP_ENV_PROP_JNDI_BER_OUTPUT</span>, berOS);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                iEnvironment<span class=\"pl-k\">.</span>put(<span class=\"pl-c1\">LDAP_ENV_PROP_JNDI_BER_OUTPUT</span>, berOS);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                iEnvironment<span class=\"pl-k\">.</span>put(<span class=\"pl-c1\">LDAP_ENV_PROP_JNDI_BER_OUTPUT</span>, <span class=\"x x-first x-last\">berOS</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                iEnvironment<span class=\"pl-k\">.</span>put(<span class=\"pl-c1\">LDAP_ENV_PROP_JNDI_BER_OUTPUT</span>, <span class=\"pl-k x x-first\">new</span><span class=\"x\"> </span><span class=\"pl-smi x\">BEROutputStream</span><span class=\"x x-last\">()</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-14T22:04:22Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1063,18 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Enabled JNDI BER output if required.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            synchronized (iLock) {\n+                BEROutputStream berOS = new BEROutputStream();\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);", "originalCommit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1NjkzNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425456934", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            BEROutputStream berOS = new BEROutputStream();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">                </span><span class=\"pl-smi x\">BEROutputStream</span><span class=\"x\"> berOS </span><span class=\"pl-k x\">=</span><span class=\"x\"> </span><span class=\"pl-k x\">new</span><span class=\"x\"> </span><span class=\"pl-smi x\">BEROutputStream</span><span class=\"x x-last\">();</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-14T22:04:30Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1063,18 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Enabled JNDI BER output if required.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            synchronized (iLock) {\n+                BEROutputStream berOS = new BEROutputStream();", "originalCommit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1NzA4Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425457083", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //                PrintStream Stdout = new PrintStream(berOS);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-c\"><span class=\"pl-c x x-first\">//</span><span class=\"x x-last\">                PrintStream Stdout = new PrintStream(berOS);</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-14T22:04:50Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1063,18 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Enabled JNDI BER output if required.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            synchronized (iLock) {\n+                BEROutputStream berOS = new BEROutputStream();\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n+//                PrintStream Stdout = new PrintStream(berOS);", "originalCommit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1NzIwNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425457206", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-c\"><span class=\"pl-c x x-first\">//</span><span class=\"x x-last\">                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jvanhill", "createdAt": "2020-05-14T22:05:07Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1063,18 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Enabled JNDI BER output if required.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            synchronized (iLock) {\n+                BEROutputStream berOS = new BEROutputStream();\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n+//                PrintStream Stdout = new PrintStream(berOS);\n+//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);", "originalCommit": "0736c4073ad65d52d1303aede275ef1f0a1b44d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex 57570f987a..ff659e1b0d 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1068,10 +1068,7 @@ public class ContextManager {\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n             synchronized (iLock) {\n-                BEROutputStream berOS = new BEROutputStream();\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, berOS);\n-//                PrintStream Stdout = new PrintStream(berOS);\n-//                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, Stdout);\n+                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n             }\n         }\n \n", "next_change": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}]}}, {"oid": "99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "url": "https://github.com/OpenLiberty/open-liberty/commit/99dda7443d2ffb891a2ceebef8fc4f42051a4f4a", "message": "creating a JNDI output Config", "committedDate": "2020-05-14T23:28:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUwNzk5NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12004#discussion_r425507994", "body": "Did I miss this synchronized block? I don't think we need this. We are adding a new instance of the output stream to the environment, so I don't think there are any race conditions here.", "bodyText": "Did I miss this synchronized block? I don't think we need this. We are adding a new instance of the output stream to the environment, so I don't think there are any race conditions here.", "bodyHTML": "<p dir=\"auto\">Did I miss this synchronized block? I don't think we need this. We are adding a new instance of the output stream to the environment, so I don't think there are any race conditions here.</p>", "author": "jvanhill", "createdAt": "2020-05-15T00:52:52Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java", "diffHunk": "@@ -1056,6 +1063,15 @@ public InitializeResult initialize() throws WIMApplicationException {\n             iEnvironment.put(LDAP_ENV_PROP_READ_TIMEOUT, String.valueOf(DEFAULT_READ_TIMEOUT));\n         }\n \n+        /*\n+         * Enabled JNDI BER output if required.\n+         */\n+        if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n+            synchronized (iLock) {", "originalCommit": "3c6a752325dd013e36bcbb70a63b8143a1093473", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "changed_code": [{"header": "diff --git a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\nindex ff659e1b0d..373a1b56bb 100644\n--- a/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n+++ b/dev/com.ibm.ws.security.wim.adapter.ldap/src/com/ibm/ws/security/wim/adapter/ldap/context/ContextManager.java\n", "chunk": "@@ -1067,9 +1067,7 @@ public class ContextManager {\n          * Enabled JNDI BER output if required.\n          */\n         if (iJndiOutputEnabled != null && iJndiOutputEnabled) {\n-            synchronized (iLock) {\n-                iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n-            }\n+            iEnvironment.put(LDAP_ENV_PROP_JNDI_BER_OUTPUT, new BEROutputStream());\n         }\n \n         /*\n", "next_change": null}]}}, {"oid": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "url": "https://github.com/OpenLiberty/open-liberty/commit/7149c732b679d5d96c0efa1872da335d2b83ca9f", "message": "creating a JNDI output Config", "committedDate": "2020-05-15T01:29:39Z", "type": "commit"}, {"oid": "7149c732b679d5d96c0efa1872da335d2b83ca9f", "url": "https://github.com/OpenLiberty/open-liberty/commit/7149c732b679d5d96c0efa1872da335d2b83ca9f", "message": "creating a JNDI output Config", "committedDate": "2020-05-15T01:29:39Z", "type": "forcePushed"}, {"oid": "5734e7c2567726f6d1c8f6e090ed145923c58fd3", "url": "https://github.com/OpenLiberty/open-liberty/commit/5734e7c2567726f6d1c8f6e090ed145923c58fd3", "message": "Merge branch 'integration' into OLGH9902-JNDItrace", "committedDate": "2020-05-15T13:51:44Z", "type": "commit"}]}