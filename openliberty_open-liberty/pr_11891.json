{"pr_number": 11891, "pr_title": "Upgrade to Testcontainers 1.14.0", "pr_author": "aguibert", "pr_createdAt": "2020-04-22T16:39:53Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11891", "timeline": [{"oid": "a29351a56f44d584cf6fe188f678084df15a4f16", "url": "https://github.com/OpenLiberty/open-liberty/commit/a29351a56f44d584cf6fe188f678084df15a4f16", "message": "Upgrade to Testcontainers 1.14.0", "committedDate": "2020-04-23T20:28:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0Njg1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11891#discussion_r414746854", "body": "The oracle container uses ports 1521, and 5500.\r\nThis regression will also affect fattest.databases.  You'll need to expose these ports here as well: \r\nhttps://github.com/OpenLiberty/open-liberty/blob/dfd64634f4f0715db178b558e88f52c9b74c8f05/dev/fattest.databases/src/componenttest/topology/database/container/DatabaseContainerFactory.java#L122-L124", "bodyText": "The oracle container uses ports 1521, and 5500.\nThis regression will also affect fattest.databases.  You'll need to expose these ports here as well:\n\n  \n    \n      open-liberty/dev/fattest.databases/src/componenttest/topology/database/container/DatabaseContainerFactory.java\n    \n    \n        Lines 122 to 124\n      in\n      dfd6463\n    \n    \n    \n    \n\n        \n          \n           case Oracle:          \t \n        \n\n        \n          \n           \tcont = (JdbcDatabaseContainer<?>) clazz.getConstructor(String.class).newInstance(\"kyleaure/oracle-18.4.0-xe-prebuilt:1.0\"); \n        \n\n        \n          \n               break;", "bodyHTML": "<p dir=\"auto\">The oracle container uses ports 1521, and 5500.<br>\nThis regression will also affect fattest.databases.  You'll need to expose these ports here as well:<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/OpenLiberty/open-liberty/blob/dfd64634f4f0715db178b558e88f52c9b74c8f05/dev/fattest.databases/src/componenttest/topology/database/container/DatabaseContainerFactory.java#L122-L124\">open-liberty/dev/fattest.databases/src/componenttest/topology/database/container/DatabaseContainerFactory.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 122 to 124\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/OpenLiberty/open-liberty/commit/dfd64634f4f0715db178b558e88f52c9b74c8f05\">dfd6463</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L122\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"122\"></td>\n          <td id=\"LC122\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">case</span> <span class=\"pl-smi\">Oracle</span><span class=\"pl-k\">:</span>          \t </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L123\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"123\"></td>\n          <td id=\"LC123\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \tcont <span class=\"pl-k\">=</span> (<span class=\"pl-k\">JdbcDatabaseContainer&lt;?&gt;</span>) clazz<span class=\"pl-k\">.</span>getConstructor(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>class)<span class=\"pl-k\">.</span>newInstance(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>kyleaure/oracle-18.4.0-xe-prebuilt:1.0<span class=\"pl-pds\">\"</span></span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L124\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"124\"></td>\n          <td id=\"LC124\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">break</span>; </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "KyleAure", "createdAt": "2020-04-24T17:35:25Z", "path": "dev/com.ibm.ws.jdbc_fat_oracle/fat/src/com/ibm/ws/jdbc/fat/oracle/FATSuite.java", "diffHunk": "@@ -30,83 +30,83 @@\n import oracle.jdbc.pool.OracleDataSource;\n \n @RunWith(Suite.class)\n-@SuiteClasses({\n-                OracleTest.class,\n-                OracleTraceTest.class,\n-                OracleUCPTest.class\n-})\n+@SuiteClasses({ OracleTest.class, OracleTraceTest.class, OracleUCPTest.class })\n public class FATSuite {\n \n-    //TODO replace this container with the official oracle-xe container if/when it is available without a license\n-    static OracleContainer oracle = new OracleContainer(\"kyleaure/oracle-18.4.0-xe-prebuilt:1.0\").withLogConsumer(FATSuite::log);\n-\n-    private static void log(OutputFrame frame) {\n-        String msg = frame.getUtf8String();\n-        if (msg.endsWith(\"\\n\"))\n-            msg = msg.substring(0, msg.length() - 1);\n-        Log.info(FATSuite.class, \"oracle\", msg);\n-    }\n-\n-    @BeforeClass\n-    public static void beforeSuite() throws Exception {\n-        //Allows local tests to switch between using a local docker client, to using a remote docker client.\n-        ExternalTestServiceDockerClientStrategy.clearTestcontainersConfig();\n-\n-        oracle.start();\n-    }\n-\n-    @AfterClass\n-    public static void afterSuite() {\n-        oracle.stop();\n-    }\n-\n-    public static void initDatabaseTables() throws SQLException {\n-        Properties connProps = new Properties();\n-        // This property prevents \"ORA-01882: timezone region not found\" errors due to the Oracle DB not understanding\n-        // some time zones(specifically those used by our RHEL 6 test systems).\n-        connProps.put(\"oracle.jdbc.timezoneAsRegion\", \"false\");\n-\n-        OracleDataSource ds = new OracleDataSource();\n-        ds.setConnectionProperties(connProps);\n-        ds.setUser(oracle.getUsername());\n-        ds.setPassword(oracle.getPassword());\n-        ds.setURL(oracle.getJdbcUrl());\n-\n-        try (Connection conn = ds.getConnection()) {\n-            Statement stmt = conn.createStatement();\n-\n-            //Create MYTABLE for OracleTest.class and OracleTraceTest.class\n-            try {\n-                stmt.execute(\"DROP TABLE MYTABLE\");\n-            } catch (SQLException x) {\n-                // probably didn't exist\n-            }\n-            stmt.execute(\"CREATE TABLE MYTABLE (ID NUMBER NOT NULL PRIMARY KEY, STRVAL NVARCHAR2(40))\");\n-\n-            //Create CONCOUNT for OracleTest.class\n-            try {\n-                stmt.execute(\"DROP TABLE CONCOUNT\");\n-            } catch (SQLException x) {\n-                // probably didn't exist\n-            }\n-            stmt.execute(\"CREATE TABLE CONCOUNT (NUMCONNECTIONS NUMBER NOT NULL)\");\n-            stmt.execute(\"INSERT INTO CONCOUNT VALUES(0)\");\n-\n-            //Create COLORTABLE for OracleUCPTest.class\n-            try {\n-                stmt.execute(\"DROP TABLE COLORTABLE\");\n-            } catch (SQLException x) {\n-                // probably didn't exist\n-            }\n-            stmt.execute(\"CREATE TABLE COLORTABLE (ID NUMBER NOT NULL PRIMARY KEY, COLOR NVARCHAR2(40))\");\n-            PreparedStatement ps = conn.prepareStatement(\"INSERT INTO COLORTABLE VALUES(?,?)\");\n-            ps.setInt(1, 1);\n-            ps.setString(2, \"maroon\");\n-            ps.executeUpdate();\n-\n-            //Close statements\n-            ps.close();\n-            stmt.close();\n-        }\n-    }\n+\t// TODO replace this container with the official oracle-xe container if/when it is available without a license\n+\tstatic OracleContainer oracle = new OracleContainer(\"kyleaure/oracle-18.4.0-xe-prebuilt:1.0\")\n+\t\t\t.withExposedPorts(1521, 8080) // need to manually expose ports due to regression in 1.14.0", "originalCommit": "a29351a56f44d584cf6fe188f678084df15a4f16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1aa8882e93c10a1494d0dc351acdf0df1cf49b19", "url": "https://github.com/OpenLiberty/open-liberty/commit/1aa8882e93c10a1494d0dc351acdf0df1cf49b19", "message": "Upgrade to Testcontainers 1.14.0", "committedDate": "2020-04-24T17:53:50Z", "type": "commit"}, {"oid": "1aa8882e93c10a1494d0dc351acdf0df1cf49b19", "url": "https://github.com/OpenLiberty/open-liberty/commit/1aa8882e93c10a1494d0dc351acdf0df1cf49b19", "message": "Upgrade to Testcontainers 1.14.0", "committedDate": "2020-04-24T17:53:50Z", "type": "forcePushed"}]}