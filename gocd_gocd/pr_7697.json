{"pr_number": 7697, "pr_title": "Applied rules after a successful config repo parse", "pr_author": "kritika-singh3", "pr_createdAt": "2020-02-03T11:52:26Z", "pr_url": "https://github.com/gocd/gocd/pull/7697", "timeline": [{"oid": "70c7cbbb3c4bf86dcfca0cf1298e75ce82111c6e", "url": "https://github.com/gocd/gocd/commit/70c7cbbb3c4bf86dcfca0cf1298e75ce82111c6e", "message": "Applied rules after a successful config repo parse\n\n - The PartialConfig is validated against the rules defined in the config repo while updating the config in the PartialConfigUpdateCommand.\n - In case of pre-flight api where no config-repo id is specified, the check is skipped.", "committedDate": "2020-02-04T04:02:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzMTM1Mw==", "url": "https://github.com/gocd/gocd/pull/7697#discussion_r374531353", "body": "@kritika-singh3 @arvindsv @adityasood \r\n\r\n**Pipeline reference rule defined on a config repository is not applicable for the pipelines coming from the same repository.**\r\n\r\nDescription:\r\n\r\nFor the following rule:\r\n`<allow action=\"refer\" type=\"pipeline\">up42</pipeline>`\r\n\r\nFollowing partials are coming from config repository:\r\n* `pipeline1` (which has a pipeline-dependency `up42`)\r\n* `pipeline2` (which has a pipeline-dependency `pipeline1`)\r\n\r\nEven though, there is no explicit allow permission mentioned for `pipeline1` pipeline dependency, it is allowed because both the pipelines are defined in the same repository.\r\n\r\n**Note:** We need to mention this behavior on our docs explicitly.\r\n\r\n\r\n\r\n", "bodyText": "@kritika-singh3 @arvindsv @adityasood\nPipeline reference rule defined on a config repository is not applicable for the pipelines coming from the same repository.\nDescription:\nFor the following rule:\n<allow action=\"refer\" type=\"pipeline\">up42</pipeline>\nFollowing partials are coming from config repository:\n\npipeline1 (which has a pipeline-dependency up42)\npipeline2 (which has a pipeline-dependency pipeline1)\n\nEven though, there is no explicit allow permission mentioned for pipeline1 pipeline dependency, it is allowed because both the pipelines are defined in the same repository.\nNote: We need to mention this behavior on our docs explicitly.", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/kritika-singh3/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/kritika-singh3\">@kritika-singh3</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/arvindsv/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/arvindsv\">@arvindsv</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/adityasood/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/adityasood\">@adityasood</a></p>\n<p dir=\"auto\"><strong>Pipeline reference rule defined on a config repository is not applicable for the pipelines coming from the same repository.</strong></p>\n<p dir=\"auto\">Description:</p>\n<p dir=\"auto\">For the following rule:<br>\n<code>&lt;allow action=\"refer\" type=\"pipeline\"&gt;up42&lt;/pipeline&gt;</code></p>\n<p dir=\"auto\">Following partials are coming from config repository:</p>\n<ul dir=\"auto\">\n<li><code>pipeline1</code> (which has a pipeline-dependency <code>up42</code>)</li>\n<li><code>pipeline2</code> (which has a pipeline-dependency <code>pipeline1</code>)</li>\n</ul>\n<p dir=\"auto\">Even though, there is no explicit allow permission mentioned for <code>pipeline1</code> pipeline dependency, it is allowed because both the pipelines are defined in the same repository.</p>\n<p dir=\"auto\"><strong>Note:</strong> We need to mention this behavior on our docs explicitly.</p>", "author": "GaneshSPatil", "createdAt": "2020-02-04T08:30:28Z", "path": "server/src/main/java/com/thoughtworks/go/config/update/PartialConfigUpdateCommand.java", "diffHunk": "@@ -58,4 +75,44 @@ public CruiseConfig update(CruiseConfig cruiseConfig) {\n         }\n         return cruiseConfig;\n     }\n+\n+    private boolean validateEntityForRules(PartialConfig partialConfig) {\n+        //preflight check\n+        if (configRepoConfig == null) {\n+            return true;\n+        }\n+\n+        if (configRepoConfig.getRules().isEmpty()) {\n+            throw new InvalidPartialConfigException(partialConfig, \"Configurations can not be merged as no rules are defined.\");\n+        }\n+\n+        partialConfig.getEnvironments().stream()\n+                .filter(env -> !configRepoConfig.canRefer(ENVIRONMENT.getEntityType(), env.name().toString()))\n+                .forEach(envThatCanNotBeReferred -> {\n+                    envThatCanNotBeReferred.addError(ENVIRONMENT.getType(), format(\"Cannot refer environment: '%s' from the config repository.\", envThatCanNotBeReferred.name()));\n+                });\n+\n+        partialConfig.getGroups().stream()\n+                .filter(pipelineGrp -> !configRepoConfig.canRefer(PIPELINE_GROUP.getEntityType(), pipelineGrp.getGroup()))\n+                .forEach(pipelineGrpThatCannotBeReferred -> {\n+                    pipelineGrpThatCannotBeReferred.addError(PIPELINE_GROUP.getType(), format(\"Cannot refer pipeline group: '%s' from the config repository.\", pipelineGrpThatCannotBeReferred.getGroup()));\n+                });\n+\n+        List<DependencyMaterialConfig> dependencyMaterialConfigs = new ArrayList<>();\n+        partialConfig.getGroups().forEach((pipelineGrp) -> {\n+            pipelineGrp.forEach((pipelineConfig) -> dependencyMaterialConfigs.addAll(pipelineConfig.dependencyMaterialConfigs()));\n+        });\n+        dependencyMaterialConfigs.stream()\n+                .filter(dependencyMaterialConfig -> !doesPipelineExistInPartialConfig(partialConfig, dependencyMaterialConfig.getPipelineName()))", "originalCommit": "9c85244b440c35f58f435a38b8eb17247614b97d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb9474f9641a31c6fb4ad4e9429906cde1be35dd", "url": "https://github.com/gocd/gocd/commit/fb9474f9641a31c6fb4ad4e9429906cde1be35dd", "message": "Applied rules after a successful config repo parse\n\n - The PartialConfig is validated against the rules defined in the config repo while updating the config in the PartialConfigUpdateCommand.\n - In case of pre-flight api where no config-repo id is specified, the check is skipped.", "committedDate": "2020-02-04T09:53:01Z", "type": "commit"}, {"oid": "efe6175dd41778e8355e36db16324df8de382a9e", "url": "https://github.com/gocd/gocd/commit/efe6175dd41778e8355e36db16324df8de382a9e", "message": "Fix tests", "committedDate": "2020-02-04T09:53:01Z", "type": "commit"}, {"oid": "5dcc88618f80d43cfd3369cab2fdc7abeb49d14a", "url": "https://github.com/gocd/gocd/commit/5dcc88618f80d43cfd3369cab2fdc7abeb49d14a", "message": "Update error message", "committedDate": "2020-02-04T09:53:01Z", "type": "forcePushed"}, {"oid": "6da558c603d05928403a4e0c81399f1c8ad35134", "url": "https://github.com/gocd/gocd/commit/6da558c603d05928403a4e0c81399f1c8ad35134", "message": "Update error message", "committedDate": "2020-02-04T09:59:16Z", "type": "forcePushed"}, {"oid": "d9d19430f097cbd3f4f451d5742131a46937e416", "url": "https://github.com/gocd/gocd/commit/d9d19430f097cbd3f4f451d5742131a46937e416", "message": "Update error message", "committedDate": "2020-02-04T10:37:12Z", "type": "forcePushed"}, {"oid": "b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "url": "https://github.com/gocd/gocd/commit/b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "message": "Update error message", "committedDate": "2020-02-04T11:40:42Z", "type": "commit"}, {"oid": "b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "url": "https://github.com/gocd/gocd/commit/b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "message": "Update error message", "committedDate": "2020-02-04T11:40:42Z", "type": "forcePushed"}, {"oid": "a58ff9b52b50a1e37fed31833970e02d0717243d", "url": "https://github.com/gocd/gocd/commit/a58ff9b52b50a1e37fed31833970e02d0717243d", "message": "move the error msg generation to EntityType", "committedDate": "2020-02-05T05:36:48Z", "type": "commit"}, {"oid": "1859f02f2724091fe4f733863a0989cac809ccf1", "url": "https://github.com/gocd/gocd/commit/1859f02f2724091fe4f733863a0989cac809ccf1", "message": "Update GoConfigInvalidMergeException getMessage builder to referentiate between rule validation errors and config validation errors", "committedDate": "2020-02-05T06:00:12Z", "type": "commit"}]}